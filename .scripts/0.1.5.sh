#! /bin/zsh -e

source ".scripts/functions.sh"

set -e

PACKAGE_VERSION=0.1.5
HELIOS_VERSION=0.1.3
SWIFT_BRIDGE_VERSION=0.1.52
ETHERS_VERSION=1.0.2

env::setup
env::build_configuration $1

rust::setup

pre_build::create_build_directory
pre_build::setup_openssl dc976d756f9d3273c3c6f960fadb88e44b468050
pre_build::setup_helios
pre_build::modify_helios "dXNlIDo6Y2xpZW50Ojp7ZGF0YWJhc2U6OkZpbGVEQiwgQ2xpZW50LCBDbGllbnRCdWlsZGVyfTsKdXNlIDo6Y29uZmlnOjp7bmV0d29ya3N9Owp1c2UgOjpleGVjdXRpb246OnR5cGVzOjp7RXhlY3V0aW9uQmxvY2ssIFRyYW5zYWN0aW9uc307CnVzZSA6OmNvbnNlbnN1czo6dHlwZXM6OkhlYWRlcjsKdXNlIGV0aGVyczo6ewogIHByZWx1ZGU6OntBZGRyZXNzLCBVMjU2LCBIMjU2LCBVNjR9LCAKICBhYmk6OkFiaUVuY29kZSwKICB0eXBlczo6e0Jsb2NrTnVtYmVyLCBGaWx0ZXJCbG9ja09wdGlvbiwgRmlsdGVyLCBWYWx1ZU9yQXJyYXksIExvZywgVHJhbnNhY3Rpb25SZWNlaXB0LCBUcmFuc2FjdGlvbn0sCn07CgojW3N3aWZ0X2JyaWRnZTo6YnJpZGdlXQptb2QgZmZpIHsKCiAgZW51bSBCbG9ja1RhZyB7CiAgICBMYXRlc3QsCiAgICBGaW5hbGl6ZWQsCiAgICBTYWZlLAogICAgRWFybGllc3QsCiAgICBQZW5kaW5nLAogICAgTnVtYmVyKHU2NCksCiAgfQoKICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogIHN0cnVjdCBDYWxsT3B0cyB7CiAgICBwdWIgZnJvbTogU3RyaW5nLAogICAgcHViIHRvOiBTdHJpbmcsCiAgICBwdWIgZ2FzOiBTdHJpbmcsCiAgICBwdWIgZ2FzX3ByaWNlOiBTdHJpbmcsCiAgICBwdWIgdmFsdWU6IFN0cmluZywKICAgIHB1YiBkYXRhOiBTdHJpbmcsCn0KCiAgZW51bSBIZWxpb3NOZXR3b3JrIHsKICAgIE1BSU5ORVQsCiAgICBHT0VSTEksCiAgfQoKICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogIHN0cnVjdCBTdGFydFVwU3RhdGUgewogICAgc3RhcnRlZDogYm9vbCwKICAgIGVycm9yOiBTdHJpbmcsCiAgfQoKICBlbnVtIEZpbHRlckJsb2NrT3B0aW9uIHsKICAgIFJhbmdlIHsgZnJvbV9ibG9jazogT3B0aW9uPEJsb2NrVGFnPiwgdG9fYmxvY2s6IE9wdGlvbjxCbG9ja1RhZz4gfSwKICAgIEF0QmxvY2tIYXNoKFN0cmluZyksCiAgfQoKICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogIHN0cnVjdCBMb2dGaWx0ZXIgewogICAgcHViIGJsb2NrX29wdGlvbjogRmlsdGVyQmxvY2tPcHRpb24sCiAgICBwdWIgYWRkcmVzczogU3RyaW5nLAogICAgcHViIHRvcGljczogVmVjPFN0cmluZz4sCiAgfQoKICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICNbZGVyaXZlKENsb25lKV0KICBzdHJ1Y3QgTG9nIHsKICAgIGFkZHJlc3M6IFN0cmluZywKICAgIHRvcGljczogVmVjPFN0cmluZz4sCiAgICBkYXRhOiBWZWM8dTg+LAogICAgYmxvY2tfaGFzaDogU3RyaW5nLAogICAgYmxvY2tfbnVtYmVyOiBPcHRpb248dTY0PiwKICAgIHRyYW5zYWN0aW9uX2hhc2g6IFN0cmluZywKICAgIHRyYW5zYWN0aW9uX2luZGV4OiBPcHRpb248dTY0PiwKICAgIGxvZ19pbmRleDogU3RyaW5nLAogICAgdHJhbnNhY3Rpb25fbG9nX2luZGV4OiBTdHJpbmcsCiAgICBsb2dfdHlwZTogU3RyaW5nLAogICAgcmVtb3ZlZDogT3B0aW9uPGJvb2w+LAogIH0KCiAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICBzdHJ1Y3QgVHJhbnNhY3Rpb25SZWNlaXB0IHsKICAgIHRyYW5zYWN0aW9uX2hhc2g6IFN0cmluZywKICAgIHRyYW5zYWN0aW9uX2luZGV4OiB1NjQsCiAgICBibG9ja19oYXNoOiBTdHJpbmcsIC8vIG9wdGlvbmFsCiAgICBibG9ja19udW1iZXI6IE9wdGlvbjx1NjQ+LAogICAgZnJvbTogU3RyaW5nLAogICAgdG86IFN0cmluZywgLy8gb3B0aW9uYWwKICAgIGN1bXVsYXRpdmVfZ2FzX3VzZWQ6IFN0cmluZywKICAgIGdhc191c2VkOiBTdHJpbmcsIC8vIG9wdGlvbmFsCiAgICBjb250cmFjdF9hZGRyZXNzOiBTdHJpbmcsIC8vIG9wdGlvbmFsCiAgICBsb2dzOiBWZWM8TG9nPiwKICAgIHN0YXR1czogT3B0aW9uPHU2ND4sCiAgICByb290OiBTdHJpbmcsIC8vIG9wdGlvbm5hbAogICAgbG9nc19ibG9vbTogVmVjPHU4PiwKICAgIHRyYW5zYWN0aW9uX3R5cGU6IE9wdGlvbjx1NjQ+LAogICAgZWZmZWN0aXZlX2dhc19wcmljZTogU3RyaW5nLCAvL29wdGlvbmFsCiAgfQoKICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICNbZGVyaXZlKENsb25lKV0KICBzdHJ1Y3QgVHJhbnNhY3Rpb24gewogICAgaGFzaDogU3RyaW5nLAogICAgbm9uY2U6IFN0cmluZywKICAgIGJsb2NrX2hhc2g6IFN0cmluZywgLy9vcHRpb25hbAogICAgYmxvY2tfbnVtYmVyOiBPcHRpb248dTY0PiwKICAgIHRyYW5zYWN0aW9uX2luZGV4OiBPcHRpb248dTY0PiwKICAgIGZyb206IFN0cmluZywKICAgIHRvOiBTdHJpbmcsIC8vIG9wdGlvbmFsCiAgICB2YWx1ZTogU3RyaW5nLAogICAgZ2FzX3ByaWNlOiBTdHJpbmcsIC8vIG9wdGlvbmFsCiAgICBnYXM6IFN0cmluZywKICAgIGlucHV0OiBWZWM8dTg+LAogICAgdjogU3RyaW5nLAogICAgcjogU3RyaW5nLAogICAgczogU3RyaW5nLAogIH0KCiAgZW51bSBUcmFuc2FjdGlvbnMgewogICAgSGFzaGVzKFZlYzxTdHJpbmc+KSwKICAgIEZ1bGwoVmVjPFRyYW5zYWN0aW9uPiksCiAgfQoKICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogIHN0cnVjdCBFeGVjdXRpb25CbG9jayB7CiAgICBudW1iZXI6IHU2NCwKICAgIGJhc2VfZmVlX3Blcl9nYXM6IFN0cmluZywKICAgIGRpZmZpY3VsdHk6IFN0cmluZywKICAgIGV4dHJhX2RhdGE6IFZlYzx1OD4sCiAgICBnYXNfbGltaXQ6IHU2NCwKICAgIGdhc191c2VkOiB1NjQsCiAgICBoYXNoOiBTdHJpbmcsCiAgICBsb2dzX2Jsb29tOiBWZWM8dTg+LAogICAgbWluZXI6IFN0cmluZywKICAgIG1peF9oYXNoOiBTdHJpbmcsCiAgICBub25jZTogU3RyaW5nLAogICAgcGFyZW50X2hhc2g6IFN0cmluZywKICAgIHJlY2VpcHRzX3Jvb3Q6IFN0cmluZywKICAgIHNoYTNfdW5jbGVzOiBTdHJpbmcsCiAgICBzaXplOiB1NjQsCiAgICBzdGF0ZV9yb290OiBTdHJpbmcsCiAgICB0aW1lc3RhbXA6IHU2NCwKICAgIHRvdGFsX2RpZmZpY3VsdHk6IHU2NCwKICAgIHRyYW5zYWN0aW9uczogVHJhbnNhY3Rpb25zLAogICAgdHJhbnNhY3Rpb25zX3Jvb3Q6IFN0cmluZywKICAgIHVuY2xlczogVmVjPFN0cmluZz4sCiAgfQoKICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogIHN0cnVjdCBIZWFkZXIgewogICAgc2xvdDogdTY0LAogICAgcHJvcG9zZXJfaW5kZXg6IHU2NCwKICAgIHBhcmVudF9yb290OiBTdHJpbmcsCiAgICBzdGF0ZV9yb290OiBTdHJpbmcsCiAgICBib2R5X3Jvb3Q6IFN0cmluZywKICB9CgogICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgc3RydWN0IFJlc3BvbnNlVTY0IHsKICAgIHZhbHVlOiB1NjQsCiAgICBmYWlsZWQ6IGJvb2wsCiAgICBlcnJvcjogU3RyaW5nLAogIH0KCiAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICBzdHJ1Y3QgUmVzcG9uc2VTdHJpbmcgewogICAgdmFsdWU6IFN0cmluZywKICAgIGZhaWxlZDogYm9vbCwKICAgIGVycm9yOiBTdHJpbmcsCiAgfQoKICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogIHN0cnVjdCBSZXNwb25zZVZlYzggewogICAgdmFsdWU6IFZlYzx1OD4sCiAgICBmYWlsZWQ6IGJvb2wsCiAgICBlcnJvcjogU3RyaW5nLAogIH0KCiAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICBzdHJ1Y3QgUmVzcG9uc2VWZWNMb2cgewogICAgdmFsdWU6IFZlYzxMb2c+LAogICAgZmFpbGVkOiBib29sLAogICAgZXJyb3I6IFN0cmluZywKICB9CgogICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgc3RydWN0IFJlc3BvbnNlVHJhbnNhY3Rpb25SZWNlaXB0IHsKICAgIHZhbHVlOiBPcHRpb248VHJhbnNhY3Rpb25SZWNlaXB0PiwKICAgIGZhaWxlZDogYm9vbCwKICAgIGVycm9yOiBTdHJpbmcsCiAgfQoKICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogIHN0cnVjdCBSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgIHZhbHVlOiBPcHRpb248VHJhbnNhY3Rpb24+LAogICAgZmFpbGVkOiBib29sLAogICAgZXJyb3I6IFN0cmluZywKICB9CgogICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgc3RydWN0IFJlc3BvbnNlRXhlY3V0aW9uQmxvY2sgewogICAgdmFsdWU6IE9wdGlvbjxFeGVjdXRpb25CbG9jaz4sCiAgICBmYWlsZWQ6IGJvb2wsCiAgICBlcnJvcjogU3RyaW5nLAogIH0KCiAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICBzdHJ1Y3QgUmVzcG9uc2VIZWFkZXIgewogICAgdmFsdWU6IE9wdGlvbjxIZWFkZXI+LAogICAgZmFpbGVkOiBib29sLAogICAgZXJyb3I6IFN0cmluZywKICB9CgogIGV4dGVybiAiUnVzdCIgewogICAgdHlwZSBIZWxpb3NDbGllbnQ7CgogICAgI1tzd2lmdF9icmlkZ2UoaW5pdCldCiAgICBmbiBuZXcoKSAtPiBIZWxpb3NDbGllbnQ7CgogICAgYXN5bmMgZm4gc3RhcnQoCiAgICAgICZtdXQgc2VsZiwgCiAgICAgIHVudHJ1c3RlZF9ycGNfdXJsOiBTdHJpbmcsIAogICAgICBjb25zZW5zdXNfcnBjX3VybDogU3RyaW5nLAogICAgICBjaGVja3BvaW50OiBPcHRpb248U3RyaW5nPiwKICAgICAgcnBjX3BvcnQ6IHUxNiwKICAgICAgbmV0d29yazogSGVsaW9zTmV0d29yaywKICAgICAgZGF0YV9kaXI6IE9wdGlvbjxTdHJpbmc+CiAgICApIC0+IFN0YXJ0VXBTdGF0ZTsKCiAgICBhc3luYyBmbiBzaHV0ZG93bigmbXV0IHNlbGYpOwoKICAgIGFzeW5jIGZuIGNhbGwoJnNlbGYsIG9wdHM6IENhbGxPcHRzLCBibG9jazogQmxvY2tUYWcpIC0+IFJlc3BvbnNlVmVjODsKICAgIGFzeW5jIGZuIHNlbmRfcmF3X3RyYW5zYWN0aW9uKCZzZWxmLCBieXRlczogVmVjPHU4PikgLT4gUmVzcG9uc2VTdHJpbmc7CiAgICAKICAgIGFzeW5jIGZuIGVzdGltYXRlX2dhcygmc2VsZiwgb3B0czogQ2FsbE9wdHMpIC0+IFJlc3BvbnNlVTY0OwogICAgYXN5bmMgZm4gY2hhaW5faWQoJnNlbGYpIC0+IFJlc3BvbnNlVTY0OwogICAgYXN5bmMgZm4gZ2V0X2dhc19wcmljZSgmc2VsZikgLT4gUmVzcG9uc2VTdHJpbmc7CiAgICBhc3luYyBmbiBnZXRfcHJpb3JpdHlfZmVlKCZzZWxmKSAtPiBSZXNwb25zZVN0cmluZzsKICAgIGFzeW5jIGZuIGdldF9ibG9ja19udW1iZXIoJnNlbGYpIC0+IFJlc3BvbnNlVTY0OwogICAgYXN5bmMgZm4gZ2V0X2NvaW5iYXNlKCZzZWxmKSAtPiBSZXNwb25zZVN0cmluZzsKCiAgICBhc3luYyBmbiBnZXRfYmFsYW5jZSgmc2VsZiwgYWRkcmVzczogU3RyaW5nLCBibG9jazogQmxvY2tUYWcpIC0+IFJlc3BvbnNlU3RyaW5nOwogICAgYXN5bmMgZm4gZ2V0X25vbmNlKCZzZWxmLCBhZGRyZXNzOiBTdHJpbmcsIGJsb2NrOiBCbG9ja1RhZykgLT4gUmVzcG9uc2VVNjQ7CgogICAgYXN5bmMgZm4gZ2V0X2Jsb2NrX2J5X251bWJlcigmc2VsZiwgYmxvY2s6IEJsb2NrVGFnLCBmdWxsX3R4OiBib29sKSAtPiBSZXNwb25zZUV4ZWN1dGlvbkJsb2NrOwogICAgYXN5bmMgZm4gZ2V0X2Jsb2NrX2J5X2hhc2goJnNlbGYsIGhhc2g6IFN0cmluZywgZnVsbF90eDogYm9vbCkgLT4gUmVzcG9uc2VFeGVjdXRpb25CbG9jazsKICAgIGFzeW5jIGZuIGdldF9ibG9ja190cmFuc2FjdGlvbl9jb3VudF9ieV9oYXNoKCZzZWxmLCBoYXNoOiBTdHJpbmcpIC0+IFJlc3BvbnNlVTY0OwogICAgYXN5bmMgZm4gZ2V0X2Jsb2NrX3RyYW5zYWN0aW9uX2NvdW50X2J5X251bWJlcigmc2VsZiwgYmxvY2s6IEJsb2NrVGFnKSAtPiBSZXNwb25zZVU2NDsKCiAgICBhc3luYyBmbiBnZXRfdHJhbnNhY3Rpb25fcmVjZWlwdCgmc2VsZiwgdHhfaGFzaDogU3RyaW5nKSAtPiBSZXNwb25zZVRyYW5zYWN0aW9uUmVjZWlwdDsKICAgIGFzeW5jIGZuIGdldF90cmFuc2FjdGlvbl9ieV9oYXNoKCZzZWxmLCB0eF9oYXNoOiBTdHJpbmcpIC0+IFJlc3BvbnNlVHJhbnNhY3Rpb247CiAgICBhc3luYyBmbiBnZXRfdHJhbnNhY3Rpb25fYnlfYmxvY2tfaGFzaF9hbmRfaW5kZXgoJnNlbGYsIGJsb2NrX2hhc2g6IFN0cmluZywgaW5kZXg6IHVzaXplKSAtPiBSZXNwb25zZVRyYW5zYWN0aW9uOwogICAgCiAgICBhc3luYyBmbiBnZXRfbG9ncygmc2VsZiwgZmlsdGVyOiBMb2dGaWx0ZXIpIC0+IFJlc3BvbnNlVmVjTG9nOwoKICAgIGFzeW5jIGZuIGdldF9jb2RlKCZzZWxmLCBhZGRyZXNzOiBTdHJpbmcsIGJsb2NrOiBCbG9ja1RhZykgLT4gUmVzcG9uc2VWZWM4OwogICAgYXN5bmMgZm4gZ2V0X3N0b3JhZ2VfYXQoCiAgICAgICZzZWxmLAogICAgICBhZGRyZXNzOiBTdHJpbmcsCiAgICAgIHNsb3Q6IFN0cmluZywKICAgICAgYmxvY2s6IEJsb2NrVGFnLAogICAgKSAtPiBSZXNwb25zZVN0cmluZzsKCiAgICBhc3luYyBmbiBnZXRfaGVhZGVyKCZzZWxmKSAtPiBSZXNwb25zZUhlYWRlcjsKICB9Cn0KCmltcGwgSGVsaW9zQ2xpZW50IHsKCiAgcHViIGZuIG5ldygpIC0+IEhlbGlvc0NsaWVudCB7CiAgICBIZWxpb3NDbGllbnQgewogICAgICBjbGllbnQ6IE5vbmUsCiAgICAgIGlzX2xvZ2dpbmc6IGZhbHNlLAogICAgfQogIH0KCiAgYXN5bmMgZm4gc3RhcnQoCiAgICAmbXV0IHNlbGYsCiAgICB1bnRydXN0ZWRfcnBjX3VybDogU3RyaW5nLAogICAgY29uc2Vuc3VzX3JwY191cmw6IFN0cmluZywKICAgIGNoZWNrcG9pbnQ6IE9wdGlvbjxTdHJpbmc+LAogICAgcnBjX3BvcnQ6IHUxNiwKICAgIG5ldHdvcms6IGZmaTo6SGVsaW9zTmV0d29yaywKICAgIGRhdGFfZGlyOiBPcHRpb248U3RyaW5nPiwKICApIC0+IGZmaTo6U3RhcnRVcFN0YXRlIHsKICAgIGlmIGxldCBTb21lKF9jbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgcmV0dXJuIGZmaTo6U3RhcnRVcFN0YXRlIHsKICAgICAgICBzdGFydGVkOiBmYWxzZSwKICAgICAgICBlcnJvcjogIkNsaWVudCBoYXMgYWxyZWFkeSBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgIH07CiAgICB9CgogICAgaWYgIXNlbGYuaXNfbG9nZ2luZyB7CiAgICAgIHNlbGYuaXNfbG9nZ2luZyA9IHRydWU7CiAgICAgIGVudl9sb2dnZXI6OmluaXQoKTsKICAgIH0KCiAgICBsZXQgbXV0IGNsaWVudF9idWlsZGVyID0gQ2xpZW50QnVpbGRlcjo6bmV3KCkKICAgICAgLm5ldHdvcmsobmV0d29yay50b19iYXNlX25ldHdvcmsoKSkKICAgICAgLmV4ZWN1dGlvbl9ycGMoJnVudHJ1c3RlZF9ycGNfdXJsKQogICAgICAuY29uc2Vuc3VzX3JwYygmY29uc2Vuc3VzX3JwY191cmwpCiAgICAgIC5ycGNfcG9ydChycGNfcG9ydCk7CiAgICAKICAgIGlmIGxldCBTb21lKGNoZWNrcG9pbnQpID0gJmNoZWNrcG9pbnQgewogICAgICBjbGllbnRfYnVpbGRlciA9IGNsaWVudF9idWlsZGVyLmNoZWNrcG9pbnQoJmNoZWNrcG9pbnQpOwogICAgfQoKICAgIGlmIGxldCBTb21lKGRhdGFfZGlyKSA9ICZkYXRhX2RpciB7CiAgICAgIGNsaWVudF9idWlsZGVyID0gY2xpZW50X2J1aWxkZXIuZGF0YV9kaXIoKCZkYXRhX2RpcikuaW50bygpKTsKICAgIH0KCiAgICBtYXRjaCBjbGllbnRfYnVpbGRlci5idWlsZCgpIHsKICAgICAgRXJyKGVycm9yKSA9PiByZXR1cm4gZmZpOjpTdGFydFVwU3RhdGUgewogICAgICAgIHN0YXJ0ZWQ6IGZhbHNlLAogICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgfSwKICAgICAgT2sobXV0IGNsaWVudCkgPT4gewogICAgICAgIG1hdGNoIGNsaWVudC5zdGFydCgpLmF3YWl0IHsKICAgICAgICAgIEVycihlcnJvcikgPT4gcmV0dXJuIGZmaTo6U3RhcnRVcFN0YXRlIHsKICAgICAgICAgICAgc3RhcnRlZDogZmFsc2UsCiAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgIH0sCiAgICAgICAgICBPaygoKSkgPT4gewogICAgICAgICAgICBzZWxmLmNsaWVudCA9IFNvbWUoY2xpZW50KTsKICAgICAgICAgICAgcmV0dXJuIGZmaTo6U3RhcnRVcFN0YXRlIHsKICAgICAgICAgICAgICBzdGFydGVkOiB0cnVlLAogICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfTsKICAgICAgICAgIH0sCiAgICAgICAgfQogICAgICB9LAogICAgfQogIH0KCiAgYXN5bmMgZm4gc2h1dGRvd24oJm11dCBzZWxmKSB7CiAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgY2xpZW50LnNodXRkb3duKCkuYXdhaXQ7CiAgICAgIHNlbGYuY2xpZW50ID0gTm9uZTsKICAgIH0KICB9CgogIGFzeW5jIGZuIGNhbGwoJnNlbGYsIG9wdHM6IGZmaTo6Q2FsbE9wdHMsIGJsb2NrOiBmZmk6OkJsb2NrVGFnKSAtPiBmZmk6OlJlc3BvbnNlVmVjOCB7CiAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgbWF0Y2ggJm9wdHMudG9fYmFzZV9vcHRzKCkgewogICAgICAgIE9rKG9wdHMpID0+IHsKICAgICAgICAgIG1hdGNoIGNsaWVudC5jYWxsKG9wdHMsIGJsb2NrLnRvX2Jhc2VfYmxvY2soKSkuYXdhaXQgewogICAgICAgICAgICBPayhkYXRhKSA9PiBmZmk6OlJlc3BvbnNlVmVjOCB7CiAgICAgICAgICAgICAgdmFsdWU6IGRhdGEsCiAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgICAgICAgIHZhbHVlOiBbXS5pbnRvKCksCiAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlVmVjOCB7CiAgICAgICAgICB2YWx1ZTogW10uaW50bygpLAogICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIkludmFsaWQgY2FsbCBvcHRpb25zOiB7fSIsIGVycm9yKSwKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZmaTo6UmVzcG9uc2VWZWM4IHsKICAgICAgICB2YWx1ZTogW10uaW50bygpLAogICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgfQogICAgfQogIH0KCiAgYXN5bmMgZm4gc2VuZF9yYXdfdHJhbnNhY3Rpb24oJnNlbGYsIGJ5dGVzOiBWZWM8dTg+KSAtPiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICBtYXRjaCBjbGllbnQuc2VuZF9yYXdfdHJhbnNhY3Rpb24oJmJ5dGVzKS5hd2FpdCB7CiAgICAgICAgT2soaGFzaCkgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICB2YWx1ZTogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGhhc2gpKSwKICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgfSwKICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgIGVycm9yOiBlcnIudG9fc3RyaW5nKCksCiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICB9CiAgICB9CiAgfQoKICBhc3luYyBmbiBlc3RpbWF0ZV9nYXMoJnNlbGYsIG9wdHM6IGZmaTo6Q2FsbE9wdHMpIC0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgIG1hdGNoICZvcHRzLnRvX2Jhc2Vfb3B0cygpIHsKICAgICAgICBPayhvcHRzKSA9PiB7CiAgICAgICAgICBtYXRjaCBjbGllbnQuZXN0aW1hdGVfZ2FzKCZvcHRzKS5hd2FpdCB7CiAgICAgICAgICAgIE9rKGdhcykgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgdmFsdWU6IGdhcywKICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiSW52YWxpZCBjYWxsIG9wdGlvbnM6IHt9IiwgZXJyb3IpLAogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICB9CiAgICB9CiAgfQoKICBhc3luYyBmbiBjaGFpbl9pZCgmc2VsZikgLT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgdmFsdWU6IGNsaWVudC5jaGFpbl9pZCgpLmF3YWl0LAogICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICB2YWx1ZTogMCwKICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgIH0KICAgIH0KICB9CiAgYXN5bmMgZm4gZ2V0X2dhc19wcmljZSgmc2VsZikgLT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgbWF0Y2ggY2xpZW50LmdldF9nYXNfcHJpY2UoKS5hd2FpdCB7CiAgICAgICAgT2soZ2FzX3ByaWNlKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgIHZhbHVlOiBnYXNfcHJpY2UudG9fc3RyaW5nKCksCiAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgIH0sCiAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKQogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgfQogICAgfQogIH0KICAKICBhc3luYyBmbiBnZXRfcHJpb3JpdHlfZmVlKCZzZWxmKSAtPiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICBtYXRjaCBjbGllbnQuZ2V0X3ByaW9yaXR5X2ZlZSgpLmF3YWl0IHsKICAgICAgICBPayhwcmlvcml0eV9mZWUpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgdmFsdWU6IHByaW9yaXR5X2ZlZS50b19zdHJpbmcoKSwKICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgfSwKICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpCiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICB9CiAgICB9CiAgfQogIAogIGFzeW5jIGZuIGdldF9ibG9ja19udW1iZXIoJnNlbGYpIC0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgIG1hdGNoIGNsaWVudC5nZXRfYmxvY2tfbnVtYmVyKCkuYXdhaXQgewogICAgICAgIE9rKGJsb2NrKSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgIHZhbHVlOiBibG9jaywKICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgfSwKICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICB2YWx1ZTogMCwKICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgIH0KICAgIH0KICB9CgogIGFzeW5jIGZuIGdldF9jb2luYmFzZSgmc2VsZikgLT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgbWF0Y2ggY2xpZW50LmdldF9jb2luYmFzZSgpLmF3YWl0IHsKICAgICAgICBPayhjb2luYmFzZSkgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICB2YWx1ZTogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGNvaW5iYXNlLmFzX2J5dGVzKCkpKSwKICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgfSwKICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgfQogICAgfQogIH0KCiAgYXN5bmMgZm4gZ2V0X2JhbGFuY2UoJnNlbGYsIGFkZHJlc3M6IFN0cmluZywgYmxvY2s6IGZmaTo6QmxvY2tUYWcpIC0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgIG1hdGNoIGFkZHJlc3NfZnJvbV9zdHJpbmcoYWRkcmVzcykgewogICAgICAgIE9rKGFkZHJlc3MpID0+IHsKICAgICAgICAgIG1hdGNoIGNsaWVudC5nZXRfYmFsYW5jZSgmYWRkcmVzcywgYmxvY2sudG9fYmFzZV9ibG9jaygpKS5hd2FpdCB7CiAgICAgICAgICAgIE9rKGJhbGFuY2UpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgIHZhbHVlOiBiYWxhbmNlLnRvX3N0cmluZygpLAogICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICB9LAogICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIkludmFsaWQgYWRkcmVzczoge30iLCBlcnJvciksCiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICB9CiAgICB9CiAgfQoKICBhc3luYyBmbiBnZXRfbm9uY2UoJnNlbGYsIGFkZHJlc3M6IFN0cmluZywgYmxvY2s6IGZmaTo6QmxvY2tUYWcpIC0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgIG1hdGNoIGFkZHJlc3NfZnJvbV9zdHJpbmcoYWRkcmVzcykgewogICAgICAgIE9rKGFkZHJlc3MpID0+IHsKICAgICAgICAgIG1hdGNoIGNsaWVudC5nZXRfbm9uY2UoJmFkZHJlc3MsIGJsb2NrLnRvX2Jhc2VfYmxvY2soKSkuYXdhaXQgewogICAgICAgICAgICBPayhub25jZSkgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgdmFsdWU6IG5vbmNlLAogICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICB9LAogICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJJbnZhbGlkIGFkZHJlc3M6IHt9IiwgZXJyb3IpLAogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICB9CiAgICB9CiAgfQoKICBhc3luYyBmbiBnZXRfYmxvY2tfYnlfbnVtYmVyKCZzZWxmLCBibG9jazogZmZpOjpCbG9ja1RhZywgZnVsbF90eDogYm9vbCkgLT4gZmZpOjpSZXNwb25zZUV4ZWN1dGlvbkJsb2NrIHsKICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICBtYXRjaCBjbGllbnQuZ2V0X2Jsb2NrX2J5X251bWJlcihibG9jay50b19iYXNlX2Jsb2NrKCksIGZ1bGxfdHgpLmF3YWl0IHsKICAgICAgICBPayhibG9jaykgPT4gZmZpOjpSZXNwb25zZUV4ZWN1dGlvbkJsb2NrIHsKICAgICAgICAgIHZhbHVlOiBibG9jay5tYXAoaGVsaW9zX2V4ZWN1dGlvbl9ibG9ja190b19mZmkpLAogICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICB9LAogICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VFeGVjdXRpb25CbG9jayB7CiAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgIGVycm9yOiBlcnIudG9fc3RyaW5nKCksCiAgICAgICAgfQogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmZmk6OlJlc3BvbnNlRXhlY3V0aW9uQmxvY2sgewogICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgfQogICAgfQogIH0KICAgIAogIGFzeW5jIGZuIGdldF9ibG9ja19ieV9oYXNoKCZzZWxmLCBoYXNoOiBTdHJpbmcsIGZ1bGxfdHg6IGJvb2wpIC0+IGZmaTo6UmVzcG9uc2VFeGVjdXRpb25CbG9jayB7CiAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgbWF0Y2ggaDI1Nl9mcm9tX3N0cmluZyhoYXNoKSB7CiAgICAgICAgT2soaGFzaCkgPT4gewogICAgICAgICAgbWF0Y2ggY2xpZW50LmdldF9ibG9ja19ieV9oYXNoKCZoYXNoLmFzX2J5dGVzKCkudG9fdmVjKCksIGZ1bGxfdHgpLmF3YWl0IHsKICAgICAgICAgICAgT2soYmxvY2spID0+IGZmaTo6UmVzcG9uc2VFeGVjdXRpb25CbG9jayB7CiAgICAgICAgICAgICAgdmFsdWU6IGJsb2NrLm1hcChoZWxpb3NfZXhlY3V0aW9uX2Jsb2NrX3RvX2ZmaSksCiAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VFeGVjdXRpb25CbG9jayB7CiAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgIGVycm9yOiBlcnIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0sCiAgICAgICAgICB9CiAgICAgICAgfSwKICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlRXhlY3V0aW9uQmxvY2sgewogICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiQmxvY2sgaGFzaDoge30iLCBlcnIpLAogICAgICAgIH0sCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZmaTo6UmVzcG9uc2VFeGVjdXRpb25CbG9jayB7CiAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICB9CiAgICB9CiAgfQoKICBhc3luYyBmbiBnZXRfYmxvY2tfdHJhbnNhY3Rpb25fY291bnRfYnlfaGFzaCgmc2VsZiwgaGFzaDogU3RyaW5nKSAtPiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgIGlmIGxldCBPayhoYXNoKSA9IGhleDo6ZGVjb2RlKGhhc2guc3RyaXBfcHJlZml4KCIweCIpLnVud3JhcF9vcigiIikpIHsKICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgbWF0Y2ggY2xpZW50LmdldF9ibG9ja190cmFuc2FjdGlvbl9jb3VudF9ieV9oYXNoKCZoYXNoKS5hd2FpdCB7CiAgICAgICAgICBPayhjb3VudCkgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgIHZhbHVlOiBjb3VudCwKICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgfSwKICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgIH0sCiAgICAgICAgfQogICAgICB9IGVsc2UgewogICAgICAgIGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgIHZhbHVlOiAwLAogICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICBlcnJvcjogIkludmFsaWQgaGFzaCIudG9fc3RyaW5nKCksCiAgICAgIH0KICAgIH0KICB9CgogIGFzeW5jIGZuIGdldF9ibG9ja190cmFuc2FjdGlvbl9jb3VudF9ieV9udW1iZXIoJnNlbGYsIGJsb2NrOiBmZmk6OkJsb2NrVGFnKSAtPiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICBtYXRjaCBjbGllbnQuZ2V0X2Jsb2NrX3RyYW5zYWN0aW9uX2NvdW50X2J5X251bWJlcihibG9jay50b19iYXNlX2Jsb2NrKCkpLmF3YWl0IHsKICAgICAgICBPayhjb3VudCkgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICB2YWx1ZTogY291bnQsCiAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgIH0sCiAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgIH0sCiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgIHZhbHVlOiAwLAogICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgfQogICAgfQogIH0KCiAgYXN5bmMgZm4gZ2V0X3RyYW5zYWN0aW9uX3JlY2VpcHQoJnNlbGYsIHR4X2hhc2g6IFN0cmluZykgLT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgbWF0Y2ggaDI1Nl9mcm9tX3N0cmluZyh0eF9oYXNoKSB7CiAgICAgICAgT2sodHhfaGFzaCkgPT4gewogICAgICAgICAgbWF0Y2ggY2xpZW50LmdldF90cmFuc2FjdGlvbl9yZWNlaXB0KCZ0eF9oYXNoKS5hd2FpdCB7CiAgICAgICAgICAgIE9rKHJlY2VpcHQpID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvblJlY2VpcHQgewogICAgICAgICAgICAgIHZhbHVlOiByZWNlaXB0Lm1hcChldGhlcnNfcmVjZWlwdF90b19mZmkpLAogICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICB9LAogICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvblJlY2VpcHQgewogICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJUcmFuc2FjdGlvbiBoYXNoOiB7fSIsIGVycm9yKSwKICAgICAgICB9CiAgICAgIH0KICAgIH0gZWxzZSB7CiAgICAgIGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvblJlY2VpcHQgewogICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgfQogICAgfQogIH0KCiAgYXN5bmMgZm4gZ2V0X3RyYW5zYWN0aW9uX2J5X2hhc2goJnNlbGYsIHR4X2hhc2g6IFN0cmluZykgLT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICBtYXRjaCBoMjU2X2Zyb21fc3RyaW5nKHR4X2hhc2gpIHsKICAgICAgICBPayhoYXNoKSA9PiB7CiAgICAgICAgICBtYXRjaCBjbGllbnQuZ2V0X3RyYW5zYWN0aW9uX2J5X2hhc2goJmhhc2gpLmF3YWl0IHsKICAgICAgICAgICAgT2sodHJhbnNhY3Rpb24pID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgICAgICAgdmFsdWU6IHRyYW5zYWN0aW9uLm1hcChldGhlcnNfdHJhbnNhY3Rpb25fdG9fZmZpKSwKICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgRXJyKGVycikgPT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgZXJyb3I6IGVyci50b19zdHJpbmcoKSwKICAgICAgICAgICAgfSwKICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJUcmFuc2FjdGlvbiBoYXNoOiB7fSIsIGVyciksCiAgICAgICAgfSwKICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgIH0KICAgIH0KICB9CgogIGFzeW5jIGZuIGdldF90cmFuc2FjdGlvbl9ieV9ibG9ja19oYXNoX2FuZF9pbmRleCgmc2VsZiwgYmxvY2tfaGFzaDogU3RyaW5nLCBpbmRleDogdXNpemUpIC0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgbWF0Y2ggaDI1Nl9mcm9tX3N0cmluZyhibG9ja19oYXNoKSB7CiAgICAgICAgT2soaGFzaCkgPT4gewogICAgICAgICAgbWF0Y2ggY2xpZW50LmdldF90cmFuc2FjdGlvbl9ieV9ibG9ja19oYXNoX2FuZF9pbmRleCgmaGFzaC5hc19ieXRlcygpLnRvX3ZlYygpLCBpbmRleCkuYXdhaXQgewogICAgICAgICAgICBPayh0cmFuc2FjdGlvbikgPT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgICAgICAgICAgICB2YWx1ZTogdHJhbnNhY3Rpb24ubWFwKGV0aGVyc190cmFuc2FjdGlvbl90b19mZmkpLAogICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICB9LAogICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICBlcnJvcjogZXJyLnRvX3N0cmluZygpLAogICAgICAgICAgICB9LAogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgRXJyKGVycikgPT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIkJsb2NrIGhhc2g6IHt9IiwgZXJyKSwKICAgICAgICB9LAogICAgICB9CiAgICB9IGVsc2UgewogICAgICBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgfQogICAgfQogIH0KCiAgYXN5bmMgZm4gZ2V0X2xvZ3MoJnNlbGYsIGZpbHRlcjogZmZpOjpMb2dGaWx0ZXIpIC0+IGZmaTo6UmVzcG9uc2VWZWNMb2cgewogICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgIG1hdGNoIGZpbHRlci50b19ldGhlcnNfZmlsdGVyKCkgewogICAgICAgIE9rKGZpbHRlcikgPT4gewogICAgICAgICAgbWF0Y2ggY2xpZW50LmdldF9sb2dzKCZmaWx0ZXIpLmF3YWl0IHsKICAgICAgICAgICAgT2sobG9ncykgPT4gewogICAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VWZWNMb2cgewogICAgICAgICAgICAgICAgdmFsdWU6IGxvZ3MuaW50b19pdGVyKCkubWFwKGV0aGVyc19sb2dfdG9fZmZpX2xvZykuY29sbGVjdCgpLAogICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VWZWNMb2cgewogICAgICAgICAgICAgIHZhbHVlOiB2ZWMhW10sCiAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgIGVycm9yOiBlcnIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0sCiAgICAgICAgICB9CiAgICAgICAgfQogICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VWZWNMb2cgewogICAgICAgICAgdmFsdWU6IHZlYyFbXSwKICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJJbnZhbGlkIGZpbHRlcjoge30iLCBlcnIpLAogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZmZpOjpSZXNwb25zZVZlY0xvZyB7CiAgICAgICAgdmFsdWU6IHZlYyFbXSwKICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgIH0KICAgIH0KICB9CgogIGFzeW5jIGZuIGdldF9jb2RlKCZzZWxmLCBhZGRyZXNzOiBTdHJpbmcsIGJsb2NrOiBmZmk6OkJsb2NrVGFnKSAtPiBmZmk6OlJlc3BvbnNlVmVjOCB7CiAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgbWF0Y2ggYWRkcmVzc19mcm9tX3N0cmluZyhhZGRyZXNzKSB7CiAgICAgICAgT2soYWRkcmVzcykgPT4gewogICAgICAgICAgbWF0Y2ggY2xpZW50LmdldF9jb2RlKCZhZGRyZXNzLCBibG9jay50b19iYXNlX2Jsb2NrKCkpLmF3YWl0IHsKICAgICAgICAgICAgT2soY29kZSkgPT4gZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgICAgICAgIHZhbHVlOiBjb2RlLAogICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICB9LAogICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VWZWM4IHsKICAgICAgICAgICAgICB2YWx1ZTogW10uaW50bygpLAogICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICAgIH0KICAgICAgICB9LAogICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgICAgdmFsdWU6IFtdLmludG8oKSwKICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJJbnZhbGlkIGFkZHJlc3M6IHt9IiwgZXJyb3IpLAogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgIHZhbHVlOiBbXS5pbnRvKCksCiAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICB9CiAgICB9CiAgfQoKICBhc3luYyBmbiBnZXRfc3RvcmFnZV9hdCgKICAgICZzZWxmLAogICAgYWRkcmVzczogU3RyaW5nLAogICAgc2xvdDogU3RyaW5nLAogICAgYmxvY2s6IGZmaTo6QmxvY2tUYWcsCiAgKSAtPiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICBtYXRjaCBhZGRyZXNzX2Zyb21fc3RyaW5nKGFkZHJlc3MpIHsKICAgICAgICBPayhhZGRyZXNzKSA9PiB7CiAgICAgICAgICBtYXRjaCBoMjU2X2Zyb21fc3RyaW5nKHNsb3QpIHsKICAgICAgICAgICAgT2soc2xvdCkgPT4gewogICAgICAgICAgICAgIG1hdGNoIGNsaWVudC5nZXRfc3RvcmFnZV9hdCgmYWRkcmVzcywgc2xvdCwgYmxvY2sudG9fYmFzZV9ibG9jaygpKS5hd2FpdCB7CiAgICAgICAgICAgICAgICBPayhzdG9yYWdlKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6IHN0b3JhZ2UuZW5jb2RlX2hleCgpLAogICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiSW52YWxpZCBzbG90OiB7fSIsIGVycm9yKSwKICAgICAgICAgICAgfQogICAgICAgICAgfQogICAgICAgIH0sCiAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJJbnZhbGlkIGFkZHJlc3M6IHt9IiwgZXJyb3IpLAogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgfQogICAgfQogIH0KCiAgYXN5bmMgZm4gZ2V0X2hlYWRlcigmc2VsZikgLT4gZmZpOjpSZXNwb25zZUhlYWRlciB7CiAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgbWF0Y2ggY2xpZW50LmdldF9oZWFkZXIoKS5hd2FpdCB7CiAgICAgICAgT2soaGVhZGVyKSA9PiBmZmk6OlJlc3BvbnNlSGVhZGVyIHsKICAgICAgICAgIHZhbHVlOiBTb21lKGhlbGlvc19oZWFkZXJfdG9fZmZpKGhlYWRlcikpLAogICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICB9LAogICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VIZWFkZXIgewogICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICBlcnJvcjogZXJyLnRvX3N0cmluZygpLAogICAgICAgIH0KICAgICAgfQogICAgfSBlbHNlIHsKICAgICAgZmZpOjpSZXNwb25zZUhlYWRlciB7CiAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICB9CiAgICB9CiAgfQp9CgppbXBsIGZmaTo6SGVsaW9zTmV0d29yayB7CgogIGZuIHRvX2Jhc2VfbmV0d29yaygmc2VsZikgLT4gbmV0d29ya3M6Ok5ldHdvcmsgewogICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgIFNlbGY6Ok1BSU5ORVQgPT4gbmV0d29ya3M6Ok5ldHdvcms6Ok1BSU5ORVQsCiAgICAgICAgICBTZWxmOjpHT0VSTEkgPT4gbmV0d29ya3M6Ok5ldHdvcms6OkdPRVJMSSwKICAgICAgfQogIH0KfQoKaW1wbCBmZmk6OkJsb2NrVGFnIHsKICBmbiB0b19iYXNlX2Jsb2NrKCZzZWxmKSAtPiBjb21tb246OnR5cGVzOjpCbG9ja1RhZyB7CiAgICBtYXRjaCBzZWxmIHsKICAgICAgU2VsZjo6RmluYWxpemVkID0+IGNvbW1vbjo6dHlwZXM6OkJsb2NrVGFnOjpGaW5hbGl6ZWQsCiAgICAgIFNlbGY6OkxhdGVzdCA9PiBjb21tb246OnR5cGVzOjpCbG9ja1RhZzo6TGF0ZXN0LAogICAgICBTZWxmOjpTYWZlID0+IGNvbW1vbjo6dHlwZXM6OkJsb2NrVGFnOjpGaW5hbGl6ZWQsCiAgICAgIFNlbGY6OlBlbmRpbmcgPT4gY29tbW9uOjp0eXBlczo6QmxvY2tUYWc6OkxhdGVzdCwKICAgICAgU2VsZjo6RWFybGllc3QgPT4gY29tbW9uOjp0eXBlczo6QmxvY2tUYWc6Ok51bWJlcigxKSwKICAgICAgU2VsZjo6TnVtYmVyKGJsb2NrKSA9PiBjb21tb246OnR5cGVzOjpCbG9ja1RhZzo6TnVtYmVyKCpibG9jayksCiAgICB9CiAgfQoKICBmbiB0b19ldGhlcnNfYmxvY2soJnNlbGYpIC0+IEJsb2NrTnVtYmVyIHsKICAgIG1hdGNoIHNlbGYgewogICAgICBTZWxmOjpGaW5hbGl6ZWQgPT4gQmxvY2tOdW1iZXI6OkZpbmFsaXplZCwKICAgICAgU2VsZjo6TGF0ZXN0ID0+IEJsb2NrTnVtYmVyOjpMYXRlc3QsCiAgICAgIFNlbGY6OlNhZmUgPT4gQmxvY2tOdW1iZXI6OlNhZmUsCiAgICAgIFNlbGY6OlBlbmRpbmcgPT4gQmxvY2tOdW1iZXI6OlBlbmRpbmcsCiAgICAgIFNlbGY6OkVhcmxpZXN0ID0+IEJsb2NrTnVtYmVyOjpFYXJsaWVzdCwKICAgICAgU2VsZjo6TnVtYmVyKGJsb2NrKSA9PiBCbG9ja051bWJlcjo6TnVtYmVyKFU2NDo6ZnJvbSgqYmxvY2spKSwKICAgIH0KICB9Cn0KCmltcGwgQ2xvbmUgZm9yIGZmaTo6QmxvY2tUYWcgewogIGZuIGNsb25lKCZzZWxmKSAtPiBTZWxmIHsKICAgIG1hdGNoIHNlbGYgewogICAgICBTZWxmOjpGaW5hbGl6ZWQgPT4gZmZpOjpCbG9ja1RhZzo6RmluYWxpemVkLAogICAgICBTZWxmOjpMYXRlc3QgPT4gZmZpOjpCbG9ja1RhZzo6TGF0ZXN0LAogICAgICBTZWxmOjpTYWZlID0+IGZmaTo6QmxvY2tUYWc6OlNhZmUsCiAgICAgIFNlbGY6OlBlbmRpbmcgPT4gZmZpOjpCbG9ja1RhZzo6UGVuZGluZywKICAgICAgU2VsZjo6RWFybGllc3QgPT4gZmZpOjpCbG9ja1RhZzo6RWFybGllc3QsCiAgICAgIFNlbGY6Ok51bWJlcihibG9jaykgPT4gZmZpOjpCbG9ja1RhZzo6TnVtYmVyKCpibG9jayksCiAgICB9CiAgfQp9CgppbXBsIGZmaTo6RmlsdGVyQmxvY2tPcHRpb24gewogIGZuIHRvX2V0aGVyc19ibG9ja19vcHRpb24oJnNlbGYpIC0+IFJlc3VsdDxGaWx0ZXJCbG9ja09wdGlvbiwgU3RyaW5nPiB7CiAgICBtYXRjaCBzZWxmIHsKICAgICAgU2VsZjo6UmFuZ2UgeyBmcm9tX2Jsb2NrLCB0b19ibG9jayB9ID0+IE9rKEZpbHRlckJsb2NrT3B0aW9uOjpSYW5nZSB7IGZyb21fYmxvY2s6IGZyb21fYmxvY2suYXNfcmVmKCkubWFwKHxibG9ja3wgYmxvY2sudG9fZXRoZXJzX2Jsb2NrKCkpLCB0b19ibG9jazogdG9fYmxvY2suYXNfcmVmKCkubWFwKHxibG9ja3wgYmxvY2sudG9fZXRoZXJzX2Jsb2NrKCkpIH0pLAogICAgICBTZWxmOjpBdEJsb2NrSGFzaChoYXNoKSA9PiBPayhGaWx0ZXJCbG9ja09wdGlvbjo6QXRCbG9ja0hhc2goaDI1Nl9mcm9tX3N0cmluZyhoYXNoLnRvX3N0cmluZygpKS5tYXBfZXJyKHxlcnJvcnwgZm9ybWF0ISgiRmlsdGVyIGJsb2NrIGhhc2g6IHt9IiwgZXJyb3IpKT8pKSwKICAgIH0KICB9Cn0KCmltcGwgQ2xvbmUgZm9yIGZmaTo6RmlsdGVyQmxvY2tPcHRpb24gewogIGZuIGNsb25lKCZzZWxmKSAtPiBTZWxmIHsKICAgIG1hdGNoIHNlbGYgewogICAgICBTZWxmOjpSYW5nZSB7IGZyb21fYmxvY2ssIHRvX2Jsb2NrIH0gPT4gZmZpOjpGaWx0ZXJCbG9ja09wdGlvbjo6UmFuZ2UgeyBmcm9tX2Jsb2NrOiBmcm9tX2Jsb2NrLmNsb25lKCksIHRvX2Jsb2NrOiB0b19ibG9jay5jbG9uZSgpIH0sCiAgICAgIFNlbGY6OkF0QmxvY2tIYXNoKGhhc2gpID0+IGZmaTo6RmlsdGVyQmxvY2tPcHRpb246OkF0QmxvY2tIYXNoKGhhc2guY2xvbmUoKSksCiAgICB9CiAgfQp9CgppbXBsIGZmaTo6TG9nRmlsdGVyIHsKICBmbiB0b19ldGhlcnNfZmlsdGVyKCZzZWxmKSAtPiBSZXN1bHQ8RmlsdGVyLCBTdHJpbmc+IHsKICAgIE9rKAogICAgICBGaWx0ZXIgewogICAgICAgIGJsb2NrX29wdGlvbjogc2VsZi5ibG9ja19vcHRpb24udG9fZXRoZXJzX2Jsb2NrX29wdGlvbigpPywKICAgICAgICBhZGRyZXNzOiBpZiBzZWxmLmFkZHJlc3MuaXNfZW1wdHkoKSB7IE5vbmUgfSBlbHNlIHsgU29tZShhZGRyZXNzZXNfZnJvbV9zdHJpbmcoc2VsZi5hZGRyZXNzLmNsb25lKCkpLm1hcF9lcnIofGVycnwgZm9ybWF0ISgiRmlsdGVyIGFkZHJlc3M6IHt9IiwgZXJyKSk/KSB9LAogICAgICAgIHRvcGljczogdG9waWNzX2Zyb21fc3RyaW5ncyhzZWxmLnRvcGljcy5jbG9uZSgpKS5tYXBfZXJyKHxlcnJ8IGZvcm1hdCEoIkZpbHRlciB0b3BpY3M6IHt9IiwgZXJyKSk/CiAgICAgIH0KICAgICkKICB9Cn0KCmltcGwgZmZpOjpDYWxsT3B0cyB7CiAgZm4gdG9fYmFzZV9vcHRzKCZzZWxmKSAtPiBSZXN1bHQ8ZXhlY3V0aW9uOjp0eXBlczo6Q2FsbE9wdHMsIFN0cmluZz4gewogICAgT2soZXhlY3V0aW9uOjp0eXBlczo6Q2FsbE9wdHMgewogICAgICBmcm9tOiBpZiBzZWxmLmZyb20uaXNfZW1wdHkoKSB7IE5vbmUgfSBlbHNlIHsgU29tZShhZGRyZXNzX2Zyb21fc3RyaW5nKHNlbGYuZnJvbS5jbG9uZSgpKS5tYXBfZXJyKHxlcnJ8IGZvcm1hdCEoImZyb206IHt9IiwgZXJyKSk/KSB9LAogICAgICB0bzogYWRkcmVzc19mcm9tX3N0cmluZyhzZWxmLnRvLmNsb25lKCkpLm1hcF9lcnIofGVycnwgZm9ybWF0ISgidG86IHt9IiwgZXJyKSk/LAogICAgICBnYXM6IGlmIHNlbGYuZ2FzLmlzX2VtcHR5KCkgeyBOb25lIH0gZWxzZSB7IFNvbWUodTI1Nl9mcm9tX3N0cmluZyhzZWxmLmdhcy5jbG9uZSgpKS5tYXBfZXJyKHxlcnJ8IGZvcm1hdCEoImdhczoge30iLCBlcnIpKT8pIH0sCiAgICAgIGdhc19wcmljZTogaWYgc2VsZi5nYXNfcHJpY2UuaXNfZW1wdHkoKSB7IE5vbmUgfSBlbHNlIHsgU29tZSh1MjU2X2Zyb21fc3RyaW5nKHNlbGYuZ2FzX3ByaWNlLmNsb25lKCkpLm1hcF9lcnIofGVycnwgZm9ybWF0ISgiZ2FzX3ByaWNlOiB7fSIsIGVycikpPykgfSwKICAgICAgdmFsdWU6IGlmIHNlbGYudmFsdWUuaXNfZW1wdHkoKSB7IE5vbmUgfSBlbHNlIHsgU29tZSh1MjU2X2Zyb21fc3RyaW5nKHNlbGYudmFsdWUuY2xvbmUoKSkubWFwX2Vycih8ZXJyfCBmb3JtYXQhKCJ2YWx1ZToge30iLCBlcnIpKT8pIH0sCiAgICAgIGRhdGE6IGlmIHNlbGYuZGF0YS5pc19lbXB0eSgpIHsgTm9uZSB9IGVsc2UgeyBTb21lKHZlYzhfZnJvbV9zdHJpbmcoc2VsZi5kYXRhLmNsb25lKCkpLm1hcF9lcnIofGVycnwgZm9ybWF0ISgiZGF0YToge30iLCBlcnIpKT8pIH0sCiAgICB9KQogIH0KfQoKaW1wbCBDbG9uZSBmb3IgZmZpOjpUcmFuc2FjdGlvbnMgewogIGZuIGNsb25lKCZzZWxmKSAtPiBTZWxmIHsKICAgIG1hdGNoIHNlbGYgewogICAgICBTZWxmOjpIYXNoZXMoaGFzaGVzKSA9PiBmZmk6OlRyYW5zYWN0aW9uczo6SGFzaGVzKGhhc2hlcy5jbG9uZSgpKSwKICAgICAgU2VsZjo6RnVsbCh0cmFuc2FjdGlvbnMpID0+IGZmaTo6VHJhbnNhY3Rpb25zOjpGdWxsKHRyYW5zYWN0aW9ucy50b192ZWMoKSksCiAgICB9CiAgfQp9CgpmbiB0b3BpY3NfZnJvbV9zdHJpbmdzKHZhbHVlOiBWZWM8U3RyaW5nPikgLT4gUmVzdWx0PFtPcHRpb248VmFsdWVPckFycmF5PE9wdGlvbjxIMjU2Pj4+OyA0XSwgU3RyaW5nPiB7CiAgaWYgdmFsdWUubGVuKCkgPiA0IHsKICAgIEVycigiVG9vIG1hbnkgdG9waWNzIi50b19zdHJpbmcoKSkKICB9IGVsc2UgewogICAgbGV0IG1hcF9zdHJpbmdfdG9fdG9waWNzID0gfHZhbHVlOiBTdHJpbmd8IC0+IFJlc3VsdDxPcHRpb248VmFsdWVPckFycmF5PE9wdGlvbjxIMjU2Pj4+LCBTdHJpbmc+IHsKICAgICAgaWYgdmFsdWUuaXNfZW1wdHkoKSB7CiAgICAgICAgT2soTm9uZSkKICAgICAgfSBlbHNlIHsKICAgICAgICBsZXQgdG9waWNzOiBWZWM8JnN0cj4gPSB2YWx1ZS5zcGxpdCgnLCcpLmNvbGxlY3QoKTsKICAgICAgICBpZiB0b3BpY3MubGVuKCkgPT0gMSB7CiAgICAgICAgICBPayhTb21lKFZhbHVlT3JBcnJheTo6VmFsdWUoU29tZShoMjU2X2Zyb21fc3RyaW5nKHRvcGljc1swXS50b19zdHJpbmcoKSk/KSkpKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICBsZXQgbWFwcGVkOiBSZXN1bHQ8VmVjPEgyNTY+LCBTdHJpbmc+ID0gdG9waWNzLmludG9faXRlcigpLm1hcCh8dG9waWN8IGgyNTZfZnJvbV9zdHJpbmcodG9waWMudG9fc3RyaW5nKCkpKS5jb2xsZWN0KCk7CiAgICAgICAgICBsZXQgb3B0aW9uX21hcHBlZDogVmVjPE9wdGlvbjxIMjU2Pj4gPSBtYXBwZWQ/LmludG9faXRlcigpLm1hcCh8aGFzaHwgT3B0aW9uOjpTb21lKGhhc2gpKS5jb2xsZWN0KCk7CiAgICAgICAgICBPayhTb21lKFZhbHVlT3JBcnJheTo6QXJyYXkob3B0aW9uX21hcHBlZCkpKQogICAgICAgIH0KICAgICAgfQogICAgfTsKICAgIGxldCBtdXQgdG9waWNzID0gdmFsdWUuY2xvbmUoKTsKICAgIGZvciBfaSBpbiB0b3BpY3MubGVuKCkuLjQgewogICAgICB0b3BpY3MucHVzaCgiIi50b19zdHJpbmcoKSk7CiAgICB9CiAgICBsZXQgbWFwcGVkOiBSZXN1bHQ8VmVjPE9wdGlvbjxWYWx1ZU9yQXJyYXk8T3B0aW9uPEgyNTY+Pj4+LCBTdHJpbmc+ID0gdG9waWNzLmludG9faXRlcigpLm1hcChtYXBfc3RyaW5nX3RvX3RvcGljcykuY29sbGVjdCgpOwogICAgT2sobWFwcGVkPy50cnlfaW50bygpLm1hcF9lcnIofF9lcnJ8ICJGYWlsZWQgdG8gbWFwIHZlY3RvciIpPykKICB9Cn0KCmZuIGFkZHJlc3NfZnJvbV9zdHJpbmcodmFsdWU6IFN0cmluZykgLT4gUmVzdWx0PEFkZHJlc3MsIFN0cmluZz4gewogIGxldCByYXdfaGV4ID0gdmVjOF9mcm9tX3N0cmluZyh2YWx1ZSk/OwogIGlmIHJhd19oZXgubGVuKCkgPT0gQWRkcmVzczo6bGVuX2J5dGVzKCkgewogICAgT2soQWRkcmVzczo6ZnJvbV9zbGljZSgmcmF3X2hleCkpCiAgfSBlbHNlIHsKICAgIEVycihmb3JtYXQhKCJTaG91bGQgYmUge30gYnl0ZXMgbG9uZyIsIEFkZHJlc3M6Omxlbl9ieXRlcygpKSkKICB9Cn0KCmZuIGFkZHJlc3Nlc19mcm9tX3N0cmluZyh2YWx1ZTogU3RyaW5nKSAtPiBSZXN1bHQ8VmFsdWVPckFycmF5PEFkZHJlc3M+LCBTdHJpbmc+IHsKICBsZXQgYWRkcmVzc2VzOiBWZWM8JnN0cj4gPSB2YWx1ZS5zcGxpdCgnLCcpLmNvbGxlY3QoKTsKICBpZiBhZGRyZXNzZXMubGVuKCkgPT0gMSB7CiAgICBPayhWYWx1ZU9yQXJyYXk6OlZhbHVlKGFkZHJlc3NfZnJvbV9zdHJpbmcoYWRkcmVzc2VzWzBdLnRvX3N0cmluZygpKT8pKQogIH0gZWxzZSB7CiAgICBsZXQgbWFwcGVkOiBSZXN1bHQ8VmVjPEFkZHJlc3M+LCBTdHJpbmc+ID0gYWRkcmVzc2VzLmludG9faXRlcigpLm1hcCh8YWRkcmVzc3wgYWRkcmVzc19mcm9tX3N0cmluZyhhZGRyZXNzLnRvX3N0cmluZygpKSkuY29sbGVjdCgpOwogICAgT2soVmFsdWVPckFycmF5OjpBcnJheShtYXBwZWQ/KSkKICB9Cn0KCmZuIGgyNTZfZnJvbV9zdHJpbmcodmFsdWU6IFN0cmluZykgLT4gUmVzdWx0PEgyNTYsIFN0cmluZz4gewogIGxldCByYXdfaGV4ID0gdmVjOF9mcm9tX3N0cmluZyh2YWx1ZSk/OwogIGlmIHJhd19oZXgubGVuKCkgPT0gSDI1Njo6bGVuX2J5dGVzKCkgewogICAgT2soSDI1Njo6ZnJvbV9zbGljZSgmcmF3X2hleCkpCiAgfSBlbHNlIHsKICAgIEVycihmb3JtYXQhKCJTaG91bGQgYmUge30gYnl0ZXMgbG9uZyIsIEgyNTY6Omxlbl9ieXRlcygpKSkKICB9Cn0KCmZuIHUyNTZfZnJvbV9zdHJpbmcodmFsdWU6IFN0cmluZykgLT4gUmVzdWx0PFUyNTYsIFN0cmluZz4gewogIGlmIGxldCBTb21lKHJhd19oZXhfc3RyaW5nKSA9IHZhbHVlLnN0cmlwX3ByZWZpeCgiMHgiKSB7CiAgICBPayhVMjU2Ojpmcm9tX3N0cl9yYWRpeChyYXdfaGV4X3N0cmluZywgMTYpLm1hcF9lcnIofGVycnwgZXJyLnRvX3N0cmluZygpKT8pCiAgfSBlbHNlIHsKICAgIE9rKFUyNTY6OmZyb21fc3RyX3JhZGl4KCZ2YWx1ZSwgMTApLm1hcF9lcnIofGVycnwgZXJyLnRvX3N0cmluZygpKT8pCiAgfQp9CgpmbiB2ZWM4X2Zyb21fc3RyaW5nKHZhbHVlOiBTdHJpbmcpIC0+IFJlc3VsdDxWZWM8dTg+LCBTdHJpbmc+IHsKICBpZiBsZXQgU29tZShyYXdfaGV4X3N0cmluZykgPSB2YWx1ZS5zdHJpcF9wcmVmaXgoIjB4IikgewogICAgT2soaGV4OjpkZWNvZGUocmF3X2hleF9zdHJpbmcpLm1hcF9lcnIofGVycnwgZXJyLnRvX3N0cmluZygpKT8pCiAgfSBlbHNlIHsKICAgIEVycigiU2hvdWxkIGJlIGEgaGV4IHZhbHVlIHByZWZpeGVkIHdpdGggMHgiLnRvX3N0cmluZygpKQogIH0KfQoKZm4gZXRoZXJzX2xvZ190b19mZmlfbG9nKHZhbHVlOiBMb2cpIC0+IGZmaTo6TG9nIHsKICBmZmk6OkxvZyB7CiAgICBhZGRyZXNzOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUuYWRkcmVzcy5hc19ieXRlcygpKSksCiAgICB0b3BpY3M6IHZhbHVlLnRvcGljcy5pbnRvX2l0ZXIoKS5tYXAofHRvcGljfCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodG9waWMuYXNfYnl0ZXMoKSkpKS5jb2xsZWN0KCksCiAgICBkYXRhOiB2YWx1ZS5kYXRhLmVuY29kZSgpLAogICAgYmxvY2tfaGFzaDogdmFsdWUuYmxvY2tfaGFzaC5tYXAofGhhc2h8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShoYXNoLmFzX2J5dGVzKCkpKSkudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgIGJsb2NrX251bWJlcjogdmFsdWUuYmxvY2tfbnVtYmVyLm1hcCh8YmxvY2t8IGJsb2NrLmFzX3U2NCgpKSwKICAgIHRyYW5zYWN0aW9uX2hhc2g6IHZhbHVlLnRyYW5zYWN0aW9uX2hhc2gubWFwKHxoYXNofCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoaGFzaC5hc19ieXRlcygpKSkpLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICB0cmFuc2FjdGlvbl9pbmRleDogdmFsdWUudHJhbnNhY3Rpb25faW5kZXgubWFwKHxpbmRleHwgaW5kZXguYXNfdTY0KCkpLAogICAgbG9nX2luZGV4OiB2YWx1ZS5sb2dfaW5kZXgubWFwKHxpbmRleHwgaW5kZXgudG9fc3RyaW5nKCkpLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICB0cmFuc2FjdGlvbl9sb2dfaW5kZXg6IHZhbHVlLnRyYW5zYWN0aW9uX2xvZ19pbmRleC5tYXAofGluZGV4fCBpbmRleC50b19zdHJpbmcoKSkudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgIGxvZ190eXBlOiB2YWx1ZS5sb2dfdHlwZS51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgcmVtb3ZlZDogdmFsdWUucmVtb3ZlZCwKICB9Cn0KCmZuIGV0aGVyc19yZWNlaXB0X3RvX2ZmaSh2YWx1ZTogVHJhbnNhY3Rpb25SZWNlaXB0KSAtPiBmZmk6OlRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgZmZpOjpUcmFuc2FjdGlvblJlY2VpcHQgewogICAgdHJhbnNhY3Rpb25faGFzaDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLnRyYW5zYWN0aW9uX2hhc2guYXNfYnl0ZXMoKSkpLAogICAgdHJhbnNhY3Rpb25faW5kZXg6IHZhbHVlLnRyYW5zYWN0aW9uX2luZGV4LmFzX3U2NCgpLAogICAgYmxvY2tfaGFzaDogdmFsdWUuYmxvY2tfaGFzaC5tYXAofGhhc2h8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShoYXNoLmFzX2J5dGVzKCkpKSkudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgIGJsb2NrX251bWJlcjogdmFsdWUuYmxvY2tfbnVtYmVyLm1hcCh8bnVtYmVyfCBudW1iZXIuYXNfdTY0KCkpLAogICAgZnJvbTogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLmZyb20uYXNfYnl0ZXMoKSkpLAogICAgdG86IHZhbHVlLnRvLm1hcCh8YWRkcmVzc3wgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGFkZHJlc3MuYXNfYnl0ZXMoKSkpKS51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgY3VtdWxhdGl2ZV9nYXNfdXNlZDogdmFsdWUuY3VtdWxhdGl2ZV9nYXNfdXNlZC50b19zdHJpbmcoKSwKICAgIGdhc191c2VkOiB2YWx1ZS5nYXNfdXNlZC5tYXAofGdhc3wgZ2FzLnRvX3N0cmluZygpKS51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgY29udHJhY3RfYWRkcmVzczogdmFsdWUuY29udHJhY3RfYWRkcmVzcy5tYXAofGFkZHJlc3N8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShhZGRyZXNzLmFzX2J5dGVzKCkpKSkudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgIGxvZ3M6IHZhbHVlLmxvZ3MuaW50b19pdGVyKCkubWFwKGV0aGVyc19sb2dfdG9fZmZpX2xvZykuY29sbGVjdCgpLAogICAgc3RhdHVzOiB2YWx1ZS5zdGF0dXMubWFwKHxzdGF0dXN8IHN0YXR1cy5hc191NjQoKSksCiAgICByb290OiB2YWx1ZS5yb290Lm1hcCh8aGFzaHwgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGhhc2guYXNfYnl0ZXMoKSkpKS51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgbG9nc19ibG9vbTogdmFsdWUubG9nc19ibG9vbS5hc19ieXRlcygpLnRvX3ZlYygpLAogICAgdHJhbnNhY3Rpb25fdHlwZTogdmFsdWUudHJhbnNhY3Rpb25fdHlwZS5tYXAofHZhbHwgdmFsLmFzX3U2NCgpKSwKICAgIGVmZmVjdGl2ZV9nYXNfcHJpY2U6IHZhbHVlLmVmZmVjdGl2ZV9nYXNfcHJpY2UubWFwKHxnYXN8IGdhcy50b19zdHJpbmcoKSkudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICB9Cn0KCmZuIGV0aGVyc190cmFuc2FjdGlvbl90b19mZmkodmFsdWU6IFRyYW5zYWN0aW9uKSAtPiBmZmk6OlRyYW5zYWN0aW9uIHsKICBmZmk6OlRyYW5zYWN0aW9uIHsKICAgIGhhc2g6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5oYXNoLmFzX2J5dGVzKCkpKSwKICAgIG5vbmNlOiB2YWx1ZS5ub25jZS50b19zdHJpbmcoKSwKICAgIGJsb2NrX2hhc2g6IHZhbHVlLmJsb2NrX2hhc2gubWFwKHxoYXNofCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoaGFzaC5hc19ieXRlcygpKSkpLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICBibG9ja19udW1iZXI6IHZhbHVlLmJsb2NrX251bWJlci5tYXAofGJsb2NrfCBibG9jay5hc191NjQoKSksCiAgICB0cmFuc2FjdGlvbl9pbmRleDogdmFsdWUudHJhbnNhY3Rpb25faW5kZXgubWFwKHxpbmRleHwgaW5kZXguYXNfdTY0KCkpLAogICAgZnJvbTogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLmZyb20uYXNfYnl0ZXMoKSkpLAogICAgdG86IHZhbHVlLnRvLm1hcCh8YWRkcmVzc3wgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGFkZHJlc3MuYXNfYnl0ZXMoKSkpKS51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgdmFsdWU6IHZhbHVlLnZhbHVlLnRvX3N0cmluZygpLAogICAgZ2FzX3ByaWNlOiB2YWx1ZS5nYXNfcHJpY2UubWFwKHxnYXN8IGdhcy50b19zdHJpbmcoKSkudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgIGdhczogdmFsdWUuZ2FzLnRvX3N0cmluZygpLAogICAgaW5wdXQ6IHZhbHVlLmlucHV0LnRvX3ZlYygpLAogICAgdjogdmFsdWUudi50b19zdHJpbmcoKSwKICAgIHI6IHZhbHVlLnIuZW5jb2RlX2hleCgpLAogICAgczogdmFsdWUucy5lbmNvZGVfaGV4KCksCiAgfQp9CgpmbiBoZWxpb3NfdHJhbnNhY3Rpb25zX3RvX2ZmaSh2YWx1ZTogVHJhbnNhY3Rpb25zKSAtPiBmZmk6OlRyYW5zYWN0aW9ucyB7CiAgbWF0Y2ggdmFsdWUgewogICAgVHJhbnNhY3Rpb25zOjpIYXNoZXMoaGFzaGVzKSA9PiBmZmk6OlRyYW5zYWN0aW9uczo6SGFzaGVzKGhhc2hlcy5pbnRvX2l0ZXIoKS5tYXAofGhhc2h8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShoYXNoLmFzX2J5dGVzKCkpKSkuY29sbGVjdCgpKSwKICAgIFRyYW5zYWN0aW9uczo6RnVsbCh0cmFuc2FjdGlvbnMpID0+IGZmaTo6VHJhbnNhY3Rpb25zOjpGdWxsKHRyYW5zYWN0aW9ucy5pbnRvX2l0ZXIoKS5tYXAoZXRoZXJzX3RyYW5zYWN0aW9uX3RvX2ZmaSkuY29sbGVjdCgpKSwKICB9Cn0KCmZuIGhlbGlvc19leGVjdXRpb25fYmxvY2tfdG9fZmZpKHZhbHVlOiBFeGVjdXRpb25CbG9jaykgLT4gZmZpOjpFeGVjdXRpb25CbG9jayB7CiAgZmZpOjpFeGVjdXRpb25CbG9jayB7CiAgICBudW1iZXI6IHZhbHVlLm51bWJlciwKICAgIGJhc2VfZmVlX3Blcl9nYXM6IHZhbHVlLmJhc2VfZmVlX3Blcl9nYXMudG9fc3RyaW5nKCksCiAgICBkaWZmaWN1bHR5OiB2YWx1ZS5kaWZmaWN1bHR5LnRvX3N0cmluZygpLAogICAgZXh0cmFfZGF0YTogdmFsdWUuZXh0cmFfZGF0YS50b192ZWMoKSwKICAgIGdhc19saW1pdDogdmFsdWUuZ2FzX2xpbWl0LAogICAgZ2FzX3VzZWQ6IHZhbHVlLmdhc191c2VkLAogICAgaGFzaDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLmhhc2guYXNfYnl0ZXMoKSkpLAogICAgbG9nc19ibG9vbTogdmFsdWUubG9nc19ibG9vbS50b192ZWMoKSwKICAgIG1pbmVyOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUubWluZXIuYXNfYnl0ZXMoKSkpLAogICAgbWl4X2hhc2g6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5taXhfaGFzaC5hc19ieXRlcygpKSksCiAgICBub25jZTogdmFsdWUubm9uY2UudG9fc3RyaW5nKCksCiAgICBwYXJlbnRfaGFzaDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLnBhcmVudF9oYXNoLmFzX2J5dGVzKCkpKSwKICAgIHJlY2VpcHRzX3Jvb3Q6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5yZWNlaXB0c19yb290LmFzX2J5dGVzKCkpKSwKICAgIHNoYTNfdW5jbGVzOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUuc2hhM191bmNsZXMuYXNfYnl0ZXMoKSkpLAogICAgc2l6ZTogdmFsdWUuc2l6ZSwKICAgIHN0YXRlX3Jvb3Q6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5zdGF0ZV9yb290LmFzX2J5dGVzKCkpKSwKICAgIHRpbWVzdGFtcDogdmFsdWUudGltZXN0YW1wLAogICAgdG90YWxfZGlmZmljdWx0eTogdmFsdWUudG90YWxfZGlmZmljdWx0eSwKICAgIHRyYW5zYWN0aW9uczogaGVsaW9zX3RyYW5zYWN0aW9uc190b19mZmkodmFsdWUudHJhbnNhY3Rpb25zKSwKICAgIHRyYW5zYWN0aW9uc19yb290OiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUudHJhbnNhY3Rpb25zX3Jvb3QuYXNfYnl0ZXMoKSkpLAogICAgdW5jbGVzOiB2YWx1ZS51bmNsZXMuaW50b19pdGVyKCkubWFwKHxoYXNofCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoaGFzaC5hc19ieXRlcygpKSkpLmNvbGxlY3QoKSwKICB9Cn0KCmZuIGhlbGlvc19oZWFkZXJfdG9fZmZpKHZhbHVlOiBIZWFkZXIpIC0+IGZmaTo6SGVhZGVyIHsKICBmZmk6OkhlYWRlciB7CiAgICBzbG90OiB2YWx1ZS5zbG90LAogICAgcHJvcG9zZXJfaW5kZXg6IHZhbHVlLnByb3Bvc2VyX2luZGV4LAogICAgcGFyZW50X3Jvb3Q6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5wYXJlbnRfcm9vdCkpLAogICAgc3RhdGVfcm9vdDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLnN0YXRlX3Jvb3QpKSwKICAgIGJvZHlfcm9vdDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLmJvZHlfcm9vdCkpLAogIH0KfQoKcHViIHN0cnVjdCBIZWxpb3NDbGllbnQgewogIGNsaWVudDogT3B0aW9uPENsaWVudDxGaWxlREI+PiwKICBpc19sb2dnaW5nOiBib29sLAp9Cg=="

rust::build
build::lipo
build::generate_c_headers
build::xcframework

post_build::compress
post_build::copy_bridge_files
post_build::success
