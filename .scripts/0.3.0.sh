#! /bin/zsh -e

source ".scripts/functions.sh"

set -e

PACKAGE_VERSION=0.3.0
SWIFT_BRIDGE_PACKAGE='git = "https:\/\/github.com\/rkreutz\/swift-bridge.git", branch = "feature\/struct-vec-support"'
SWIFT_BRIDGE_FEATURES='["async", "compatibility"]'
ETHERS_VERSION=1.0.2

env::setup
env::build_configuration $1

rust::setup

pre_build::create_build_directory
pre_build::setup_openssl dc976d756f9d3273c3c6f960fadb88e44b468050
pre_build::setup_helios
pre_build::modify_helios "dXNlIDo6Y2xpZW50Ojp7CiAgICBkYXRhYmFzZTo6e0RhdGFiYXNlLCBGaWxlREJ9LAogICAgQ2xpZW50LCBDbGllbnRCdWlsZGVyLAp9Owp1c2UgOjpjb25maWc6OntuZXR3b3JrcywgQ29uZmlnfTsKdXNlIDo6Y29uc2Vuc3VzOjp0eXBlczo6SGVhZGVyOwp1c2UgOjpleGVjdXRpb246OnR5cGVzOjp7RXhlY3V0aW9uQmxvY2ssIFRyYW5zYWN0aW9uc307CnVzZSBldGhlcnM6OnsKICAgIGFiaTo6QWJpRW5jb2RlLAogICAgcHJlbHVkZTo6e0FkZHJlc3MsIEgyNTYsIFUyNTYsIFU2NH0sCiAgICB0eXBlczo6ewogICAgICAgIEJsb2NrTnVtYmVyLCBGZWVIaXN0b3J5LCBGaWx0ZXIsIEZpbHRlckJsb2NrT3B0aW9uLCBMb2csIFN5bmNpbmdTdGF0dXMsIFRyYW5zYWN0aW9uLAogICAgICAgIFRyYW5zYWN0aW9uUmVjZWlwdCwgVmFsdWVPckFycmF5LAogICAgfSwKfTsKdXNlIGV5cmU6OlJlcG9ydDsKCiNbc3dpZnRfYnJpZGdlOjpicmlkZ2VdCm1vZCBmZmkgewoKICAgIGVudW0gQmxvY2tUYWcgewogICAgICAgIExhdGVzdCwKICAgICAgICBGaW5hbGl6ZWQsCiAgICAgICAgU2FmZSwKICAgICAgICBFYXJsaWVzdCwKICAgICAgICBQZW5kaW5nLAogICAgICAgIE51bWJlcih1NjQpLAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgQ2FsbE9wdHMgewogICAgICAgIHB1YiBmcm9tOiBTdHJpbmcsCiAgICAgICAgcHViIHRvOiBTdHJpbmcsCiAgICAgICAgcHViIGdhczogU3RyaW5nLAogICAgICAgIHB1YiBnYXNfcHJpY2U6IFN0cmluZywKICAgICAgICBwdWIgdmFsdWU6IFN0cmluZywKICAgICAgICBwdWIgZGF0YTogU3RyaW5nLAogICAgfQoKICAgIGVudW0gSGVsaW9zTmV0d29yayB7CiAgICAgICAgTUFJTk5FVCwKICAgICAgICBHT0VSTEksCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBTdGFydFVwU3RhdGUgewogICAgICAgIHN0YXJ0ZWQ6IGJvb2wsCiAgICAgICAgZXJyb3I6IFN0cmluZywKICAgIH0KCiAgICBlbnVtIEZpbHRlckJsb2NrT3B0aW9uIHsKICAgICAgICBSYW5nZSB7CiAgICAgICAgICAgIGZyb21fYmxvY2s6IE9wdGlvbjxCbG9ja1RhZz4sCiAgICAgICAgICAgIHRvX2Jsb2NrOiBPcHRpb248QmxvY2tUYWc+LAogICAgICAgIH0sCiAgICAgICAgQXRCbG9ja0hhc2goU3RyaW5nKSwKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IExvZ0ZpbHRlciB7CiAgICAgICAgcHViIGJsb2NrX29wdGlvbjogRmlsdGVyQmxvY2tPcHRpb24sCiAgICAgICAgcHViIGFkZHJlc3M6IFN0cmluZywKICAgICAgICBwdWIgdG9waWNzOiBWZWM8U3RyaW5nPiwKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgI1tkZXJpdmUoQ2xvbmUpXQogICAgc3RydWN0IExvZyB7CiAgICAgICAgYWRkcmVzczogU3RyaW5nLAogICAgICAgIHRvcGljczogVmVjPFN0cmluZz4sCiAgICAgICAgZGF0YTogVmVjPHU4PiwKICAgICAgICBibG9ja19oYXNoOiBTdHJpbmcsCiAgICAgICAgYmxvY2tfbnVtYmVyOiBPcHRpb248dTY0PiwKICAgICAgICB0cmFuc2FjdGlvbl9oYXNoOiBTdHJpbmcsCiAgICAgICAgdHJhbnNhY3Rpb25faW5kZXg6IE9wdGlvbjx1NjQ+LAogICAgICAgIGxvZ19pbmRleDogU3RyaW5nLAogICAgICAgIHRyYW5zYWN0aW9uX2xvZ19pbmRleDogU3RyaW5nLAogICAgICAgIGxvZ190eXBlOiBTdHJpbmcsCiAgICAgICAgcmVtb3ZlZDogT3B0aW9uPGJvb2w+LAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgVHJhbnNhY3Rpb25SZWNlaXB0IHsKICAgICAgICB0cmFuc2FjdGlvbl9oYXNoOiBTdHJpbmcsCiAgICAgICAgdHJhbnNhY3Rpb25faW5kZXg6IHU2NCwKICAgICAgICBibG9ja19oYXNoOiBTdHJpbmcsIC8vIG9wdGlvbmFsCiAgICAgICAgYmxvY2tfbnVtYmVyOiBPcHRpb248dTY0PiwKICAgICAgICBmcm9tOiBTdHJpbmcsCiAgICAgICAgdG86IFN0cmluZywgLy8gb3B0aW9uYWwKICAgICAgICBjdW11bGF0aXZlX2dhc191c2VkOiBTdHJpbmcsCiAgICAgICAgZ2FzX3VzZWQ6IFN0cmluZywgICAgICAgICAvLyBvcHRpb25hbAogICAgICAgIGNvbnRyYWN0X2FkZHJlc3M6IFN0cmluZywgLy8gb3B0aW9uYWwKICAgICAgICBsb2dzOiBWZWM8TG9nPiwKICAgICAgICBzdGF0dXM6IE9wdGlvbjx1NjQ+LAogICAgICAgIHJvb3Q6IFN0cmluZywgLy8gb3B0aW9ubmFsCiAgICAgICAgbG9nc19ibG9vbTogVmVjPHU4PiwKICAgICAgICB0cmFuc2FjdGlvbl90eXBlOiBPcHRpb248dTY0PiwKICAgICAgICBlZmZlY3RpdmVfZ2FzX3ByaWNlOiBTdHJpbmcsIC8vb3B0aW9uYWwKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgI1tkZXJpdmUoQ2xvbmUpXQogICAgc3RydWN0IFRyYW5zYWN0aW9uIHsKICAgICAgICBoYXNoOiBTdHJpbmcsCiAgICAgICAgbm9uY2U6IFN0cmluZywKICAgICAgICBibG9ja19oYXNoOiBTdHJpbmcsIC8vb3B0aW9uYWwKICAgICAgICBibG9ja19udW1iZXI6IE9wdGlvbjx1NjQ+LAogICAgICAgIHRyYW5zYWN0aW9uX2luZGV4OiBPcHRpb248dTY0PiwKICAgICAgICBmcm9tOiBTdHJpbmcsCiAgICAgICAgdG86IFN0cmluZywgLy8gb3B0aW9uYWwKICAgICAgICB2YWx1ZTogU3RyaW5nLAogICAgICAgIGdhc19wcmljZTogU3RyaW5nLCAvLyBvcHRpb25hbAogICAgICAgIGdhczogU3RyaW5nLAogICAgICAgIGlucHV0OiBWZWM8dTg+LAogICAgICAgIHY6IFN0cmluZywKICAgICAgICByOiBTdHJpbmcsCiAgICAgICAgczogU3RyaW5nLAogICAgfQoKICAgIGVudW0gVHJhbnNhY3Rpb25zIHsKICAgICAgICBIYXNoZXMoVmVjPFN0cmluZz4pLAogICAgICAgIEZ1bGwoVmVjPFRyYW5zYWN0aW9uPiksCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBFeGVjdXRpb25CbG9jayB7CiAgICAgICAgbnVtYmVyOiB1NjQsCiAgICAgICAgYmFzZV9mZWVfcGVyX2dhczogU3RyaW5nLAogICAgICAgIGRpZmZpY3VsdHk6IFN0cmluZywKICAgICAgICBleHRyYV9kYXRhOiBWZWM8dTg+LAogICAgICAgIGdhc19saW1pdDogdTY0LAogICAgICAgIGdhc191c2VkOiB1NjQsCiAgICAgICAgaGFzaDogU3RyaW5nLAogICAgICAgIGxvZ3NfYmxvb206IFZlYzx1OD4sCiAgICAgICAgbWluZXI6IFN0cmluZywKICAgICAgICBtaXhfaGFzaDogU3RyaW5nLAogICAgICAgIG5vbmNlOiBTdHJpbmcsCiAgICAgICAgcGFyZW50X2hhc2g6IFN0cmluZywKICAgICAgICByZWNlaXB0c19yb290OiBTdHJpbmcsCiAgICAgICAgc2hhM191bmNsZXM6IFN0cmluZywKICAgICAgICBzaXplOiB1NjQsCiAgICAgICAgc3RhdGVfcm9vdDogU3RyaW5nLAogICAgICAgIHRpbWVzdGFtcDogdTY0LAogICAgICAgIHRvdGFsX2RpZmZpY3VsdHk6IHU2NCwKICAgICAgICB0cmFuc2FjdGlvbnM6IFRyYW5zYWN0aW9ucywKICAgICAgICB0cmFuc2FjdGlvbnNfcm9vdDogU3RyaW5nLAogICAgICAgIHVuY2xlczogVmVjPFN0cmluZz4sCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBIZWFkZXIgewogICAgICAgIHNsb3Q6IHU2NCwKICAgICAgICBwcm9wb3Nlcl9pbmRleDogdTY0LAogICAgICAgIHBhcmVudF9yb290OiBTdHJpbmcsCiAgICAgICAgc3RhdGVfcm9vdDogU3RyaW5nLAogICAgICAgIGJvZHlfcm9vdDogU3RyaW5nLAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgU3luY2luZ1N0YXR1cyB7CiAgICAgICAgcHViIGN1cnJlbnRfYmxvY2s6IHU2NCwKICAgICAgICBwdWIgaGlnaGVzdF9ibG9jazogdTY0LAogICAgICAgIHB1YiBzdGFydGluZ19ibG9jazogdTY0LAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgRmVlSGlzdG9yeSB7CiAgICAgICAgcHViIGJhc2VfZmVlX3Blcl9nYXM6IFZlYzxTdHJpbmc+LAogICAgICAgIHB1YiBnYXNfdXNlZF9yYXRpbzogVmVjPGY2ND4sCiAgICAgICAgcHViIG9sZGVzdF9ibG9jazogdTY0LAogICAgICAgIHB1YiByZXdhcmQ6IFZlYzxTdHJpbmc+LCAvLyBBbiBhcnJheSBvZiBzdHJpbmdzIHdpdGggY29tbWEgc2VwYXJhdGVkIHZhbHVlcwogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgUmVzcG9uc2VVNjQgewogICAgICAgIHZhbHVlOiB1NjQsCiAgICAgICAgZmFpbGVkOiBib29sLAogICAgICAgIGVycm9yOiBTdHJpbmcsCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBSZXNwb25zZVN0cmluZyB7CiAgICAgICAgdmFsdWU6IFN0cmluZywKICAgICAgICBmYWlsZWQ6IGJvb2wsCiAgICAgICAgZXJyb3I6IFN0cmluZywKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IFJlc3BvbnNlVmVjOCB7CiAgICAgICAgdmFsdWU6IFZlYzx1OD4sCiAgICAgICAgZmFpbGVkOiBib29sLAogICAgICAgIGVycm9yOiBTdHJpbmcsCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBSZXNwb25zZVZlY0xvZyB7CiAgICAgICAgdmFsdWU6IFZlYzxMb2c+LAogICAgICAgIGZhaWxlZDogYm9vbCwKICAgICAgICBlcnJvcjogU3RyaW5nLAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgUmVzcG9uc2VUcmFuc2FjdGlvblJlY2VpcHQgewogICAgICAgIHZhbHVlOiBPcHRpb248VHJhbnNhY3Rpb25SZWNlaXB0PiwKICAgICAgICBmYWlsZWQ6IGJvb2wsCiAgICAgICAgZXJyb3I6IFN0cmluZywKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IFJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgIHZhbHVlOiBPcHRpb248VHJhbnNhY3Rpb24+LAogICAgICAgIGZhaWxlZDogYm9vbCwKICAgICAgICBlcnJvcjogU3RyaW5nLAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgUmVzcG9uc2VFeGVjdXRpb25CbG9jayB7CiAgICAgICAgdmFsdWU6IE9wdGlvbjxFeGVjdXRpb25CbG9jaz4sCiAgICAgICAgZmFpbGVkOiBib29sLAogICAgICAgIGVycm9yOiBTdHJpbmcsCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBSZXNwb25zZUhlYWRlciB7CiAgICAgICAgdmFsdWU6IE9wdGlvbjxIZWFkZXI+LAogICAgICAgIGZhaWxlZDogYm9vbCwKICAgICAgICBlcnJvcjogU3RyaW5nLAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgUmVzcG9uc2VTeW5jaW5nIHsKICAgICAgICB2YWx1ZTogT3B0aW9uPFN5bmNpbmdTdGF0dXM+LAogICAgICAgIGZhaWxlZDogYm9vbCwKICAgICAgICBlcnJvcjogU3RyaW5nLAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgUmVzcG9uc2VGZWVIaXN0b3J5IHsKICAgICAgICB2YWx1ZTogT3B0aW9uPEZlZUhpc3Rvcnk+LAogICAgICAgIGZhaWxlZDogYm9vbCwKICAgICAgICBlcnJvcjogU3RyaW5nLAogICAgfQoKICAgIGV4dGVybiAiUnVzdCIgewogICAgICAgIHR5cGUgSGVsaW9zQ2xpZW50OwoKICAgICAgICAjW3N3aWZ0X2JyaWRnZShpbml0KV0KICAgICAgICBmbiBuZXcoKSAtPiBIZWxpb3NDbGllbnQ7CgogICAgICAgIGFzeW5jIGZuIHN0YXJ0KAogICAgICAgICAgICAmbXV0IHNlbGYsCiAgICAgICAgICAgIHVudHJ1c3RlZF9ycGNfdXJsOiBTdHJpbmcsCiAgICAgICAgICAgIGNvbnNlbnN1c19ycGNfdXJsOiBTdHJpbmcsCiAgICAgICAgICAgIGNoZWNrcG9pbnQ6IE9wdGlvbjxTdHJpbmc+LAogICAgICAgICAgICBycGNfcG9ydDogdTE2LAogICAgICAgICAgICBuZXR3b3JrOiBIZWxpb3NOZXR3b3JrLAogICAgICAgICAgICBkYXRhX2RpcjogT3B0aW9uPFN0cmluZz4sCiAgICAgICAgKSAtPiBTdGFydFVwU3RhdGU7CgogICAgICAgIGFzeW5jIGZuIHNodXRkb3duKCZtdXQgc2VsZik7CgogICAgICAgIGFzeW5jIGZuIGNhbGwoJnNlbGYsIG9wdHM6IENhbGxPcHRzLCBibG9jazogQmxvY2tUYWcpIC0+IFJlc3BvbnNlVmVjODsKICAgICAgICBhc3luYyBmbiBzZW5kX3Jhd190cmFuc2FjdGlvbigmc2VsZiwgYnl0ZXM6IFZlYzx1OD4pIC0+IFJlc3BvbnNlU3RyaW5nOwoKICAgICAgICBhc3luYyBmbiBlc3RpbWF0ZV9nYXMoJnNlbGYsIG9wdHM6IENhbGxPcHRzKSAtPiBSZXNwb25zZVU2NDsKICAgICAgICBhc3luYyBmbiBjaGFpbl9pZCgmc2VsZikgLT4gUmVzcG9uc2VVNjQ7CiAgICAgICAgYXN5bmMgZm4gZ2V0X2dhc19wcmljZSgmc2VsZikgLT4gUmVzcG9uc2VTdHJpbmc7CiAgICAgICAgYXN5bmMgZm4gZ2V0X3ByaW9yaXR5X2ZlZSgmc2VsZikgLT4gUmVzcG9uc2VTdHJpbmc7CiAgICAgICAgYXN5bmMgZm4gZ2V0X2ZlZV9oaXN0b3J5KAogICAgICAgICAgICAmc2VsZiwKICAgICAgICAgICAgYmxvY2tfY291bnQ6IHU2NCwKICAgICAgICAgICAgbGFzdF9ibG9jazogdTY0LAogICAgICAgICAgICByZXdhcmRfcGVyY2VudGlsZXM6IFZlYzxmNjQ+LAogICAgICAgICkgLT4gUmVzcG9uc2VGZWVIaXN0b3J5OwogICAgICAgIGFzeW5jIGZuIGdldF9ibG9ja19udW1iZXIoJnNlbGYpIC0+IFJlc3BvbnNlVTY0OwogICAgICAgIGFzeW5jIGZuIGdldF9jb2luYmFzZSgmc2VsZikgLT4gUmVzcG9uc2VTdHJpbmc7CgogICAgICAgIGFzeW5jIGZuIGdldF9iYWxhbmNlKCZzZWxmLCBhZGRyZXNzOiBTdHJpbmcsIGJsb2NrOiBCbG9ja1RhZykgLT4gUmVzcG9uc2VTdHJpbmc7CiAgICAgICAgYXN5bmMgZm4gZ2V0X25vbmNlKCZzZWxmLCBhZGRyZXNzOiBTdHJpbmcsIGJsb2NrOiBCbG9ja1RhZykgLT4gUmVzcG9uc2VVNjQ7CgogICAgICAgIGFzeW5jIGZuIGdldF9ibG9ja19ieV9udW1iZXIoCiAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICBibG9jazogQmxvY2tUYWcsCiAgICAgICAgICAgIGZ1bGxfdHg6IGJvb2wsCiAgICAgICAgKSAtPiBSZXNwb25zZUV4ZWN1dGlvbkJsb2NrOwogICAgICAgIGFzeW5jIGZuIGdldF9ibG9ja19ieV9oYXNoKCZzZWxmLCBoYXNoOiBTdHJpbmcsIGZ1bGxfdHg6IGJvb2wpIC0+IFJlc3BvbnNlRXhlY3V0aW9uQmxvY2s7CiAgICAgICAgYXN5bmMgZm4gZ2V0X2Jsb2NrX3RyYW5zYWN0aW9uX2NvdW50X2J5X2hhc2goJnNlbGYsIGhhc2g6IFN0cmluZykgLT4gUmVzcG9uc2VVNjQ7CiAgICAgICAgYXN5bmMgZm4gZ2V0X2Jsb2NrX3RyYW5zYWN0aW9uX2NvdW50X2J5X251bWJlcigmc2VsZiwgYmxvY2s6IEJsb2NrVGFnKSAtPiBSZXNwb25zZVU2NDsKCiAgICAgICAgYXN5bmMgZm4gZ2V0X3RyYW5zYWN0aW9uX3JlY2VpcHQoJnNlbGYsIHR4X2hhc2g6IFN0cmluZykgLT4gUmVzcG9uc2VUcmFuc2FjdGlvblJlY2VpcHQ7CiAgICAgICAgYXN5bmMgZm4gZ2V0X3RyYW5zYWN0aW9uX2J5X2hhc2goJnNlbGYsIHR4X2hhc2g6IFN0cmluZykgLT4gUmVzcG9uc2VUcmFuc2FjdGlvbjsKICAgICAgICBhc3luYyBmbiBnZXRfdHJhbnNhY3Rpb25fYnlfYmxvY2tfaGFzaF9hbmRfaW5kZXgoCiAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICBibG9ja19oYXNoOiBTdHJpbmcsCiAgICAgICAgICAgIGluZGV4OiB1c2l6ZSwKICAgICAgICApIC0+IFJlc3BvbnNlVHJhbnNhY3Rpb247CgogICAgICAgIGFzeW5jIGZuIGdldF9sb2dzKCZzZWxmLCBmaWx0ZXI6IExvZ0ZpbHRlcikgLT4gUmVzcG9uc2VWZWNMb2c7CgogICAgICAgIGFzeW5jIGZuIGdldF9jb2RlKCZzZWxmLCBhZGRyZXNzOiBTdHJpbmcsIGJsb2NrOiBCbG9ja1RhZykgLT4gUmVzcG9uc2VWZWM4OwogICAgICAgIGFzeW5jIGZuIGdldF9zdG9yYWdlX2F0KAogICAgICAgICAgICAmc2VsZiwKICAgICAgICAgICAgYWRkcmVzczogU3RyaW5nLAogICAgICAgICAgICBzbG90OiBTdHJpbmcsCiAgICAgICAgICAgIGJsb2NrOiBCbG9ja1RhZywKICAgICAgICApIC0+IFJlc3BvbnNlU3RyaW5nOwoKICAgICAgICBhc3luYyBmbiBnZXRfaGVhZGVyKCZzZWxmKSAtPiBSZXNwb25zZUhlYWRlcjsKICAgICAgICBhc3luYyBmbiBzeW5jaW5nKCZzZWxmKSAtPiBSZXNwb25zZVN5bmNpbmc7CiAgICB9Cn0KCmltcGwgSGVsaW9zQ2xpZW50IHsKICAgIHB1YiBmbiBuZXcoKSAtPiBIZWxpb3NDbGllbnQgewogICAgICAgIEhlbGlvc0NsaWVudCB7CiAgICAgICAgICAgIGNsaWVudDogTm9uZSwKICAgICAgICAgICAgaXNfbG9nZ2luZzogZmFsc2UsCiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIHN0YXJ0KAogICAgICAgICZtdXQgc2VsZiwKICAgICAgICB1bnRydXN0ZWRfcnBjX3VybDogU3RyaW5nLAogICAgICAgIGNvbnNlbnN1c19ycGNfdXJsOiBTdHJpbmcsCiAgICAgICAgY2hlY2twb2ludDogT3B0aW9uPFN0cmluZz4sCiAgICAgICAgcnBjX3BvcnQ6IHUxNiwKICAgICAgICBuZXR3b3JrOiBmZmk6OkhlbGlvc05ldHdvcmssCiAgICAgICAgZGF0YV9kaXI6IE9wdGlvbjxTdHJpbmc+LAogICAgKSAtPiBmZmk6OlN0YXJ0VXBTdGF0ZSB7CiAgICAgICAgaWYgbGV0IFNvbWUoX2NsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICByZXR1cm4gZmZpOjpTdGFydFVwU3RhdGUgewogICAgICAgICAgICAgICAgc3RhcnRlZDogZmFsc2UsCiAgICAgICAgICAgICAgICBlcnJvcjogIkNsaWVudCBoYXMgYWxyZWFkeSBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH07CiAgICAgICAgfQoKICAgICAgICBpZiAhc2VsZi5pc19sb2dnaW5nIHsKICAgICAgICAgICAgc2VsZi5pc19sb2dnaW5nID0gdHJ1ZTsKICAgICAgICAgICAgZW52X2xvZ2dlcjo6aW5pdCgpOwogICAgICAgIH0KCiAgICAgICAgbGV0IG11dCBjbGllbnRfYnVpbGRlciA9IENsaWVudEJ1aWxkZXI6Om5ldygpCiAgICAgICAgICAgIC5uZXR3b3JrKG5ldHdvcmsudG9fYmFzZV9uZXR3b3JrKCkpCiAgICAgICAgICAgIC5leGVjdXRpb25fcnBjKCZ1bnRydXN0ZWRfcnBjX3VybCkKICAgICAgICAgICAgLmNvbnNlbnN1c19ycGMoJmNvbnNlbnN1c19ycGNfdXJsKQogICAgICAgICAgICAucnBjX3BvcnQocnBjX3BvcnQpOwoKICAgICAgICBpZiBsZXQgU29tZShjaGVja3BvaW50KSA9ICZjaGVja3BvaW50IHsKICAgICAgICAgICAgY2xpZW50X2J1aWxkZXIgPSBjbGllbnRfYnVpbGRlci5jaGVja3BvaW50KCZjaGVja3BvaW50KTsKICAgICAgICB9CgogICAgICAgIGlmIGxldCBTb21lKGRhdGFfZGlyKSA9ICZkYXRhX2RpciB7CiAgICAgICAgICAgIGNsaWVudF9idWlsZGVyID0gY2xpZW50X2J1aWxkZXIuZGF0YV9kaXIoKCZkYXRhX2RpcikuaW50bygpKTsKICAgICAgICB9CgogICAgICAgIG1hdGNoIGNsaWVudF9idWlsZGVyLmJ1aWxkKCkgewogICAgICAgICAgICBFcnIoZXJyb3IpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiBmZmk6OlN0YXJ0VXBTdGF0ZSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnRlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIE9rKG11dCBjbGllbnQpID0+IG1hdGNoIGNsaWVudC5zdGFydCgpLmF3YWl0IHsKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmZmk6OlN0YXJ0VXBTdGF0ZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgT2soKCkpID0+IHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmNsaWVudCA9IFNvbWUoY2xpZW50KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmZpOjpTdGFydFVwU3RhdGUgewogICAgICAgICAgICAgICAgICAgICAgICBzdGFydGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gc2h1dGRvd24oJm11dCBzZWxmKSB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIGNsaWVudC5zaHV0ZG93bigpLmF3YWl0OwogICAgICAgICAgICBzZWxmLmNsaWVudCA9IE5vbmU7CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGNhbGwoJnNlbGYsIG9wdHM6IGZmaTo6Q2FsbE9wdHMsIGJsb2NrOiBmZmk6OkJsb2NrVGFnKSAtPiBmZmk6OlJlc3BvbnNlVmVjOCB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoICZvcHRzLnRvX2Jhc2Vfb3B0cygpIHsKICAgICAgICAgICAgICAgIE9rKG9wdHMpID0+IG1hdGNoIGNsaWVudC5jYWxsKG9wdHMsIGJsb2NrLnRvX2Jhc2VfYmxvY2soKSkuYXdhaXQgewogICAgICAgICAgICAgICAgICAgIE9rKGRhdGEpID0+IGZmaTo6UmVzcG9uc2VWZWM4IHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGRhdGEsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogW10uaW50bygpLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBbXS5pbnRvKCksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJJbnZhbGlkIGNhbGwgb3B0aW9uczoge30iLCBlcnJvciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgICAgICAgICAgdmFsdWU6IFtdLmludG8oKSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIHNlbmRfcmF3X3RyYW5zYWN0aW9uKCZzZWxmLCBieXRlczogVmVjPHU4PikgLT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGNsaWVudC5zZW5kX3Jhd190cmFuc2FjdGlvbigmYnl0ZXMpLmF3YWl0IHsKICAgICAgICAgICAgICAgIE9rKGhhc2gpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoaGFzaCkpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVyci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGVzdGltYXRlX2dhcygmc2VsZiwgb3B0czogZmZpOjpDYWxsT3B0cykgLT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoICZvcHRzLnRvX2Jhc2Vfb3B0cygpIHsKICAgICAgICAgICAgICAgIE9rKG9wdHMpID0+IG1hdGNoIGNsaWVudC5lc3RpbWF0ZV9nYXMoJm9wdHMpLmF3YWl0IHsKICAgICAgICAgICAgICAgICAgICBPayhnYXMpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZ2FzLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiSW52YWxpZCBjYWxsIG9wdGlvbnM6IHt9IiwgZXJyb3IpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBjaGFpbl9pZCgmc2VsZikgLT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgdmFsdWU6IGNsaWVudC5jaGFpbl9pZCgpLmF3YWl0LAogICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIGZuIGdldF9nYXNfcHJpY2UoJnNlbGYpIC0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBjbGllbnQuZ2V0X2dhc19wcmljZSgpLmF3YWl0IHsKICAgICAgICAgICAgICAgIE9rKGdhc19wcmljZSkgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGdhc19wcmljZS50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X3ByaW9yaXR5X2ZlZSgmc2VsZikgLT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGNsaWVudC5nZXRfcHJpb3JpdHlfZmVlKCkuYXdhaXQgewogICAgICAgICAgICAgICAgT2socHJpb3JpdHlfZmVlKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogcHJpb3JpdHlfZmVlLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfZmVlX2hpc3RvcnkoCiAgICAgICAgJnNlbGYsCiAgICAgICAgYmxvY2tfY291bnQ6IHU2NCwKICAgICAgICBsYXN0X2Jsb2NrOiB1NjQsCiAgICAgICAgcmV3YXJkX3BlcmNlbnRpbGVzOiBWZWM8ZjY0PiwKICAgICkgLT4gZmZpOjpSZXNwb25zZUZlZUhpc3RvcnkgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBjbGllbnQKICAgICAgICAgICAgICAgIC5nZXRfZmVlX2hpc3RvcnkoYmxvY2tfY291bnQsIGxhc3RfYmxvY2ssICZyZXdhcmRfcGVyY2VudGlsZXMpCiAgICAgICAgICAgICAgICAuYXdhaXQKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgT2soZmVlX2hpc3RvcnkpID0+IGZmaTo6UmVzcG9uc2VGZWVIaXN0b3J5IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZmVlX2hpc3RvcnkubWFwKGV0aGVyc19mZWVfaGlzdG9yeV90b19mZmkpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VGZWVIaXN0b3J5IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVyci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlRmVlSGlzdG9yeSB7CiAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9ibG9ja19udW1iZXIoJnNlbGYpIC0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBjbGllbnQuZ2V0X2Jsb2NrX251bWJlcigpLmF3YWl0IHsKICAgICAgICAgICAgICAgIE9rKGJsb2NrKSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogYmxvY2ssCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfY29pbmJhc2UoJnNlbGYpIC0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBjbGllbnQuZ2V0X2NvaW5iYXNlKCkuYXdhaXQgewogICAgICAgICAgICAgICAgT2soY29pbmJhc2UpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoY29pbmJhc2UuYXNfYnl0ZXMoKSkpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfYmFsYW5jZSgmc2VsZiwgYWRkcmVzczogU3RyaW5nLCBibG9jazogZmZpOjpCbG9ja1RhZykgLT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGFkZHJlc3NfZnJvbV9zdHJpbmcoYWRkcmVzcykgewogICAgICAgICAgICAgICAgT2soYWRkcmVzcykgPT4gbWF0Y2ggY2xpZW50LmdldF9iYWxhbmNlKCZhZGRyZXNzLCBibG9jay50b19iYXNlX2Jsb2NrKCkpLmF3YWl0IHsKICAgICAgICAgICAgICAgICAgICBPayhiYWxhbmNlKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGJhbGFuY2UudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIkludmFsaWQgYWRkcmVzczoge30iLCBlcnJvciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfbm9uY2UoJnNlbGYsIGFkZHJlc3M6IFN0cmluZywgYmxvY2s6IGZmaTo6QmxvY2tUYWcpIC0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBhZGRyZXNzX2Zyb21fc3RyaW5nKGFkZHJlc3MpIHsKICAgICAgICAgICAgICAgIE9rKGFkZHJlc3MpID0+IG1hdGNoIGNsaWVudC5nZXRfbm9uY2UoJmFkZHJlc3MsIGJsb2NrLnRvX2Jhc2VfYmxvY2soKSkuYXdhaXQgewogICAgICAgICAgICAgICAgICAgIE9rKG5vbmNlKSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG5vbmNlLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiSW52YWxpZCBhZGRyZXNzOiB7fSIsIGVycm9yKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X2Jsb2NrX2J5X251bWJlcigKICAgICAgICAmc2VsZiwKICAgICAgICBibG9jazogZmZpOjpCbG9ja1RhZywKICAgICAgICBmdWxsX3R4OiBib29sLAogICAgKSAtPiBmZmk6OlJlc3BvbnNlRXhlY3V0aW9uQmxvY2sgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBjbGllbnQKICAgICAgICAgICAgICAgIC5nZXRfYmxvY2tfYnlfbnVtYmVyKGJsb2NrLnRvX2Jhc2VfYmxvY2soKSwgZnVsbF90eCkKICAgICAgICAgICAgICAgIC5hd2FpdAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBPayhibG9jaykgPT4gZmZpOjpSZXNwb25zZUV4ZWN1dGlvbkJsb2NrIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogYmxvY2subWFwKGhlbGlvc19leGVjdXRpb25fYmxvY2tfdG9fZmZpKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlRXhlY3V0aW9uQmxvY2sgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VFeGVjdXRpb25CbG9jayB7CiAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9ibG9ja19ieV9oYXNoKCZzZWxmLCBoYXNoOiBTdHJpbmcsIGZ1bGxfdHg6IGJvb2wpIC0+IGZmaTo6UmVzcG9uc2VFeGVjdXRpb25CbG9jayB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGgyNTZfZnJvbV9zdHJpbmcoaGFzaCkgewogICAgICAgICAgICAgICAgT2soaGFzaCkgPT4gewogICAgICAgICAgICAgICAgICAgIG1hdGNoIGNsaWVudAogICAgICAgICAgICAgICAgICAgICAgICAuZ2V0X2Jsb2NrX2J5X2hhc2goJmhhc2guYXNfYnl0ZXMoKS50b192ZWMoKSwgZnVsbF90eCkKICAgICAgICAgICAgICAgICAgICAgICAgLmF3YWl0CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBPayhibG9jaykgPT4gZmZpOjpSZXNwb25zZUV4ZWN1dGlvbkJsb2NrIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBibG9jay5tYXAoaGVsaW9zX2V4ZWN1dGlvbl9ibG9ja190b19mZmkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgRXJyKGVycikgPT4gZmZpOjpSZXNwb25zZUV4ZWN1dGlvbkJsb2NrIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVyci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlRXhlY3V0aW9uQmxvY2sgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiQmxvY2sgaGFzaDoge30iLCBlcnIpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VFeGVjdXRpb25CbG9jayB7CiAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9ibG9ja190cmFuc2FjdGlvbl9jb3VudF9ieV9oYXNoKCZzZWxmLCBoYXNoOiBTdHJpbmcpIC0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgIGlmIGxldCBPayhoYXNoKSA9IGhleDo6ZGVjb2RlKGhhc2guc3RyaXBfcHJlZml4KCIweCIpLnVud3JhcF9vcigiIikpIHsKICAgICAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgICAgICBtYXRjaCBjbGllbnQuZ2V0X2Jsb2NrX3RyYW5zYWN0aW9uX2NvdW50X2J5X2hhc2goJmhhc2gpLmF3YWl0IHsKICAgICAgICAgICAgICAgICAgICBPayhjb3VudCkgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJJbnZhbGlkIGhhc2giLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9ibG9ja190cmFuc2FjdGlvbl9jb3VudF9ieV9udW1iZXIoCiAgICAgICAgJnNlbGYsCiAgICAgICAgYmxvY2s6IGZmaTo6QmxvY2tUYWcsCiAgICApIC0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBjbGllbnQKICAgICAgICAgICAgICAgIC5nZXRfYmxvY2tfdHJhbnNhY3Rpb25fY291bnRfYnlfbnVtYmVyKGJsb2NrLnRvX2Jhc2VfYmxvY2soKSkKICAgICAgICAgICAgICAgIC5hd2FpdAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBPayhjb3VudCkgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGNvdW50LAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X3RyYW5zYWN0aW9uX3JlY2VpcHQoJnNlbGYsIHR4X2hhc2g6IFN0cmluZykgLT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGgyNTZfZnJvbV9zdHJpbmcodHhfaGFzaCkgewogICAgICAgICAgICAgICAgT2sodHhfaGFzaCkgPT4gbWF0Y2ggY2xpZW50LmdldF90cmFuc2FjdGlvbl9yZWNlaXB0KCZ0eF9oYXNoKS5hd2FpdCB7CiAgICAgICAgICAgICAgICAgICAgT2socmVjZWlwdCkgPT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiByZWNlaXB0Lm1hcChldGhlcnNfcmVjZWlwdF90b19mZmkpLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvblJlY2VpcHQgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvblJlY2VpcHQgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiVHJhbnNhY3Rpb24gaGFzaDoge30iLCBlcnJvciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF90cmFuc2FjdGlvbl9ieV9oYXNoKCZzZWxmLCB0eF9oYXNoOiBTdHJpbmcpIC0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGgyNTZfZnJvbV9zdHJpbmcodHhfaGFzaCkgewogICAgICAgICAgICAgICAgT2soaGFzaCkgPT4gbWF0Y2ggY2xpZW50LmdldF90cmFuc2FjdGlvbl9ieV9oYXNoKCZoYXNoKS5hd2FpdCB7CiAgICAgICAgICAgICAgICAgICAgT2sodHJhbnNhY3Rpb24pID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0cmFuc2FjdGlvbi5tYXAoZXRoZXJzX3RyYW5zYWN0aW9uX3RvX2ZmaSksCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiVHJhbnNhY3Rpb24gaGFzaDoge30iLCBlcnIpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF90cmFuc2FjdGlvbl9ieV9ibG9ja19oYXNoX2FuZF9pbmRleCgKICAgICAgICAmc2VsZiwKICAgICAgICBibG9ja19oYXNoOiBTdHJpbmcsCiAgICAgICAgaW5kZXg6IHVzaXplLAogICAgKSAtPiBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBoMjU2X2Zyb21fc3RyaW5nKGJsb2NrX2hhc2gpIHsKICAgICAgICAgICAgICAgIE9rKGhhc2gpID0+IHsKICAgICAgICAgICAgICAgICAgICBtYXRjaCBjbGllbnQKICAgICAgICAgICAgICAgICAgICAgICAgLmdldF90cmFuc2FjdGlvbl9ieV9ibG9ja19oYXNoX2FuZF9pbmRleCgmaGFzaC5hc19ieXRlcygpLnRvX3ZlYygpLCBpbmRleCkKICAgICAgICAgICAgICAgICAgICAgICAgLmF3YWl0CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBPayh0cmFuc2FjdGlvbikgPT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiB0cmFuc2FjdGlvbi5tYXAoZXRoZXJzX3RyYW5zYWN0aW9uX3RvX2ZmaSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJCbG9jayBoYXNoOiB7fSIsIGVyciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X2xvZ3MoJnNlbGYsIGZpbHRlcjogZmZpOjpMb2dGaWx0ZXIpIC0+IGZmaTo6UmVzcG9uc2VWZWNMb2cgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBmaWx0ZXIudG9fZXRoZXJzX2ZpbHRlcigpIHsKICAgICAgICAgICAgICAgIE9rKGZpbHRlcikgPT4gbWF0Y2ggY2xpZW50LmdldF9sb2dzKCZmaWx0ZXIpLmF3YWl0IHsKICAgICAgICAgICAgICAgICAgICBPayhsb2dzKSA9PiBmZmk6OlJlc3BvbnNlVmVjTG9nIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGxvZ3MuaW50b19pdGVyKCkubWFwKGV0aGVyc19sb2dfdG9fZmZpX2xvZykuY29sbGVjdCgpLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlVmVjTG9nIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZlYyFbXSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycikgPT4gZmZpOjpSZXNwb25zZVZlY0xvZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZlYyFbXSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIkludmFsaWQgZmlsdGVyOiB7fSIsIGVyciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVZlY0xvZyB7CiAgICAgICAgICAgICAgICB2YWx1ZTogdmVjIVtdLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X2NvZGUoJnNlbGYsIGFkZHJlc3M6IFN0cmluZywgYmxvY2s6IGZmaTo6QmxvY2tUYWcpIC0+IGZmaTo6UmVzcG9uc2VWZWM4IHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggYWRkcmVzc19mcm9tX3N0cmluZyhhZGRyZXNzKSB7CiAgICAgICAgICAgICAgICBPayhhZGRyZXNzKSA9PiBtYXRjaCBjbGllbnQuZ2V0X2NvZGUoJmFkZHJlc3MsIGJsb2NrLnRvX2Jhc2VfYmxvY2soKSkuYXdhaXQgewogICAgICAgICAgICAgICAgICAgIE9rKGNvZGUpID0+IGZmaTo6UmVzcG9uc2VWZWM4IHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGNvZGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogW10uaW50bygpLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBbXS5pbnRvKCksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJJbnZhbGlkIGFkZHJlc3M6IHt9IiwgZXJyb3IpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VWZWM4IHsKICAgICAgICAgICAgICAgIHZhbHVlOiBbXS5pbnRvKCksCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfc3RvcmFnZV9hdCgKICAgICAgICAmc2VsZiwKICAgICAgICBhZGRyZXNzOiBTdHJpbmcsCiAgICAgICAgc2xvdDogU3RyaW5nLAogICAgICAgIGJsb2NrOiBmZmk6OkJsb2NrVGFnLAogICAgKSAtPiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggYWRkcmVzc19mcm9tX3N0cmluZyhhZGRyZXNzKSB7CiAgICAgICAgICAgICAgICBPayhhZGRyZXNzKSA9PiBtYXRjaCBoMjU2X2Zyb21fc3RyaW5nKHNsb3QpIHsKICAgICAgICAgICAgICAgICAgICBPayhzbG90KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoIGNsaWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldF9zdG9yYWdlX2F0KCZhZGRyZXNzLCBzbG90LCBibG9jay50b19iYXNlX2Jsb2NrKCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYXdhaXQKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgT2soc3RvcmFnZSkgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHN0b3JhZ2UuZW5jb2RlX2hleCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiSW52YWxpZCBzbG90OiB7fSIsIGVycm9yKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiSW52YWxpZCBhZGRyZXNzOiB7fSIsIGVycm9yKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9oZWFkZXIoJnNlbGYpIC0+IGZmaTo6UmVzcG9uc2VIZWFkZXIgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBjbGllbnQuZ2V0X2hlYWRlcigpLmF3YWl0IHsKICAgICAgICAgICAgICAgIE9rKGhlYWRlcikgPT4gZmZpOjpSZXNwb25zZUhlYWRlciB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IFNvbWUoaGVsaW9zX2hlYWRlcl90b19mZmkoaGVhZGVyKSksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycikgPT4gZmZpOjpSZXNwb25zZUhlYWRlciB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZUhlYWRlciB7CiAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIHN5bmNpbmcoJnNlbGYpIC0+IGZmaTo6UmVzcG9uc2VTeW5jaW5nIHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggY2xpZW50LnN5bmNpbmcoKS5hd2FpdCB7CiAgICAgICAgICAgICAgICBPayhzdGF0dXMpID0+IGZmaTo6UmVzcG9uc2VTeW5jaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZXRoZXJzX3N5bmNpbmdfc3RhdHVzX3RvX2ZmaShzdGF0dXMpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VTeW5jaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVyci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlU3luY2luZyB7CiAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgppbXBsIGZmaTo6SGVsaW9zTmV0d29yayB7CiAgICBmbiB0b19iYXNlX25ldHdvcmsoJnNlbGYpIC0+IG5ldHdvcmtzOjpOZXR3b3JrIHsKICAgICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgICAgU2VsZjo6TUFJTk5FVCA9PiBuZXR3b3Jrczo6TmV0d29yazo6TUFJTk5FVCwKICAgICAgICAgICAgU2VsZjo6R09FUkxJID0+IG5ldHdvcmtzOjpOZXR3b3JrOjpHT0VSTEksCiAgICAgICAgfQogICAgfQp9CgppbXBsIGZmaTo6QmxvY2tUYWcgewogICAgZm4gdG9fYmFzZV9ibG9jaygmc2VsZikgLT4gY29tbW9uOjp0eXBlczo6QmxvY2tUYWcgewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpGaW5hbGl6ZWQgPT4gY29tbW9uOjp0eXBlczo6QmxvY2tUYWc6OkZpbmFsaXplZCwKICAgICAgICAgICAgU2VsZjo6TGF0ZXN0ID0+IGNvbW1vbjo6dHlwZXM6OkJsb2NrVGFnOjpMYXRlc3QsCiAgICAgICAgICAgIFNlbGY6OlNhZmUgPT4gY29tbW9uOjp0eXBlczo6QmxvY2tUYWc6OkZpbmFsaXplZCwKICAgICAgICAgICAgU2VsZjo6UGVuZGluZyA9PiBjb21tb246OnR5cGVzOjpCbG9ja1RhZzo6TGF0ZXN0LAogICAgICAgICAgICBTZWxmOjpFYXJsaWVzdCA9PiBjb21tb246OnR5cGVzOjpCbG9ja1RhZzo6TnVtYmVyKDEpLAogICAgICAgICAgICBTZWxmOjpOdW1iZXIoYmxvY2spID0+IGNvbW1vbjo6dHlwZXM6OkJsb2NrVGFnOjpOdW1iZXIoKmJsb2NrKSwKICAgICAgICB9CiAgICB9CgogICAgZm4gdG9fZXRoZXJzX2Jsb2NrKCZzZWxmKSAtPiBCbG9ja051bWJlciB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6OkZpbmFsaXplZCA9PiBCbG9ja051bWJlcjo6RmluYWxpemVkLAogICAgICAgICAgICBTZWxmOjpMYXRlc3QgPT4gQmxvY2tOdW1iZXI6OkxhdGVzdCwKICAgICAgICAgICAgU2VsZjo6U2FmZSA9PiBCbG9ja051bWJlcjo6U2FmZSwKICAgICAgICAgICAgU2VsZjo6UGVuZGluZyA9PiBCbG9ja051bWJlcjo6UGVuZGluZywKICAgICAgICAgICAgU2VsZjo6RWFybGllc3QgPT4gQmxvY2tOdW1iZXI6OkVhcmxpZXN0LAogICAgICAgICAgICBTZWxmOjpOdW1iZXIoYmxvY2spID0+IEJsb2NrTnVtYmVyOjpOdW1iZXIoVTY0Ojpmcm9tKCpibG9jaykpLAogICAgICAgIH0KICAgIH0KfQoKaW1wbCBDbG9uZSBmb3IgZmZpOjpCbG9ja1RhZyB7CiAgICBmbiBjbG9uZSgmc2VsZikgLT4gU2VsZiB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6OkZpbmFsaXplZCA9PiBmZmk6OkJsb2NrVGFnOjpGaW5hbGl6ZWQsCiAgICAgICAgICAgIFNlbGY6OkxhdGVzdCA9PiBmZmk6OkJsb2NrVGFnOjpMYXRlc3QsCiAgICAgICAgICAgIFNlbGY6OlNhZmUgPT4gZmZpOjpCbG9ja1RhZzo6U2FmZSwKICAgICAgICAgICAgU2VsZjo6UGVuZGluZyA9PiBmZmk6OkJsb2NrVGFnOjpQZW5kaW5nLAogICAgICAgICAgICBTZWxmOjpFYXJsaWVzdCA9PiBmZmk6OkJsb2NrVGFnOjpFYXJsaWVzdCwKICAgICAgICAgICAgU2VsZjo6TnVtYmVyKGJsb2NrKSA9PiBmZmk6OkJsb2NrVGFnOjpOdW1iZXIoKmJsb2NrKSwKICAgICAgICB9CiAgICB9Cn0KCmltcGwgZmZpOjpGaWx0ZXJCbG9ja09wdGlvbiB7CiAgICBmbiB0b19ldGhlcnNfYmxvY2tfb3B0aW9uKCZzZWxmKSAtPiBSZXN1bHQ8RmlsdGVyQmxvY2tPcHRpb24sIFN0cmluZz4gewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpSYW5nZSB7CiAgICAgICAgICAgICAgICBmcm9tX2Jsb2NrLAogICAgICAgICAgICAgICAgdG9fYmxvY2ssCiAgICAgICAgICAgIH0gPT4gT2soRmlsdGVyQmxvY2tPcHRpb246OlJhbmdlIHsKICAgICAgICAgICAgICAgIGZyb21fYmxvY2s6IGZyb21fYmxvY2suYXNfcmVmKCkubWFwKHxibG9ja3wgYmxvY2sudG9fZXRoZXJzX2Jsb2NrKCkpLAogICAgICAgICAgICAgICAgdG9fYmxvY2s6IHRvX2Jsb2NrLmFzX3JlZigpLm1hcCh8YmxvY2t8IGJsb2NrLnRvX2V0aGVyc19ibG9jaygpKSwKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIFNlbGY6OkF0QmxvY2tIYXNoKGhhc2gpID0+IE9rKEZpbHRlckJsb2NrT3B0aW9uOjpBdEJsb2NrSGFzaCgKICAgICAgICAgICAgICAgIGgyNTZfZnJvbV9zdHJpbmcoaGFzaC50b19zdHJpbmcoKSkKICAgICAgICAgICAgICAgICAgICAubWFwX2Vycih8ZXJyb3J8IGZvcm1hdCEoIkZpbHRlciBibG9jayBoYXNoOiB7fSIsIGVycm9yKSk/LAogICAgICAgICAgICApKSwKICAgICAgICB9CiAgICB9Cn0KCmltcGwgQ2xvbmUgZm9yIGZmaTo6RmlsdGVyQmxvY2tPcHRpb24gewogICAgZm4gY2xvbmUoJnNlbGYpIC0+IFNlbGYgewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpSYW5nZSB7CiAgICAgICAgICAgICAgICBmcm9tX2Jsb2NrLAogICAgICAgICAgICAgICAgdG9fYmxvY2ssCiAgICAgICAgICAgIH0gPT4gZmZpOjpGaWx0ZXJCbG9ja09wdGlvbjo6UmFuZ2UgewogICAgICAgICAgICAgICAgZnJvbV9ibG9jazogZnJvbV9ibG9jay5jbG9uZSgpLAogICAgICAgICAgICAgICAgdG9fYmxvY2s6IHRvX2Jsb2NrLmNsb25lKCksCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFNlbGY6OkF0QmxvY2tIYXNoKGhhc2gpID0+IGZmaTo6RmlsdGVyQmxvY2tPcHRpb246OkF0QmxvY2tIYXNoKGhhc2guY2xvbmUoKSksCiAgICAgICAgfQogICAgfQp9CgppbXBsIGZmaTo6TG9nRmlsdGVyIHsKICAgIGZuIHRvX2V0aGVyc19maWx0ZXIoJnNlbGYpIC0+IFJlc3VsdDxGaWx0ZXIsIFN0cmluZz4gewogICAgICAgIE9rKEZpbHRlciB7CiAgICAgICAgICAgIGJsb2NrX29wdGlvbjogc2VsZi5ibG9ja19vcHRpb24udG9fZXRoZXJzX2Jsb2NrX29wdGlvbigpPywKICAgICAgICAgICAgYWRkcmVzczogaWYgc2VsZi5hZGRyZXNzLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgTm9uZQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgU29tZSgKICAgICAgICAgICAgICAgICAgICBhZGRyZXNzZXNfZnJvbV9zdHJpbmcoc2VsZi5hZGRyZXNzLmNsb25lKCkpCiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKHxlcnJ8IGZvcm1hdCEoIkZpbHRlciBhZGRyZXNzOiB7fSIsIGVycikpPywKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdG9waWNzOiB0b3BpY3NfZnJvbV9zdHJpbmdzKHNlbGYudG9waWNzLmNsb25lKCkpCiAgICAgICAgICAgICAgICAubWFwX2Vycih8ZXJyfCBmb3JtYXQhKCJGaWx0ZXIgdG9waWNzOiB7fSIsIGVycikpPywKICAgICAgICB9KQogICAgfQp9CgppbXBsIGZmaTo6Q2FsbE9wdHMgewogICAgZm4gdG9fYmFzZV9vcHRzKCZzZWxmKSAtPiBSZXN1bHQ8ZXhlY3V0aW9uOjp0eXBlczo6Q2FsbE9wdHMsIFN0cmluZz4gewogICAgICAgIE9rKGV4ZWN1dGlvbjo6dHlwZXM6OkNhbGxPcHRzIHsKICAgICAgICAgICAgZnJvbTogaWYgc2VsZi5mcm9tLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgTm9uZQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgU29tZSgKICAgICAgICAgICAgICAgICAgICBhZGRyZXNzX2Zyb21fc3RyaW5nKHNlbGYuZnJvbS5jbG9uZSgpKQogICAgICAgICAgICAgICAgICAgICAgICAubWFwX2Vycih8ZXJyfCBmb3JtYXQhKCJmcm9tOiB7fSIsIGVycikpPywKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdG86IFNvbWUoYWRkcmVzc19mcm9tX3N0cmluZyhzZWxmLnRvLmNsb25lKCkpLm1hcF9lcnIofGVycnwgZm9ybWF0ISgidG86IHt9IiwgZXJyKSk/KSwKICAgICAgICAgICAgZ2FzOiBpZiBzZWxmLmdhcy5pc19lbXB0eSgpIHsKICAgICAgICAgICAgICAgIE5vbmUKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIFNvbWUodTI1Nl9mcm9tX3N0cmluZyhzZWxmLmdhcy5jbG9uZSgpKS5tYXBfZXJyKHxlcnJ8IGZvcm1hdCEoImdhczoge30iLCBlcnIpKT8pCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdhc19wcmljZTogaWYgc2VsZi5nYXNfcHJpY2UuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICBOb25lCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBTb21lKAogICAgICAgICAgICAgICAgICAgIHUyNTZfZnJvbV9zdHJpbmcoc2VsZi5nYXNfcHJpY2UuY2xvbmUoKSkKICAgICAgICAgICAgICAgICAgICAgICAgLm1hcF9lcnIofGVycnwgZm9ybWF0ISgiZ2FzX3ByaWNlOiB7fSIsIGVycikpPywKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdmFsdWU6IGlmIHNlbGYudmFsdWUuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICBOb25lCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBTb21lKAogICAgICAgICAgICAgICAgICAgIHUyNTZfZnJvbV9zdHJpbmcoc2VsZi52YWx1ZS5jbG9uZSgpKQogICAgICAgICAgICAgICAgICAgICAgICAubWFwX2Vycih8ZXJyfCBmb3JtYXQhKCJ2YWx1ZToge30iLCBlcnIpKT8sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRhdGE6IGlmIHNlbGYuZGF0YS5pc19lbXB0eSgpIHsKICAgICAgICAgICAgICAgIE5vbmUKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIFNvbWUodmVjOF9mcm9tX3N0cmluZyhzZWxmLmRhdGEuY2xvbmUoKSkubWFwX2Vycih8ZXJyfCBmb3JtYXQhKCJkYXRhOiB7fSIsIGVycikpPykKICAgICAgICAgICAgfSwKICAgICAgICB9KQogICAgfQp9CgppbXBsIENsb25lIGZvciBmZmk6OlRyYW5zYWN0aW9ucyB7CiAgICBmbiBjbG9uZSgmc2VsZikgLT4gU2VsZiB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6Okhhc2hlcyhoYXNoZXMpID0+IGZmaTo6VHJhbnNhY3Rpb25zOjpIYXNoZXMoaGFzaGVzLmNsb25lKCkpLAogICAgICAgICAgICBTZWxmOjpGdWxsKHRyYW5zYWN0aW9ucykgPT4gZmZpOjpUcmFuc2FjdGlvbnM6OkZ1bGwodHJhbnNhY3Rpb25zLnRvX3ZlYygpKSwKICAgICAgICB9CiAgICB9Cn0KCmZuIHRvcGljc19mcm9tX3N0cmluZ3MoCiAgICB2YWx1ZTogVmVjPFN0cmluZz4sCikgLT4gUmVzdWx0PFtPcHRpb248VmFsdWVPckFycmF5PE9wdGlvbjxIMjU2Pj4+OyA0XSwgU3RyaW5nPiB7CiAgICBpZiB2YWx1ZS5sZW4oKSA+IDQgewogICAgICAgIEVycigiVG9vIG1hbnkgdG9waWNzIi50b19zdHJpbmcoKSkKICAgIH0gZWxzZSB7CiAgICAgICAgbGV0IG1hcF9zdHJpbmdfdG9fdG9waWNzID0KICAgICAgICAgICAgfHZhbHVlOiBTdHJpbmd8IC0+IFJlc3VsdDxPcHRpb248VmFsdWVPckFycmF5PE9wdGlvbjxIMjU2Pj4+LCBTdHJpbmc+IHsKICAgICAgICAgICAgICAgIGlmIHZhbHVlLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgICAgIE9rKE5vbmUpCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGxldCB0b3BpY3M6IFZlYzwmc3RyPiA9IHZhbHVlLnNwbGl0KCcsJykuY29sbGVjdCgpOwogICAgICAgICAgICAgICAgICAgIGlmIHRvcGljcy5sZW4oKSA9PSAxIHsKICAgICAgICAgICAgICAgICAgICAgICAgT2soU29tZShWYWx1ZU9yQXJyYXk6OlZhbHVlKFNvbWUoaDI1Nl9mcm9tX3N0cmluZygKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvcGljc1swXS50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgKT8pKSkpCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG1hcHBlZDogUmVzdWx0PFZlYzxIMjU2PiwgU3RyaW5nPiA9IHRvcGljcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmludG9faXRlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAubWFwKHx0b3BpY3wgaDI1Nl9mcm9tX3N0cmluZyh0b3BpYy50b19zdHJpbmcoKSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY29sbGVjdCgpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgb3B0aW9uX21hcHBlZDogVmVjPE9wdGlvbjxIMjU2Pj4gPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwcGVkPy5pbnRvX2l0ZXIoKS5tYXAofGhhc2h8IE9wdGlvbjo6U29tZShoYXNoKSkuY29sbGVjdCgpOwogICAgICAgICAgICAgICAgICAgICAgICBPayhTb21lKFZhbHVlT3JBcnJheTo6QXJyYXkob3B0aW9uX21hcHBlZCkpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICBsZXQgbXV0IHRvcGljcyA9IHZhbHVlLmNsb25lKCk7CiAgICAgICAgZm9yIF9pIGluIHRvcGljcy5sZW4oKS4uNCB7CiAgICAgICAgICAgIHRvcGljcy5wdXNoKCIiLnRvX3N0cmluZygpKTsKICAgICAgICB9CiAgICAgICAgbGV0IG1hcHBlZDogUmVzdWx0PFZlYzxPcHRpb248VmFsdWVPckFycmF5PE9wdGlvbjxIMjU2Pj4+PiwgU3RyaW5nPiA9CiAgICAgICAgICAgIHRvcGljcy5pbnRvX2l0ZXIoKS5tYXAobWFwX3N0cmluZ190b190b3BpY3MpLmNvbGxlY3QoKTsKICAgICAgICBPayhtYXBwZWQ/LnRyeV9pbnRvKCkubWFwX2Vycih8X2VycnwgIkZhaWxlZCB0byBtYXAgdmVjdG9yIik/KQogICAgfQp9CgpmbiBhZGRyZXNzX2Zyb21fc3RyaW5nKHZhbHVlOiBTdHJpbmcpIC0+IFJlc3VsdDxBZGRyZXNzLCBTdHJpbmc+IHsKICAgIGxldCByYXdfaGV4ID0gdmVjOF9mcm9tX3N0cmluZyh2YWx1ZSk/OwogICAgaWYgcmF3X2hleC5sZW4oKSA9PSBBZGRyZXNzOjpsZW5fYnl0ZXMoKSB7CiAgICAgICAgT2soQWRkcmVzczo6ZnJvbV9zbGljZSgmcmF3X2hleCkpCiAgICB9IGVsc2UgewogICAgICAgIEVycihmb3JtYXQhKCJTaG91bGQgYmUge30gYnl0ZXMgbG9uZyIsIEFkZHJlc3M6Omxlbl9ieXRlcygpKSkKICAgIH0KfQoKZm4gYWRkcmVzc2VzX2Zyb21fc3RyaW5nKHZhbHVlOiBTdHJpbmcpIC0+IFJlc3VsdDxWYWx1ZU9yQXJyYXk8QWRkcmVzcz4sIFN0cmluZz4gewogICAgbGV0IGFkZHJlc3NlczogVmVjPCZzdHI+ID0gdmFsdWUuc3BsaXQoJywnKS5jb2xsZWN0KCk7CiAgICBpZiBhZGRyZXNzZXMubGVuKCkgPT0gMSB7CiAgICAgICAgT2soVmFsdWVPckFycmF5OjpWYWx1ZShhZGRyZXNzX2Zyb21fc3RyaW5nKAogICAgICAgICAgICBhZGRyZXNzZXNbMF0udG9fc3RyaW5nKCksCiAgICAgICAgKT8pKQogICAgfSBlbHNlIHsKICAgICAgICBsZXQgbWFwcGVkOiBSZXN1bHQ8VmVjPEFkZHJlc3M+LCBTdHJpbmc+ID0gYWRkcmVzc2VzCiAgICAgICAgICAgIC5pbnRvX2l0ZXIoKQogICAgICAgICAgICAubWFwKHxhZGRyZXNzfCBhZGRyZXNzX2Zyb21fc3RyaW5nKGFkZHJlc3MudG9fc3RyaW5nKCkpKQogICAgICAgICAgICAuY29sbGVjdCgpOwogICAgICAgIE9rKFZhbHVlT3JBcnJheTo6QXJyYXkobWFwcGVkPykpCiAgICB9Cn0KCmZuIGgyNTZfZnJvbV9zdHJpbmcodmFsdWU6IFN0cmluZykgLT4gUmVzdWx0PEgyNTYsIFN0cmluZz4gewogICAgbGV0IHJhd19oZXggPSB2ZWM4X2Zyb21fc3RyaW5nKHZhbHVlKT87CiAgICBpZiByYXdfaGV4LmxlbigpID09IEgyNTY6Omxlbl9ieXRlcygpIHsKICAgICAgICBPayhIMjU2Ojpmcm9tX3NsaWNlKCZyYXdfaGV4KSkKICAgIH0gZWxzZSB7CiAgICAgICAgRXJyKGZvcm1hdCEoIlNob3VsZCBiZSB7fSBieXRlcyBsb25nIiwgSDI1Njo6bGVuX2J5dGVzKCkpKQogICAgfQp9CgpmbiB1MjU2X2Zyb21fc3RyaW5nKHZhbHVlOiBTdHJpbmcpIC0+IFJlc3VsdDxVMjU2LCBTdHJpbmc+IHsKICAgIGlmIGxldCBTb21lKHJhd19oZXhfc3RyaW5nKSA9IHZhbHVlLnN0cmlwX3ByZWZpeCgiMHgiKSB7CiAgICAgICAgT2soVTI1Njo6ZnJvbV9zdHJfcmFkaXgocmF3X2hleF9zdHJpbmcsIDE2KS5tYXBfZXJyKHxlcnJ8IGVyci50b19zdHJpbmcoKSk/KQogICAgfSBlbHNlIHsKICAgICAgICBPayhVMjU2Ojpmcm9tX3N0cl9yYWRpeCgmdmFsdWUsIDEwKS5tYXBfZXJyKHxlcnJ8IGVyci50b19zdHJpbmcoKSk/KQogICAgfQp9CgpmbiB2ZWM4X2Zyb21fc3RyaW5nKHZhbHVlOiBTdHJpbmcpIC0+IFJlc3VsdDxWZWM8dTg+LCBTdHJpbmc+IHsKICAgIGlmIGxldCBTb21lKHJhd19oZXhfc3RyaW5nKSA9IHZhbHVlLnN0cmlwX3ByZWZpeCgiMHgiKSB7CiAgICAgICAgT2soaGV4OjpkZWNvZGUocmF3X2hleF9zdHJpbmcpLm1hcF9lcnIofGVycnwgZXJyLnRvX3N0cmluZygpKT8pCiAgICB9IGVsc2UgewogICAgICAgIEVycigiU2hvdWxkIGJlIGEgaGV4IHZhbHVlIHByZWZpeGVkIHdpdGggMHgiLnRvX3N0cmluZygpKQogICAgfQp9CgpmbiBldGhlcnNfbG9nX3RvX2ZmaV9sb2codmFsdWU6IExvZykgLT4gZmZpOjpMb2cgewogICAgZmZpOjpMb2cgewogICAgICAgIGFkZHJlc3M6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5hZGRyZXNzLmFzX2J5dGVzKCkpKSwKICAgICAgICB0b3BpY3M6IHZhbHVlCiAgICAgICAgICAgIC50b3BpY3MKICAgICAgICAgICAgLmludG9faXRlcigpCiAgICAgICAgICAgIC5tYXAofHRvcGljfCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodG9waWMuYXNfYnl0ZXMoKSkpKQogICAgICAgICAgICAuY29sbGVjdCgpLAogICAgICAgIGRhdGE6IHZhbHVlLmRhdGEuZW5jb2RlKCksCiAgICAgICAgYmxvY2tfaGFzaDogdmFsdWUKICAgICAgICAgICAgLmJsb2NrX2hhc2gKICAgICAgICAgICAgLm1hcCh8aGFzaHwgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGhhc2guYXNfYnl0ZXMoKSkpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICBibG9ja19udW1iZXI6IHZhbHVlLmJsb2NrX251bWJlci5tYXAofGJsb2NrfCBibG9jay5hc191NjQoKSksCiAgICAgICAgdHJhbnNhY3Rpb25faGFzaDogdmFsdWUKICAgICAgICAgICAgLnRyYW5zYWN0aW9uX2hhc2gKICAgICAgICAgICAgLm1hcCh8aGFzaHwgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGhhc2guYXNfYnl0ZXMoKSkpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICB0cmFuc2FjdGlvbl9pbmRleDogdmFsdWUudHJhbnNhY3Rpb25faW5kZXgubWFwKHxpbmRleHwgaW5kZXguYXNfdTY0KCkpLAogICAgICAgIGxvZ19pbmRleDogdmFsdWUKICAgICAgICAgICAgLmxvZ19pbmRleAogICAgICAgICAgICAubWFwKHxpbmRleHwgaW5kZXgudG9fc3RyaW5nKCkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIHRyYW5zYWN0aW9uX2xvZ19pbmRleDogdmFsdWUKICAgICAgICAgICAgLnRyYW5zYWN0aW9uX2xvZ19pbmRleAogICAgICAgICAgICAubWFwKHxpbmRleHwgaW5kZXgudG9fc3RyaW5nKCkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIGxvZ190eXBlOiB2YWx1ZS5sb2dfdHlwZS51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIHJlbW92ZWQ6IHZhbHVlLnJlbW92ZWQsCiAgICB9Cn0KCmZuIGV0aGVyc19yZWNlaXB0X3RvX2ZmaSh2YWx1ZTogVHJhbnNhY3Rpb25SZWNlaXB0KSAtPiBmZmk6OlRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICBmZmk6OlRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICAgICAgdHJhbnNhY3Rpb25faGFzaDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLnRyYW5zYWN0aW9uX2hhc2guYXNfYnl0ZXMoKSkpLAogICAgICAgIHRyYW5zYWN0aW9uX2luZGV4OiB2YWx1ZS50cmFuc2FjdGlvbl9pbmRleC5hc191NjQoKSwKICAgICAgICBibG9ja19oYXNoOiB2YWx1ZQogICAgICAgICAgICAuYmxvY2tfaGFzaAogICAgICAgICAgICAubWFwKHxoYXNofCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoaGFzaC5hc19ieXRlcygpKSkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIGJsb2NrX251bWJlcjogdmFsdWUuYmxvY2tfbnVtYmVyLm1hcCh8bnVtYmVyfCBudW1iZXIuYXNfdTY0KCkpLAogICAgICAgIGZyb206IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5mcm9tLmFzX2J5dGVzKCkpKSwKICAgICAgICB0bzogdmFsdWUKICAgICAgICAgICAgLnRvCiAgICAgICAgICAgIC5tYXAofGFkZHJlc3N8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShhZGRyZXNzLmFzX2J5dGVzKCkpKSkKICAgICAgICAgICAgLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICAgICAgY3VtdWxhdGl2ZV9nYXNfdXNlZDogdmFsdWUuY3VtdWxhdGl2ZV9nYXNfdXNlZC50b19zdHJpbmcoKSwKICAgICAgICBnYXNfdXNlZDogdmFsdWUKICAgICAgICAgICAgLmdhc191c2VkCiAgICAgICAgICAgIC5tYXAofGdhc3wgZ2FzLnRvX3N0cmluZygpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICBjb250cmFjdF9hZGRyZXNzOiB2YWx1ZQogICAgICAgICAgICAuY29udHJhY3RfYWRkcmVzcwogICAgICAgICAgICAubWFwKHxhZGRyZXNzfCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoYWRkcmVzcy5hc19ieXRlcygpKSkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIGxvZ3M6IHZhbHVlLmxvZ3MuaW50b19pdGVyKCkubWFwKGV0aGVyc19sb2dfdG9fZmZpX2xvZykuY29sbGVjdCgpLAogICAgICAgIHN0YXR1czogdmFsdWUuc3RhdHVzLm1hcCh8c3RhdHVzfCBzdGF0dXMuYXNfdTY0KCkpLAogICAgICAgIHJvb3Q6IHZhbHVlCiAgICAgICAgICAgIC5yb290CiAgICAgICAgICAgIC5tYXAofGhhc2h8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShoYXNoLmFzX2J5dGVzKCkpKSkKICAgICAgICAgICAgLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICAgICAgbG9nc19ibG9vbTogdmFsdWUubG9nc19ibG9vbS5hc19ieXRlcygpLnRvX3ZlYygpLAogICAgICAgIHRyYW5zYWN0aW9uX3R5cGU6IHZhbHVlLnRyYW5zYWN0aW9uX3R5cGUubWFwKHx2YWx8IHZhbC5hc191NjQoKSksCiAgICAgICAgZWZmZWN0aXZlX2dhc19wcmljZTogdmFsdWUKICAgICAgICAgICAgLmVmZmVjdGl2ZV9nYXNfcHJpY2UKICAgICAgICAgICAgLm1hcCh8Z2FzfCBnYXMudG9fc3RyaW5nKCkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgfQp9CgpmbiBldGhlcnNfdHJhbnNhY3Rpb25fdG9fZmZpKHZhbHVlOiBUcmFuc2FjdGlvbikgLT4gZmZpOjpUcmFuc2FjdGlvbiB7CiAgICBmZmk6OlRyYW5zYWN0aW9uIHsKICAgICAgICBoYXNoOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUuaGFzaC5hc19ieXRlcygpKSksCiAgICAgICAgbm9uY2U6IHZhbHVlLm5vbmNlLnRvX3N0cmluZygpLAogICAgICAgIGJsb2NrX2hhc2g6IHZhbHVlCiAgICAgICAgICAgIC5ibG9ja19oYXNoCiAgICAgICAgICAgIC5tYXAofGhhc2h8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShoYXNoLmFzX2J5dGVzKCkpKSkKICAgICAgICAgICAgLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICAgICAgYmxvY2tfbnVtYmVyOiB2YWx1ZS5ibG9ja19udW1iZXIubWFwKHxibG9ja3wgYmxvY2suYXNfdTY0KCkpLAogICAgICAgIHRyYW5zYWN0aW9uX2luZGV4OiB2YWx1ZS50cmFuc2FjdGlvbl9pbmRleC5tYXAofGluZGV4fCBpbmRleC5hc191NjQoKSksCiAgICAgICAgZnJvbTogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLmZyb20uYXNfYnl0ZXMoKSkpLAogICAgICAgIHRvOiB2YWx1ZQogICAgICAgICAgICAudG8KICAgICAgICAgICAgLm1hcCh8YWRkcmVzc3wgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGFkZHJlc3MuYXNfYnl0ZXMoKSkpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICB2YWx1ZTogdmFsdWUudmFsdWUudG9fc3RyaW5nKCksCiAgICAgICAgZ2FzX3ByaWNlOiB2YWx1ZQogICAgICAgICAgICAuZ2FzX3ByaWNlCiAgICAgICAgICAgIC5tYXAofGdhc3wgZ2FzLnRvX3N0cmluZygpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICBnYXM6IHZhbHVlLmdhcy50b19zdHJpbmcoKSwKICAgICAgICBpbnB1dDogdmFsdWUuaW5wdXQudG9fdmVjKCksCiAgICAgICAgdjogdmFsdWUudi50b19zdHJpbmcoKSwKICAgICAgICByOiB2YWx1ZS5yLmVuY29kZV9oZXgoKSwKICAgICAgICBzOiB2YWx1ZS5zLmVuY29kZV9oZXgoKSwKICAgIH0KfQoKZm4gZXRoZXJzX3N5bmNpbmdfc3RhdHVzX3RvX2ZmaSh2YWx1ZTogU3luY2luZ1N0YXR1cykgLT4gT3B0aW9uPGZmaTo6U3luY2luZ1N0YXR1cz4gewogICAgbWF0Y2ggdmFsdWUgewogICAgICAgIFN5bmNpbmdTdGF0dXM6OklzRmFsc2UgPT4gTm9uZSwKICAgICAgICBTeW5jaW5nU3RhdHVzOjpJc1N5bmNpbmcodmFsdWUpID0+IFNvbWUoZmZpOjpTeW5jaW5nU3RhdHVzIHsKICAgICAgICAgICAgY3VycmVudF9ibG9jazogdmFsdWUuY3VycmVudF9ibG9jay5hc191NjQoKSwKICAgICAgICAgICAgaGlnaGVzdF9ibG9jazogdmFsdWUuaGlnaGVzdF9ibG9jay5hc191NjQoKSwKICAgICAgICAgICAgc3RhcnRpbmdfYmxvY2s6IHZhbHVlLnN0YXJ0aW5nX2Jsb2NrLmFzX3U2NCgpLAogICAgICAgIH0pLAogICAgfQp9CgpmbiBldGhlcnNfZmVlX2hpc3RvcnlfdG9fZmZpKHZhbHVlOiBGZWVIaXN0b3J5KSAtPiBmZmk6OkZlZUhpc3RvcnkgewogICAgZmZpOjpGZWVIaXN0b3J5IHsKICAgICAgICBiYXNlX2ZlZV9wZXJfZ2FzOiB2YWx1ZQogICAgICAgICAgICAuYmFzZV9mZWVfcGVyX2dhcwogICAgICAgICAgICAuaXRlcigpCiAgICAgICAgICAgIC5tYXAofHZhbHwgdmFsLnRvX3N0cmluZygpKQogICAgICAgICAgICAuY29sbGVjdCgpLAogICAgICAgIGdhc191c2VkX3JhdGlvOiB2YWx1ZS5nYXNfdXNlZF9yYXRpbywKICAgICAgICBvbGRlc3RfYmxvY2s6IHZhbHVlLm9sZGVzdF9ibG9jay5hc191NjQoKSwKICAgICAgICByZXdhcmQ6IHZhbHVlCiAgICAgICAgICAgIC5yZXdhcmQKICAgICAgICAgICAgLml0ZXIoKQogICAgICAgICAgICAubWFwKHx2ZWN8IHsKICAgICAgICAgICAgICAgIHZlYy5pdGVyKCkKICAgICAgICAgICAgICAgICAgICAubWFwKHx2YWx8IHZhbC50b19zdHJpbmcoKSkKICAgICAgICAgICAgICAgICAgICAuY29sbGVjdDo6PFZlYzxTdHJpbmc+PigpCiAgICAgICAgICAgICAgICAgICAgLmpvaW4oIiwiKQogICAgICAgICAgICB9KQogICAgICAgICAgICAuY29sbGVjdCgpLAogICAgfQp9CgpmbiBoZWxpb3NfdHJhbnNhY3Rpb25zX3RvX2ZmaSh2YWx1ZTogVHJhbnNhY3Rpb25zKSAtPiBmZmk6OlRyYW5zYWN0aW9ucyB7CiAgICBtYXRjaCB2YWx1ZSB7CiAgICAgICAgVHJhbnNhY3Rpb25zOjpIYXNoZXMoaGFzaGVzKSA9PiBmZmk6OlRyYW5zYWN0aW9uczo6SGFzaGVzKAogICAgICAgICAgICBoYXNoZXMKICAgICAgICAgICAgICAgIC5pbnRvX2l0ZXIoKQogICAgICAgICAgICAgICAgLm1hcCh8aGFzaHwgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGhhc2guYXNfYnl0ZXMoKSkpKQogICAgICAgICAgICAgICAgLmNvbGxlY3QoKSwKICAgICAgICApLAogICAgICAgIFRyYW5zYWN0aW9uczo6RnVsbCh0cmFuc2FjdGlvbnMpID0+IGZmaTo6VHJhbnNhY3Rpb25zOjpGdWxsKAogICAgICAgICAgICB0cmFuc2FjdGlvbnMKICAgICAgICAgICAgICAgIC5pbnRvX2l0ZXIoKQogICAgICAgICAgICAgICAgLm1hcChldGhlcnNfdHJhbnNhY3Rpb25fdG9fZmZpKQogICAgICAgICAgICAgICAgLmNvbGxlY3QoKSwKICAgICAgICApLAogICAgfQp9CgpmbiBoZWxpb3NfZXhlY3V0aW9uX2Jsb2NrX3RvX2ZmaSh2YWx1ZTogRXhlY3V0aW9uQmxvY2spIC0+IGZmaTo6RXhlY3V0aW9uQmxvY2sgewogICAgZmZpOjpFeGVjdXRpb25CbG9jayB7CiAgICAgICAgbnVtYmVyOiB2YWx1ZS5udW1iZXIsCiAgICAgICAgYmFzZV9mZWVfcGVyX2dhczogdmFsdWUuYmFzZV9mZWVfcGVyX2dhcy50b19zdHJpbmcoKSwKICAgICAgICBkaWZmaWN1bHR5OiB2YWx1ZS5kaWZmaWN1bHR5LnRvX3N0cmluZygpLAogICAgICAgIGV4dHJhX2RhdGE6IHZhbHVlLmV4dHJhX2RhdGEudG9fdmVjKCksCiAgICAgICAgZ2FzX2xpbWl0OiB2YWx1ZS5nYXNfbGltaXQsCiAgICAgICAgZ2FzX3VzZWQ6IHZhbHVlLmdhc191c2VkLAogICAgICAgIGhhc2g6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5oYXNoLmFzX2J5dGVzKCkpKSwKICAgICAgICBsb2dzX2Jsb29tOiB2YWx1ZS5sb2dzX2Jsb29tLnRvX3ZlYygpLAogICAgICAgIG1pbmVyOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUubWluZXIuYXNfYnl0ZXMoKSkpLAogICAgICAgIG1peF9oYXNoOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUubWl4X2hhc2guYXNfYnl0ZXMoKSkpLAogICAgICAgIG5vbmNlOiB2YWx1ZS5ub25jZS50b19zdHJpbmcoKSwKICAgICAgICBwYXJlbnRfaGFzaDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLnBhcmVudF9oYXNoLmFzX2J5dGVzKCkpKSwKICAgICAgICByZWNlaXB0c19yb290OiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUucmVjZWlwdHNfcm9vdC5hc19ieXRlcygpKSksCiAgICAgICAgc2hhM191bmNsZXM6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5zaGEzX3VuY2xlcy5hc19ieXRlcygpKSksCiAgICAgICAgc2l6ZTogdmFsdWUuc2l6ZSwKICAgICAgICBzdGF0ZV9yb290OiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUuc3RhdGVfcm9vdC5hc19ieXRlcygpKSksCiAgICAgICAgdGltZXN0YW1wOiB2YWx1ZS50aW1lc3RhbXAsCiAgICAgICAgdG90YWxfZGlmZmljdWx0eTogdmFsdWUudG90YWxfZGlmZmljdWx0eSwKICAgICAgICB0cmFuc2FjdGlvbnM6IGhlbGlvc190cmFuc2FjdGlvbnNfdG9fZmZpKHZhbHVlLnRyYW5zYWN0aW9ucyksCiAgICAgICAgdHJhbnNhY3Rpb25zX3Jvb3Q6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS50cmFuc2FjdGlvbnNfcm9vdC5hc19ieXRlcygpKSksCiAgICAgICAgdW5jbGVzOiB2YWx1ZQogICAgICAgICAgICAudW5jbGVzCiAgICAgICAgICAgIC5pbnRvX2l0ZXIoKQogICAgICAgICAgICAubWFwKHxoYXNofCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoaGFzaC5hc19ieXRlcygpKSkpCiAgICAgICAgICAgIC5jb2xsZWN0KCksCiAgICB9Cn0KCmZuIGhlbGlvc19oZWFkZXJfdG9fZmZpKHZhbHVlOiBIZWFkZXIpIC0+IGZmaTo6SGVhZGVyIHsKICAgIGZmaTo6SGVhZGVyIHsKICAgICAgICBzbG90OiB2YWx1ZS5zbG90LAogICAgICAgIHByb3Bvc2VyX2luZGV4OiB2YWx1ZS5wcm9wb3Nlcl9pbmRleCwKICAgICAgICBwYXJlbnRfcm9vdDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLnBhcmVudF9yb290KSksCiAgICAgICAgc3RhdGVfcm9vdDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLnN0YXRlX3Jvb3QpKSwKICAgICAgICBib2R5X3Jvb3Q6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5ib2R5X3Jvb3QpKSwKICAgIH0KfQoKcHViIHN0cnVjdCBPcHRpb25hbEZpbGVEQiB7CiAgICBmaWxlX2RiOiBPcHRpb248RmlsZURCPiwKICAgIGRlZmF1bHRfY2hlY2twb2ludDogVmVjPHU4PiwKfQoKaW1wbCBEYXRhYmFzZSBmb3IgT3B0aW9uYWxGaWxlREIgewogICAgZm4gbmV3KGNvbmZpZzogJkNvbmZpZykgLT4gUmVzdWx0PFNlbGYsIFJlcG9ydD4gewogICAgICAgIGlmIGxldCBTb21lKF9kYXRhX2RpcikgPSAmY29uZmlnLmRhdGFfZGlyIHsKICAgICAgICAgICAgT2soT3B0aW9uYWxGaWxlREIgewogICAgICAgICAgICAgICAgZmlsZV9kYjogU29tZShGaWxlREI6Om5ldyhjb25maWcpPyksCiAgICAgICAgICAgICAgICBkZWZhdWx0X2NoZWNrcG9pbnQ6IGNvbmZpZy5kZWZhdWx0X2NoZWNrcG9pbnQuY2xvbmUoKSwKICAgICAgICAgICAgfSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBPayhPcHRpb25hbEZpbGVEQiB7CiAgICAgICAgICAgICAgICBmaWxlX2RiOiBOb25lLAogICAgICAgICAgICAgICAgZGVmYXVsdF9jaGVja3BvaW50OiBjb25maWcuZGVmYXVsdF9jaGVja3BvaW50LmNsb25lKCksCiAgICAgICAgICAgIH0pCiAgICAgICAgfQogICAgfQoKICAgIGZuIHNhdmVfY2hlY2twb2ludCgmc2VsZiwgY2hlY2twb2ludDogVmVjPHU4PikgLT4gUmVzdWx0PCgpLCBSZXBvcnQ+IHsKICAgICAgICBpZiBsZXQgU29tZShmaWxlX2RiKSA9ICZzZWxmLmZpbGVfZGIgewogICAgICAgICAgICBmaWxlX2RiLnNhdmVfY2hlY2twb2ludChjaGVja3BvaW50KQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIE9rKCgpKQogICAgICAgIH0KICAgIH0KCiAgICBmbiBsb2FkX2NoZWNrcG9pbnQoJnNlbGYpIC0+IFJlc3VsdDxWZWM8dTg+LCBSZXBvcnQ+IHsKICAgICAgICBpZiBsZXQgU29tZShmaWxlX2RiKSA9ICZzZWxmLmZpbGVfZGIgewogICAgICAgICAgICBmaWxlX2RiLmxvYWRfY2hlY2twb2ludCgpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgT2soc2VsZi5kZWZhdWx0X2NoZWNrcG9pbnQuY2xvbmUoKSkKICAgICAgICB9CiAgICB9Cn0KCnB1YiBzdHJ1Y3QgSGVsaW9zQ2xpZW50IHsKICAgIGNsaWVudDogT3B0aW9uPENsaWVudDxPcHRpb25hbEZpbGVEQj4+LAogICAgaXNfbG9nZ2luZzogYm9vbCwKfQo="

rust::build
build::lipo
build::generate_c_headers
build::xcframework

post_build::compress
post_build::copy_bridge_files
post_build::success
