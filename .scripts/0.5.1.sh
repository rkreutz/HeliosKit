#! /bin/zsh -e

source ".scripts/functions.sh"

set -e

PACKAGE_VERSION=0.5.1
SWIFT_BRIDGE_PACKAGE='git = "https:\/\/github.com\/rkreutz\/swift-bridge.git", branch = "feature\/struct-vec-support"'
SWIFT_BRIDGE_FEATURES='["async", "compatibility"]'
ETHERS_VERSION=2.0.2
USES_LOGGER=false
USES_TRACING=true
RUST_TOOLCHAIN='stable'

env::setup
env::build_configuration $1

rust::setup

pre_build::create_build_directory
pre_build::setup_helios
pre_build::modify_helios "dXNlIDo6Y2xpZW50Ojp7Q2xpZW50LCBDbGllbnRCdWlsZGVyfTsKdXNlIDo6Y29uZmlnOjp7bmV0d29ya3MsIENvbmZpZ307CnVzZSA6OmNvbnNlbnN1czo6ZGF0YWJhc2U6OntEYXRhYmFzZSwgRmlsZURCfTsKdXNlIDo6Y29tbW9uOjp0eXBlczo6e0Jsb2NrLCBUcmFuc2FjdGlvbnN9Owp1c2UgZXRoZXJzOjp7CiAgICBhYmk6OkFiaUVuY29kZSwKICAgIHByZWx1ZGU6OntBZGRyZXNzLCBIMjU2LCBVMjU2LCBVNjR9LAogICAgdHlwZXM6OnsKICAgICAgICBCbG9ja051bWJlciwgRmlsdGVyLCBGaWx0ZXJCbG9ja09wdGlvbiwgTG9nLCBTeW5jaW5nU3RhdHVzLCBUcmFuc2FjdGlvbiwKICAgICAgICBUcmFuc2FjdGlvblJlY2VpcHQsIFZhbHVlT3JBcnJheQogICAgfSwKfTsKdXNlIGV5cmU6OlJlcG9ydDsKdXNlIHRyYWNpbmdfc3Vic2NyaWJlcjo6ZmlsdGVyOjp7RW52RmlsdGVyLCBMZXZlbEZpbHRlcn07CnVzZSB0cmFjaW5nX3N1YnNjcmliZXI6OkZtdFN1YnNjcmliZXI7CgojW3N3aWZ0X2JyaWRnZTo6YnJpZGdlXQptb2QgZmZpIHsKCiAgICBlbnVtIEJsb2NrVGFnIHsKICAgICAgICBMYXRlc3QsCiAgICAgICAgRmluYWxpemVkLAogICAgICAgIFNhZmUsCiAgICAgICAgRWFybGllc3QsCiAgICAgICAgUGVuZGluZywKICAgICAgICBOdW1iZXIodTY0KSwKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IENhbGxPcHRzIHsKICAgICAgICBwdWIgZnJvbTogU3RyaW5nLAogICAgICAgIHB1YiB0bzogU3RyaW5nLAogICAgICAgIHB1YiBnYXM6IFN0cmluZywKICAgICAgICBwdWIgZ2FzX3ByaWNlOiBTdHJpbmcsCiAgICAgICAgcHViIHZhbHVlOiBTdHJpbmcsCiAgICAgICAgcHViIGRhdGE6IFN0cmluZywKICAgIH0KCiAgICBlbnVtIEhlbGlvc05ldHdvcmsgewogICAgICAgIE1BSU5ORVQsCiAgICAgICAgR09FUkxJLAogICAgICAgIFNFUE9MSUEsCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBTdGFydFVwU3RhdGUgewogICAgICAgIHN0YXJ0ZWQ6IGJvb2wsCiAgICAgICAgZXJyb3I6IFN0cmluZywKICAgIH0KCiAgICBlbnVtIEZpbHRlckJsb2NrT3B0aW9uIHsKICAgICAgICBSYW5nZSB7CiAgICAgICAgICAgIGZyb21fYmxvY2s6IE9wdGlvbjxCbG9ja1RhZz4sCiAgICAgICAgICAgIHRvX2Jsb2NrOiBPcHRpb248QmxvY2tUYWc+LAogICAgICAgIH0sCiAgICAgICAgQXRCbG9ja0hhc2goU3RyaW5nKSwKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IExvZ0ZpbHRlciB7CiAgICAgICAgcHViIGJsb2NrX29wdGlvbjogRmlsdGVyQmxvY2tPcHRpb24sCiAgICAgICAgcHViIGFkZHJlc3M6IFN0cmluZywKICAgICAgICBwdWIgdG9waWNzOiBWZWM8U3RyaW5nPiwKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgI1tkZXJpdmUoQ2xvbmUpXQogICAgc3RydWN0IExvZyB7CiAgICAgICAgYWRkcmVzczogU3RyaW5nLAogICAgICAgIHRvcGljczogVmVjPFN0cmluZz4sCiAgICAgICAgZGF0YTogVmVjPHU4PiwKICAgICAgICBibG9ja19oYXNoOiBTdHJpbmcsCiAgICAgICAgYmxvY2tfbnVtYmVyOiBPcHRpb248dTY0PiwKICAgICAgICB0cmFuc2FjdGlvbl9oYXNoOiBTdHJpbmcsCiAgICAgICAgdHJhbnNhY3Rpb25faW5kZXg6IE9wdGlvbjx1NjQ+LAogICAgICAgIGxvZ19pbmRleDogU3RyaW5nLAogICAgICAgIHRyYW5zYWN0aW9uX2xvZ19pbmRleDogU3RyaW5nLAogICAgICAgIGxvZ190eXBlOiBTdHJpbmcsCiAgICAgICAgcmVtb3ZlZDogT3B0aW9uPGJvb2w+LAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgVHJhbnNhY3Rpb25SZWNlaXB0IHsKICAgICAgICB0cmFuc2FjdGlvbl9oYXNoOiBTdHJpbmcsCiAgICAgICAgdHJhbnNhY3Rpb25faW5kZXg6IHU2NCwKICAgICAgICBibG9ja19oYXNoOiBTdHJpbmcsIC8vIG9wdGlvbmFsCiAgICAgICAgYmxvY2tfbnVtYmVyOiBPcHRpb248dTY0PiwKICAgICAgICBmcm9tOiBTdHJpbmcsCiAgICAgICAgdG86IFN0cmluZywgLy8gb3B0aW9uYWwKICAgICAgICBjdW11bGF0aXZlX2dhc191c2VkOiBTdHJpbmcsCiAgICAgICAgZ2FzX3VzZWQ6IFN0cmluZywgICAgICAgICAvLyBvcHRpb25hbAogICAgICAgIGNvbnRyYWN0X2FkZHJlc3M6IFN0cmluZywgLy8gb3B0aW9uYWwKICAgICAgICBsb2dzOiBWZWM8TG9nPiwKICAgICAgICBzdGF0dXM6IE9wdGlvbjx1NjQ+LAogICAgICAgIHJvb3Q6IFN0cmluZywgLy8gb3B0aW9ubmFsCiAgICAgICAgbG9nc19ibG9vbTogVmVjPHU4PiwKICAgICAgICB0cmFuc2FjdGlvbl90eXBlOiBPcHRpb248dTY0PiwKICAgICAgICBlZmZlY3RpdmVfZ2FzX3ByaWNlOiBTdHJpbmcsIC8vb3B0aW9uYWwKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgI1tkZXJpdmUoQ2xvbmUpXQogICAgc3RydWN0IFRyYW5zYWN0aW9uIHsKICAgICAgICBoYXNoOiBTdHJpbmcsCiAgICAgICAgbm9uY2U6IFN0cmluZywKICAgICAgICBibG9ja19oYXNoOiBTdHJpbmcsIC8vb3B0aW9uYWwKICAgICAgICBibG9ja19udW1iZXI6IE9wdGlvbjx1NjQ+LAogICAgICAgIHRyYW5zYWN0aW9uX2luZGV4OiBPcHRpb248dTY0PiwKICAgICAgICBmcm9tOiBTdHJpbmcsCiAgICAgICAgdG86IFN0cmluZywgLy8gb3B0aW9uYWwKICAgICAgICB2YWx1ZTogU3RyaW5nLAogICAgICAgIGdhc19wcmljZTogU3RyaW5nLCAvLyBvcHRpb25hbAogICAgICAgIGdhczogU3RyaW5nLAogICAgICAgIGlucHV0OiBWZWM8dTg+LAogICAgICAgIHY6IFN0cmluZywKICAgICAgICByOiBTdHJpbmcsCiAgICAgICAgczogU3RyaW5nLAogICAgfQoKICAgIGVudW0gVHJhbnNhY3Rpb25zIHsKICAgICAgICBIYXNoZXMoVmVjPFN0cmluZz4pLAogICAgICAgIEZ1bGwoVmVjPFRyYW5zYWN0aW9uPiksCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBCbG9jayB7CiAgICAgICAgbnVtYmVyOiB1NjQsCiAgICAgICAgYmFzZV9mZWVfcGVyX2dhczogU3RyaW5nLAogICAgICAgIGRpZmZpY3VsdHk6IFN0cmluZywKICAgICAgICBleHRyYV9kYXRhOiBWZWM8dTg+LAogICAgICAgIGdhc19saW1pdDogdTY0LAogICAgICAgIGdhc191c2VkOiB1NjQsCiAgICAgICAgaGFzaDogU3RyaW5nLAogICAgICAgIGxvZ3NfYmxvb206IFZlYzx1OD4sCiAgICAgICAgbWluZXI6IFN0cmluZywKICAgICAgICBtaXhfaGFzaDogU3RyaW5nLAogICAgICAgIG5vbmNlOiBTdHJpbmcsCiAgICAgICAgcGFyZW50X2hhc2g6IFN0cmluZywKICAgICAgICByZWNlaXB0c19yb290OiBTdHJpbmcsCiAgICAgICAgc2hhM191bmNsZXM6IFN0cmluZywKICAgICAgICBzaXplOiB1NjQsCiAgICAgICAgc3RhdGVfcm9vdDogU3RyaW5nLAogICAgICAgIHRpbWVzdGFtcDogdTY0LAogICAgICAgIHRvdGFsX2RpZmZpY3VsdHk6IHU2NCwKICAgICAgICB0cmFuc2FjdGlvbnM6IFRyYW5zYWN0aW9ucywKICAgICAgICB0cmFuc2FjdGlvbnNfcm9vdDogU3RyaW5nLAogICAgICAgIHVuY2xlczogVmVjPFN0cmluZz4sCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBTeW5jaW5nU3RhdHVzIHsKICAgICAgICBwdWIgY3VycmVudF9ibG9jazogdTY0LAogICAgICAgIHB1YiBoaWdoZXN0X2Jsb2NrOiB1NjQsCiAgICAgICAgcHViIHN0YXJ0aW5nX2Jsb2NrOiB1NjQsCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBSZXNwb25zZVU2NCB7CiAgICAgICAgdmFsdWU6IHU2NCwKICAgICAgICBmYWlsZWQ6IGJvb2wsCiAgICAgICAgZXJyb3I6IFN0cmluZywKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IFJlc3BvbnNlU3RyaW5nIHsKICAgICAgICB2YWx1ZTogU3RyaW5nLAogICAgICAgIGZhaWxlZDogYm9vbCwKICAgICAgICBlcnJvcjogU3RyaW5nLAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgUmVzcG9uc2VWZWM4IHsKICAgICAgICB2YWx1ZTogVmVjPHU4PiwKICAgICAgICBmYWlsZWQ6IGJvb2wsCiAgICAgICAgZXJyb3I6IFN0cmluZywKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IFJlc3BvbnNlVmVjTG9nIHsKICAgICAgICB2YWx1ZTogVmVjPExvZz4sCiAgICAgICAgZmFpbGVkOiBib29sLAogICAgICAgIGVycm9yOiBTdHJpbmcsCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBSZXNwb25zZVRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICAgICAgdmFsdWU6IE9wdGlvbjxUcmFuc2FjdGlvblJlY2VpcHQ+LAogICAgICAgIGZhaWxlZDogYm9vbCwKICAgICAgICBlcnJvcjogU3RyaW5nLAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgUmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgdmFsdWU6IE9wdGlvbjxUcmFuc2FjdGlvbj4sCiAgICAgICAgZmFpbGVkOiBib29sLAogICAgICAgIGVycm9yOiBTdHJpbmcsCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBSZXNwb25zZUJsb2NrIHsKICAgICAgICB2YWx1ZTogT3B0aW9uPEJsb2NrPiwKICAgICAgICBmYWlsZWQ6IGJvb2wsCiAgICAgICAgZXJyb3I6IFN0cmluZywKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IFJlc3BvbnNlU3luY2luZyB7CiAgICAgICAgdmFsdWU6IE9wdGlvbjxTeW5jaW5nU3RhdHVzPiwKICAgICAgICBmYWlsZWQ6IGJvb2wsCiAgICAgICAgZXJyb3I6IFN0cmluZywKICAgIH0KCiAgICBleHRlcm4gIlJ1c3QiIHsKICAgICAgICB0eXBlIEhlbGlvc0NsaWVudDsKCiAgICAgICAgI1tzd2lmdF9icmlkZ2UoaW5pdCldCiAgICAgICAgZm4gbmV3KCkgLT4gSGVsaW9zQ2xpZW50OwoKICAgICAgICBhc3luYyBmbiBzdGFydCgKICAgICAgICAgICAgJm11dCBzZWxmLAogICAgICAgICAgICB1bnRydXN0ZWRfcnBjX3VybDogU3RyaW5nLAogICAgICAgICAgICBjb25zZW5zdXNfcnBjX3VybDogU3RyaW5nLAogICAgICAgICAgICBjaGVja3BvaW50OiBPcHRpb248U3RyaW5nPiwKICAgICAgICAgICAgcnBjX2lwOiBTdHJpbmcsCiAgICAgICAgICAgIHJwY19wb3J0OiB1MTYsCiAgICAgICAgICAgIG5ldHdvcms6IEhlbGlvc05ldHdvcmssCiAgICAgICAgICAgIGRhdGFfZGlyOiBPcHRpb248U3RyaW5nPiwKICAgICAgICApIC0+IFN0YXJ0VXBTdGF0ZTsKCiAgICAgICAgYXN5bmMgZm4gc2h1dGRvd24oJm11dCBzZWxmKTsKCiAgICAgICAgYXN5bmMgZm4gY2FsbCgmc2VsZiwgb3B0czogQ2FsbE9wdHMsIGJsb2NrOiBCbG9ja1RhZykgLT4gUmVzcG9uc2VWZWM4OwogICAgICAgIGFzeW5jIGZuIHNlbmRfcmF3X3RyYW5zYWN0aW9uKCZzZWxmLCBieXRlczogVmVjPHU4PikgLT4gUmVzcG9uc2VTdHJpbmc7CgogICAgICAgIGFzeW5jIGZuIGVzdGltYXRlX2dhcygmc2VsZiwgb3B0czogQ2FsbE9wdHMpIC0+IFJlc3BvbnNlVTY0OwogICAgICAgIGFzeW5jIGZuIGNoYWluX2lkKCZzZWxmKSAtPiBSZXNwb25zZVU2NDsKICAgICAgICBhc3luYyBmbiBnZXRfZ2FzX3ByaWNlKCZzZWxmKSAtPiBSZXNwb25zZVN0cmluZzsKICAgICAgICBhc3luYyBmbiBnZXRfcHJpb3JpdHlfZmVlKCZzZWxmKSAtPiBSZXNwb25zZVN0cmluZzsKICAgICAgICBhc3luYyBmbiBnZXRfYmxvY2tfbnVtYmVyKCZzZWxmKSAtPiBSZXNwb25zZVN0cmluZzsKICAgICAgICBhc3luYyBmbiBnZXRfY29pbmJhc2UoJnNlbGYpIC0+IFJlc3BvbnNlU3RyaW5nOwoKICAgICAgICBhc3luYyBmbiBnZXRfYmFsYW5jZSgmc2VsZiwgYWRkcmVzczogU3RyaW5nLCBibG9jazogQmxvY2tUYWcpIC0+IFJlc3BvbnNlU3RyaW5nOwogICAgICAgIGFzeW5jIGZuIGdldF9ub25jZSgmc2VsZiwgYWRkcmVzczogU3RyaW5nLCBibG9jazogQmxvY2tUYWcpIC0+IFJlc3BvbnNlVTY0OwoKICAgICAgICBhc3luYyBmbiBnZXRfYmxvY2tfYnlfbnVtYmVyKAogICAgICAgICAgICAmc2VsZiwKICAgICAgICAgICAgYmxvY2s6IEJsb2NrVGFnLAogICAgICAgICAgICBmdWxsX3R4OiBib29sLAogICAgICAgICkgLT4gUmVzcG9uc2VCbG9jazsKICAgICAgICBhc3luYyBmbiBnZXRfYmxvY2tfYnlfaGFzaCgmc2VsZiwgaGFzaDogU3RyaW5nLCBmdWxsX3R4OiBib29sKSAtPiBSZXNwb25zZUJsb2NrOwogICAgICAgIGFzeW5jIGZuIGdldF9ibG9ja190cmFuc2FjdGlvbl9jb3VudF9ieV9oYXNoKCZzZWxmLCBoYXNoOiBTdHJpbmcpIC0+IFJlc3BvbnNlVTY0OwogICAgICAgIGFzeW5jIGZuIGdldF9ibG9ja190cmFuc2FjdGlvbl9jb3VudF9ieV9udW1iZXIoJnNlbGYsIGJsb2NrOiBCbG9ja1RhZykgLT4gUmVzcG9uc2VVNjQ7CgogICAgICAgIGFzeW5jIGZuIGdldF90cmFuc2FjdGlvbl9yZWNlaXB0KCZzZWxmLCB0eF9oYXNoOiBTdHJpbmcpIC0+IFJlc3BvbnNlVHJhbnNhY3Rpb25SZWNlaXB0OwogICAgICAgIGFzeW5jIGZuIGdldF90cmFuc2FjdGlvbl9ieV9oYXNoKCZzZWxmLCB0eF9oYXNoOiBTdHJpbmcpIC0+IFJlc3BvbnNlVHJhbnNhY3Rpb247CiAgICAgICAgYXN5bmMgZm4gZ2V0X3RyYW5zYWN0aW9uX2J5X2Jsb2NrX2hhc2hfYW5kX2luZGV4KAogICAgICAgICAgICAmc2VsZiwKICAgICAgICAgICAgYmxvY2tfaGFzaDogU3RyaW5nLAogICAgICAgICAgICBpbmRleDogdTY0LAogICAgICAgICkgLT4gUmVzcG9uc2VUcmFuc2FjdGlvbjsKCiAgICAgICAgYXN5bmMgZm4gZ2V0X2xvZ3MoJnNlbGYsIGZpbHRlcjogTG9nRmlsdGVyKSAtPiBSZXNwb25zZVZlY0xvZzsKCiAgICAgICAgYXN5bmMgZm4gZ2V0X2NvZGUoJnNlbGYsIGFkZHJlc3M6IFN0cmluZywgYmxvY2s6IEJsb2NrVGFnKSAtPiBSZXNwb25zZVZlYzg7CiAgICAgICAgYXN5bmMgZm4gZ2V0X3N0b3JhZ2VfYXQoCiAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICBhZGRyZXNzOiBTdHJpbmcsCiAgICAgICAgICAgIHNsb3Q6IFN0cmluZywKICAgICAgICAgICAgYmxvY2s6IEJsb2NrVGFnLAogICAgICAgICkgLT4gUmVzcG9uc2VTdHJpbmc7CgogICAgICAgIGFzeW5jIGZuIHN5bmNpbmcoJnNlbGYpIC0+IFJlc3BvbnNlU3luY2luZzsKICAgIH0KfQoKaW1wbCBIZWxpb3NDbGllbnQgewogICAgcHViIGZuIG5ldygpIC0+IEhlbGlvc0NsaWVudCB7CiAgICAgICAgSGVsaW9zQ2xpZW50IHsKICAgICAgICAgICAgY2xpZW50OiBOb25lLAogICAgICAgICAgICBpc19sb2dnaW5nOiBmYWxzZSwKICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gc3RhcnQoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHVudHJ1c3RlZF9ycGNfdXJsOiBTdHJpbmcsCiAgICAgICAgY29uc2Vuc3VzX3JwY191cmw6IFN0cmluZywKICAgICAgICBjaGVja3BvaW50OiBPcHRpb248U3RyaW5nPiwKICAgICAgICBycGNfaXA6IFN0cmluZywKICAgICAgICBycGNfcG9ydDogdTE2LAogICAgICAgIG5ldHdvcms6IGZmaTo6SGVsaW9zTmV0d29yaywKICAgICAgICBkYXRhX2RpcjogT3B0aW9uPFN0cmluZz4sCiAgICApIC0+IGZmaTo6U3RhcnRVcFN0YXRlIHsKICAgICAgICBpZiBsZXQgU29tZShfY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIHJldHVybiBmZmk6OlN0YXJ0VXBTdGF0ZSB7CiAgICAgICAgICAgICAgICBzdGFydGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiQ2xpZW50IGhhcyBhbHJlYWR5IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIGlmICFzZWxmLmlzX2xvZ2dpbmcgewogICAgICAgICAgICBzZWxmLmlzX2xvZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICBsZXQgZW52X2ZpbHRlciA9IEVudkZpbHRlcjo6YnVpbGRlcigpCiAgICAgICAgICAgICAgICAud2l0aF9kZWZhdWx0X2RpcmVjdGl2ZShMZXZlbEZpbHRlcjo6SU5GTy5pbnRvKCkpCiAgICAgICAgICAgICAgICAuZnJvbV9lbnYoKQogICAgICAgICAgICAgICAgLmV4cGVjdCgiaW52YWxpZCBlbnYgZmlsdGVyIik7CiAgICAgICAgCiAgICAgICAgICAgIGxldCBzdWJzY3JpYmVyID0gRm10U3Vic2NyaWJlcjo6YnVpbGRlcigpCiAgICAgICAgICAgICAgICAud2l0aF9lbnZfZmlsdGVyKGVudl9maWx0ZXIpCiAgICAgICAgICAgICAgICAuZmluaXNoKCk7CiAgICAgICAgCiAgICAgICAgICAgIHRyYWNpbmc6OnN1YnNjcmliZXI6OnNldF9nbG9iYWxfZGVmYXVsdChzdWJzY3JpYmVyKS5leHBlY3QoInN1YnNjcmliZXIgc2V0IGZhaWxlZCIpOwogICAgICAgIH0KCiAgICAgICAgbGV0IG11dCBjbGllbnRfYnVpbGRlciA9IENsaWVudEJ1aWxkZXI6Om5ldygpCiAgICAgICAgICAgIC5uZXR3b3JrKG5ldHdvcmsudG9fYmFzZV9uZXR3b3JrKCkpCiAgICAgICAgICAgIC5leGVjdXRpb25fcnBjKCZ1bnRydXN0ZWRfcnBjX3VybCkKICAgICAgICAgICAgLmNvbnNlbnN1c19ycGMoJmNvbnNlbnN1c19ycGNfdXJsKQogICAgICAgICAgICAucnBjX3BvcnQocnBjX3BvcnQpOwoKICAgICAgICBtYXRjaCBycGNfaXAucGFyc2UoKSB7CiAgICAgICAgICAgIE9rKGlwKSA9PiBjbGllbnRfYnVpbGRlciA9IGNsaWVudF9idWlsZGVyLnJwY19iaW5kX2lwKGlwKSwKICAgICAgICAgICAgRXJyKGVycikgPT4gcmV0dXJuIGZmaTo6U3RhcnRVcFN0YXRlIHsKICAgICAgICAgICAgICAgIHN0YXJ0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgZXJyb3I6IGVyci50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KCiAgICAgICAgaWYgbGV0IFNvbWUoY2hlY2twb2ludCkgPSAmY2hlY2twb2ludCB7CiAgICAgICAgICAgIGNsaWVudF9idWlsZGVyID0gY2xpZW50X2J1aWxkZXIuY2hlY2twb2ludCgmY2hlY2twb2ludCk7CiAgICAgICAgfQoKICAgICAgICBpZiBsZXQgU29tZShkYXRhX2RpcikgPSAmZGF0YV9kaXIgewogICAgICAgICAgICBjbGllbnRfYnVpbGRlciA9IGNsaWVudF9idWlsZGVyLmRhdGFfZGlyKCgmZGF0YV9kaXIpLmludG8oKSk7CiAgICAgICAgfQoKICAgICAgICBtYXRjaCBjbGllbnRfYnVpbGRlci5idWlsZCgpIHsKICAgICAgICAgICAgRXJyKGVycm9yKSA9PiB7CiAgICAgICAgICAgICAgICByZXR1cm4gZmZpOjpTdGFydFVwU3RhdGUgewogICAgICAgICAgICAgICAgICAgIHN0YXJ0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfQogICAgICAgICAgICBPayhtdXQgY2xpZW50KSA9PiBtYXRjaCBjbGllbnQuc3RhcnQoKS5hd2FpdCB7CiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IHsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmZpOjpTdGFydFVwU3RhdGUgewogICAgICAgICAgICAgICAgICAgICAgICBzdGFydGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIE9rKCgpKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgc2VsZi5jbGllbnQgPSBTb21lKGNsaWVudCk7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZmaTo6U3RhcnRVcFN0YXRlIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH07CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0sCiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIHNodXRkb3duKCZtdXQgc2VsZikgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBjbGllbnQuc2h1dGRvd24oKS5hd2FpdDsKICAgICAgICAgICAgc2VsZi5jbGllbnQgPSBOb25lOwogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBjYWxsKCZzZWxmLCBvcHRzOiBmZmk6OkNhbGxPcHRzLCBibG9jazogZmZpOjpCbG9ja1RhZykgLT4gZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCAmb3B0cy50b19iYXNlX29wdHMoKSB7CiAgICAgICAgICAgICAgICBPayhvcHRzKSA9PiBtYXRjaCBjbGllbnQuY2FsbChvcHRzLCBibG9jay50b19iYXNlX2Jsb2NrKCkpLmF3YWl0IHsKICAgICAgICAgICAgICAgICAgICBPayhkYXRhKSA9PiBmZmk6OlJlc3BvbnNlVmVjOCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBkYXRhLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VWZWM4IHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IFtdLmludG8oKSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VWZWM4IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogW10uaW50bygpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiSW52YWxpZCBjYWxsIG9wdGlvbnM6IHt9IiwgZXJyb3IpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VWZWM4IHsKICAgICAgICAgICAgICAgIHZhbHVlOiBbXS5pbnRvKCksCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBzZW5kX3Jhd190cmFuc2FjdGlvbigmc2VsZiwgYnl0ZXM6IFZlYzx1OD4pIC0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBjbGllbnQuc2VuZF9yYXdfdHJhbnNhY3Rpb24oJmJ5dGVzKS5hd2FpdCB7CiAgICAgICAgICAgICAgICBPayhoYXNoKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGhhc2gpKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBlc3RpbWF0ZV9nYXMoJnNlbGYsIG9wdHM6IGZmaTo6Q2FsbE9wdHMpIC0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCAmb3B0cy50b19iYXNlX29wdHMoKSB7CiAgICAgICAgICAgICAgICBPayhvcHRzKSA9PiBtYXRjaCBjbGllbnQuZXN0aW1hdGVfZ2FzKCZvcHRzKS5hd2FpdCB7CiAgICAgICAgICAgICAgICAgICAgT2soZ2FzKSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGdhcywKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIkludmFsaWQgY2FsbCBvcHRpb25zOiB7fSIsIGVycm9yKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gY2hhaW5faWQoJnNlbGYpIC0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgIHZhbHVlOiBjbGllbnQuY2hhaW5faWQoKS5hd2FpdCwKICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CiAgICBhc3luYyBmbiBnZXRfZ2FzX3ByaWNlKCZzZWxmKSAtPiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggY2xpZW50LmdldF9nYXNfcHJpY2UoKS5hd2FpdCB7CiAgICAgICAgICAgICAgICBPayhnYXNfcHJpY2UpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBnYXNfcHJpY2UudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9wcmlvcml0eV9mZWUoJnNlbGYpIC0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBjbGllbnQuZ2V0X3ByaW9yaXR5X2ZlZSgpLmF3YWl0IHsKICAgICAgICAgICAgICAgIE9rKHByaW9yaXR5X2ZlZSkgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHByaW9yaXR5X2ZlZS50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X2Jsb2NrX251bWJlcigmc2VsZikgLT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGNsaWVudC5nZXRfYmxvY2tfbnVtYmVyKCkuYXdhaXQgewogICAgICAgICAgICAgICAgT2soYmxvY2spID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBibG9jay50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiMCIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgIHZhbHVlOiAiMCIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfY29pbmJhc2UoJnNlbGYpIC0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBjbGllbnQuZ2V0X2NvaW5iYXNlKCkuYXdhaXQgewogICAgICAgICAgICAgICAgT2soY29pbmJhc2UpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoY29pbmJhc2UuYXNfYnl0ZXMoKSkpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfYmFsYW5jZSgmc2VsZiwgYWRkcmVzczogU3RyaW5nLCBibG9jazogZmZpOjpCbG9ja1RhZykgLT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGFkZHJlc3NfZnJvbV9zdHJpbmcoYWRkcmVzcykgewogICAgICAgICAgICAgICAgT2soYWRkcmVzcykgPT4gbWF0Y2ggY2xpZW50LmdldF9iYWxhbmNlKCZhZGRyZXNzLCBibG9jay50b19iYXNlX2Jsb2NrKCkpLmF3YWl0IHsKICAgICAgICAgICAgICAgICAgICBPayhiYWxhbmNlKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGJhbGFuY2UudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIkludmFsaWQgYWRkcmVzczoge30iLCBlcnJvciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfbm9uY2UoJnNlbGYsIGFkZHJlc3M6IFN0cmluZywgYmxvY2s6IGZmaTo6QmxvY2tUYWcpIC0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBhZGRyZXNzX2Zyb21fc3RyaW5nKGFkZHJlc3MpIHsKICAgICAgICAgICAgICAgIE9rKGFkZHJlc3MpID0+IG1hdGNoIGNsaWVudC5nZXRfbm9uY2UoJmFkZHJlc3MsIGJsb2NrLnRvX2Jhc2VfYmxvY2soKSkuYXdhaXQgewogICAgICAgICAgICAgICAgICAgIE9rKG5vbmNlKSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IG5vbmNlLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiSW52YWxpZCBhZGRyZXNzOiB7fSIsIGVycm9yKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X2Jsb2NrX2J5X251bWJlcigKICAgICAgICAmc2VsZiwKICAgICAgICBibG9jazogZmZpOjpCbG9ja1RhZywKICAgICAgICBmdWxsX3R4OiBib29sLAogICAgKSAtPiBmZmk6OlJlc3BvbnNlQmxvY2sgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBjbGllbnQKICAgICAgICAgICAgICAgIC5nZXRfYmxvY2tfYnlfbnVtYmVyKGJsb2NrLnRvX2Jhc2VfYmxvY2soKSwgZnVsbF90eCkKICAgICAgICAgICAgICAgIC5hd2FpdAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBPayhibG9jaykgPT4gZmZpOjpSZXNwb25zZUJsb2NrIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogYmxvY2subWFwKGhlbGlvc19leGVjdXRpb25fYmxvY2tfdG9fZmZpKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlQmxvY2sgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VCbG9jayB7CiAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9ibG9ja19ieV9oYXNoKCZzZWxmLCBoYXNoOiBTdHJpbmcsIGZ1bGxfdHg6IGJvb2wpIC0+IGZmaTo6UmVzcG9uc2VCbG9jayB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGgyNTZfZnJvbV9zdHJpbmcoaGFzaCkgewogICAgICAgICAgICAgICAgT2soaGFzaCkgPT4gewogICAgICAgICAgICAgICAgICAgIG1hdGNoIGNsaWVudAogICAgICAgICAgICAgICAgICAgICAgICAuZ2V0X2Jsb2NrX2J5X2hhc2goJmhhc2gsIGZ1bGxfdHgpCiAgICAgICAgICAgICAgICAgICAgICAgIC5hd2FpdAogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgT2soYmxvY2spID0+IGZmaTo6UmVzcG9uc2VCbG9jayB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogYmxvY2subWFwKGhlbGlvc19leGVjdXRpb25fYmxvY2tfdG9fZmZpKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VCbG9jayB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgRXJyKGVycikgPT4gZmZpOjpSZXNwb25zZUJsb2NrIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIkJsb2NrIGhhc2g6IHt9IiwgZXJyKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlQmxvY2sgewogICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfYmxvY2tfdHJhbnNhY3Rpb25fY291bnRfYnlfaGFzaCgmc2VsZiwgaGFzaDogU3RyaW5nKSAtPiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggaDI1Nl9mcm9tX3N0cmluZyhoYXNoKSB7CiAgICAgICAgICAgICAgICBPayhoYXNoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2ggY2xpZW50CiAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRfYmxvY2tfdHJhbnNhY3Rpb25fY291bnRfYnlfaGFzaCgmaGFzaCkKICAgICAgICAgICAgICAgICAgICAgICAgLmF3YWl0CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBPayhjb3VudCkgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogY291bnQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVyci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIkJsb2NrIGhhc2g6IHt9IiwgZXJyKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X2Jsb2NrX3RyYW5zYWN0aW9uX2NvdW50X2J5X251bWJlcigKICAgICAgICAmc2VsZiwKICAgICAgICBibG9jazogZmZpOjpCbG9ja1RhZywKICAgICkgLT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGNsaWVudAogICAgICAgICAgICAgICAgLmdldF9ibG9ja190cmFuc2FjdGlvbl9jb3VudF9ieV9udW1iZXIoYmxvY2sudG9fYmFzZV9ibG9jaygpKQogICAgICAgICAgICAgICAgLmF3YWl0CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIE9rKGNvdW50KSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogY291bnQsCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfdHJhbnNhY3Rpb25fcmVjZWlwdCgmc2VsZiwgdHhfaGFzaDogU3RyaW5nKSAtPiBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb25SZWNlaXB0IHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggaDI1Nl9mcm9tX3N0cmluZyh0eF9oYXNoKSB7CiAgICAgICAgICAgICAgICBPayh0eF9oYXNoKSA9PiBtYXRjaCBjbGllbnQuZ2V0X3RyYW5zYWN0aW9uX3JlY2VpcHQoJnR4X2hhc2gpLmF3YWl0IHsKICAgICAgICAgICAgICAgICAgICBPayhyZWNlaXB0KSA9PiBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb25SZWNlaXB0IHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHJlY2VpcHQubWFwKGV0aGVyc19yZWNlaXB0X3RvX2ZmaSksCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJUcmFuc2FjdGlvbiBoYXNoOiB7fSIsIGVycm9yKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb25SZWNlaXB0IHsKICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X3RyYW5zYWN0aW9uX2J5X2hhc2goJnNlbGYsIHR4X2hhc2g6IFN0cmluZykgLT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggaDI1Nl9mcm9tX3N0cmluZyh0eF9oYXNoKSB7CiAgICAgICAgICAgICAgICBPayhoYXNoKSA9PiBtYXRjaCBjbGllbnQuZ2V0X3RyYW5zYWN0aW9uX2J5X2hhc2goJmhhc2gpLmF3YWl0IHsKICAgICAgICAgICAgICAgICAgICBTb21lKHRyYW5zYWN0aW9uKSA9PiBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogU29tZShldGhlcnNfdHJhbnNhY3Rpb25fdG9fZmZpKHRyYW5zYWN0aW9uKSksCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIE5vbmUgPT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICJUcmFuc2FjdGlvbiBub3QgZm91bmQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJUcmFuc2FjdGlvbiBoYXNoOiB7fSIsIGVyciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X3RyYW5zYWN0aW9uX2J5X2Jsb2NrX2hhc2hfYW5kX2luZGV4KAogICAgICAgICZzZWxmLAogICAgICAgIGJsb2NrX2hhc2g6IFN0cmluZywKICAgICAgICBpbmRleDogdTY0LAogICAgKSAtPiBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBoMjU2X2Zyb21fc3RyaW5nKGJsb2NrX2hhc2gpIHsKICAgICAgICAgICAgICAgIE9rKGhhc2gpID0+IHsKICAgICAgICAgICAgICAgICAgICBtYXRjaCBjbGllbnQKICAgICAgICAgICAgICAgICAgICAgICAgLmdldF90cmFuc2FjdGlvbl9ieV9ibG9ja19oYXNoX2FuZF9pbmRleCgmaGFzaCwgaW5kZXgpCiAgICAgICAgICAgICAgICAgICAgICAgIC5hd2FpdAogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgU29tZSh0cmFuc2FjdGlvbikgPT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBTb21lKGV0aGVyc190cmFuc2FjdGlvbl90b19mZmkodHJhbnNhY3Rpb24pKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIE5vbmUgPT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICJUcmFuc2FjdGlvbiBub3QgZm91bmQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiQmxvY2sgaGFzaDoge30iLCBlcnIpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9sb2dzKCZzZWxmLCBmaWx0ZXI6IGZmaTo6TG9nRmlsdGVyKSAtPiBmZmk6OlJlc3BvbnNlVmVjTG9nIHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggZmlsdGVyLnRvX2V0aGVyc19maWx0ZXIoKSB7CiAgICAgICAgICAgICAgICBPayhmaWx0ZXIpID0+IG1hdGNoIGNsaWVudC5nZXRfbG9ncygmZmlsdGVyKS5hd2FpdCB7CiAgICAgICAgICAgICAgICAgICAgT2sobG9ncykgPT4gZmZpOjpSZXNwb25zZVZlY0xvZyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBsb2dzLmludG9faXRlcigpLm1hcChldGhlcnNfbG9nX3RvX2ZmaV9sb2cpLmNvbGxlY3QoKSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgRXJyKGVycikgPT4gZmZpOjpSZXNwb25zZVZlY0xvZyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiB2ZWMhW10sCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVyci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VWZWNMb2cgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiB2ZWMhW10sCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJJbnZhbGlkIGZpbHRlcjoge30iLCBlcnIpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VWZWNMb2cgewogICAgICAgICAgICAgICAgdmFsdWU6IHZlYyFbXSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9jb2RlKCZzZWxmLCBhZGRyZXNzOiBTdHJpbmcsIGJsb2NrOiBmZmk6OkJsb2NrVGFnKSAtPiBmZmk6OlJlc3BvbnNlVmVjOCB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGFkZHJlc3NfZnJvbV9zdHJpbmcoYWRkcmVzcykgewogICAgICAgICAgICAgICAgT2soYWRkcmVzcykgPT4gbWF0Y2ggY2xpZW50LmdldF9jb2RlKCZhZGRyZXNzLCBibG9jay50b19iYXNlX2Jsb2NrKCkpLmF3YWl0IHsKICAgICAgICAgICAgICAgICAgICBPayhjb2RlKSA9PiBmZmk6OlJlc3BvbnNlVmVjOCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBjb2RlLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VWZWM4IHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IFtdLmludG8oKSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VWZWM4IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogW10uaW50bygpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiSW52YWxpZCBhZGRyZXNzOiB7fSIsIGVycm9yKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlVmVjOCB7CiAgICAgICAgICAgICAgICB2YWx1ZTogW10uaW50bygpLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X3N0b3JhZ2VfYXQoCiAgICAgICAgJnNlbGYsCiAgICAgICAgYWRkcmVzczogU3RyaW5nLAogICAgICAgIHNsb3Q6IFN0cmluZywKICAgICAgICBibG9jazogZmZpOjpCbG9ja1RhZywKICAgICkgLT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGFkZHJlc3NfZnJvbV9zdHJpbmcoYWRkcmVzcykgewogICAgICAgICAgICAgICAgT2soYWRkcmVzcykgPT4gbWF0Y2ggaDI1Nl9mcm9tX3N0cmluZyhzbG90KSB7CiAgICAgICAgICAgICAgICAgICAgT2soc2xvdCkgPT4gewogICAgICAgICAgICAgICAgICAgICAgICBtYXRjaCBjbGllbnQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRfc3RvcmFnZV9hdCgmYWRkcmVzcywgc2xvdCwgYmxvY2sudG9fYmFzZV9ibG9jaygpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmF3YWl0CiAgICAgICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIE9rKHN0b3JhZ2UpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBzdG9yYWdlLmVuY29kZV9oZXgoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIkludmFsaWQgc2xvdDoge30iLCBlcnJvciksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIkludmFsaWQgYWRkcmVzczoge30iLCBlcnJvciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBzeW5jaW5nKCZzZWxmKSAtPiBmZmk6OlJlc3BvbnNlU3luY2luZyB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGNsaWVudC5zeW5jaW5nKCkuYXdhaXQgewogICAgICAgICAgICAgICAgT2soc3RhdHVzKSA9PiBmZmk6OlJlc3BvbnNlU3luY2luZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGV0aGVyc19zeW5jaW5nX3N0YXR1c190b19mZmkoc3RhdHVzKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlU3luY2luZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVN5bmNpbmcgewogICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KfQoKaW1wbCBmZmk6OkhlbGlvc05ldHdvcmsgewogICAgZm4gdG9fYmFzZV9uZXR3b3JrKCZzZWxmKSAtPiBuZXR3b3Jrczo6TmV0d29yayB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6Ok1BSU5ORVQgPT4gbmV0d29ya3M6Ok5ldHdvcms6Ok1BSU5ORVQsCiAgICAgICAgICAgIFNlbGY6OkdPRVJMSSA9PiBuZXR3b3Jrczo6TmV0d29yazo6R09FUkxJLAogICAgICAgICAgICBTZWxmOjpTRVBPTElBID0+IG5ldHdvcmtzOjpOZXR3b3JrOjpTRVBPTElBLAogICAgICAgIH0KICAgIH0KfQoKaW1wbCBmZmk6OkJsb2NrVGFnIHsKICAgIGZuIHRvX2Jhc2VfYmxvY2soJnNlbGYpIC0+IGNvbW1vbjo6dHlwZXM6OkJsb2NrVGFnIHsKICAgICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgICAgU2VsZjo6RmluYWxpemVkID0+IGNvbW1vbjo6dHlwZXM6OkJsb2NrVGFnOjpGaW5hbGl6ZWQsCiAgICAgICAgICAgIFNlbGY6OkxhdGVzdCA9PiBjb21tb246OnR5cGVzOjpCbG9ja1RhZzo6TGF0ZXN0LAogICAgICAgICAgICBTZWxmOjpTYWZlID0+IGNvbW1vbjo6dHlwZXM6OkJsb2NrVGFnOjpGaW5hbGl6ZWQsCiAgICAgICAgICAgIFNlbGY6OlBlbmRpbmcgPT4gY29tbW9uOjp0eXBlczo6QmxvY2tUYWc6OkxhdGVzdCwKICAgICAgICAgICAgU2VsZjo6RWFybGllc3QgPT4gY29tbW9uOjp0eXBlczo6QmxvY2tUYWc6Ok51bWJlcigxKSwKICAgICAgICAgICAgU2VsZjo6TnVtYmVyKGJsb2NrKSA9PiBjb21tb246OnR5cGVzOjpCbG9ja1RhZzo6TnVtYmVyKCpibG9jayksCiAgICAgICAgfQogICAgfQoKICAgIGZuIHRvX2V0aGVyc19ibG9jaygmc2VsZikgLT4gQmxvY2tOdW1iZXIgewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpGaW5hbGl6ZWQgPT4gQmxvY2tOdW1iZXI6OkZpbmFsaXplZCwKICAgICAgICAgICAgU2VsZjo6TGF0ZXN0ID0+IEJsb2NrTnVtYmVyOjpMYXRlc3QsCiAgICAgICAgICAgIFNlbGY6OlNhZmUgPT4gQmxvY2tOdW1iZXI6OlNhZmUsCiAgICAgICAgICAgIFNlbGY6OlBlbmRpbmcgPT4gQmxvY2tOdW1iZXI6OlBlbmRpbmcsCiAgICAgICAgICAgIFNlbGY6OkVhcmxpZXN0ID0+IEJsb2NrTnVtYmVyOjpFYXJsaWVzdCwKICAgICAgICAgICAgU2VsZjo6TnVtYmVyKGJsb2NrKSA9PiBCbG9ja051bWJlcjo6TnVtYmVyKFU2NDo6ZnJvbSgqYmxvY2spKSwKICAgICAgICB9CiAgICB9Cn0KCmltcGwgQ2xvbmUgZm9yIGZmaTo6QmxvY2tUYWcgewogICAgZm4gY2xvbmUoJnNlbGYpIC0+IFNlbGYgewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpGaW5hbGl6ZWQgPT4gZmZpOjpCbG9ja1RhZzo6RmluYWxpemVkLAogICAgICAgICAgICBTZWxmOjpMYXRlc3QgPT4gZmZpOjpCbG9ja1RhZzo6TGF0ZXN0LAogICAgICAgICAgICBTZWxmOjpTYWZlID0+IGZmaTo6QmxvY2tUYWc6OlNhZmUsCiAgICAgICAgICAgIFNlbGY6OlBlbmRpbmcgPT4gZmZpOjpCbG9ja1RhZzo6UGVuZGluZywKICAgICAgICAgICAgU2VsZjo6RWFybGllc3QgPT4gZmZpOjpCbG9ja1RhZzo6RWFybGllc3QsCiAgICAgICAgICAgIFNlbGY6Ok51bWJlcihibG9jaykgPT4gZmZpOjpCbG9ja1RhZzo6TnVtYmVyKCpibG9jayksCiAgICAgICAgfQogICAgfQp9CgppbXBsIGZmaTo6RmlsdGVyQmxvY2tPcHRpb24gewogICAgZm4gdG9fZXRoZXJzX2Jsb2NrX29wdGlvbigmc2VsZikgLT4gUmVzdWx0PEZpbHRlckJsb2NrT3B0aW9uLCBTdHJpbmc+IHsKICAgICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgICAgU2VsZjo6UmFuZ2UgewogICAgICAgICAgICAgICAgZnJvbV9ibG9jaywKICAgICAgICAgICAgICAgIHRvX2Jsb2NrLAogICAgICAgICAgICB9ID0+IE9rKEZpbHRlckJsb2NrT3B0aW9uOjpSYW5nZSB7CiAgICAgICAgICAgICAgICBmcm9tX2Jsb2NrOiBmcm9tX2Jsb2NrLmFzX3JlZigpLm1hcCh8YmxvY2t8IGJsb2NrLnRvX2V0aGVyc19ibG9jaygpKSwKICAgICAgICAgICAgICAgIHRvX2Jsb2NrOiB0b19ibG9jay5hc19yZWYoKS5tYXAofGJsb2NrfCBibG9jay50b19ldGhlcnNfYmxvY2soKSksCiAgICAgICAgICAgIH0pLAogICAgICAgICAgICBTZWxmOjpBdEJsb2NrSGFzaChoYXNoKSA9PiBPayhGaWx0ZXJCbG9ja09wdGlvbjo6QXRCbG9ja0hhc2goCiAgICAgICAgICAgICAgICBoMjU2X2Zyb21fc3RyaW5nKGhhc2gudG9fc3RyaW5nKCkpCiAgICAgICAgICAgICAgICAgICAgLm1hcF9lcnIofGVycm9yfCBmb3JtYXQhKCJGaWx0ZXIgYmxvY2sgaGFzaDoge30iLCBlcnJvcikpPywKICAgICAgICAgICAgKSksCiAgICAgICAgfQogICAgfQp9CgppbXBsIENsb25lIGZvciBmZmk6OkZpbHRlckJsb2NrT3B0aW9uIHsKICAgIGZuIGNsb25lKCZzZWxmKSAtPiBTZWxmIHsKICAgICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgICAgU2VsZjo6UmFuZ2UgewogICAgICAgICAgICAgICAgZnJvbV9ibG9jaywKICAgICAgICAgICAgICAgIHRvX2Jsb2NrLAogICAgICAgICAgICB9ID0+IGZmaTo6RmlsdGVyQmxvY2tPcHRpb246OlJhbmdlIHsKICAgICAgICAgICAgICAgIGZyb21fYmxvY2s6IGZyb21fYmxvY2suY2xvbmUoKSwKICAgICAgICAgICAgICAgIHRvX2Jsb2NrOiB0b19ibG9jay5jbG9uZSgpLAogICAgICAgICAgICB9LAogICAgICAgICAgICBTZWxmOjpBdEJsb2NrSGFzaChoYXNoKSA9PiBmZmk6OkZpbHRlckJsb2NrT3B0aW9uOjpBdEJsb2NrSGFzaChoYXNoLmNsb25lKCkpLAogICAgICAgIH0KICAgIH0KfQoKaW1wbCBmZmk6OkxvZ0ZpbHRlciB7CiAgICBmbiB0b19ldGhlcnNfZmlsdGVyKCZzZWxmKSAtPiBSZXN1bHQ8RmlsdGVyLCBTdHJpbmc+IHsKICAgICAgICBPayhGaWx0ZXIgewogICAgICAgICAgICBibG9ja19vcHRpb246IHNlbGYuYmxvY2tfb3B0aW9uLnRvX2V0aGVyc19ibG9ja19vcHRpb24oKT8sCiAgICAgICAgICAgIGFkZHJlc3M6IGlmIHNlbGYuYWRkcmVzcy5pc19lbXB0eSgpIHsKICAgICAgICAgICAgICAgIE5vbmUKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIFNvbWUoCiAgICAgICAgICAgICAgICAgICAgYWRkcmVzc2VzX2Zyb21fc3RyaW5nKHNlbGYuYWRkcmVzcy5jbG9uZSgpKQogICAgICAgICAgICAgICAgICAgICAgICAubWFwX2Vycih8ZXJyfCBmb3JtYXQhKCJGaWx0ZXIgYWRkcmVzczoge30iLCBlcnIpKT8sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRvcGljczogdG9waWNzX2Zyb21fc3RyaW5ncyhzZWxmLnRvcGljcy5jbG9uZSgpKQogICAgICAgICAgICAgICAgLm1hcF9lcnIofGVycnwgZm9ybWF0ISgiRmlsdGVyIHRvcGljczoge30iLCBlcnIpKT8sCiAgICAgICAgfSkKICAgIH0KfQoKaW1wbCBmZmk6OkNhbGxPcHRzIHsKICAgIGZuIHRvX2Jhc2Vfb3B0cygmc2VsZikgLT4gUmVzdWx0PGV4ZWN1dGlvbjo6dHlwZXM6OkNhbGxPcHRzLCBTdHJpbmc+IHsKICAgICAgICBPayhleGVjdXRpb246OnR5cGVzOjpDYWxsT3B0cyB7CiAgICAgICAgICAgIGZyb206IGlmIHNlbGYuZnJvbS5pc19lbXB0eSgpIHsKICAgICAgICAgICAgICAgIE5vbmUKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIFNvbWUoCiAgICAgICAgICAgICAgICAgICAgYWRkcmVzc19mcm9tX3N0cmluZyhzZWxmLmZyb20uY2xvbmUoKSkKICAgICAgICAgICAgICAgICAgICAgICAgLm1hcF9lcnIofGVycnwgZm9ybWF0ISgiZnJvbToge30iLCBlcnIpKT8sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHRvOiBTb21lKGFkZHJlc3NfZnJvbV9zdHJpbmcoc2VsZi50by5jbG9uZSgpKS5tYXBfZXJyKHxlcnJ8IGZvcm1hdCEoInRvOiB7fSIsIGVycikpPyksCiAgICAgICAgICAgIGdhczogaWYgc2VsZi5nYXMuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICBOb25lCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBTb21lKHUyNTZfZnJvbV9zdHJpbmcoc2VsZi5nYXMuY2xvbmUoKSkubWFwX2Vycih8ZXJyfCBmb3JtYXQhKCJnYXM6IHt9IiwgZXJyKSk/KQogICAgICAgICAgICB9LAogICAgICAgICAgICBnYXNfcHJpY2U6IGlmIHNlbGYuZ2FzX3ByaWNlLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgTm9uZQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgU29tZSgKICAgICAgICAgICAgICAgICAgICB1MjU2X2Zyb21fc3RyaW5nKHNlbGYuZ2FzX3ByaWNlLmNsb25lKCkpCiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKHxlcnJ8IGZvcm1hdCEoImdhc19wcmljZToge30iLCBlcnIpKT8sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIHZhbHVlOiBpZiBzZWxmLnZhbHVlLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgTm9uZQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgU29tZSgKICAgICAgICAgICAgICAgICAgICB1MjU2X2Zyb21fc3RyaW5nKHNlbGYudmFsdWUuY2xvbmUoKSkKICAgICAgICAgICAgICAgICAgICAgICAgLm1hcF9lcnIofGVycnwgZm9ybWF0ISgidmFsdWU6IHt9IiwgZXJyKSk/LAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB9LAogICAgICAgICAgICBkYXRhOiBpZiBzZWxmLmRhdGEuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICBOb25lCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBTb21lKHZlYzhfZnJvbV9zdHJpbmcoc2VsZi5kYXRhLmNsb25lKCkpLm1hcF9lcnIofGVycnwgZm9ybWF0ISgiZGF0YToge30iLCBlcnIpKT8uaW50bygpKQogICAgICAgICAgICB9LAogICAgICAgIH0pCiAgICB9Cn0KCmltcGwgQ2xvbmUgZm9yIGZmaTo6VHJhbnNhY3Rpb25zIHsKICAgIGZuIGNsb25lKCZzZWxmKSAtPiBTZWxmIHsKICAgICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgICAgU2VsZjo6SGFzaGVzKGhhc2hlcykgPT4gZmZpOjpUcmFuc2FjdGlvbnM6Okhhc2hlcyhoYXNoZXMuY2xvbmUoKSksCiAgICAgICAgICAgIFNlbGY6OkZ1bGwodHJhbnNhY3Rpb25zKSA9PiBmZmk6OlRyYW5zYWN0aW9uczo6RnVsbCh0cmFuc2FjdGlvbnMudG9fdmVjKCkpLAogICAgICAgIH0KICAgIH0KfQoKZm4gdG9waWNzX2Zyb21fc3RyaW5ncygKICAgIHZhbHVlOiBWZWM8U3RyaW5nPiwKKSAtPiBSZXN1bHQ8W09wdGlvbjxWYWx1ZU9yQXJyYXk8T3B0aW9uPEgyNTY+Pj47IDRdLCBTdHJpbmc+IHsKICAgIGlmIHZhbHVlLmxlbigpID4gNCB7CiAgICAgICAgRXJyKCJUb28gbWFueSB0b3BpY3MiLnRvX3N0cmluZygpKQogICAgfSBlbHNlIHsKICAgICAgICBsZXQgbWFwX3N0cmluZ190b190b3BpY3MgPQogICAgICAgICAgICB8dmFsdWU6IFN0cmluZ3wgLT4gUmVzdWx0PE9wdGlvbjxWYWx1ZU9yQXJyYXk8T3B0aW9uPEgyNTY+Pj4sIFN0cmluZz4gewogICAgICAgICAgICAgICAgaWYgdmFsdWUuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICAgICAgT2soTm9uZSkKICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgbGV0IHRvcGljczogVmVjPCZzdHI+ID0gdmFsdWUuc3BsaXQoJywnKS5jb2xsZWN0KCk7CiAgICAgICAgICAgICAgICAgICAgaWYgdG9waWNzLmxlbigpID09IDEgewogICAgICAgICAgICAgICAgICAgICAgICBPayhTb21lKFZhbHVlT3JBcnJheTo6VmFsdWUoU29tZShoMjU2X2Zyb21fc3RyaW5nKAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdG9waWNzWzBdLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICApPykpKSkKICAgICAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgICAgICBsZXQgbWFwcGVkOiBSZXN1bHQ8VmVjPEgyNTY+LCBTdHJpbmc+ID0gdG9waWNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuaW50b19pdGVyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAofHRvcGljfCBoMjU2X2Zyb21fc3RyaW5nKHRvcGljLnRvX3N0cmluZygpKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5jb2xsZWN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBvcHRpb25fbWFwcGVkOiBWZWM8T3B0aW9uPEgyNTY+PiA9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBtYXBwZWQ/LmludG9faXRlcigpLm1hcCh8aGFzaHwgT3B0aW9uOjpTb21lKGhhc2gpKS5jb2xsZWN0KCk7CiAgICAgICAgICAgICAgICAgICAgICAgIE9rKFNvbWUoVmFsdWVPckFycmF5OjpBcnJheShvcHRpb25fbWFwcGVkKSkpCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9OwogICAgICAgIGxldCBtdXQgdG9waWNzID0gdmFsdWUuY2xvbmUoKTsKICAgICAgICBmb3IgX2kgaW4gdG9waWNzLmxlbigpLi40IHsKICAgICAgICAgICAgdG9waWNzLnB1c2goIiIudG9fc3RyaW5nKCkpOwogICAgICAgIH0KICAgICAgICBsZXQgbWFwcGVkOiBSZXN1bHQ8VmVjPE9wdGlvbjxWYWx1ZU9yQXJyYXk8T3B0aW9uPEgyNTY+Pj4+LCBTdHJpbmc+ID0KICAgICAgICAgICAgdG9waWNzLmludG9faXRlcigpLm1hcChtYXBfc3RyaW5nX3RvX3RvcGljcykuY29sbGVjdCgpOwogICAgICAgIE9rKG1hcHBlZD8udHJ5X2ludG8oKS5tYXBfZXJyKHxfZXJyfCAiRmFpbGVkIHRvIG1hcCB2ZWN0b3IiKT8pCiAgICB9Cn0KCmZuIGFkZHJlc3NfZnJvbV9zdHJpbmcodmFsdWU6IFN0cmluZykgLT4gUmVzdWx0PEFkZHJlc3MsIFN0cmluZz4gewogICAgbGV0IHJhd19oZXggPSB2ZWM4X2Zyb21fc3RyaW5nKHZhbHVlKT87CiAgICBpZiByYXdfaGV4LmxlbigpID09IEFkZHJlc3M6Omxlbl9ieXRlcygpIHsKICAgICAgICBPayhBZGRyZXNzOjpmcm9tX3NsaWNlKCZyYXdfaGV4KSkKICAgIH0gZWxzZSB7CiAgICAgICAgRXJyKGZvcm1hdCEoIlNob3VsZCBiZSB7fSBieXRlcyBsb25nIiwgQWRkcmVzczo6bGVuX2J5dGVzKCkpKQogICAgfQp9CgpmbiBhZGRyZXNzZXNfZnJvbV9zdHJpbmcodmFsdWU6IFN0cmluZykgLT4gUmVzdWx0PFZhbHVlT3JBcnJheTxBZGRyZXNzPiwgU3RyaW5nPiB7CiAgICBsZXQgYWRkcmVzc2VzOiBWZWM8JnN0cj4gPSB2YWx1ZS5zcGxpdCgnLCcpLmNvbGxlY3QoKTsKICAgIGlmIGFkZHJlc3Nlcy5sZW4oKSA9PSAxIHsKICAgICAgICBPayhWYWx1ZU9yQXJyYXk6OlZhbHVlKGFkZHJlc3NfZnJvbV9zdHJpbmcoCiAgICAgICAgICAgIGFkZHJlc3Nlc1swXS50b19zdHJpbmcoKSwKICAgICAgICApPykpCiAgICB9IGVsc2UgewogICAgICAgIGxldCBtYXBwZWQ6IFJlc3VsdDxWZWM8QWRkcmVzcz4sIFN0cmluZz4gPSBhZGRyZXNzZXMKICAgICAgICAgICAgLmludG9faXRlcigpCiAgICAgICAgICAgIC5tYXAofGFkZHJlc3N8IGFkZHJlc3NfZnJvbV9zdHJpbmcoYWRkcmVzcy50b19zdHJpbmcoKSkpCiAgICAgICAgICAgIC5jb2xsZWN0KCk7CiAgICAgICAgT2soVmFsdWVPckFycmF5OjpBcnJheShtYXBwZWQ/KSkKICAgIH0KfQoKZm4gaDI1Nl9mcm9tX3N0cmluZyh2YWx1ZTogU3RyaW5nKSAtPiBSZXN1bHQ8SDI1NiwgU3RyaW5nPiB7CiAgICBsZXQgcmF3X2hleCA9IHZlYzhfZnJvbV9zdHJpbmcodmFsdWUpPzsKICAgIGlmIHJhd19oZXgubGVuKCkgPT0gSDI1Njo6bGVuX2J5dGVzKCkgewogICAgICAgIE9rKEgyNTY6OmZyb21fc2xpY2UoJnJhd19oZXgpKQogICAgfSBlbHNlIHsKICAgICAgICBFcnIoZm9ybWF0ISgiU2hvdWxkIGJlIHt9IGJ5dGVzIGxvbmciLCBIMjU2OjpsZW5fYnl0ZXMoKSkpCiAgICB9Cn0KCmZuIHUyNTZfZnJvbV9zdHJpbmcodmFsdWU6IFN0cmluZykgLT4gUmVzdWx0PFUyNTYsIFN0cmluZz4gewogICAgaWYgbGV0IFNvbWUocmF3X2hleF9zdHJpbmcpID0gdmFsdWUuc3RyaXBfcHJlZml4KCIweCIpIHsKICAgICAgICBPayhVMjU2Ojpmcm9tX3N0cl9yYWRpeChyYXdfaGV4X3N0cmluZywgMTYpLm1hcF9lcnIofGVycnwgZXJyLnRvX3N0cmluZygpKT8pCiAgICB9IGVsc2UgewogICAgICAgIE9rKFUyNTY6OmZyb21fc3RyX3JhZGl4KCZ2YWx1ZSwgMTApLm1hcF9lcnIofGVycnwgZXJyLnRvX3N0cmluZygpKT8pCiAgICB9Cn0KCmZuIHZlYzhfZnJvbV9zdHJpbmcodmFsdWU6IFN0cmluZykgLT4gUmVzdWx0PFZlYzx1OD4sIFN0cmluZz4gewogICAgaWYgbGV0IFNvbWUocmF3X2hleF9zdHJpbmcpID0gdmFsdWUuc3RyaXBfcHJlZml4KCIweCIpIHsKICAgICAgICBPayhoZXg6OmRlY29kZShyYXdfaGV4X3N0cmluZykubWFwX2Vycih8ZXJyfCBlcnIudG9fc3RyaW5nKCkpPykKICAgIH0gZWxzZSB7CiAgICAgICAgRXJyKCJTaG91bGQgYmUgYSBoZXggdmFsdWUgcHJlZml4ZWQgd2l0aCAweCIudG9fc3RyaW5nKCkpCiAgICB9Cn0KCmZuIGV0aGVyc19sb2dfdG9fZmZpX2xvZyh2YWx1ZTogTG9nKSAtPiBmZmk6OkxvZyB7CiAgICBmZmk6OkxvZyB7CiAgICAgICAgYWRkcmVzczogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLmFkZHJlc3MuYXNfYnl0ZXMoKSkpLAogICAgICAgIHRvcGljczogdmFsdWUKICAgICAgICAgICAgLnRvcGljcwogICAgICAgICAgICAuaW50b19pdGVyKCkKICAgICAgICAgICAgLm1hcCh8dG9waWN8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh0b3BpYy5hc19ieXRlcygpKSkpCiAgICAgICAgICAgIC5jb2xsZWN0KCksCiAgICAgICAgZGF0YTogdmFsdWUuZGF0YS5lbmNvZGUoKSwKICAgICAgICBibG9ja19oYXNoOiB2YWx1ZQogICAgICAgICAgICAuYmxvY2tfaGFzaAogICAgICAgICAgICAubWFwKHxoYXNofCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoaGFzaC5hc19ieXRlcygpKSkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIGJsb2NrX251bWJlcjogdmFsdWUuYmxvY2tfbnVtYmVyLm1hcCh8YmxvY2t8IGJsb2NrLmFzX3U2NCgpKSwKICAgICAgICB0cmFuc2FjdGlvbl9oYXNoOiB2YWx1ZQogICAgICAgICAgICAudHJhbnNhY3Rpb25faGFzaAogICAgICAgICAgICAubWFwKHxoYXNofCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoaGFzaC5hc19ieXRlcygpKSkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIHRyYW5zYWN0aW9uX2luZGV4OiB2YWx1ZS50cmFuc2FjdGlvbl9pbmRleC5tYXAofGluZGV4fCBpbmRleC5hc191NjQoKSksCiAgICAgICAgbG9nX2luZGV4OiB2YWx1ZQogICAgICAgICAgICAubG9nX2luZGV4CiAgICAgICAgICAgIC5tYXAofGluZGV4fCBpbmRleC50b19zdHJpbmcoKSkKICAgICAgICAgICAgLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICAgICAgdHJhbnNhY3Rpb25fbG9nX2luZGV4OiB2YWx1ZQogICAgICAgICAgICAudHJhbnNhY3Rpb25fbG9nX2luZGV4CiAgICAgICAgICAgIC5tYXAofGluZGV4fCBpbmRleC50b19zdHJpbmcoKSkKICAgICAgICAgICAgLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICAgICAgbG9nX3R5cGU6IHZhbHVlLmxvZ190eXBlLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICAgICAgcmVtb3ZlZDogdmFsdWUucmVtb3ZlZCwKICAgIH0KfQoKZm4gZXRoZXJzX3JlY2VpcHRfdG9fZmZpKHZhbHVlOiBUcmFuc2FjdGlvblJlY2VpcHQpIC0+IGZmaTo6VHJhbnNhY3Rpb25SZWNlaXB0IHsKICAgIGZmaTo6VHJhbnNhY3Rpb25SZWNlaXB0IHsKICAgICAgICB0cmFuc2FjdGlvbl9oYXNoOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUudHJhbnNhY3Rpb25faGFzaC5hc19ieXRlcygpKSksCiAgICAgICAgdHJhbnNhY3Rpb25faW5kZXg6IHZhbHVlLnRyYW5zYWN0aW9uX2luZGV4LmFzX3U2NCgpLAogICAgICAgIGJsb2NrX2hhc2g6IHZhbHVlCiAgICAgICAgICAgIC5ibG9ja19oYXNoCiAgICAgICAgICAgIC5tYXAofGhhc2h8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShoYXNoLmFzX2J5dGVzKCkpKSkKICAgICAgICAgICAgLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICAgICAgYmxvY2tfbnVtYmVyOiB2YWx1ZS5ibG9ja19udW1iZXIubWFwKHxudW1iZXJ8IG51bWJlci5hc191NjQoKSksCiAgICAgICAgZnJvbTogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLmZyb20uYXNfYnl0ZXMoKSkpLAogICAgICAgIHRvOiB2YWx1ZQogICAgICAgICAgICAudG8KICAgICAgICAgICAgLm1hcCh8YWRkcmVzc3wgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGFkZHJlc3MuYXNfYnl0ZXMoKSkpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICBjdW11bGF0aXZlX2dhc191c2VkOiB2YWx1ZS5jdW11bGF0aXZlX2dhc191c2VkLnRvX3N0cmluZygpLAogICAgICAgIGdhc191c2VkOiB2YWx1ZQogICAgICAgICAgICAuZ2FzX3VzZWQKICAgICAgICAgICAgLm1hcCh8Z2FzfCBnYXMudG9fc3RyaW5nKCkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIGNvbnRyYWN0X2FkZHJlc3M6IHZhbHVlCiAgICAgICAgICAgIC5jb250cmFjdF9hZGRyZXNzCiAgICAgICAgICAgIC5tYXAofGFkZHJlc3N8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShhZGRyZXNzLmFzX2J5dGVzKCkpKSkKICAgICAgICAgICAgLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICAgICAgbG9nczogdmFsdWUubG9ncy5pbnRvX2l0ZXIoKS5tYXAoZXRoZXJzX2xvZ190b19mZmlfbG9nKS5jb2xsZWN0KCksCiAgICAgICAgc3RhdHVzOiB2YWx1ZS5zdGF0dXMubWFwKHxzdGF0dXN8IHN0YXR1cy5hc191NjQoKSksCiAgICAgICAgcm9vdDogdmFsdWUKICAgICAgICAgICAgLnJvb3QKICAgICAgICAgICAgLm1hcCh8aGFzaHwgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGhhc2guYXNfYnl0ZXMoKSkpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICBsb2dzX2Jsb29tOiB2YWx1ZS5sb2dzX2Jsb29tLmFzX2J5dGVzKCkudG9fdmVjKCksCiAgICAgICAgdHJhbnNhY3Rpb25fdHlwZTogdmFsdWUudHJhbnNhY3Rpb25fdHlwZS5tYXAofHZhbHwgdmFsLmFzX3U2NCgpKSwKICAgICAgICBlZmZlY3RpdmVfZ2FzX3ByaWNlOiB2YWx1ZQogICAgICAgICAgICAuZWZmZWN0aXZlX2dhc19wcmljZQogICAgICAgICAgICAubWFwKHxnYXN8IGdhcy50b19zdHJpbmcoKSkKICAgICAgICAgICAgLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICB9Cn0KCmZuIGV0aGVyc190cmFuc2FjdGlvbl90b19mZmkodmFsdWU6IFRyYW5zYWN0aW9uKSAtPiBmZmk6OlRyYW5zYWN0aW9uIHsKICAgIGZmaTo6VHJhbnNhY3Rpb24gewogICAgICAgIGhhc2g6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5oYXNoLmFzX2J5dGVzKCkpKSwKICAgICAgICBub25jZTogdmFsdWUubm9uY2UudG9fc3RyaW5nKCksCiAgICAgICAgYmxvY2tfaGFzaDogdmFsdWUKICAgICAgICAgICAgLmJsb2NrX2hhc2gKICAgICAgICAgICAgLm1hcCh8aGFzaHwgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGhhc2guYXNfYnl0ZXMoKSkpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICBibG9ja19udW1iZXI6IHZhbHVlLmJsb2NrX251bWJlci5tYXAofGJsb2NrfCBibG9jay5hc191NjQoKSksCiAgICAgICAgdHJhbnNhY3Rpb25faW5kZXg6IHZhbHVlLnRyYW5zYWN0aW9uX2luZGV4Lm1hcCh8aW5kZXh8IGluZGV4LmFzX3U2NCgpKSwKICAgICAgICBmcm9tOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUuZnJvbS5hc19ieXRlcygpKSksCiAgICAgICAgdG86IHZhbHVlCiAgICAgICAgICAgIC50bwogICAgICAgICAgICAubWFwKHxhZGRyZXNzfCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoYWRkcmVzcy5hc19ieXRlcygpKSkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIHZhbHVlOiB2YWx1ZS52YWx1ZS50b19zdHJpbmcoKSwKICAgICAgICBnYXNfcHJpY2U6IHZhbHVlCiAgICAgICAgICAgIC5nYXNfcHJpY2UKICAgICAgICAgICAgLm1hcCh8Z2FzfCBnYXMudG9fc3RyaW5nKCkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIGdhczogdmFsdWUuZ2FzLnRvX3N0cmluZygpLAogICAgICAgIGlucHV0OiB2YWx1ZS5pbnB1dC50b192ZWMoKSwKICAgICAgICB2OiB2YWx1ZS52LnRvX3N0cmluZygpLAogICAgICAgIHI6IHZhbHVlLnIuZW5jb2RlX2hleCgpLAogICAgICAgIHM6IHZhbHVlLnMuZW5jb2RlX2hleCgpLAogICAgfQp9CgpmbiBldGhlcnNfc3luY2luZ19zdGF0dXNfdG9fZmZpKHZhbHVlOiBTeW5jaW5nU3RhdHVzKSAtPiBPcHRpb248ZmZpOjpTeW5jaW5nU3RhdHVzPiB7CiAgICBtYXRjaCB2YWx1ZSB7CiAgICAgICAgU3luY2luZ1N0YXR1czo6SXNGYWxzZSA9PiBOb25lLAogICAgICAgIFN5bmNpbmdTdGF0dXM6OklzU3luY2luZyh2YWx1ZSkgPT4gU29tZShmZmk6OlN5bmNpbmdTdGF0dXMgewogICAgICAgICAgICBjdXJyZW50X2Jsb2NrOiB2YWx1ZS5jdXJyZW50X2Jsb2NrLmFzX3U2NCgpLAogICAgICAgICAgICBoaWdoZXN0X2Jsb2NrOiB2YWx1ZS5oaWdoZXN0X2Jsb2NrLmFzX3U2NCgpLAogICAgICAgICAgICBzdGFydGluZ19ibG9jazogdmFsdWUuc3RhcnRpbmdfYmxvY2suYXNfdTY0KCksCiAgICAgICAgfSksCiAgICB9Cn0KCmZuIGhlbGlvc190cmFuc2FjdGlvbnNfdG9fZmZpKHZhbHVlOiBUcmFuc2FjdGlvbnMpIC0+IGZmaTo6VHJhbnNhY3Rpb25zIHsKICAgIG1hdGNoIHZhbHVlIHsKICAgICAgICBUcmFuc2FjdGlvbnM6Okhhc2hlcyhoYXNoZXMpID0+IGZmaTo6VHJhbnNhY3Rpb25zOjpIYXNoZXMoCiAgICAgICAgICAgIGhhc2hlcwogICAgICAgICAgICAgICAgLmludG9faXRlcigpCiAgICAgICAgICAgICAgICAubWFwKHxoYXNofCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoaGFzaC5hc19ieXRlcygpKSkpCiAgICAgICAgICAgICAgICAuY29sbGVjdCgpLAogICAgICAgICksCiAgICAgICAgVHJhbnNhY3Rpb25zOjpGdWxsKHRyYW5zYWN0aW9ucykgPT4gZmZpOjpUcmFuc2FjdGlvbnM6OkZ1bGwoCiAgICAgICAgICAgIHRyYW5zYWN0aW9ucwogICAgICAgICAgICAgICAgLmludG9faXRlcigpCiAgICAgICAgICAgICAgICAubWFwKGV0aGVyc190cmFuc2FjdGlvbl90b19mZmkpCiAgICAgICAgICAgICAgICAuY29sbGVjdCgpLAogICAgICAgICksCiAgICB9Cn0KCmZuIGhlbGlvc19leGVjdXRpb25fYmxvY2tfdG9fZmZpKHZhbHVlOiBCbG9jaykgLT4gZmZpOjpCbG9jayB7CiAgICBmZmk6OkJsb2NrIHsKICAgICAgICBudW1iZXI6IHZhbHVlLm51bWJlci5hc191NjQoKSwKICAgICAgICBiYXNlX2ZlZV9wZXJfZ2FzOiB2YWx1ZS5iYXNlX2ZlZV9wZXJfZ2FzLnRvX3N0cmluZygpLAogICAgICAgIGRpZmZpY3VsdHk6IHZhbHVlLmRpZmZpY3VsdHkudG9fc3RyaW5nKCksCiAgICAgICAgZXh0cmFfZGF0YTogdmFsdWUuZXh0cmFfZGF0YS50b192ZWMoKSwKICAgICAgICBnYXNfbGltaXQ6IHZhbHVlLmdhc19saW1pdC5hc191NjQoKSwKICAgICAgICBnYXNfdXNlZDogdmFsdWUuZ2FzX3VzZWQuYXNfdTY0KCksCiAgICAgICAgaGFzaDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLmhhc2guYXNfYnl0ZXMoKSkpLAogICAgICAgIGxvZ3NfYmxvb206IHZhbHVlLmxvZ3NfYmxvb20udG9fdmVjKCksCiAgICAgICAgbWluZXI6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5taW5lci5hc19ieXRlcygpKSksCiAgICAgICAgbWl4X2hhc2g6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5taXhfaGFzaC5hc19ieXRlcygpKSksCiAgICAgICAgbm9uY2U6IHZhbHVlLm5vbmNlLnRvX3N0cmluZygpLAogICAgICAgIHBhcmVudF9oYXNoOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUucGFyZW50X2hhc2guYXNfYnl0ZXMoKSkpLAogICAgICAgIHJlY2VpcHRzX3Jvb3Q6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5yZWNlaXB0c19yb290LmFzX2J5dGVzKCkpKSwKICAgICAgICBzaGEzX3VuY2xlczogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLnNoYTNfdW5jbGVzLmFzX2J5dGVzKCkpKSwKICAgICAgICBzaXplOiB2YWx1ZS5zaXplLmFzX3U2NCgpLAogICAgICAgIHN0YXRlX3Jvb3Q6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5zdGF0ZV9yb290LmFzX2J5dGVzKCkpKSwKICAgICAgICB0aW1lc3RhbXA6IHZhbHVlLnRpbWVzdGFtcC5hc191NjQoKSwKICAgICAgICB0b3RhbF9kaWZmaWN1bHR5OiB2YWx1ZS50b3RhbF9kaWZmaWN1bHR5LmFzX3U2NCgpLAogICAgICAgIHRyYW5zYWN0aW9uczogaGVsaW9zX3RyYW5zYWN0aW9uc190b19mZmkodmFsdWUudHJhbnNhY3Rpb25zKSwKICAgICAgICB0cmFuc2FjdGlvbnNfcm9vdDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLnRyYW5zYWN0aW9uc19yb290LmFzX2J5dGVzKCkpKSwKICAgICAgICB1bmNsZXM6IHZhbHVlCiAgICAgICAgICAgIC51bmNsZXMKICAgICAgICAgICAgLmludG9faXRlcigpCiAgICAgICAgICAgIC5tYXAofGhhc2h8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShoYXNoLmFzX2J5dGVzKCkpKSkKICAgICAgICAgICAgLmNvbGxlY3QoKSwKICAgIH0KfQoKI1tkZXJpdmUoQ2xvbmUpXQpwdWIgc3RydWN0IE9wdGlvbmFsRmlsZURCIHsKICAgIGZpbGVfZGI6IE9wdGlvbjxGaWxlREI+LAogICAgZGVmYXVsdF9jaGVja3BvaW50OiBWZWM8dTg+LAp9CgppbXBsIERhdGFiYXNlIGZvciBPcHRpb25hbEZpbGVEQiB7CiAgICBmbiBuZXcoY29uZmlnOiAmQ29uZmlnKSAtPiBSZXN1bHQ8U2VsZiwgUmVwb3J0PiB7CiAgICAgICAgaWYgbGV0IFNvbWUoX2RhdGFfZGlyKSA9ICZjb25maWcuZGF0YV9kaXIgewogICAgICAgICAgICBPayhPcHRpb25hbEZpbGVEQiB7CiAgICAgICAgICAgICAgICBmaWxlX2RiOiBTb21lKEZpbGVEQjo6bmV3KGNvbmZpZyk/KSwKICAgICAgICAgICAgICAgIGRlZmF1bHRfY2hlY2twb2ludDogY29uZmlnLmRlZmF1bHRfY2hlY2twb2ludC5jbG9uZSgpLAogICAgICAgICAgICB9KQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIE9rKE9wdGlvbmFsRmlsZURCIHsKICAgICAgICAgICAgICAgIGZpbGVfZGI6IE5vbmUsCiAgICAgICAgICAgICAgICBkZWZhdWx0X2NoZWNrcG9pbnQ6IGNvbmZpZy5kZWZhdWx0X2NoZWNrcG9pbnQuY2xvbmUoKSwKICAgICAgICAgICAgfSkKICAgICAgICB9CiAgICB9CgogICAgZm4gc2F2ZV9jaGVja3BvaW50KCZzZWxmLCBjaGVja3BvaW50OiAmW3U4XSkgLT4gUmVzdWx0PCgpLCBSZXBvcnQ+IHsKICAgICAgICBpZiBsZXQgU29tZShmaWxlX2RiKSA9ICZzZWxmLmZpbGVfZGIgewogICAgICAgICAgICBmaWxlX2RiLnNhdmVfY2hlY2twb2ludCgmY2hlY2twb2ludCkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBPaygoKSkKICAgICAgICB9CiAgICB9CgogICAgZm4gbG9hZF9jaGVja3BvaW50KCZzZWxmKSAtPiBSZXN1bHQ8VmVjPHU4PiwgUmVwb3J0PiB7CiAgICAgICAgaWYgbGV0IFNvbWUoZmlsZV9kYikgPSAmc2VsZi5maWxlX2RiIHsKICAgICAgICAgICAgZmlsZV9kYi5sb2FkX2NoZWNrcG9pbnQoKQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIE9rKHNlbGYuZGVmYXVsdF9jaGVja3BvaW50LmNsb25lKCkpCiAgICAgICAgfQogICAgfQp9CgpwdWIgc3RydWN0IEhlbGlvc0NsaWVudCB7CiAgICBjbGllbnQ6IE9wdGlvbjxDbGllbnQ8T3B0aW9uYWxGaWxlREI+PiwKICAgIGlzX2xvZ2dpbmc6IGJvb2wsCn0="

# Expose rpc_bind_ip in helios/client/src/client.rs
echo $HELIOS_DIRECTORY
if grep -q -v "pub fn rpc_bind_ip(mut self, ip: IpAddr) -> Self {" "$HELIOS_DIRECTORY/client/src/client.rs"; then
    sed -i '' 's/^    pub fn rpc_port[(]mut self[,] port[:] u16[)] [-][>] Self [{]/    pub fn rpc_bind_ip(mut self, ip: IpAddr) -> Self {\n        self.rpc_bind_ip = Some(ip);\n        self\n    }\n\n    #[cfg(not(target_arch = "wasm32"))]\n    pub fn rpc_port(mut self, port: u16) -> Self {/' "$HELIOS_DIRECTORY/client/src/client.rs"
fi

rust::build
build::lipo
build::generate_c_headers
build::xcframework

post_build::compress
post_build::copy_bridge_files
post_build::success
