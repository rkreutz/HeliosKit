#! /bin/zsh -e

source ".scripts/functions.sh"

set -e

PACKAGE_VERSION=0.5.1
SWIFT_BRIDGE_PACKAGE='git = "https:\/\/github.com\/rkreutz\/swift-bridge.git", branch = "feature\/struct-vec-support"'
SWIFT_BRIDGE_FEATURES='["async", "compatibility"]'
ETHERS_VERSION=2.0.2
USES_LOGGER=false
USES_TRACING=true
RUST_TOOLCHAIN='stable'

env::setup
env::build_configuration $1

rust::setup

pre_build::create_build_directory
pre_build::setup_helios
pre_build::modify_helios "dXNlIDo6Y2xpZW50Ojp7Q2xpZW50LCBDbGllbnRCdWlsZGVyfTsKdXNlIDo6Y29uZmlnOjp7bmV0d29ya3MsIENvbmZpZ307CnVzZSA6OmNvbnNlbnN1czo6ZGF0YWJhc2U6OntEYXRhYmFzZSwgRmlsZURCfTsKdXNlIDo6Y29tbW9uOjp0eXBlczo6e0Jsb2NrLCBUcmFuc2FjdGlvbnN9Owp1c2UgZXRoZXJzOjp7CiAgICBhYmk6OkFiaUVuY29kZSwKICAgIHByZWx1ZGU6OntBZGRyZXNzLCBIMjU2LCBVMjU2LCBVNjR9LAogICAgdHlwZXM6OnsKICAgICAgICBCbG9ja051bWJlciwgRmlsdGVyLCBGaWx0ZXJCbG9ja09wdGlvbiwgTG9nLCBTeW5jaW5nU3RhdHVzLCBUcmFuc2FjdGlvbiwKICAgICAgICBUcmFuc2FjdGlvblJlY2VpcHQsIFZhbHVlT3JBcnJheQogICAgfSwKfTsKdXNlIGV5cmU6OlJlcG9ydDsKdXNlIHRyYWNpbmdfc3Vic2NyaWJlcjo6ZmlsdGVyOjp7RW52RmlsdGVyLCBMZXZlbEZpbHRlcn07CnVzZSB0cmFjaW5nX3N1YnNjcmliZXI6OkZtdFN1YnNjcmliZXI7CgojW3N3aWZ0X2JyaWRnZTo6YnJpZGdlXQptb2QgZmZpIHsKCiAgICBlbnVtIEJsb2NrVGFnIHsKICAgICAgICBMYXRlc3QsCiAgICAgICAgRmluYWxpemVkLAogICAgICAgIFNhZmUsCiAgICAgICAgRWFybGllc3QsCiAgICAgICAgUGVuZGluZywKICAgICAgICBOdW1iZXIodTY0KSwKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IENhbGxPcHRzIHsKICAgICAgICBwdWIgZnJvbTogU3RyaW5nLAogICAgICAgIHB1YiB0bzogU3RyaW5nLAogICAgICAgIHB1YiBnYXM6IFN0cmluZywKICAgICAgICBwdWIgZ2FzX3ByaWNlOiBTdHJpbmcsCiAgICAgICAgcHViIHZhbHVlOiBTdHJpbmcsCiAgICAgICAgcHViIGRhdGE6IFN0cmluZywKICAgIH0KCiAgICBlbnVtIEhlbGlvc05ldHdvcmsgewogICAgICAgIE1BSU5ORVQsCiAgICAgICAgR09FUkxJLAogICAgICAgIFNFUE9MSUEsCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBTdGFydFVwU3RhdGUgewogICAgICAgIHN0YXJ0ZWQ6IGJvb2wsCiAgICAgICAgZXJyb3I6IFN0cmluZywKICAgIH0KCiAgICBlbnVtIEZpbHRlckJsb2NrT3B0aW9uIHsKICAgICAgICBSYW5nZSB7CiAgICAgICAgICAgIGZyb21fYmxvY2s6IE9wdGlvbjxCbG9ja1RhZz4sCiAgICAgICAgICAgIHRvX2Jsb2NrOiBPcHRpb248QmxvY2tUYWc+LAogICAgICAgIH0sCiAgICAgICAgQXRCbG9ja0hhc2goU3RyaW5nKSwKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IExvZ0ZpbHRlciB7CiAgICAgICAgcHViIGJsb2NrX29wdGlvbjogRmlsdGVyQmxvY2tPcHRpb24sCiAgICAgICAgcHViIGFkZHJlc3M6IFN0cmluZywKICAgICAgICBwdWIgdG9waWNzOiBWZWM8U3RyaW5nPiwKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgI1tkZXJpdmUoQ2xvbmUpXQogICAgc3RydWN0IExvZyB7CiAgICAgICAgYWRkcmVzczogU3RyaW5nLAogICAgICAgIHRvcGljczogVmVjPFN0cmluZz4sCiAgICAgICAgZGF0YTogVmVjPHU4PiwKICAgICAgICBibG9ja19oYXNoOiBTdHJpbmcsCiAgICAgICAgYmxvY2tfbnVtYmVyOiBPcHRpb248dTY0PiwKICAgICAgICB0cmFuc2FjdGlvbl9oYXNoOiBTdHJpbmcsCiAgICAgICAgdHJhbnNhY3Rpb25faW5kZXg6IE9wdGlvbjx1NjQ+LAogICAgICAgIGxvZ19pbmRleDogU3RyaW5nLAogICAgICAgIHRyYW5zYWN0aW9uX2xvZ19pbmRleDogU3RyaW5nLAogICAgICAgIGxvZ190eXBlOiBTdHJpbmcsCiAgICAgICAgcmVtb3ZlZDogT3B0aW9uPGJvb2w+LAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgVHJhbnNhY3Rpb25SZWNlaXB0IHsKICAgICAgICB0cmFuc2FjdGlvbl9oYXNoOiBTdHJpbmcsCiAgICAgICAgdHJhbnNhY3Rpb25faW5kZXg6IHU2NCwKICAgICAgICBibG9ja19oYXNoOiBTdHJpbmcsIC8vIG9wdGlvbmFsCiAgICAgICAgYmxvY2tfbnVtYmVyOiBPcHRpb248dTY0PiwKICAgICAgICBmcm9tOiBTdHJpbmcsCiAgICAgICAgdG86IFN0cmluZywgLy8gb3B0aW9uYWwKICAgICAgICBjdW11bGF0aXZlX2dhc191c2VkOiBTdHJpbmcsCiAgICAgICAgZ2FzX3VzZWQ6IFN0cmluZywgICAgICAgICAvLyBvcHRpb25hbAogICAgICAgIGNvbnRyYWN0X2FkZHJlc3M6IFN0cmluZywgLy8gb3B0aW9uYWwKICAgICAgICBsb2dzOiBWZWM8TG9nPiwKICAgICAgICBzdGF0dXM6IE9wdGlvbjx1NjQ+LAogICAgICAgIHJvb3Q6IFN0cmluZywgLy8gb3B0aW9ubmFsCiAgICAgICAgbG9nc19ibG9vbTogVmVjPHU4PiwKICAgICAgICB0cmFuc2FjdGlvbl90eXBlOiBPcHRpb248dTY0PiwKICAgICAgICBlZmZlY3RpdmVfZ2FzX3ByaWNlOiBTdHJpbmcsIC8vb3B0aW9uYWwKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgI1tkZXJpdmUoQ2xvbmUpXQogICAgc3RydWN0IFRyYW5zYWN0aW9uIHsKICAgICAgICBoYXNoOiBTdHJpbmcsCiAgICAgICAgbm9uY2U6IFN0cmluZywKICAgICAgICBibG9ja19oYXNoOiBTdHJpbmcsIC8vb3B0aW9uYWwKICAgICAgICBibG9ja19udW1iZXI6IE9wdGlvbjx1NjQ+LAogICAgICAgIHRyYW5zYWN0aW9uX2luZGV4OiBPcHRpb248dTY0PiwKICAgICAgICBmcm9tOiBTdHJpbmcsCiAgICAgICAgdG86IFN0cmluZywgLy8gb3B0aW9uYWwKICAgICAgICB2YWx1ZTogU3RyaW5nLAogICAgICAgIGdhc19wcmljZTogU3RyaW5nLCAvLyBvcHRpb25hbAogICAgICAgIGdhczogU3RyaW5nLAogICAgICAgIGlucHV0OiBWZWM8dTg+LAogICAgICAgIHY6IFN0cmluZywKICAgICAgICByOiBTdHJpbmcsCiAgICAgICAgczogU3RyaW5nLAogICAgfQoKICAgIGVudW0gVHJhbnNhY3Rpb25zIHsKICAgICAgICBIYXNoZXMoVmVjPFN0cmluZz4pLAogICAgICAgIEZ1bGwoVmVjPFRyYW5zYWN0aW9uPiksCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBCbG9jayB7CiAgICAgICAgbnVtYmVyOiB1NjQsCiAgICAgICAgYmFzZV9mZWVfcGVyX2dhczogU3RyaW5nLAogICAgICAgIGRpZmZpY3VsdHk6IFN0cmluZywKICAgICAgICBleHRyYV9kYXRhOiBWZWM8dTg+LAogICAgICAgIGdhc19saW1pdDogdTY0LAogICAgICAgIGdhc191c2VkOiB1NjQsCiAgICAgICAgaGFzaDogU3RyaW5nLAogICAgICAgIGxvZ3NfYmxvb206IFZlYzx1OD4sCiAgICAgICAgbWluZXI6IFN0cmluZywKICAgICAgICBtaXhfaGFzaDogU3RyaW5nLAogICAgICAgIG5vbmNlOiBTdHJpbmcsCiAgICAgICAgcGFyZW50X2hhc2g6IFN0cmluZywKICAgICAgICByZWNlaXB0c19yb290OiBTdHJpbmcsCiAgICAgICAgc2hhM191bmNsZXM6IFN0cmluZywKICAgICAgICBzaXplOiB1NjQsCiAgICAgICAgc3RhdGVfcm9vdDogU3RyaW5nLAogICAgICAgIHRpbWVzdGFtcDogdTY0LAogICAgICAgIHRvdGFsX2RpZmZpY3VsdHk6IHU2NCwKICAgICAgICB0cmFuc2FjdGlvbnM6IFRyYW5zYWN0aW9ucywKICAgICAgICB0cmFuc2FjdGlvbnNfcm9vdDogU3RyaW5nLAogICAgICAgIHVuY2xlczogVmVjPFN0cmluZz4sCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBTeW5jaW5nU3RhdHVzIHsKICAgICAgICBwdWIgY3VycmVudF9ibG9jazogdTY0LAogICAgICAgIHB1YiBoaWdoZXN0X2Jsb2NrOiB1NjQsCiAgICAgICAgcHViIHN0YXJ0aW5nX2Jsb2NrOiB1NjQsCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBSZXNwb25zZVU2NCB7CiAgICAgICAgdmFsdWU6IHU2NCwKICAgICAgICBmYWlsZWQ6IGJvb2wsCiAgICAgICAgZXJyb3I6IFN0cmluZywKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IFJlc3BvbnNlU3RyaW5nIHsKICAgICAgICB2YWx1ZTogU3RyaW5nLAogICAgICAgIGZhaWxlZDogYm9vbCwKICAgICAgICBlcnJvcjogU3RyaW5nLAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgUmVzcG9uc2VWZWM4IHsKICAgICAgICB2YWx1ZTogVmVjPHU4PiwKICAgICAgICBmYWlsZWQ6IGJvb2wsCiAgICAgICAgZXJyb3I6IFN0cmluZywKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IFJlc3BvbnNlVmVjTG9nIHsKICAgICAgICB2YWx1ZTogVmVjPExvZz4sCiAgICAgICAgZmFpbGVkOiBib29sLAogICAgICAgIGVycm9yOiBTdHJpbmcsCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBSZXNwb25zZVRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICAgICAgdmFsdWU6IE9wdGlvbjxUcmFuc2FjdGlvblJlY2VpcHQ+LAogICAgICAgIGZhaWxlZDogYm9vbCwKICAgICAgICBlcnJvcjogU3RyaW5nLAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgUmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgdmFsdWU6IE9wdGlvbjxUcmFuc2FjdGlvbj4sCiAgICAgICAgZmFpbGVkOiBib29sLAogICAgICAgIGVycm9yOiBTdHJpbmcsCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBSZXNwb25zZUJsb2NrIHsKICAgICAgICB2YWx1ZTogT3B0aW9uPEJsb2NrPiwKICAgICAgICBmYWlsZWQ6IGJvb2wsCiAgICAgICAgZXJyb3I6IFN0cmluZywKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IFJlc3BvbnNlU3luY2luZyB7CiAgICAgICAgdmFsdWU6IE9wdGlvbjxTeW5jaW5nU3RhdHVzPiwKICAgICAgICBmYWlsZWQ6IGJvb2wsCiAgICAgICAgZXJyb3I6IFN0cmluZywKICAgIH0KCiAgICBleHRlcm4gIlJ1c3QiIHsKICAgICAgICB0eXBlIEhlbGlvc0NsaWVudDsKCiAgICAgICAgI1tzd2lmdF9icmlkZ2UoaW5pdCldCiAgICAgICAgZm4gbmV3KCkgLT4gSGVsaW9zQ2xpZW50OwoKICAgICAgICBhc3luYyBmbiBzdGFydCgKICAgICAgICAgICAgJm11dCBzZWxmLAogICAgICAgICAgICB1bnRydXN0ZWRfcnBjX3VybDogU3RyaW5nLAogICAgICAgICAgICBjb25zZW5zdXNfcnBjX3VybDogU3RyaW5nLAogICAgICAgICAgICBjaGVja3BvaW50OiBPcHRpb248U3RyaW5nPiwKICAgICAgICAgICAgcnBjX3BvcnQ6IHUxNiwKICAgICAgICAgICAgbmV0d29yazogSGVsaW9zTmV0d29yaywKICAgICAgICAgICAgZGF0YV9kaXI6IE9wdGlvbjxTdHJpbmc+LAogICAgICAgICkgLT4gU3RhcnRVcFN0YXRlOwoKICAgICAgICBhc3luYyBmbiBzaHV0ZG93bigmbXV0IHNlbGYpOwoKICAgICAgICBhc3luYyBmbiBjYWxsKCZzZWxmLCBvcHRzOiBDYWxsT3B0cywgYmxvY2s6IEJsb2NrVGFnKSAtPiBSZXNwb25zZVZlYzg7CiAgICAgICAgYXN5bmMgZm4gc2VuZF9yYXdfdHJhbnNhY3Rpb24oJnNlbGYsIGJ5dGVzOiBWZWM8dTg+KSAtPiBSZXNwb25zZVN0cmluZzsKCiAgICAgICAgYXN5bmMgZm4gZXN0aW1hdGVfZ2FzKCZzZWxmLCBvcHRzOiBDYWxsT3B0cykgLT4gUmVzcG9uc2VVNjQ7CiAgICAgICAgYXN5bmMgZm4gY2hhaW5faWQoJnNlbGYpIC0+IFJlc3BvbnNlVTY0OwogICAgICAgIGFzeW5jIGZuIGdldF9nYXNfcHJpY2UoJnNlbGYpIC0+IFJlc3BvbnNlU3RyaW5nOwogICAgICAgIGFzeW5jIGZuIGdldF9wcmlvcml0eV9mZWUoJnNlbGYpIC0+IFJlc3BvbnNlU3RyaW5nOwogICAgICAgIGFzeW5jIGZuIGdldF9ibG9ja19udW1iZXIoJnNlbGYpIC0+IFJlc3BvbnNlU3RyaW5nOwogICAgICAgIGFzeW5jIGZuIGdldF9jb2luYmFzZSgmc2VsZikgLT4gUmVzcG9uc2VTdHJpbmc7CgogICAgICAgIGFzeW5jIGZuIGdldF9iYWxhbmNlKCZzZWxmLCBhZGRyZXNzOiBTdHJpbmcsIGJsb2NrOiBCbG9ja1RhZykgLT4gUmVzcG9uc2VTdHJpbmc7CiAgICAgICAgYXN5bmMgZm4gZ2V0X25vbmNlKCZzZWxmLCBhZGRyZXNzOiBTdHJpbmcsIGJsb2NrOiBCbG9ja1RhZykgLT4gUmVzcG9uc2VVNjQ7CgogICAgICAgIGFzeW5jIGZuIGdldF9ibG9ja19ieV9udW1iZXIoCiAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICBibG9jazogQmxvY2tUYWcsCiAgICAgICAgICAgIGZ1bGxfdHg6IGJvb2wsCiAgICAgICAgKSAtPiBSZXNwb25zZUJsb2NrOwogICAgICAgIGFzeW5jIGZuIGdldF9ibG9ja19ieV9oYXNoKCZzZWxmLCBoYXNoOiBTdHJpbmcsIGZ1bGxfdHg6IGJvb2wpIC0+IFJlc3BvbnNlQmxvY2s7CiAgICAgICAgYXN5bmMgZm4gZ2V0X2Jsb2NrX3RyYW5zYWN0aW9uX2NvdW50X2J5X2hhc2goJnNlbGYsIGhhc2g6IFN0cmluZykgLT4gUmVzcG9uc2VVNjQ7CiAgICAgICAgYXN5bmMgZm4gZ2V0X2Jsb2NrX3RyYW5zYWN0aW9uX2NvdW50X2J5X251bWJlcigmc2VsZiwgYmxvY2s6IEJsb2NrVGFnKSAtPiBSZXNwb25zZVU2NDsKCiAgICAgICAgYXN5bmMgZm4gZ2V0X3RyYW5zYWN0aW9uX3JlY2VpcHQoJnNlbGYsIHR4X2hhc2g6IFN0cmluZykgLT4gUmVzcG9uc2VUcmFuc2FjdGlvblJlY2VpcHQ7CiAgICAgICAgYXN5bmMgZm4gZ2V0X3RyYW5zYWN0aW9uX2J5X2hhc2goJnNlbGYsIHR4X2hhc2g6IFN0cmluZykgLT4gUmVzcG9uc2VUcmFuc2FjdGlvbjsKICAgICAgICBhc3luYyBmbiBnZXRfdHJhbnNhY3Rpb25fYnlfYmxvY2tfaGFzaF9hbmRfaW5kZXgoCiAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICBibG9ja19oYXNoOiBTdHJpbmcsCiAgICAgICAgICAgIGluZGV4OiB1NjQsCiAgICAgICAgKSAtPiBSZXNwb25zZVRyYW5zYWN0aW9uOwoKICAgICAgICBhc3luYyBmbiBnZXRfbG9ncygmc2VsZiwgZmlsdGVyOiBMb2dGaWx0ZXIpIC0+IFJlc3BvbnNlVmVjTG9nOwoKICAgICAgICBhc3luYyBmbiBnZXRfY29kZSgmc2VsZiwgYWRkcmVzczogU3RyaW5nLCBibG9jazogQmxvY2tUYWcpIC0+IFJlc3BvbnNlVmVjODsKICAgICAgICBhc3luYyBmbiBnZXRfc3RvcmFnZV9hdCgKICAgICAgICAgICAgJnNlbGYsCiAgICAgICAgICAgIGFkZHJlc3M6IFN0cmluZywKICAgICAgICAgICAgc2xvdDogU3RyaW5nLAogICAgICAgICAgICBibG9jazogQmxvY2tUYWcsCiAgICAgICAgKSAtPiBSZXNwb25zZVN0cmluZzsKCiAgICAgICAgYXN5bmMgZm4gc3luY2luZygmc2VsZikgLT4gUmVzcG9uc2VTeW5jaW5nOwogICAgfQp9CgppbXBsIEhlbGlvc0NsaWVudCB7CiAgICBwdWIgZm4gbmV3KCkgLT4gSGVsaW9zQ2xpZW50IHsKICAgICAgICBIZWxpb3NDbGllbnQgewogICAgICAgICAgICBjbGllbnQ6IE5vbmUsCiAgICAgICAgICAgIGlzX2xvZ2dpbmc6IGZhbHNlLAogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBzdGFydCgKICAgICAgICAmbXV0IHNlbGYsCiAgICAgICAgdW50cnVzdGVkX3JwY191cmw6IFN0cmluZywKICAgICAgICBjb25zZW5zdXNfcnBjX3VybDogU3RyaW5nLAogICAgICAgIGNoZWNrcG9pbnQ6IE9wdGlvbjxTdHJpbmc+LAogICAgICAgIHJwY19wb3J0OiB1MTYsCiAgICAgICAgbmV0d29yazogZmZpOjpIZWxpb3NOZXR3b3JrLAogICAgICAgIGRhdGFfZGlyOiBPcHRpb248U3RyaW5nPiwKICAgICkgLT4gZmZpOjpTdGFydFVwU3RhdGUgewogICAgICAgIGlmIGxldCBTb21lKF9jbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgcmV0dXJuIGZmaTo6U3RhcnRVcFN0YXRlIHsKICAgICAgICAgICAgICAgIHN0YXJ0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJDbGllbnQgaGFzIGFscmVhZHkgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9OwogICAgICAgIH0KCiAgICAgICAgaWYgIXNlbGYuaXNfbG9nZ2luZyB7CiAgICAgICAgICAgIHNlbGYuaXNfbG9nZ2luZyA9IHRydWU7CiAgICAgICAgICAgIGxldCBlbnZfZmlsdGVyID0gRW52RmlsdGVyOjpidWlsZGVyKCkKICAgICAgICAgICAgICAgIC53aXRoX2RlZmF1bHRfZGlyZWN0aXZlKExldmVsRmlsdGVyOjpJTkZPLmludG8oKSkKICAgICAgICAgICAgICAgIC5mcm9tX2VudigpCiAgICAgICAgICAgICAgICAuZXhwZWN0KCJpbnZhbGlkIGVudiBmaWx0ZXIiKTsKICAgICAgICAKICAgICAgICAgICAgbGV0IHN1YnNjcmliZXIgPSBGbXRTdWJzY3JpYmVyOjpidWlsZGVyKCkKICAgICAgICAgICAgICAgIC53aXRoX2Vudl9maWx0ZXIoZW52X2ZpbHRlcikKICAgICAgICAgICAgICAgIC5maW5pc2goKTsKICAgICAgICAKICAgICAgICAgICAgdHJhY2luZzo6c3Vic2NyaWJlcjo6c2V0X2dsb2JhbF9kZWZhdWx0KHN1YnNjcmliZXIpLmV4cGVjdCgic3Vic2NyaWJlciBzZXQgZmFpbGVkIik7CiAgICAgICAgfQoKICAgICAgICBsZXQgbXV0IGNsaWVudF9idWlsZGVyID0gQ2xpZW50QnVpbGRlcjo6bmV3KCkKICAgICAgICAgICAgLm5ldHdvcmsobmV0d29yay50b19iYXNlX25ldHdvcmsoKSkKICAgICAgICAgICAgLmV4ZWN1dGlvbl9ycGMoJnVudHJ1c3RlZF9ycGNfdXJsKQogICAgICAgICAgICAuY29uc2Vuc3VzX3JwYygmY29uc2Vuc3VzX3JwY191cmwpCiAgICAgICAgICAgIC5ycGNfcG9ydChycGNfcG9ydCk7CgogICAgICAgIGlmIGxldCBTb21lKGNoZWNrcG9pbnQpID0gJmNoZWNrcG9pbnQgewogICAgICAgICAgICBjbGllbnRfYnVpbGRlciA9IGNsaWVudF9idWlsZGVyLmNoZWNrcG9pbnQoJmNoZWNrcG9pbnQpOwogICAgICAgIH0KCiAgICAgICAgaWYgbGV0IFNvbWUoZGF0YV9kaXIpID0gJmRhdGFfZGlyIHsKICAgICAgICAgICAgY2xpZW50X2J1aWxkZXIgPSBjbGllbnRfYnVpbGRlci5kYXRhX2RpcigoJmRhdGFfZGlyKS5pbnRvKCkpOwogICAgICAgIH0KCiAgICAgICAgbWF0Y2ggY2xpZW50X2J1aWxkZXIuYnVpbGQoKSB7CiAgICAgICAgICAgIEVycihlcnJvcikgPT4gewogICAgICAgICAgICAgICAgcmV0dXJuIGZmaTo6U3RhcnRVcFN0YXRlIHsKICAgICAgICAgICAgICAgICAgICBzdGFydGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH0KICAgICAgICAgICAgT2sobXV0IGNsaWVudCkgPT4gbWF0Y2ggY2xpZW50LnN0YXJ0KCkuYXdhaXQgewogICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZmaTo6U3RhcnRVcFN0YXRlIHsKICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBPaygoKSkgPT4gewogICAgICAgICAgICAgICAgICAgIHNlbGYuY2xpZW50ID0gU29tZShjbGllbnQpOwogICAgICAgICAgICAgICAgICAgIHJldHVybiBmZmk6OlN0YXJ0VXBTdGF0ZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9OwogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9LAogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBzaHV0ZG93bigmbXV0IHNlbGYpIHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgY2xpZW50LnNodXRkb3duKCkuYXdhaXQ7CiAgICAgICAgICAgIHNlbGYuY2xpZW50ID0gTm9uZTsKICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gY2FsbCgmc2VsZiwgb3B0czogZmZpOjpDYWxsT3B0cywgYmxvY2s6IGZmaTo6QmxvY2tUYWcpIC0+IGZmaTo6UmVzcG9uc2VWZWM4IHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggJm9wdHMudG9fYmFzZV9vcHRzKCkgewogICAgICAgICAgICAgICAgT2sob3B0cykgPT4gbWF0Y2ggY2xpZW50LmNhbGwob3B0cywgYmxvY2sudG9fYmFzZV9ibG9jaygpKS5hd2FpdCB7CiAgICAgICAgICAgICAgICAgICAgT2soZGF0YSkgPT4gZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZGF0YSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlVmVjOCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBbXS5pbnRvKCksCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlVmVjOCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IFtdLmludG8oKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIkludmFsaWQgY2FsbCBvcHRpb25zOiB7fSIsIGVycm9yKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlVmVjOCB7CiAgICAgICAgICAgICAgICB2YWx1ZTogW10uaW50bygpLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gc2VuZF9yYXdfdHJhbnNhY3Rpb24oJnNlbGYsIGJ5dGVzOiBWZWM8dTg+KSAtPiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggY2xpZW50LnNlbmRfcmF3X3RyYW5zYWN0aW9uKCZieXRlcykuYXdhaXQgewogICAgICAgICAgICAgICAgT2soaGFzaCkgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShoYXNoKSksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZXN0aW1hdGVfZ2FzKCZzZWxmLCBvcHRzOiBmZmk6OkNhbGxPcHRzKSAtPiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggJm9wdHMudG9fYmFzZV9vcHRzKCkgewogICAgICAgICAgICAgICAgT2sob3B0cykgPT4gbWF0Y2ggY2xpZW50LmVzdGltYXRlX2dhcygmb3B0cykuYXdhaXQgewogICAgICAgICAgICAgICAgICAgIE9rKGdhcykgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBnYXMsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJJbnZhbGlkIGNhbGwgb3B0aW9uczoge30iLCBlcnJvciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGNoYWluX2lkKCZzZWxmKSAtPiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICB2YWx1ZTogY2xpZW50LmNoYWluX2lkKCkuYXdhaXQsCiAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQogICAgYXN5bmMgZm4gZ2V0X2dhc19wcmljZSgmc2VsZikgLT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGNsaWVudC5nZXRfZ2FzX3ByaWNlKCkuYXdhaXQgewogICAgICAgICAgICAgICAgT2soZ2FzX3ByaWNlKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZ2FzX3ByaWNlLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfcHJpb3JpdHlfZmVlKCZzZWxmKSAtPiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggY2xpZW50LmdldF9wcmlvcml0eV9mZWUoKS5hd2FpdCB7CiAgICAgICAgICAgICAgICBPayhwcmlvcml0eV9mZWUpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBwcmlvcml0eV9mZWUudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9ibG9ja19udW1iZXIoJnNlbGYpIC0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBjbGllbnQuZ2V0X2Jsb2NrX251bWJlcigpLmF3YWl0IHsKICAgICAgICAgICAgICAgIE9rKGJsb2NrKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogYmxvY2sudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogIjAiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICB2YWx1ZTogIjAiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X2NvaW5iYXNlKCZzZWxmKSAtPiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggY2xpZW50LmdldF9jb2luYmFzZSgpLmF3YWl0IHsKICAgICAgICAgICAgICAgIE9rKGNvaW5iYXNlKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGNvaW5iYXNlLmFzX2J5dGVzKCkpKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X2JhbGFuY2UoJnNlbGYsIGFkZHJlc3M6IFN0cmluZywgYmxvY2s6IGZmaTo6QmxvY2tUYWcpIC0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBhZGRyZXNzX2Zyb21fc3RyaW5nKGFkZHJlc3MpIHsKICAgICAgICAgICAgICAgIE9rKGFkZHJlc3MpID0+IG1hdGNoIGNsaWVudC5nZXRfYmFsYW5jZSgmYWRkcmVzcywgYmxvY2sudG9fYmFzZV9ibG9jaygpKS5hd2FpdCB7CiAgICAgICAgICAgICAgICAgICAgT2soYmFsYW5jZSkgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBiYWxhbmNlLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJJbnZhbGlkIGFkZHJlc3M6IHt9IiwgZXJyb3IpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X25vbmNlKCZzZWxmLCBhZGRyZXNzOiBTdHJpbmcsIGJsb2NrOiBmZmk6OkJsb2NrVGFnKSAtPiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggYWRkcmVzc19mcm9tX3N0cmluZyhhZGRyZXNzKSB7CiAgICAgICAgICAgICAgICBPayhhZGRyZXNzKSA9PiBtYXRjaCBjbGllbnQuZ2V0X25vbmNlKCZhZGRyZXNzLCBibG9jay50b19iYXNlX2Jsb2NrKCkpLmF3YWl0IHsKICAgICAgICAgICAgICAgICAgICBPayhub25jZSkgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBub25jZSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIkludmFsaWQgYWRkcmVzczoge30iLCBlcnJvciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9ibG9ja19ieV9udW1iZXIoCiAgICAgICAgJnNlbGYsCiAgICAgICAgYmxvY2s6IGZmaTo6QmxvY2tUYWcsCiAgICAgICAgZnVsbF90eDogYm9vbCwKICAgICkgLT4gZmZpOjpSZXNwb25zZUJsb2NrIHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggY2xpZW50CiAgICAgICAgICAgICAgICAuZ2V0X2Jsb2NrX2J5X251bWJlcihibG9jay50b19iYXNlX2Jsb2NrKCksIGZ1bGxfdHgpCiAgICAgICAgICAgICAgICAuYXdhaXQKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgT2soYmxvY2spID0+IGZmaTo6UmVzcG9uc2VCbG9jayB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGJsb2NrLm1hcChoZWxpb3NfZXhlY3V0aW9uX2Jsb2NrX3RvX2ZmaSksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycikgPT4gZmZpOjpSZXNwb25zZUJsb2NrIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVyci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlQmxvY2sgewogICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfYmxvY2tfYnlfaGFzaCgmc2VsZiwgaGFzaDogU3RyaW5nLCBmdWxsX3R4OiBib29sKSAtPiBmZmk6OlJlc3BvbnNlQmxvY2sgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBoMjU2X2Zyb21fc3RyaW5nKGhhc2gpIHsKICAgICAgICAgICAgICAgIE9rKGhhc2gpID0+IHsKICAgICAgICAgICAgICAgICAgICBtYXRjaCBjbGllbnQKICAgICAgICAgICAgICAgICAgICAgICAgLmdldF9ibG9ja19ieV9oYXNoKCZoYXNoLCBmdWxsX3R4KQogICAgICAgICAgICAgICAgICAgICAgICAuYXdhaXQKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIE9rKGJsb2NrKSA9PiBmZmk6OlJlc3BvbnNlQmxvY2sgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGJsb2NrLm1hcChoZWxpb3NfZXhlY3V0aW9uX2Jsb2NrX3RvX2ZmaSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlQmxvY2sgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VCbG9jayB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJCbG9jayBoYXNoOiB7fSIsIGVyciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZUJsb2NrIHsKICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X2Jsb2NrX3RyYW5zYWN0aW9uX2NvdW50X2J5X2hhc2goJnNlbGYsIGhhc2g6IFN0cmluZykgLT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGgyNTZfZnJvbV9zdHJpbmcoaGFzaCkgewogICAgICAgICAgICAgICAgT2soaGFzaCkgPT4gewogICAgICAgICAgICAgICAgICAgIG1hdGNoIGNsaWVudAogICAgICAgICAgICAgICAgICAgICAgICAuZ2V0X2Jsb2NrX3RyYW5zYWN0aW9uX2NvdW50X2J5X2hhc2goJmhhc2gpCiAgICAgICAgICAgICAgICAgICAgICAgIC5hd2FpdAogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgT2soY291bnQpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGNvdW50LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgRXJyKGVycikgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgRXJyKGVycikgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJCbG9jayBoYXNoOiB7fSIsIGVyciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9ibG9ja190cmFuc2FjdGlvbl9jb3VudF9ieV9udW1iZXIoCiAgICAgICAgJnNlbGYsCiAgICAgICAgYmxvY2s6IGZmaTo6QmxvY2tUYWcsCiAgICApIC0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBjbGllbnQKICAgICAgICAgICAgICAgIC5nZXRfYmxvY2tfdHJhbnNhY3Rpb25fY291bnRfYnlfbnVtYmVyKGJsb2NrLnRvX2Jhc2VfYmxvY2soKSkKICAgICAgICAgICAgICAgIC5hd2FpdAogICAgICAgICAgICB7CiAgICAgICAgICAgICAgICBPayhjb3VudCkgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGNvdW50LAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X3RyYW5zYWN0aW9uX3JlY2VpcHQoJnNlbGYsIHR4X2hhc2g6IFN0cmluZykgLT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGgyNTZfZnJvbV9zdHJpbmcodHhfaGFzaCkgewogICAgICAgICAgICAgICAgT2sodHhfaGFzaCkgPT4gbWF0Y2ggY2xpZW50LmdldF90cmFuc2FjdGlvbl9yZWNlaXB0KCZ0eF9oYXNoKS5hd2FpdCB7CiAgICAgICAgICAgICAgICAgICAgT2socmVjZWlwdCkgPT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiByZWNlaXB0Lm1hcChldGhlcnNfcmVjZWlwdF90b19mZmkpLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvblJlY2VpcHQgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvblJlY2VpcHQgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiVHJhbnNhY3Rpb24gaGFzaDoge30iLCBlcnJvciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF90cmFuc2FjdGlvbl9ieV9oYXNoKCZzZWxmLCB0eF9oYXNoOiBTdHJpbmcpIC0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGgyNTZfZnJvbV9zdHJpbmcodHhfaGFzaCkgewogICAgICAgICAgICAgICAgT2soaGFzaCkgPT4gbWF0Y2ggY2xpZW50LmdldF90cmFuc2FjdGlvbl9ieV9oYXNoKCZoYXNoKS5hd2FpdCB7CiAgICAgICAgICAgICAgICAgICAgU29tZSh0cmFuc2FjdGlvbikgPT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IFNvbWUoZXRoZXJzX3RyYW5zYWN0aW9uX3RvX2ZmaSh0cmFuc2FjdGlvbikpLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBOb25lID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiVHJhbnNhY3Rpb24gbm90IGZvdW5kLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiVHJhbnNhY3Rpb24gaGFzaDoge30iLCBlcnIpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF90cmFuc2FjdGlvbl9ieV9ibG9ja19oYXNoX2FuZF9pbmRleCgKICAgICAgICAmc2VsZiwKICAgICAgICBibG9ja19oYXNoOiBTdHJpbmcsCiAgICAgICAgaW5kZXg6IHU2NCwKICAgICkgLT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggaDI1Nl9mcm9tX3N0cmluZyhibG9ja19oYXNoKSB7CiAgICAgICAgICAgICAgICBPayhoYXNoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2ggY2xpZW50CiAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRfdHJhbnNhY3Rpb25fYnlfYmxvY2tfaGFzaF9hbmRfaW5kZXgoJmhhc2gsIGluZGV4KQogICAgICAgICAgICAgICAgICAgICAgICAuYXdhaXQKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIFNvbWUodHJhbnNhY3Rpb24pID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogU29tZShldGhlcnNfdHJhbnNhY3Rpb25fdG9fZmZpKHRyYW5zYWN0aW9uKSksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICBOb25lID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiVHJhbnNhY3Rpb24gbm90IGZvdW5kLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgRXJyKGVycikgPT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIkJsb2NrIGhhc2g6IHt9IiwgZXJyKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfbG9ncygmc2VsZiwgZmlsdGVyOiBmZmk6OkxvZ0ZpbHRlcikgLT4gZmZpOjpSZXNwb25zZVZlY0xvZyB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGZpbHRlci50b19ldGhlcnNfZmlsdGVyKCkgewogICAgICAgICAgICAgICAgT2soZmlsdGVyKSA9PiBtYXRjaCBjbGllbnQuZ2V0X2xvZ3MoJmZpbHRlcikuYXdhaXQgewogICAgICAgICAgICAgICAgICAgIE9rKGxvZ3MpID0+IGZmaTo6UmVzcG9uc2VWZWNMb2cgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbG9ncy5pbnRvX2l0ZXIoKS5tYXAoZXRoZXJzX2xvZ190b19mZmlfbG9nKS5jb2xsZWN0KCksCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VWZWNMb2cgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdmVjIVtdLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlVmVjTG9nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogdmVjIVtdLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiSW52YWxpZCBmaWx0ZXI6IHt9IiwgZXJyKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlVmVjTG9nIHsKICAgICAgICAgICAgICAgIHZhbHVlOiB2ZWMhW10sCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfY29kZSgmc2VsZiwgYWRkcmVzczogU3RyaW5nLCBibG9jazogZmZpOjpCbG9ja1RhZykgLT4gZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBhZGRyZXNzX2Zyb21fc3RyaW5nKGFkZHJlc3MpIHsKICAgICAgICAgICAgICAgIE9rKGFkZHJlc3MpID0+IG1hdGNoIGNsaWVudC5nZXRfY29kZSgmYWRkcmVzcywgYmxvY2sudG9fYmFzZV9ibG9jaygpKS5hd2FpdCB7CiAgICAgICAgICAgICAgICAgICAgT2soY29kZSkgPT4gZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogY29kZSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlVmVjOCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBbXS5pbnRvKCksCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlVmVjOCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IFtdLmludG8oKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIkludmFsaWQgYWRkcmVzczoge30iLCBlcnJvciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgICAgICAgICAgdmFsdWU6IFtdLmludG8oKSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9zdG9yYWdlX2F0KAogICAgICAgICZzZWxmLAogICAgICAgIGFkZHJlc3M6IFN0cmluZywKICAgICAgICBzbG90OiBTdHJpbmcsCiAgICAgICAgYmxvY2s6IGZmaTo6QmxvY2tUYWcsCiAgICApIC0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBhZGRyZXNzX2Zyb21fc3RyaW5nKGFkZHJlc3MpIHsKICAgICAgICAgICAgICAgIE9rKGFkZHJlc3MpID0+IG1hdGNoIGgyNTZfZnJvbV9zdHJpbmcoc2xvdCkgewogICAgICAgICAgICAgICAgICAgIE9rKHNsb3QpID0+IHsKICAgICAgICAgICAgICAgICAgICAgICAgbWF0Y2ggY2xpZW50CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuZ2V0X3N0b3JhZ2VfYXQoJmFkZHJlc3MsIHNsb3QsIGJsb2NrLnRvX2Jhc2VfYmxvY2soKSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5hd2FpdAogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBPayhzdG9yYWdlKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogc3RvcmFnZS5lbmNvZGVfaGV4KCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJJbnZhbGlkIHNsb3Q6IHt9IiwgZXJyb3IpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJJbnZhbGlkIGFkZHJlc3M6IHt9IiwgZXJyb3IpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gc3luY2luZygmc2VsZikgLT4gZmZpOjpSZXNwb25zZVN5bmNpbmcgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBjbGllbnQuc3luY2luZygpLmF3YWl0IHsKICAgICAgICAgICAgICAgIE9rKHN0YXR1cykgPT4gZmZpOjpSZXNwb25zZVN5bmNpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBldGhlcnNfc3luY2luZ19zdGF0dXNfdG9fZmZpKHN0YXR1cyksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycikgPT4gZmZpOjpSZXNwb25zZVN5bmNpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VTeW5jaW5nIHsKICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9Cn0KCmltcGwgZmZpOjpIZWxpb3NOZXR3b3JrIHsKICAgIGZuIHRvX2Jhc2VfbmV0d29yaygmc2VsZikgLT4gbmV0d29ya3M6Ok5ldHdvcmsgewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpNQUlOTkVUID0+IG5ldHdvcmtzOjpOZXR3b3JrOjpNQUlOTkVULAogICAgICAgICAgICBTZWxmOjpHT0VSTEkgPT4gbmV0d29ya3M6Ok5ldHdvcms6OkdPRVJMSSwKICAgICAgICAgICAgU2VsZjo6U0VQT0xJQSA9PiBuZXR3b3Jrczo6TmV0d29yazo6U0VQT0xJQSwKICAgICAgICB9CiAgICB9Cn0KCmltcGwgZmZpOjpCbG9ja1RhZyB7CiAgICBmbiB0b19iYXNlX2Jsb2NrKCZzZWxmKSAtPiBjb21tb246OnR5cGVzOjpCbG9ja1RhZyB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6OkZpbmFsaXplZCA9PiBjb21tb246OnR5cGVzOjpCbG9ja1RhZzo6RmluYWxpemVkLAogICAgICAgICAgICBTZWxmOjpMYXRlc3QgPT4gY29tbW9uOjp0eXBlczo6QmxvY2tUYWc6OkxhdGVzdCwKICAgICAgICAgICAgU2VsZjo6U2FmZSA9PiBjb21tb246OnR5cGVzOjpCbG9ja1RhZzo6RmluYWxpemVkLAogICAgICAgICAgICBTZWxmOjpQZW5kaW5nID0+IGNvbW1vbjo6dHlwZXM6OkJsb2NrVGFnOjpMYXRlc3QsCiAgICAgICAgICAgIFNlbGY6OkVhcmxpZXN0ID0+IGNvbW1vbjo6dHlwZXM6OkJsb2NrVGFnOjpOdW1iZXIoMSksCiAgICAgICAgICAgIFNlbGY6Ok51bWJlcihibG9jaykgPT4gY29tbW9uOjp0eXBlczo6QmxvY2tUYWc6Ok51bWJlcigqYmxvY2spLAogICAgICAgIH0KICAgIH0KCiAgICBmbiB0b19ldGhlcnNfYmxvY2soJnNlbGYpIC0+IEJsb2NrTnVtYmVyIHsKICAgICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgICAgU2VsZjo6RmluYWxpemVkID0+IEJsb2NrTnVtYmVyOjpGaW5hbGl6ZWQsCiAgICAgICAgICAgIFNlbGY6OkxhdGVzdCA9PiBCbG9ja051bWJlcjo6TGF0ZXN0LAogICAgICAgICAgICBTZWxmOjpTYWZlID0+IEJsb2NrTnVtYmVyOjpTYWZlLAogICAgICAgICAgICBTZWxmOjpQZW5kaW5nID0+IEJsb2NrTnVtYmVyOjpQZW5kaW5nLAogICAgICAgICAgICBTZWxmOjpFYXJsaWVzdCA9PiBCbG9ja051bWJlcjo6RWFybGllc3QsCiAgICAgICAgICAgIFNlbGY6Ok51bWJlcihibG9jaykgPT4gQmxvY2tOdW1iZXI6Ok51bWJlcihVNjQ6OmZyb20oKmJsb2NrKSksCiAgICAgICAgfQogICAgfQp9CgppbXBsIENsb25lIGZvciBmZmk6OkJsb2NrVGFnIHsKICAgIGZuIGNsb25lKCZzZWxmKSAtPiBTZWxmIHsKICAgICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgICAgU2VsZjo6RmluYWxpemVkID0+IGZmaTo6QmxvY2tUYWc6OkZpbmFsaXplZCwKICAgICAgICAgICAgU2VsZjo6TGF0ZXN0ID0+IGZmaTo6QmxvY2tUYWc6OkxhdGVzdCwKICAgICAgICAgICAgU2VsZjo6U2FmZSA9PiBmZmk6OkJsb2NrVGFnOjpTYWZlLAogICAgICAgICAgICBTZWxmOjpQZW5kaW5nID0+IGZmaTo6QmxvY2tUYWc6OlBlbmRpbmcsCiAgICAgICAgICAgIFNlbGY6OkVhcmxpZXN0ID0+IGZmaTo6QmxvY2tUYWc6OkVhcmxpZXN0LAogICAgICAgICAgICBTZWxmOjpOdW1iZXIoYmxvY2spID0+IGZmaTo6QmxvY2tUYWc6Ok51bWJlcigqYmxvY2spLAogICAgICAgIH0KICAgIH0KfQoKaW1wbCBmZmk6OkZpbHRlckJsb2NrT3B0aW9uIHsKICAgIGZuIHRvX2V0aGVyc19ibG9ja19vcHRpb24oJnNlbGYpIC0+IFJlc3VsdDxGaWx0ZXJCbG9ja09wdGlvbiwgU3RyaW5nPiB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6OlJhbmdlIHsKICAgICAgICAgICAgICAgIGZyb21fYmxvY2ssCiAgICAgICAgICAgICAgICB0b19ibG9jaywKICAgICAgICAgICAgfSA9PiBPayhGaWx0ZXJCbG9ja09wdGlvbjo6UmFuZ2UgewogICAgICAgICAgICAgICAgZnJvbV9ibG9jazogZnJvbV9ibG9jay5hc19yZWYoKS5tYXAofGJsb2NrfCBibG9jay50b19ldGhlcnNfYmxvY2soKSksCiAgICAgICAgICAgICAgICB0b19ibG9jazogdG9fYmxvY2suYXNfcmVmKCkubWFwKHxibG9ja3wgYmxvY2sudG9fZXRoZXJzX2Jsb2NrKCkpLAogICAgICAgICAgICB9KSwKICAgICAgICAgICAgU2VsZjo6QXRCbG9ja0hhc2goaGFzaCkgPT4gT2soRmlsdGVyQmxvY2tPcHRpb246OkF0QmxvY2tIYXNoKAogICAgICAgICAgICAgICAgaDI1Nl9mcm9tX3N0cmluZyhoYXNoLnRvX3N0cmluZygpKQogICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKHxlcnJvcnwgZm9ybWF0ISgiRmlsdGVyIGJsb2NrIGhhc2g6IHt9IiwgZXJyb3IpKT8sCiAgICAgICAgICAgICkpLAogICAgICAgIH0KICAgIH0KfQoKaW1wbCBDbG9uZSBmb3IgZmZpOjpGaWx0ZXJCbG9ja09wdGlvbiB7CiAgICBmbiBjbG9uZSgmc2VsZikgLT4gU2VsZiB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6OlJhbmdlIHsKICAgICAgICAgICAgICAgIGZyb21fYmxvY2ssCiAgICAgICAgICAgICAgICB0b19ibG9jaywKICAgICAgICAgICAgfSA9PiBmZmk6OkZpbHRlckJsb2NrT3B0aW9uOjpSYW5nZSB7CiAgICAgICAgICAgICAgICBmcm9tX2Jsb2NrOiBmcm9tX2Jsb2NrLmNsb25lKCksCiAgICAgICAgICAgICAgICB0b19ibG9jazogdG9fYmxvY2suY2xvbmUoKSwKICAgICAgICAgICAgfSwKICAgICAgICAgICAgU2VsZjo6QXRCbG9ja0hhc2goaGFzaCkgPT4gZmZpOjpGaWx0ZXJCbG9ja09wdGlvbjo6QXRCbG9ja0hhc2goaGFzaC5jbG9uZSgpKSwKICAgICAgICB9CiAgICB9Cn0KCmltcGwgZmZpOjpMb2dGaWx0ZXIgewogICAgZm4gdG9fZXRoZXJzX2ZpbHRlcigmc2VsZikgLT4gUmVzdWx0PEZpbHRlciwgU3RyaW5nPiB7CiAgICAgICAgT2soRmlsdGVyIHsKICAgICAgICAgICAgYmxvY2tfb3B0aW9uOiBzZWxmLmJsb2NrX29wdGlvbi50b19ldGhlcnNfYmxvY2tfb3B0aW9uKCk/LAogICAgICAgICAgICBhZGRyZXNzOiBpZiBzZWxmLmFkZHJlc3MuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICBOb25lCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBTb21lKAogICAgICAgICAgICAgICAgICAgIGFkZHJlc3Nlc19mcm9tX3N0cmluZyhzZWxmLmFkZHJlc3MuY2xvbmUoKSkKICAgICAgICAgICAgICAgICAgICAgICAgLm1hcF9lcnIofGVycnwgZm9ybWF0ISgiRmlsdGVyIGFkZHJlc3M6IHt9IiwgZXJyKSk/LAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB9LAogICAgICAgICAgICB0b3BpY3M6IHRvcGljc19mcm9tX3N0cmluZ3Moc2VsZi50b3BpY3MuY2xvbmUoKSkKICAgICAgICAgICAgICAgIC5tYXBfZXJyKHxlcnJ8IGZvcm1hdCEoIkZpbHRlciB0b3BpY3M6IHt9IiwgZXJyKSk/LAogICAgICAgIH0pCiAgICB9Cn0KCmltcGwgZmZpOjpDYWxsT3B0cyB7CiAgICBmbiB0b19iYXNlX29wdHMoJnNlbGYpIC0+IFJlc3VsdDxleGVjdXRpb246OnR5cGVzOjpDYWxsT3B0cywgU3RyaW5nPiB7CiAgICAgICAgT2soZXhlY3V0aW9uOjp0eXBlczo6Q2FsbE9wdHMgewogICAgICAgICAgICBmcm9tOiBpZiBzZWxmLmZyb20uaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICBOb25lCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBTb21lKAogICAgICAgICAgICAgICAgICAgIGFkZHJlc3NfZnJvbV9zdHJpbmcoc2VsZi5mcm9tLmNsb25lKCkpCiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKHxlcnJ8IGZvcm1hdCEoImZyb206IHt9IiwgZXJyKSk/LAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB9LAogICAgICAgICAgICB0bzogU29tZShhZGRyZXNzX2Zyb21fc3RyaW5nKHNlbGYudG8uY2xvbmUoKSkubWFwX2Vycih8ZXJyfCBmb3JtYXQhKCJ0bzoge30iLCBlcnIpKT8pLAogICAgICAgICAgICBnYXM6IGlmIHNlbGYuZ2FzLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgTm9uZQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgU29tZSh1MjU2X2Zyb21fc3RyaW5nKHNlbGYuZ2FzLmNsb25lKCkpLm1hcF9lcnIofGVycnwgZm9ybWF0ISgiZ2FzOiB7fSIsIGVycikpPykKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZ2FzX3ByaWNlOiBpZiBzZWxmLmdhc19wcmljZS5pc19lbXB0eSgpIHsKICAgICAgICAgICAgICAgIE5vbmUKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIFNvbWUoCiAgICAgICAgICAgICAgICAgICAgdTI1Nl9mcm9tX3N0cmluZyhzZWxmLmdhc19wcmljZS5jbG9uZSgpKQogICAgICAgICAgICAgICAgICAgICAgICAubWFwX2Vycih8ZXJyfCBmb3JtYXQhKCJnYXNfcHJpY2U6IHt9IiwgZXJyKSk/LAogICAgICAgICAgICAgICAgKQogICAgICAgICAgICB9LAogICAgICAgICAgICB2YWx1ZTogaWYgc2VsZi52YWx1ZS5pc19lbXB0eSgpIHsKICAgICAgICAgICAgICAgIE5vbmUKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIFNvbWUoCiAgICAgICAgICAgICAgICAgICAgdTI1Nl9mcm9tX3N0cmluZyhzZWxmLnZhbHVlLmNsb25lKCkpCiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKHxlcnJ8IGZvcm1hdCEoInZhbHVlOiB7fSIsIGVycikpPywKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgZGF0YTogaWYgc2VsZi5kYXRhLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgTm9uZQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgU29tZSh2ZWM4X2Zyb21fc3RyaW5nKHNlbGYuZGF0YS5jbG9uZSgpKS5tYXBfZXJyKHxlcnJ8IGZvcm1hdCEoImRhdGE6IHt9IiwgZXJyKSk/LmludG8oKSkKICAgICAgICAgICAgfSwKICAgICAgICB9KQogICAgfQp9CgppbXBsIENsb25lIGZvciBmZmk6OlRyYW5zYWN0aW9ucyB7CiAgICBmbiBjbG9uZSgmc2VsZikgLT4gU2VsZiB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6Okhhc2hlcyhoYXNoZXMpID0+IGZmaTo6VHJhbnNhY3Rpb25zOjpIYXNoZXMoaGFzaGVzLmNsb25lKCkpLAogICAgICAgICAgICBTZWxmOjpGdWxsKHRyYW5zYWN0aW9ucykgPT4gZmZpOjpUcmFuc2FjdGlvbnM6OkZ1bGwodHJhbnNhY3Rpb25zLnRvX3ZlYygpKSwKICAgICAgICB9CiAgICB9Cn0KCmZuIHRvcGljc19mcm9tX3N0cmluZ3MoCiAgICB2YWx1ZTogVmVjPFN0cmluZz4sCikgLT4gUmVzdWx0PFtPcHRpb248VmFsdWVPckFycmF5PE9wdGlvbjxIMjU2Pj4+OyA0XSwgU3RyaW5nPiB7CiAgICBpZiB2YWx1ZS5sZW4oKSA+IDQgewogICAgICAgIEVycigiVG9vIG1hbnkgdG9waWNzIi50b19zdHJpbmcoKSkKICAgIH0gZWxzZSB7CiAgICAgICAgbGV0IG1hcF9zdHJpbmdfdG9fdG9waWNzID0KICAgICAgICAgICAgfHZhbHVlOiBTdHJpbmd8IC0+IFJlc3VsdDxPcHRpb248VmFsdWVPckFycmF5PE9wdGlvbjxIMjU2Pj4+LCBTdHJpbmc+IHsKICAgICAgICAgICAgICAgIGlmIHZhbHVlLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgICAgIE9rKE5vbmUpCiAgICAgICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgICAgIGxldCB0b3BpY3M6IFZlYzwmc3RyPiA9IHZhbHVlLnNwbGl0KCcsJykuY29sbGVjdCgpOwogICAgICAgICAgICAgICAgICAgIGlmIHRvcGljcy5sZW4oKSA9PSAxIHsKICAgICAgICAgICAgICAgICAgICAgICAgT2soU29tZShWYWx1ZU9yQXJyYXk6OlZhbHVlKFNvbWUoaDI1Nl9mcm9tX3N0cmluZygKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRvcGljc1swXS50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgKT8pKSkpCiAgICAgICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG1hcHBlZDogUmVzdWx0PFZlYzxIMjU2PiwgU3RyaW5nPiA9IHRvcGljcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmludG9faXRlcigpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAubWFwKHx0b3BpY3wgaDI1Nl9mcm9tX3N0cmluZyh0b3BpYy50b19zdHJpbmcoKSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuY29sbGVjdCgpOwogICAgICAgICAgICAgICAgICAgICAgICBsZXQgb3B0aW9uX21hcHBlZDogVmVjPE9wdGlvbjxIMjU2Pj4gPQogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWFwcGVkPy5pbnRvX2l0ZXIoKS5tYXAofGhhc2h8IE9wdGlvbjo6U29tZShoYXNoKSkuY29sbGVjdCgpOwogICAgICAgICAgICAgICAgICAgICAgICBPayhTb21lKFZhbHVlT3JBcnJheTo6QXJyYXkob3B0aW9uX21hcHBlZCkpKQogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfTsKICAgICAgICBsZXQgbXV0IHRvcGljcyA9IHZhbHVlLmNsb25lKCk7CiAgICAgICAgZm9yIF9pIGluIHRvcGljcy5sZW4oKS4uNCB7CiAgICAgICAgICAgIHRvcGljcy5wdXNoKCIiLnRvX3N0cmluZygpKTsKICAgICAgICB9CiAgICAgICAgbGV0IG1hcHBlZDogUmVzdWx0PFZlYzxPcHRpb248VmFsdWVPckFycmF5PE9wdGlvbjxIMjU2Pj4+PiwgU3RyaW5nPiA9CiAgICAgICAgICAgIHRvcGljcy5pbnRvX2l0ZXIoKS5tYXAobWFwX3N0cmluZ190b190b3BpY3MpLmNvbGxlY3QoKTsKICAgICAgICBPayhtYXBwZWQ/LnRyeV9pbnRvKCkubWFwX2Vycih8X2VycnwgIkZhaWxlZCB0byBtYXAgdmVjdG9yIik/KQogICAgfQp9CgpmbiBhZGRyZXNzX2Zyb21fc3RyaW5nKHZhbHVlOiBTdHJpbmcpIC0+IFJlc3VsdDxBZGRyZXNzLCBTdHJpbmc+IHsKICAgIGxldCByYXdfaGV4ID0gdmVjOF9mcm9tX3N0cmluZyh2YWx1ZSk/OwogICAgaWYgcmF3X2hleC5sZW4oKSA9PSBBZGRyZXNzOjpsZW5fYnl0ZXMoKSB7CiAgICAgICAgT2soQWRkcmVzczo6ZnJvbV9zbGljZSgmcmF3X2hleCkpCiAgICB9IGVsc2UgewogICAgICAgIEVycihmb3JtYXQhKCJTaG91bGQgYmUge30gYnl0ZXMgbG9uZyIsIEFkZHJlc3M6Omxlbl9ieXRlcygpKSkKICAgIH0KfQoKZm4gYWRkcmVzc2VzX2Zyb21fc3RyaW5nKHZhbHVlOiBTdHJpbmcpIC0+IFJlc3VsdDxWYWx1ZU9yQXJyYXk8QWRkcmVzcz4sIFN0cmluZz4gewogICAgbGV0IGFkZHJlc3NlczogVmVjPCZzdHI+ID0gdmFsdWUuc3BsaXQoJywnKS5jb2xsZWN0KCk7CiAgICBpZiBhZGRyZXNzZXMubGVuKCkgPT0gMSB7CiAgICAgICAgT2soVmFsdWVPckFycmF5OjpWYWx1ZShhZGRyZXNzX2Zyb21fc3RyaW5nKAogICAgICAgICAgICBhZGRyZXNzZXNbMF0udG9fc3RyaW5nKCksCiAgICAgICAgKT8pKQogICAgfSBlbHNlIHsKICAgICAgICBsZXQgbWFwcGVkOiBSZXN1bHQ8VmVjPEFkZHJlc3M+LCBTdHJpbmc+ID0gYWRkcmVzc2VzCiAgICAgICAgICAgIC5pbnRvX2l0ZXIoKQogICAgICAgICAgICAubWFwKHxhZGRyZXNzfCBhZGRyZXNzX2Zyb21fc3RyaW5nKGFkZHJlc3MudG9fc3RyaW5nKCkpKQogICAgICAgICAgICAuY29sbGVjdCgpOwogICAgICAgIE9rKFZhbHVlT3JBcnJheTo6QXJyYXkobWFwcGVkPykpCiAgICB9Cn0KCmZuIGgyNTZfZnJvbV9zdHJpbmcodmFsdWU6IFN0cmluZykgLT4gUmVzdWx0PEgyNTYsIFN0cmluZz4gewogICAgbGV0IHJhd19oZXggPSB2ZWM4X2Zyb21fc3RyaW5nKHZhbHVlKT87CiAgICBpZiByYXdfaGV4LmxlbigpID09IEgyNTY6Omxlbl9ieXRlcygpIHsKICAgICAgICBPayhIMjU2Ojpmcm9tX3NsaWNlKCZyYXdfaGV4KSkKICAgIH0gZWxzZSB7CiAgICAgICAgRXJyKGZvcm1hdCEoIlNob3VsZCBiZSB7fSBieXRlcyBsb25nIiwgSDI1Njo6bGVuX2J5dGVzKCkpKQogICAgfQp9CgpmbiB1MjU2X2Zyb21fc3RyaW5nKHZhbHVlOiBTdHJpbmcpIC0+IFJlc3VsdDxVMjU2LCBTdHJpbmc+IHsKICAgIGlmIGxldCBTb21lKHJhd19oZXhfc3RyaW5nKSA9IHZhbHVlLnN0cmlwX3ByZWZpeCgiMHgiKSB7CiAgICAgICAgT2soVTI1Njo6ZnJvbV9zdHJfcmFkaXgocmF3X2hleF9zdHJpbmcsIDE2KS5tYXBfZXJyKHxlcnJ8IGVyci50b19zdHJpbmcoKSk/KQogICAgfSBlbHNlIHsKICAgICAgICBPayhVMjU2Ojpmcm9tX3N0cl9yYWRpeCgmdmFsdWUsIDEwKS5tYXBfZXJyKHxlcnJ8IGVyci50b19zdHJpbmcoKSk/KQogICAgfQp9CgpmbiB2ZWM4X2Zyb21fc3RyaW5nKHZhbHVlOiBTdHJpbmcpIC0+IFJlc3VsdDxWZWM8dTg+LCBTdHJpbmc+IHsKICAgIGlmIGxldCBTb21lKHJhd19oZXhfc3RyaW5nKSA9IHZhbHVlLnN0cmlwX3ByZWZpeCgiMHgiKSB7CiAgICAgICAgT2soaGV4OjpkZWNvZGUocmF3X2hleF9zdHJpbmcpLm1hcF9lcnIofGVycnwgZXJyLnRvX3N0cmluZygpKT8pCiAgICB9IGVsc2UgewogICAgICAgIEVycigiU2hvdWxkIGJlIGEgaGV4IHZhbHVlIHByZWZpeGVkIHdpdGggMHgiLnRvX3N0cmluZygpKQogICAgfQp9CgpmbiBldGhlcnNfbG9nX3RvX2ZmaV9sb2codmFsdWU6IExvZykgLT4gZmZpOjpMb2cgewogICAgZmZpOjpMb2cgewogICAgICAgIGFkZHJlc3M6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5hZGRyZXNzLmFzX2J5dGVzKCkpKSwKICAgICAgICB0b3BpY3M6IHZhbHVlCiAgICAgICAgICAgIC50b3BpY3MKICAgICAgICAgICAgLmludG9faXRlcigpCiAgICAgICAgICAgIC5tYXAofHRvcGljfCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodG9waWMuYXNfYnl0ZXMoKSkpKQogICAgICAgICAgICAuY29sbGVjdCgpLAogICAgICAgIGRhdGE6IHZhbHVlLmRhdGEuZW5jb2RlKCksCiAgICAgICAgYmxvY2tfaGFzaDogdmFsdWUKICAgICAgICAgICAgLmJsb2NrX2hhc2gKICAgICAgICAgICAgLm1hcCh8aGFzaHwgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGhhc2guYXNfYnl0ZXMoKSkpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICBibG9ja19udW1iZXI6IHZhbHVlLmJsb2NrX251bWJlci5tYXAofGJsb2NrfCBibG9jay5hc191NjQoKSksCiAgICAgICAgdHJhbnNhY3Rpb25faGFzaDogdmFsdWUKICAgICAgICAgICAgLnRyYW5zYWN0aW9uX2hhc2gKICAgICAgICAgICAgLm1hcCh8aGFzaHwgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGhhc2guYXNfYnl0ZXMoKSkpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICB0cmFuc2FjdGlvbl9pbmRleDogdmFsdWUudHJhbnNhY3Rpb25faW5kZXgubWFwKHxpbmRleHwgaW5kZXguYXNfdTY0KCkpLAogICAgICAgIGxvZ19pbmRleDogdmFsdWUKICAgICAgICAgICAgLmxvZ19pbmRleAogICAgICAgICAgICAubWFwKHxpbmRleHwgaW5kZXgudG9fc3RyaW5nKCkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIHRyYW5zYWN0aW9uX2xvZ19pbmRleDogdmFsdWUKICAgICAgICAgICAgLnRyYW5zYWN0aW9uX2xvZ19pbmRleAogICAgICAgICAgICAubWFwKHxpbmRleHwgaW5kZXgudG9fc3RyaW5nKCkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIGxvZ190eXBlOiB2YWx1ZS5sb2dfdHlwZS51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIHJlbW92ZWQ6IHZhbHVlLnJlbW92ZWQsCiAgICB9Cn0KCmZuIGV0aGVyc19yZWNlaXB0X3RvX2ZmaSh2YWx1ZTogVHJhbnNhY3Rpb25SZWNlaXB0KSAtPiBmZmk6OlRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICBmZmk6OlRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICAgICAgdHJhbnNhY3Rpb25faGFzaDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLnRyYW5zYWN0aW9uX2hhc2guYXNfYnl0ZXMoKSkpLAogICAgICAgIHRyYW5zYWN0aW9uX2luZGV4OiB2YWx1ZS50cmFuc2FjdGlvbl9pbmRleC5hc191NjQoKSwKICAgICAgICBibG9ja19oYXNoOiB2YWx1ZQogICAgICAgICAgICAuYmxvY2tfaGFzaAogICAgICAgICAgICAubWFwKHxoYXNofCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoaGFzaC5hc19ieXRlcygpKSkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIGJsb2NrX251bWJlcjogdmFsdWUuYmxvY2tfbnVtYmVyLm1hcCh8bnVtYmVyfCBudW1iZXIuYXNfdTY0KCkpLAogICAgICAgIGZyb206IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5mcm9tLmFzX2J5dGVzKCkpKSwKICAgICAgICB0bzogdmFsdWUKICAgICAgICAgICAgLnRvCiAgICAgICAgICAgIC5tYXAofGFkZHJlc3N8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShhZGRyZXNzLmFzX2J5dGVzKCkpKSkKICAgICAgICAgICAgLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICAgICAgY3VtdWxhdGl2ZV9nYXNfdXNlZDogdmFsdWUuY3VtdWxhdGl2ZV9nYXNfdXNlZC50b19zdHJpbmcoKSwKICAgICAgICBnYXNfdXNlZDogdmFsdWUKICAgICAgICAgICAgLmdhc191c2VkCiAgICAgICAgICAgIC5tYXAofGdhc3wgZ2FzLnRvX3N0cmluZygpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICBjb250cmFjdF9hZGRyZXNzOiB2YWx1ZQogICAgICAgICAgICAuY29udHJhY3RfYWRkcmVzcwogICAgICAgICAgICAubWFwKHxhZGRyZXNzfCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoYWRkcmVzcy5hc19ieXRlcygpKSkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIGxvZ3M6IHZhbHVlLmxvZ3MuaW50b19pdGVyKCkubWFwKGV0aGVyc19sb2dfdG9fZmZpX2xvZykuY29sbGVjdCgpLAogICAgICAgIHN0YXR1czogdmFsdWUuc3RhdHVzLm1hcCh8c3RhdHVzfCBzdGF0dXMuYXNfdTY0KCkpLAogICAgICAgIHJvb3Q6IHZhbHVlCiAgICAgICAgICAgIC5yb290CiAgICAgICAgICAgIC5tYXAofGhhc2h8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShoYXNoLmFzX2J5dGVzKCkpKSkKICAgICAgICAgICAgLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICAgICAgbG9nc19ibG9vbTogdmFsdWUubG9nc19ibG9vbS5hc19ieXRlcygpLnRvX3ZlYygpLAogICAgICAgIHRyYW5zYWN0aW9uX3R5cGU6IHZhbHVlLnRyYW5zYWN0aW9uX3R5cGUubWFwKHx2YWx8IHZhbC5hc191NjQoKSksCiAgICAgICAgZWZmZWN0aXZlX2dhc19wcmljZTogdmFsdWUKICAgICAgICAgICAgLmVmZmVjdGl2ZV9nYXNfcHJpY2UKICAgICAgICAgICAgLm1hcCh8Z2FzfCBnYXMudG9fc3RyaW5nKCkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgfQp9CgpmbiBldGhlcnNfdHJhbnNhY3Rpb25fdG9fZmZpKHZhbHVlOiBUcmFuc2FjdGlvbikgLT4gZmZpOjpUcmFuc2FjdGlvbiB7CiAgICBmZmk6OlRyYW5zYWN0aW9uIHsKICAgICAgICBoYXNoOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUuaGFzaC5hc19ieXRlcygpKSksCiAgICAgICAgbm9uY2U6IHZhbHVlLm5vbmNlLnRvX3N0cmluZygpLAogICAgICAgIGJsb2NrX2hhc2g6IHZhbHVlCiAgICAgICAgICAgIC5ibG9ja19oYXNoCiAgICAgICAgICAgIC5tYXAofGhhc2h8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShoYXNoLmFzX2J5dGVzKCkpKSkKICAgICAgICAgICAgLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICAgICAgYmxvY2tfbnVtYmVyOiB2YWx1ZS5ibG9ja19udW1iZXIubWFwKHxibG9ja3wgYmxvY2suYXNfdTY0KCkpLAogICAgICAgIHRyYW5zYWN0aW9uX2luZGV4OiB2YWx1ZS50cmFuc2FjdGlvbl9pbmRleC5tYXAofGluZGV4fCBpbmRleC5hc191NjQoKSksCiAgICAgICAgZnJvbTogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLmZyb20uYXNfYnl0ZXMoKSkpLAogICAgICAgIHRvOiB2YWx1ZQogICAgICAgICAgICAudG8KICAgICAgICAgICAgLm1hcCh8YWRkcmVzc3wgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGFkZHJlc3MuYXNfYnl0ZXMoKSkpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICB2YWx1ZTogdmFsdWUudmFsdWUudG9fc3RyaW5nKCksCiAgICAgICAgZ2FzX3ByaWNlOiB2YWx1ZQogICAgICAgICAgICAuZ2FzX3ByaWNlCiAgICAgICAgICAgIC5tYXAofGdhc3wgZ2FzLnRvX3N0cmluZygpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICBnYXM6IHZhbHVlLmdhcy50b19zdHJpbmcoKSwKICAgICAgICBpbnB1dDogdmFsdWUuaW5wdXQudG9fdmVjKCksCiAgICAgICAgdjogdmFsdWUudi50b19zdHJpbmcoKSwKICAgICAgICByOiB2YWx1ZS5yLmVuY29kZV9oZXgoKSwKICAgICAgICBzOiB2YWx1ZS5zLmVuY29kZV9oZXgoKSwKICAgIH0KfQoKZm4gZXRoZXJzX3N5bmNpbmdfc3RhdHVzX3RvX2ZmaSh2YWx1ZTogU3luY2luZ1N0YXR1cykgLT4gT3B0aW9uPGZmaTo6U3luY2luZ1N0YXR1cz4gewogICAgbWF0Y2ggdmFsdWUgewogICAgICAgIFN5bmNpbmdTdGF0dXM6OklzRmFsc2UgPT4gTm9uZSwKICAgICAgICBTeW5jaW5nU3RhdHVzOjpJc1N5bmNpbmcodmFsdWUpID0+IFNvbWUoZmZpOjpTeW5jaW5nU3RhdHVzIHsKICAgICAgICAgICAgY3VycmVudF9ibG9jazogdmFsdWUuY3VycmVudF9ibG9jay5hc191NjQoKSwKICAgICAgICAgICAgaGlnaGVzdF9ibG9jazogdmFsdWUuaGlnaGVzdF9ibG9jay5hc191NjQoKSwKICAgICAgICAgICAgc3RhcnRpbmdfYmxvY2s6IHZhbHVlLnN0YXJ0aW5nX2Jsb2NrLmFzX3U2NCgpLAogICAgICAgIH0pLAogICAgfQp9CgpmbiBoZWxpb3NfdHJhbnNhY3Rpb25zX3RvX2ZmaSh2YWx1ZTogVHJhbnNhY3Rpb25zKSAtPiBmZmk6OlRyYW5zYWN0aW9ucyB7CiAgICBtYXRjaCB2YWx1ZSB7CiAgICAgICAgVHJhbnNhY3Rpb25zOjpIYXNoZXMoaGFzaGVzKSA9PiBmZmk6OlRyYW5zYWN0aW9uczo6SGFzaGVzKAogICAgICAgICAgICBoYXNoZXMKICAgICAgICAgICAgICAgIC5pbnRvX2l0ZXIoKQogICAgICAgICAgICAgICAgLm1hcCh8aGFzaHwgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGhhc2guYXNfYnl0ZXMoKSkpKQogICAgICAgICAgICAgICAgLmNvbGxlY3QoKSwKICAgICAgICApLAogICAgICAgIFRyYW5zYWN0aW9uczo6RnVsbCh0cmFuc2FjdGlvbnMpID0+IGZmaTo6VHJhbnNhY3Rpb25zOjpGdWxsKAogICAgICAgICAgICB0cmFuc2FjdGlvbnMKICAgICAgICAgICAgICAgIC5pbnRvX2l0ZXIoKQogICAgICAgICAgICAgICAgLm1hcChldGhlcnNfdHJhbnNhY3Rpb25fdG9fZmZpKQogICAgICAgICAgICAgICAgLmNvbGxlY3QoKSwKICAgICAgICApLAogICAgfQp9CgpmbiBoZWxpb3NfZXhlY3V0aW9uX2Jsb2NrX3RvX2ZmaSh2YWx1ZTogQmxvY2spIC0+IGZmaTo6QmxvY2sgewogICAgZmZpOjpCbG9jayB7CiAgICAgICAgbnVtYmVyOiB2YWx1ZS5udW1iZXIuYXNfdTY0KCksCiAgICAgICAgYmFzZV9mZWVfcGVyX2dhczogdmFsdWUuYmFzZV9mZWVfcGVyX2dhcy50b19zdHJpbmcoKSwKICAgICAgICBkaWZmaWN1bHR5OiB2YWx1ZS5kaWZmaWN1bHR5LnRvX3N0cmluZygpLAogICAgICAgIGV4dHJhX2RhdGE6IHZhbHVlLmV4dHJhX2RhdGEudG9fdmVjKCksCiAgICAgICAgZ2FzX2xpbWl0OiB2YWx1ZS5nYXNfbGltaXQuYXNfdTY0KCksCiAgICAgICAgZ2FzX3VzZWQ6IHZhbHVlLmdhc191c2VkLmFzX3U2NCgpLAogICAgICAgIGhhc2g6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5oYXNoLmFzX2J5dGVzKCkpKSwKICAgICAgICBsb2dzX2Jsb29tOiB2YWx1ZS5sb2dzX2Jsb29tLnRvX3ZlYygpLAogICAgICAgIG1pbmVyOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUubWluZXIuYXNfYnl0ZXMoKSkpLAogICAgICAgIG1peF9oYXNoOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUubWl4X2hhc2guYXNfYnl0ZXMoKSkpLAogICAgICAgIG5vbmNlOiB2YWx1ZS5ub25jZS50b19zdHJpbmcoKSwKICAgICAgICBwYXJlbnRfaGFzaDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLnBhcmVudF9oYXNoLmFzX2J5dGVzKCkpKSwKICAgICAgICByZWNlaXB0c19yb290OiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUucmVjZWlwdHNfcm9vdC5hc19ieXRlcygpKSksCiAgICAgICAgc2hhM191bmNsZXM6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5zaGEzX3VuY2xlcy5hc19ieXRlcygpKSksCiAgICAgICAgc2l6ZTogdmFsdWUuc2l6ZS5hc191NjQoKSwKICAgICAgICBzdGF0ZV9yb290OiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUuc3RhdGVfcm9vdC5hc19ieXRlcygpKSksCiAgICAgICAgdGltZXN0YW1wOiB2YWx1ZS50aW1lc3RhbXAuYXNfdTY0KCksCiAgICAgICAgdG90YWxfZGlmZmljdWx0eTogdmFsdWUudG90YWxfZGlmZmljdWx0eS5hc191NjQoKSwKICAgICAgICB0cmFuc2FjdGlvbnM6IGhlbGlvc190cmFuc2FjdGlvbnNfdG9fZmZpKHZhbHVlLnRyYW5zYWN0aW9ucyksCiAgICAgICAgdHJhbnNhY3Rpb25zX3Jvb3Q6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS50cmFuc2FjdGlvbnNfcm9vdC5hc19ieXRlcygpKSksCiAgICAgICAgdW5jbGVzOiB2YWx1ZQogICAgICAgICAgICAudW5jbGVzCiAgICAgICAgICAgIC5pbnRvX2l0ZXIoKQogICAgICAgICAgICAubWFwKHxoYXNofCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoaGFzaC5hc19ieXRlcygpKSkpCiAgICAgICAgICAgIC5jb2xsZWN0KCksCiAgICB9Cn0KCiNbZGVyaXZlKENsb25lKV0KcHViIHN0cnVjdCBPcHRpb25hbEZpbGVEQiB7CiAgICBmaWxlX2RiOiBPcHRpb248RmlsZURCPiwKICAgIGRlZmF1bHRfY2hlY2twb2ludDogVmVjPHU4PiwKfQoKaW1wbCBEYXRhYmFzZSBmb3IgT3B0aW9uYWxGaWxlREIgewogICAgZm4gbmV3KGNvbmZpZzogJkNvbmZpZykgLT4gUmVzdWx0PFNlbGYsIFJlcG9ydD4gewogICAgICAgIGlmIGxldCBTb21lKF9kYXRhX2RpcikgPSAmY29uZmlnLmRhdGFfZGlyIHsKICAgICAgICAgICAgT2soT3B0aW9uYWxGaWxlREIgewogICAgICAgICAgICAgICAgZmlsZV9kYjogU29tZShGaWxlREI6Om5ldyhjb25maWcpPyksCiAgICAgICAgICAgICAgICBkZWZhdWx0X2NoZWNrcG9pbnQ6IGNvbmZpZy5kZWZhdWx0X2NoZWNrcG9pbnQuY2xvbmUoKSwKICAgICAgICAgICAgfSkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBPayhPcHRpb25hbEZpbGVEQiB7CiAgICAgICAgICAgICAgICBmaWxlX2RiOiBOb25lLAogICAgICAgICAgICAgICAgZGVmYXVsdF9jaGVja3BvaW50OiBjb25maWcuZGVmYXVsdF9jaGVja3BvaW50LmNsb25lKCksCiAgICAgICAgICAgIH0pCiAgICAgICAgfQogICAgfQoKICAgIGZuIHNhdmVfY2hlY2twb2ludCgmc2VsZiwgY2hlY2twb2ludDogJlt1OF0pIC0+IFJlc3VsdDwoKSwgUmVwb3J0PiB7CiAgICAgICAgaWYgbGV0IFNvbWUoZmlsZV9kYikgPSAmc2VsZi5maWxlX2RiIHsKICAgICAgICAgICAgZmlsZV9kYi5zYXZlX2NoZWNrcG9pbnQoJmNoZWNrcG9pbnQpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgT2soKCkpCiAgICAgICAgfQogICAgfQoKICAgIGZuIGxvYWRfY2hlY2twb2ludCgmc2VsZikgLT4gUmVzdWx0PFZlYzx1OD4sIFJlcG9ydD4gewogICAgICAgIGlmIGxldCBTb21lKGZpbGVfZGIpID0gJnNlbGYuZmlsZV9kYiB7CiAgICAgICAgICAgIGZpbGVfZGIubG9hZF9jaGVja3BvaW50KCkKICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBPayhzZWxmLmRlZmF1bHRfY2hlY2twb2ludC5jbG9uZSgpKQogICAgICAgIH0KICAgIH0KfQoKcHViIHN0cnVjdCBIZWxpb3NDbGllbnQgewogICAgY2xpZW50OiBPcHRpb248Q2xpZW50PE9wdGlvbmFsRmlsZURCPj4sCiAgICBpc19sb2dnaW5nOiBib29sLAp9Cg="

rust::build
build::lipo
build::generate_c_headers
build::xcframework

post_build::compress
post_build::copy_bridge_files
post_build::success
