#! /bin/zsh -e

source ".scripts/functions.sh"

set -e

PACKAGE_VERSION=0.5.1
SWIFT_BRIDGE_PACKAGE='git = "https:\/\/github.com\/rkreutz\/swift-bridge.git", branch = "feature\/struct-vec-support"'
SWIFT_BRIDGE_FEATURES='["async", "compatibility"]'
ETHERS_VERSION=2.0.2
USES_LOGGER=false
USES_TRACING=true
RUST_TOOLCHAIN='stable'

env::setup
env::build_configuration $1

rust::setup

pre_build::create_build_directory
pre_build::setup_helios
pre_build::modify_helios "dXNlIDo6Y2xpZW50Ojp7Q2xpZW50LCBDbGllbnRCdWlsZGVyfTsKdXNlIDo6Y29uZmlnOjp7bmV0d29ya3MsIENvbmZpZ307CnVzZSA6OmNvbnNlbnN1czo6ZGF0YWJhc2U6OntEYXRhYmFzZSwgRmlsZURCfTsKdXNlIDo6Y29tbW9uOjp0eXBlczo6e0Jsb2NrLCBUcmFuc2FjdGlvbnN9Owp1c2UgZXRoZXJzOjp7CiAgICBhYmk6OkFiaUVuY29kZSwKICAgIHByZWx1ZGU6OntBZGRyZXNzLCBIMjU2LCBVMjU2LCBVNjR9LAogICAgdHlwZXM6OnsKICAgICAgICBCbG9ja051bWJlciwgRmlsdGVyLCBGaWx0ZXJCbG9ja09wdGlvbiwgTG9nLCBTeW5jaW5nU3RhdHVzLCBUcmFuc2FjdGlvbiwKICAgICAgICBUcmFuc2FjdGlvblJlY2VpcHQsIFZhbHVlT3JBcnJheQogICAgfSwKfTsKdXNlIGV5cmU6OlJlcG9ydDsKdXNlIHRyYWNpbmdfc3Vic2NyaWJlcjo6ZmlsdGVyOjp7RW52RmlsdGVyLCBMZXZlbEZpbHRlcn07CnVzZSB0cmFjaW5nX3N1YnNjcmliZXI6OkZtdFN1YnNjcmliZXI7CgojW3N3aWZ0X2JyaWRnZTo6YnJpZGdlXQptb2QgZmZpIHsKCiAgICBlbnVtIEJsb2NrVGFnIHsKICAgICAgICBMYXRlc3QsCiAgICAgICAgRmluYWxpemVkLAogICAgICAgIFNhZmUsCiAgICAgICAgRWFybGllc3QsCiAgICAgICAgUGVuZGluZywKICAgICAgICBOdW1iZXIodTY0KSwKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IENhbGxPcHRzIHsKICAgICAgICBwdWIgZnJvbTogU3RyaW5nLAogICAgICAgIHB1YiB0bzogU3RyaW5nLAogICAgICAgIHB1YiBnYXM6IFN0cmluZywKICAgICAgICBwdWIgZ2FzX3ByaWNlOiBTdHJpbmcsCiAgICAgICAgcHViIHZhbHVlOiBTdHJpbmcsCiAgICAgICAgcHViIGRhdGE6IFN0cmluZywKICAgIH0KCiAgICBlbnVtIEhlbGlvc05ldHdvcmsgewogICAgICAgIE1BSU5ORVQsCiAgICAgICAgR09FUkxJLAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgU3RhcnRVcFN0YXRlIHsKICAgICAgICBzdGFydGVkOiBib29sLAogICAgICAgIGVycm9yOiBTdHJpbmcsCiAgICB9CgogICAgZW51bSBGaWx0ZXJCbG9ja09wdGlvbiB7CiAgICAgICAgUmFuZ2UgewogICAgICAgICAgICBmcm9tX2Jsb2NrOiBPcHRpb248QmxvY2tUYWc+LAogICAgICAgICAgICB0b19ibG9jazogT3B0aW9uPEJsb2NrVGFnPiwKICAgICAgICB9LAogICAgICAgIEF0QmxvY2tIYXNoKFN0cmluZyksCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBMb2dGaWx0ZXIgewogICAgICAgIHB1YiBibG9ja19vcHRpb246IEZpbHRlckJsb2NrT3B0aW9uLAogICAgICAgIHB1YiBhZGRyZXNzOiBTdHJpbmcsCiAgICAgICAgcHViIHRvcGljczogVmVjPFN0cmluZz4sCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgICNbZGVyaXZlKENsb25lKV0KICAgIHN0cnVjdCBMb2cgewogICAgICAgIGFkZHJlc3M6IFN0cmluZywKICAgICAgICB0b3BpY3M6IFZlYzxTdHJpbmc+LAogICAgICAgIGRhdGE6IFZlYzx1OD4sCiAgICAgICAgYmxvY2tfaGFzaDogU3RyaW5nLAogICAgICAgIGJsb2NrX251bWJlcjogT3B0aW9uPHU2ND4sCiAgICAgICAgdHJhbnNhY3Rpb25faGFzaDogU3RyaW5nLAogICAgICAgIHRyYW5zYWN0aW9uX2luZGV4OiBPcHRpb248dTY0PiwKICAgICAgICBsb2dfaW5kZXg6IFN0cmluZywKICAgICAgICB0cmFuc2FjdGlvbl9sb2dfaW5kZXg6IFN0cmluZywKICAgICAgICBsb2dfdHlwZTogU3RyaW5nLAogICAgICAgIHJlbW92ZWQ6IE9wdGlvbjxib29sPiwKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IFRyYW5zYWN0aW9uUmVjZWlwdCB7CiAgICAgICAgdHJhbnNhY3Rpb25faGFzaDogU3RyaW5nLAogICAgICAgIHRyYW5zYWN0aW9uX2luZGV4OiB1NjQsCiAgICAgICAgYmxvY2tfaGFzaDogU3RyaW5nLCAvLyBvcHRpb25hbAogICAgICAgIGJsb2NrX251bWJlcjogT3B0aW9uPHU2ND4sCiAgICAgICAgZnJvbTogU3RyaW5nLAogICAgICAgIHRvOiBTdHJpbmcsIC8vIG9wdGlvbmFsCiAgICAgICAgY3VtdWxhdGl2ZV9nYXNfdXNlZDogU3RyaW5nLAogICAgICAgIGdhc191c2VkOiBTdHJpbmcsICAgICAgICAgLy8gb3B0aW9uYWwKICAgICAgICBjb250cmFjdF9hZGRyZXNzOiBTdHJpbmcsIC8vIG9wdGlvbmFsCiAgICAgICAgbG9nczogVmVjPExvZz4sCiAgICAgICAgc3RhdHVzOiBPcHRpb248dTY0PiwKICAgICAgICByb290OiBTdHJpbmcsIC8vIG9wdGlvbm5hbAogICAgICAgIGxvZ3NfYmxvb206IFZlYzx1OD4sCiAgICAgICAgdHJhbnNhY3Rpb25fdHlwZTogT3B0aW9uPHU2ND4sCiAgICAgICAgZWZmZWN0aXZlX2dhc19wcmljZTogU3RyaW5nLCAvL29wdGlvbmFsCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgICNbZGVyaXZlKENsb25lKV0KICAgIHN0cnVjdCBUcmFuc2FjdGlvbiB7CiAgICAgICAgaGFzaDogU3RyaW5nLAogICAgICAgIG5vbmNlOiBTdHJpbmcsCiAgICAgICAgYmxvY2tfaGFzaDogU3RyaW5nLCAvL29wdGlvbmFsCiAgICAgICAgYmxvY2tfbnVtYmVyOiBPcHRpb248dTY0PiwKICAgICAgICB0cmFuc2FjdGlvbl9pbmRleDogT3B0aW9uPHU2ND4sCiAgICAgICAgZnJvbTogU3RyaW5nLAogICAgICAgIHRvOiBTdHJpbmcsIC8vIG9wdGlvbmFsCiAgICAgICAgdmFsdWU6IFN0cmluZywKICAgICAgICBnYXNfcHJpY2U6IFN0cmluZywgLy8gb3B0aW9uYWwKICAgICAgICBnYXM6IFN0cmluZywKICAgICAgICBpbnB1dDogVmVjPHU4PiwKICAgICAgICB2OiBTdHJpbmcsCiAgICAgICAgcjogU3RyaW5nLAogICAgICAgIHM6IFN0cmluZywKICAgIH0KCiAgICBlbnVtIFRyYW5zYWN0aW9ucyB7CiAgICAgICAgSGFzaGVzKFZlYzxTdHJpbmc+KSwKICAgICAgICBGdWxsKFZlYzxUcmFuc2FjdGlvbj4pLAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgQmxvY2sgewogICAgICAgIG51bWJlcjogdTY0LAogICAgICAgIGJhc2VfZmVlX3Blcl9nYXM6IFN0cmluZywKICAgICAgICBkaWZmaWN1bHR5OiBTdHJpbmcsCiAgICAgICAgZXh0cmFfZGF0YTogVmVjPHU4PiwKICAgICAgICBnYXNfbGltaXQ6IHU2NCwKICAgICAgICBnYXNfdXNlZDogdTY0LAogICAgICAgIGhhc2g6IFN0cmluZywKICAgICAgICBsb2dzX2Jsb29tOiBWZWM8dTg+LAogICAgICAgIG1pbmVyOiBTdHJpbmcsCiAgICAgICAgbWl4X2hhc2g6IFN0cmluZywKICAgICAgICBub25jZTogU3RyaW5nLAogICAgICAgIHBhcmVudF9oYXNoOiBTdHJpbmcsCiAgICAgICAgcmVjZWlwdHNfcm9vdDogU3RyaW5nLAogICAgICAgIHNoYTNfdW5jbGVzOiBTdHJpbmcsCiAgICAgICAgc2l6ZTogdTY0LAogICAgICAgIHN0YXRlX3Jvb3Q6IFN0cmluZywKICAgICAgICB0aW1lc3RhbXA6IHU2NCwKICAgICAgICB0b3RhbF9kaWZmaWN1bHR5OiB1NjQsCiAgICAgICAgdHJhbnNhY3Rpb25zOiBUcmFuc2FjdGlvbnMsCiAgICAgICAgdHJhbnNhY3Rpb25zX3Jvb3Q6IFN0cmluZywKICAgICAgICB1bmNsZXM6IFZlYzxTdHJpbmc+LAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgU3luY2luZ1N0YXR1cyB7CiAgICAgICAgcHViIGN1cnJlbnRfYmxvY2s6IHU2NCwKICAgICAgICBwdWIgaGlnaGVzdF9ibG9jazogdTY0LAogICAgICAgIHB1YiBzdGFydGluZ19ibG9jazogdTY0LAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgUmVzcG9uc2VVNjQgewogICAgICAgIHZhbHVlOiB1NjQsCiAgICAgICAgZmFpbGVkOiBib29sLAogICAgICAgIGVycm9yOiBTdHJpbmcsCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBSZXNwb25zZVN0cmluZyB7CiAgICAgICAgdmFsdWU6IFN0cmluZywKICAgICAgICBmYWlsZWQ6IGJvb2wsCiAgICAgICAgZXJyb3I6IFN0cmluZywKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IFJlc3BvbnNlVmVjOCB7CiAgICAgICAgdmFsdWU6IFZlYzx1OD4sCiAgICAgICAgZmFpbGVkOiBib29sLAogICAgICAgIGVycm9yOiBTdHJpbmcsCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBSZXNwb25zZVZlY0xvZyB7CiAgICAgICAgdmFsdWU6IFZlYzxMb2c+LAogICAgICAgIGZhaWxlZDogYm9vbCwKICAgICAgICBlcnJvcjogU3RyaW5nLAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgUmVzcG9uc2VUcmFuc2FjdGlvblJlY2VpcHQgewogICAgICAgIHZhbHVlOiBPcHRpb248VHJhbnNhY3Rpb25SZWNlaXB0PiwKICAgICAgICBmYWlsZWQ6IGJvb2wsCiAgICAgICAgZXJyb3I6IFN0cmluZywKICAgIH0KCiAgICAjW3N3aWZ0X2JyaWRnZShzd2lmdF9yZXByID0gInN0cnVjdCIpXQogICAgc3RydWN0IFJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgIHZhbHVlOiBPcHRpb248VHJhbnNhY3Rpb24+LAogICAgICAgIGZhaWxlZDogYm9vbCwKICAgICAgICBlcnJvcjogU3RyaW5nLAogICAgfQoKICAgICNbc3dpZnRfYnJpZGdlKHN3aWZ0X3JlcHIgPSAic3RydWN0IildCiAgICBzdHJ1Y3QgUmVzcG9uc2VCbG9jayB7CiAgICAgICAgdmFsdWU6IE9wdGlvbjxCbG9jaz4sCiAgICAgICAgZmFpbGVkOiBib29sLAogICAgICAgIGVycm9yOiBTdHJpbmcsCiAgICB9CgogICAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICAgIHN0cnVjdCBSZXNwb25zZVN5bmNpbmcgewogICAgICAgIHZhbHVlOiBPcHRpb248U3luY2luZ1N0YXR1cz4sCiAgICAgICAgZmFpbGVkOiBib29sLAogICAgICAgIGVycm9yOiBTdHJpbmcsCiAgICB9CgogICAgZXh0ZXJuICJSdXN0IiB7CiAgICAgICAgdHlwZSBIZWxpb3NDbGllbnQ7CgogICAgICAgICNbc3dpZnRfYnJpZGdlKGluaXQpXQogICAgICAgIGZuIG5ldygpIC0+IEhlbGlvc0NsaWVudDsKCiAgICAgICAgYXN5bmMgZm4gc3RhcnQoCiAgICAgICAgICAgICZtdXQgc2VsZiwKICAgICAgICAgICAgdW50cnVzdGVkX3JwY191cmw6IFN0cmluZywKICAgICAgICAgICAgY29uc2Vuc3VzX3JwY191cmw6IFN0cmluZywKICAgICAgICAgICAgY2hlY2twb2ludDogT3B0aW9uPFN0cmluZz4sCiAgICAgICAgICAgIHJwY19wb3J0OiB1MTYsCiAgICAgICAgICAgIG5ldHdvcms6IEhlbGlvc05ldHdvcmssCiAgICAgICAgICAgIGRhdGFfZGlyOiBPcHRpb248U3RyaW5nPiwKICAgICAgICApIC0+IFN0YXJ0VXBTdGF0ZTsKCiAgICAgICAgYXN5bmMgZm4gc2h1dGRvd24oJm11dCBzZWxmKTsKCiAgICAgICAgYXN5bmMgZm4gY2FsbCgmc2VsZiwgb3B0czogQ2FsbE9wdHMsIGJsb2NrOiBCbG9ja1RhZykgLT4gUmVzcG9uc2VWZWM4OwogICAgICAgIGFzeW5jIGZuIHNlbmRfcmF3X3RyYW5zYWN0aW9uKCZzZWxmLCBieXRlczogVmVjPHU4PikgLT4gUmVzcG9uc2VTdHJpbmc7CgogICAgICAgIGFzeW5jIGZuIGVzdGltYXRlX2dhcygmc2VsZiwgb3B0czogQ2FsbE9wdHMpIC0+IFJlc3BvbnNlVTY0OwogICAgICAgIGFzeW5jIGZuIGNoYWluX2lkKCZzZWxmKSAtPiBSZXNwb25zZVU2NDsKICAgICAgICBhc3luYyBmbiBnZXRfZ2FzX3ByaWNlKCZzZWxmKSAtPiBSZXNwb25zZVN0cmluZzsKICAgICAgICBhc3luYyBmbiBnZXRfcHJpb3JpdHlfZmVlKCZzZWxmKSAtPiBSZXNwb25zZVN0cmluZzsKICAgICAgICBhc3luYyBmbiBnZXRfYmxvY2tfbnVtYmVyKCZzZWxmKSAtPiBSZXNwb25zZVN0cmluZzsKICAgICAgICBhc3luYyBmbiBnZXRfY29pbmJhc2UoJnNlbGYpIC0+IFJlc3BvbnNlU3RyaW5nOwoKICAgICAgICBhc3luYyBmbiBnZXRfYmFsYW5jZSgmc2VsZiwgYWRkcmVzczogU3RyaW5nLCBibG9jazogQmxvY2tUYWcpIC0+IFJlc3BvbnNlU3RyaW5nOwogICAgICAgIGFzeW5jIGZuIGdldF9ub25jZSgmc2VsZiwgYWRkcmVzczogU3RyaW5nLCBibG9jazogQmxvY2tUYWcpIC0+IFJlc3BvbnNlVTY0OwoKICAgICAgICBhc3luYyBmbiBnZXRfYmxvY2tfYnlfbnVtYmVyKAogICAgICAgICAgICAmc2VsZiwKICAgICAgICAgICAgYmxvY2s6IEJsb2NrVGFnLAogICAgICAgICAgICBmdWxsX3R4OiBib29sLAogICAgICAgICkgLT4gUmVzcG9uc2VCbG9jazsKICAgICAgICBhc3luYyBmbiBnZXRfYmxvY2tfYnlfaGFzaCgmc2VsZiwgaGFzaDogU3RyaW5nLCBmdWxsX3R4OiBib29sKSAtPiBSZXNwb25zZUJsb2NrOwogICAgICAgIGFzeW5jIGZuIGdldF9ibG9ja190cmFuc2FjdGlvbl9jb3VudF9ieV9oYXNoKCZzZWxmLCBoYXNoOiBTdHJpbmcpIC0+IFJlc3BvbnNlVTY0OwogICAgICAgIGFzeW5jIGZuIGdldF9ibG9ja190cmFuc2FjdGlvbl9jb3VudF9ieV9udW1iZXIoJnNlbGYsIGJsb2NrOiBCbG9ja1RhZykgLT4gUmVzcG9uc2VVNjQ7CgogICAgICAgIGFzeW5jIGZuIGdldF90cmFuc2FjdGlvbl9yZWNlaXB0KCZzZWxmLCB0eF9oYXNoOiBTdHJpbmcpIC0+IFJlc3BvbnNlVHJhbnNhY3Rpb25SZWNlaXB0OwogICAgICAgIGFzeW5jIGZuIGdldF90cmFuc2FjdGlvbl9ieV9oYXNoKCZzZWxmLCB0eF9oYXNoOiBTdHJpbmcpIC0+IFJlc3BvbnNlVHJhbnNhY3Rpb247CiAgICAgICAgYXN5bmMgZm4gZ2V0X3RyYW5zYWN0aW9uX2J5X2Jsb2NrX2hhc2hfYW5kX2luZGV4KAogICAgICAgICAgICAmc2VsZiwKICAgICAgICAgICAgYmxvY2tfaGFzaDogU3RyaW5nLAogICAgICAgICAgICBpbmRleDogdTY0LAogICAgICAgICkgLT4gUmVzcG9uc2VUcmFuc2FjdGlvbjsKCiAgICAgICAgYXN5bmMgZm4gZ2V0X2xvZ3MoJnNlbGYsIGZpbHRlcjogTG9nRmlsdGVyKSAtPiBSZXNwb25zZVZlY0xvZzsKCiAgICAgICAgYXN5bmMgZm4gZ2V0X2NvZGUoJnNlbGYsIGFkZHJlc3M6IFN0cmluZywgYmxvY2s6IEJsb2NrVGFnKSAtPiBSZXNwb25zZVZlYzg7CiAgICAgICAgYXN5bmMgZm4gZ2V0X3N0b3JhZ2VfYXQoCiAgICAgICAgICAgICZzZWxmLAogICAgICAgICAgICBhZGRyZXNzOiBTdHJpbmcsCiAgICAgICAgICAgIHNsb3Q6IFN0cmluZywKICAgICAgICAgICAgYmxvY2s6IEJsb2NrVGFnLAogICAgICAgICkgLT4gUmVzcG9uc2VTdHJpbmc7CgogICAgICAgIGFzeW5jIGZuIHN5bmNpbmcoJnNlbGYpIC0+IFJlc3BvbnNlU3luY2luZzsKICAgIH0KfQoKaW1wbCBIZWxpb3NDbGllbnQgewogICAgcHViIGZuIG5ldygpIC0+IEhlbGlvc0NsaWVudCB7CiAgICAgICAgSGVsaW9zQ2xpZW50IHsKICAgICAgICAgICAgY2xpZW50OiBOb25lLAogICAgICAgICAgICBpc19sb2dnaW5nOiBmYWxzZSwKICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gc3RhcnQoCiAgICAgICAgJm11dCBzZWxmLAogICAgICAgIHVudHJ1c3RlZF9ycGNfdXJsOiBTdHJpbmcsCiAgICAgICAgY29uc2Vuc3VzX3JwY191cmw6IFN0cmluZywKICAgICAgICBjaGVja3BvaW50OiBPcHRpb248U3RyaW5nPiwKICAgICAgICBycGNfcG9ydDogdTE2LAogICAgICAgIG5ldHdvcms6IGZmaTo6SGVsaW9zTmV0d29yaywKICAgICAgICBkYXRhX2RpcjogT3B0aW9uPFN0cmluZz4sCiAgICApIC0+IGZmaTo6U3RhcnRVcFN0YXRlIHsKICAgICAgICBpZiBsZXQgU29tZShfY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIHJldHVybiBmZmk6OlN0YXJ0VXBTdGF0ZSB7CiAgICAgICAgICAgICAgICBzdGFydGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiQ2xpZW50IGhhcyBhbHJlYWR5IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfTsKICAgICAgICB9CgogICAgICAgIGlmICFzZWxmLmlzX2xvZ2dpbmcgewogICAgICAgICAgICBzZWxmLmlzX2xvZ2dpbmcgPSB0cnVlOwogICAgICAgICAgICBsZXQgZW52X2ZpbHRlciA9IEVudkZpbHRlcjo6YnVpbGRlcigpCiAgICAgICAgICAgICAgICAud2l0aF9kZWZhdWx0X2RpcmVjdGl2ZShMZXZlbEZpbHRlcjo6SU5GTy5pbnRvKCkpCiAgICAgICAgICAgICAgICAuZnJvbV9lbnYoKQogICAgICAgICAgICAgICAgLmV4cGVjdCgiaW52YWxpZCBlbnYgZmlsdGVyIik7CiAgICAgICAgCiAgICAgICAgICAgIGxldCBzdWJzY3JpYmVyID0gRm10U3Vic2NyaWJlcjo6YnVpbGRlcigpCiAgICAgICAgICAgICAgICAud2l0aF9lbnZfZmlsdGVyKGVudl9maWx0ZXIpCiAgICAgICAgICAgICAgICAuZmluaXNoKCk7CiAgICAgICAgCiAgICAgICAgICAgIHRyYWNpbmc6OnN1YnNjcmliZXI6OnNldF9nbG9iYWxfZGVmYXVsdChzdWJzY3JpYmVyKS5leHBlY3QoInN1YnNjcmliZXIgc2V0IGZhaWxlZCIpOwogICAgICAgIH0KCiAgICAgICAgbGV0IG11dCBjbGllbnRfYnVpbGRlciA9IENsaWVudEJ1aWxkZXI6Om5ldygpCiAgICAgICAgICAgIC5uZXR3b3JrKG5ldHdvcmsudG9fYmFzZV9uZXR3b3JrKCkpCiAgICAgICAgICAgIC5leGVjdXRpb25fcnBjKCZ1bnRydXN0ZWRfcnBjX3VybCkKICAgICAgICAgICAgLmNvbnNlbnN1c19ycGMoJmNvbnNlbnN1c19ycGNfdXJsKQogICAgICAgICAgICAucnBjX3BvcnQocnBjX3BvcnQpOwoKICAgICAgICBpZiBsZXQgU29tZShjaGVja3BvaW50KSA9ICZjaGVja3BvaW50IHsKICAgICAgICAgICAgY2xpZW50X2J1aWxkZXIgPSBjbGllbnRfYnVpbGRlci5jaGVja3BvaW50KCZjaGVja3BvaW50KTsKICAgICAgICB9CgogICAgICAgIGlmIGxldCBTb21lKGRhdGFfZGlyKSA9ICZkYXRhX2RpciB7CiAgICAgICAgICAgIGNsaWVudF9idWlsZGVyID0gY2xpZW50X2J1aWxkZXIuZGF0YV9kaXIoKCZkYXRhX2RpcikuaW50bygpKTsKICAgICAgICB9CgogICAgICAgIG1hdGNoIGNsaWVudF9idWlsZGVyLmJ1aWxkKCkgewogICAgICAgICAgICBFcnIoZXJyb3IpID0+IHsKICAgICAgICAgICAgICAgIHJldHVybiBmZmk6OlN0YXJ0VXBTdGF0ZSB7CiAgICAgICAgICAgICAgICAgICAgc3RhcnRlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfQogICAgICAgICAgICB9CiAgICAgICAgICAgIE9rKG11dCBjbGllbnQpID0+IG1hdGNoIGNsaWVudC5zdGFydCgpLmF3YWl0IHsKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gewogICAgICAgICAgICAgICAgICAgIHJldHVybiBmZmk6OlN0YXJ0VXBTdGF0ZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0ZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgT2soKCkpID0+IHsKICAgICAgICAgICAgICAgICAgICBzZWxmLmNsaWVudCA9IFNvbWUoY2xpZW50KTsKICAgICAgICAgICAgICAgICAgICByZXR1cm4gZmZpOjpTdGFydFVwU3RhdGUgewogICAgICAgICAgICAgICAgICAgICAgICBzdGFydGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfTsKICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgfSwKICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gc2h1dGRvd24oJm11dCBzZWxmKSB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIGNsaWVudC5zaHV0ZG93bigpLmF3YWl0OwogICAgICAgICAgICBzZWxmLmNsaWVudCA9IE5vbmU7CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGNhbGwoJnNlbGYsIG9wdHM6IGZmaTo6Q2FsbE9wdHMsIGJsb2NrOiBmZmk6OkJsb2NrVGFnKSAtPiBmZmk6OlJlc3BvbnNlVmVjOCB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoICZvcHRzLnRvX2Jhc2Vfb3B0cygpIHsKICAgICAgICAgICAgICAgIE9rKG9wdHMpID0+IG1hdGNoIGNsaWVudC5jYWxsKG9wdHMsIGJsb2NrLnRvX2Jhc2VfYmxvY2soKSkuYXdhaXQgewogICAgICAgICAgICAgICAgICAgIE9rKGRhdGEpID0+IGZmaTo6UmVzcG9uc2VWZWM4IHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGRhdGEsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogW10uaW50bygpLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBbXS5pbnRvKCksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJJbnZhbGlkIGNhbGwgb3B0aW9uczoge30iLCBlcnJvciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgICAgICAgICAgdmFsdWU6IFtdLmludG8oKSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIHNlbmRfcmF3X3RyYW5zYWN0aW9uKCZzZWxmLCBieXRlczogVmVjPHU4PikgLT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGNsaWVudC5zZW5kX3Jhd190cmFuc2FjdGlvbigmYnl0ZXMpLmF3YWl0IHsKICAgICAgICAgICAgICAgIE9rKGhhc2gpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoaGFzaCkpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVyci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGVzdGltYXRlX2dhcygmc2VsZiwgb3B0czogZmZpOjpDYWxsT3B0cykgLT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoICZvcHRzLnRvX2Jhc2Vfb3B0cygpIHsKICAgICAgICAgICAgICAgIE9rKG9wdHMpID0+IG1hdGNoIGNsaWVudC5lc3RpbWF0ZV9nYXMoJm9wdHMpLmF3YWl0IHsKICAgICAgICAgICAgICAgICAgICBPayhnYXMpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZ2FzLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiSW52YWxpZCBjYWxsIG9wdGlvbnM6IHt9IiwgZXJyb3IpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBjaGFpbl9pZCgmc2VsZikgLT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgdmFsdWU6IGNsaWVudC5jaGFpbl9pZCgpLmF3YWl0LAogICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KICAgIGFzeW5jIGZuIGdldF9nYXNfcHJpY2UoJnNlbGYpIC0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBjbGllbnQuZ2V0X2dhc19wcmljZSgpLmF3YWl0IHsKICAgICAgICAgICAgICAgIE9rKGdhc19wcmljZSkgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGdhc19wcmljZS50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X3ByaW9yaXR5X2ZlZSgmc2VsZikgLT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGNsaWVudC5nZXRfcHJpb3JpdHlfZmVlKCkuYXdhaXQgewogICAgICAgICAgICAgICAgT2socHJpb3JpdHlfZmVlKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogcHJpb3JpdHlfZmVlLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfYmxvY2tfbnVtYmVyKCZzZWxmKSAtPiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggY2xpZW50LmdldF9ibG9ja19udW1iZXIoKS5hd2FpdCB7CiAgICAgICAgICAgICAgICBPayhibG9jaykgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGJsb2NrLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICIwIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgdmFsdWU6ICIwIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9jb2luYmFzZSgmc2VsZikgLT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGNsaWVudC5nZXRfY29pbmJhc2UoKS5hd2FpdCB7CiAgICAgICAgICAgICAgICBPayhjb2luYmFzZSkgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShjb2luYmFzZS5hc19ieXRlcygpKSksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9iYWxhbmNlKCZzZWxmLCBhZGRyZXNzOiBTdHJpbmcsIGJsb2NrOiBmZmk6OkJsb2NrVGFnKSAtPiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggYWRkcmVzc19mcm9tX3N0cmluZyhhZGRyZXNzKSB7CiAgICAgICAgICAgICAgICBPayhhZGRyZXNzKSA9PiBtYXRjaCBjbGllbnQuZ2V0X2JhbGFuY2UoJmFkZHJlc3MsIGJsb2NrLnRvX2Jhc2VfYmxvY2soKSkuYXdhaXQgewogICAgICAgICAgICAgICAgICAgIE9rKGJhbGFuY2UpID0+IGZmaTo6UmVzcG9uc2VTdHJpbmcgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogYmFsYW5jZS50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiSW52YWxpZCBhZGRyZXNzOiB7fSIsIGVycm9yKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9ub25jZSgmc2VsZiwgYWRkcmVzczogU3RyaW5nLCBibG9jazogZmZpOjpCbG9ja1RhZykgLT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGFkZHJlc3NfZnJvbV9zdHJpbmcoYWRkcmVzcykgewogICAgICAgICAgICAgICAgT2soYWRkcmVzcykgPT4gbWF0Y2ggY2xpZW50LmdldF9ub25jZSgmYWRkcmVzcywgYmxvY2sudG9fYmFzZV9ibG9jaygpKS5hd2FpdCB7CiAgICAgICAgICAgICAgICAgICAgT2sobm9uY2UpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogbm9uY2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJJbnZhbGlkIGFkZHJlc3M6IHt9IiwgZXJyb3IpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfYmxvY2tfYnlfbnVtYmVyKAogICAgICAgICZzZWxmLAogICAgICAgIGJsb2NrOiBmZmk6OkJsb2NrVGFnLAogICAgICAgIGZ1bGxfdHg6IGJvb2wsCiAgICApIC0+IGZmaTo6UmVzcG9uc2VCbG9jayB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGNsaWVudAogICAgICAgICAgICAgICAgLmdldF9ibG9ja19ieV9udW1iZXIoYmxvY2sudG9fYmFzZV9ibG9jaygpLCBmdWxsX3R4KQogICAgICAgICAgICAgICAgLmF3YWl0CiAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgIE9rKGJsb2NrKSA9PiBmZmk6OlJlc3BvbnNlQmxvY2sgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBibG9jay5tYXAoaGVsaW9zX2V4ZWN1dGlvbl9ibG9ja190b19mZmkpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VCbG9jayB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZUJsb2NrIHsKICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X2Jsb2NrX2J5X2hhc2goJnNlbGYsIGhhc2g6IFN0cmluZywgZnVsbF90eDogYm9vbCkgLT4gZmZpOjpSZXNwb25zZUJsb2NrIHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggaDI1Nl9mcm9tX3N0cmluZyhoYXNoKSB7CiAgICAgICAgICAgICAgICBPayhoYXNoKSA9PiB7CiAgICAgICAgICAgICAgICAgICAgbWF0Y2ggY2xpZW50CiAgICAgICAgICAgICAgICAgICAgICAgIC5nZXRfYmxvY2tfYnlfaGFzaCgmaGFzaCwgZnVsbF90eCkKICAgICAgICAgICAgICAgICAgICAgICAgLmF3YWl0CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBPayhibG9jaykgPT4gZmZpOjpSZXNwb25zZUJsb2NrIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBibG9jay5tYXAoaGVsaW9zX2V4ZWN1dGlvbl9ibG9ja190b19mZmkpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgRXJyKGVycikgPT4gZmZpOjpSZXNwb25zZUJsb2NrIHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVyci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlQmxvY2sgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiQmxvY2sgaGFzaDoge30iLCBlcnIpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VCbG9jayB7CiAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF9ibG9ja190cmFuc2FjdGlvbl9jb3VudF9ieV9oYXNoKCZzZWxmLCBoYXNoOiBTdHJpbmcpIC0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBoMjU2X2Zyb21fc3RyaW5nKGhhc2gpIHsKICAgICAgICAgICAgICAgIE9rKGhhc2gpID0+IHsKICAgICAgICAgICAgICAgICAgICBtYXRjaCBjbGllbnQKICAgICAgICAgICAgICAgICAgICAgICAgLmdldF9ibG9ja190cmFuc2FjdGlvbl9jb3VudF9ieV9oYXNoKCZoYXNoKQogICAgICAgICAgICAgICAgICAgICAgICAuYXdhaXQKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIE9rKGNvdW50KSA9PiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBjb3VudCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiQmxvY2sgaGFzaDoge30iLCBlcnIpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgdmFsdWU6IDAsCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfYmxvY2tfdHJhbnNhY3Rpb25fY291bnRfYnlfbnVtYmVyKAogICAgICAgICZzZWxmLAogICAgICAgIGJsb2NrOiBmZmk6OkJsb2NrVGFnLAogICAgKSAtPiBmZmk6OlJlc3BvbnNlVTY0IHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggY2xpZW50CiAgICAgICAgICAgICAgICAuZ2V0X2Jsb2NrX3RyYW5zYWN0aW9uX2NvdW50X2J5X251bWJlcihibG9jay50b19iYXNlX2Jsb2NrKCkpCiAgICAgICAgICAgICAgICAuYXdhaXQKICAgICAgICAgICAgewogICAgICAgICAgICAgICAgT2soY291bnQpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBjb3VudCwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICBFcnIoZXJyb3IpID0+IGZmaTo6UmVzcG9uc2VVNjQgewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiAwLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVU2NCB7CiAgICAgICAgICAgICAgICB2YWx1ZTogMCwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIGdldF90cmFuc2FjdGlvbl9yZWNlaXB0KCZzZWxmLCB0eF9oYXNoOiBTdHJpbmcpIC0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvblJlY2VpcHQgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBoMjU2X2Zyb21fc3RyaW5nKHR4X2hhc2gpIHsKICAgICAgICAgICAgICAgIE9rKHR4X2hhc2gpID0+IG1hdGNoIGNsaWVudC5nZXRfdHJhbnNhY3Rpb25fcmVjZWlwdCgmdHhfaGFzaCkuYXdhaXQgewogICAgICAgICAgICAgICAgICAgIE9rKHJlY2VpcHQpID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvblJlY2VpcHQgewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogcmVjZWlwdC5tYXAoZXRoZXJzX3JlY2VpcHRfdG9fZmZpKSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb25SZWNlaXB0IHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVycm9yLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycm9yKSA9PiBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb25SZWNlaXB0IHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIlRyYW5zYWN0aW9uIGhhc2g6IHt9IiwgZXJyb3IpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvblJlY2VpcHQgewogICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfdHJhbnNhY3Rpb25fYnlfaGFzaCgmc2VsZiwgdHhfaGFzaDogU3RyaW5nKSAtPiBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBoMjU2X2Zyb21fc3RyaW5nKHR4X2hhc2gpIHsKICAgICAgICAgICAgICAgIE9rKGhhc2gpID0+IG1hdGNoIGNsaWVudC5nZXRfdHJhbnNhY3Rpb25fYnlfaGFzaCgmaGFzaCkuYXdhaXQgewogICAgICAgICAgICAgICAgICAgIFNvbWUodHJhbnNhY3Rpb24pID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiBTb21lKGV0aGVyc190cmFuc2FjdGlvbl90b19mZmkodHJhbnNhY3Rpb24pKSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICAgICAgTm9uZSA9PiBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIlRyYW5zYWN0aW9uIG5vdCBmb3VuZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycikgPT4gZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIlRyYW5zYWN0aW9uIGhhc2g6IHt9IiwgZXJyKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfdHJhbnNhY3Rpb25fYnlfYmxvY2tfaGFzaF9hbmRfaW5kZXgoCiAgICAgICAgJnNlbGYsCiAgICAgICAgYmxvY2tfaGFzaDogU3RyaW5nLAogICAgICAgIGluZGV4OiB1NjQsCiAgICApIC0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgICAgICAgIG1hdGNoIGgyNTZfZnJvbV9zdHJpbmcoYmxvY2tfaGFzaCkgewogICAgICAgICAgICAgICAgT2soaGFzaCkgPT4gewogICAgICAgICAgICAgICAgICAgIG1hdGNoIGNsaWVudAogICAgICAgICAgICAgICAgICAgICAgICAuZ2V0X3RyYW5zYWN0aW9uX2J5X2Jsb2NrX2hhc2hfYW5kX2luZGV4KCZoYXNoLCBpbmRleCkKICAgICAgICAgICAgICAgICAgICAgICAgLmF3YWl0CiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBTb21lKHRyYW5zYWN0aW9uKSA9PiBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IFNvbWUoZXRoZXJzX3RyYW5zYWN0aW9uX3RvX2ZmaSh0cmFuc2FjdGlvbikpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiBmYWxzZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgTm9uZSA9PiBmZmk6OlJlc3BvbnNlVHJhbnNhY3Rpb24gewogICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIlRyYW5zYWN0aW9uIG5vdCBmb3VuZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VUcmFuc2FjdGlvbiB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IE5vbmUsCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJCbG9jayBoYXNoOiB7fSIsIGVyciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVRyYW5zYWN0aW9uIHsKICAgICAgICAgICAgICAgIHZhbHVlOiBOb25lLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X2xvZ3MoJnNlbGYsIGZpbHRlcjogZmZpOjpMb2dGaWx0ZXIpIC0+IGZmaTo6UmVzcG9uc2VWZWNMb2cgewogICAgICAgIGlmIGxldCBTb21lKGNsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICAgICAgICBtYXRjaCBmaWx0ZXIudG9fZXRoZXJzX2ZpbHRlcigpIHsKICAgICAgICAgICAgICAgIE9rKGZpbHRlcikgPT4gbWF0Y2ggY2xpZW50LmdldF9sb2dzKCZmaWx0ZXIpLmF3YWl0IHsKICAgICAgICAgICAgICAgICAgICBPayhsb2dzKSA9PiBmZmk6OlJlc3BvbnNlVmVjTG9nIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGxvZ3MuaW50b19pdGVyKCkubWFwKGV0aGVyc19sb2dfdG9fZmZpX2xvZykuY29sbGVjdCgpLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IGZhbHNlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICBFcnIoZXJyKSA9PiBmZmk6OlJlc3BvbnNlVmVjTG9nIHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZlYyFbXSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgRXJyKGVycikgPT4gZmZpOjpSZXNwb25zZVZlY0xvZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHZlYyFbXSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGZvcm1hdCEoIkludmFsaWQgZmlsdGVyOiB7fSIsIGVyciksCiAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICB9CiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgZmZpOjpSZXNwb25zZVZlY0xvZyB7CiAgICAgICAgICAgICAgICB2YWx1ZTogdmVjIVtdLAogICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgZXJyb3I6ICJIZWxpb3MgY2xpZW50IHdhc24ndCBzdGFydGVkLiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH0KICAgICAgICB9CiAgICB9CgogICAgYXN5bmMgZm4gZ2V0X2NvZGUoJnNlbGYsIGFkZHJlc3M6IFN0cmluZywgYmxvY2s6IGZmaTo6QmxvY2tUYWcpIC0+IGZmaTo6UmVzcG9uc2VWZWM4IHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggYWRkcmVzc19mcm9tX3N0cmluZyhhZGRyZXNzKSB7CiAgICAgICAgICAgICAgICBPayhhZGRyZXNzKSA9PiBtYXRjaCBjbGllbnQuZ2V0X2NvZGUoJmFkZHJlc3MsIGJsb2NrLnRvX2Jhc2VfYmxvY2soKSkuYXdhaXQgewogICAgICAgICAgICAgICAgICAgIE9rKGNvZGUpID0+IGZmaTo6UmVzcG9uc2VWZWM4IHsKICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IGNvZGUsCiAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogW10uaW50bygpLAogICAgICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgICAgIGVycm9yOiBlcnJvci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVZlYzggewogICAgICAgICAgICAgICAgICAgIHZhbHVlOiBbXS5pbnRvKCksCiAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgIGVycm9yOiBmb3JtYXQhKCJJbnZhbGlkIGFkZHJlc3M6IHt9IiwgZXJyb3IpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgfQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIGZmaTo6UmVzcG9uc2VWZWM4IHsKICAgICAgICAgICAgICAgIHZhbHVlOiBbXS5pbnRvKCksCiAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICBlcnJvcjogIkhlbGlvcyBjbGllbnQgd2Fzbid0IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgfQogICAgICAgIH0KICAgIH0KCiAgICBhc3luYyBmbiBnZXRfc3RvcmFnZV9hdCgKICAgICAgICAmc2VsZiwKICAgICAgICBhZGRyZXNzOiBTdHJpbmcsCiAgICAgICAgc2xvdDogU3RyaW5nLAogICAgICAgIGJsb2NrOiBmZmk6OkJsb2NrVGFnLAogICAgKSAtPiBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggYWRkcmVzc19mcm9tX3N0cmluZyhhZGRyZXNzKSB7CiAgICAgICAgICAgICAgICBPayhhZGRyZXNzKSA9PiBtYXRjaCBoMjU2X2Zyb21fc3RyaW5nKHNsb3QpIHsKICAgICAgICAgICAgICAgICAgICBPayhzbG90KSA9PiB7CiAgICAgICAgICAgICAgICAgICAgICAgIG1hdGNoIGNsaWVudAogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmdldF9zdG9yYWdlX2F0KCZhZGRyZXNzLCBzbG90LCBibG9jay50b19iYXNlX2Jsb2NrKCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAuYXdhaXQKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgT2soc3RvcmFnZSkgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6IHN0b3JhZ2UuZW5jb2RlX2hleCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgICAgICAgICAgZmFpbGVkOiB0cnVlLAogICAgICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiSW52YWxpZCBzbG90OiB7fSIsIGVycm9yKSwKICAgICAgICAgICAgICAgICAgICB9LAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnJvcikgPT4gZmZpOjpSZXNwb25zZVN0cmluZyB7CiAgICAgICAgICAgICAgICAgICAgdmFsdWU6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgICAgICBlcnJvcjogZm9ybWF0ISgiSW52YWxpZCBhZGRyZXNzOiB7fSIsIGVycm9yKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlU3RyaW5nIHsKICAgICAgICAgICAgICAgIHZhbHVlOiAiIi50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQoKICAgIGFzeW5jIGZuIHN5bmNpbmcoJnNlbGYpIC0+IGZmaTo6UmVzcG9uc2VTeW5jaW5nIHsKICAgICAgICBpZiBsZXQgU29tZShjbGllbnQpID0gJnNlbGYuY2xpZW50IHsKICAgICAgICAgICAgbWF0Y2ggY2xpZW50LnN5bmNpbmcoKS5hd2FpdCB7CiAgICAgICAgICAgICAgICBPayhzdGF0dXMpID0+IGZmaTo6UmVzcG9uc2VTeW5jaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogZXRoZXJzX3N5bmNpbmdfc3RhdHVzX3RvX2ZmaShzdGF0dXMpLAogICAgICAgICAgICAgICAgICAgIGZhaWxlZDogZmFsc2UsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6ICIiLnRvX3N0cmluZygpLAogICAgICAgICAgICAgICAgfSwKICAgICAgICAgICAgICAgIEVycihlcnIpID0+IGZmaTo6UmVzcG9uc2VTeW5jaW5nIHsKICAgICAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgICAgICBmYWlsZWQ6IHRydWUsCiAgICAgICAgICAgICAgICAgICAgZXJyb3I6IGVyci50b19zdHJpbmcoKSwKICAgICAgICAgICAgICAgIH0sCiAgICAgICAgICAgIH0KICAgICAgICB9IGVsc2UgewogICAgICAgICAgICBmZmk6OlJlc3BvbnNlU3luY2luZyB7CiAgICAgICAgICAgICAgICB2YWx1ZTogTm9uZSwKICAgICAgICAgICAgICAgIGZhaWxlZDogdHJ1ZSwKICAgICAgICAgICAgICAgIGVycm9yOiAiSGVsaW9zIGNsaWVudCB3YXNuJ3Qgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICAgICAgICB9CiAgICAgICAgfQogICAgfQp9CgppbXBsIGZmaTo6SGVsaW9zTmV0d29yayB7CiAgICBmbiB0b19iYXNlX25ldHdvcmsoJnNlbGYpIC0+IG5ldHdvcmtzOjpOZXR3b3JrIHsKICAgICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgICAgU2VsZjo6TUFJTk5FVCA9PiBuZXR3b3Jrczo6TmV0d29yazo6TUFJTk5FVCwKICAgICAgICAgICAgU2VsZjo6R09FUkxJID0+IG5ldHdvcmtzOjpOZXR3b3JrOjpHT0VSTEksCiAgICAgICAgfQogICAgfQp9CgppbXBsIGZmaTo6QmxvY2tUYWcgewogICAgZm4gdG9fYmFzZV9ibG9jaygmc2VsZikgLT4gY29tbW9uOjp0eXBlczo6QmxvY2tUYWcgewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpGaW5hbGl6ZWQgPT4gY29tbW9uOjp0eXBlczo6QmxvY2tUYWc6OkZpbmFsaXplZCwKICAgICAgICAgICAgU2VsZjo6TGF0ZXN0ID0+IGNvbW1vbjo6dHlwZXM6OkJsb2NrVGFnOjpMYXRlc3QsCiAgICAgICAgICAgIFNlbGY6OlNhZmUgPT4gY29tbW9uOjp0eXBlczo6QmxvY2tUYWc6OkZpbmFsaXplZCwKICAgICAgICAgICAgU2VsZjo6UGVuZGluZyA9PiBjb21tb246OnR5cGVzOjpCbG9ja1RhZzo6TGF0ZXN0LAogICAgICAgICAgICBTZWxmOjpFYXJsaWVzdCA9PiBjb21tb246OnR5cGVzOjpCbG9ja1RhZzo6TnVtYmVyKDEpLAogICAgICAgICAgICBTZWxmOjpOdW1iZXIoYmxvY2spID0+IGNvbW1vbjo6dHlwZXM6OkJsb2NrVGFnOjpOdW1iZXIoKmJsb2NrKSwKICAgICAgICB9CiAgICB9CgogICAgZm4gdG9fZXRoZXJzX2Jsb2NrKCZzZWxmKSAtPiBCbG9ja051bWJlciB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6OkZpbmFsaXplZCA9PiBCbG9ja051bWJlcjo6RmluYWxpemVkLAogICAgICAgICAgICBTZWxmOjpMYXRlc3QgPT4gQmxvY2tOdW1iZXI6OkxhdGVzdCwKICAgICAgICAgICAgU2VsZjo6U2FmZSA9PiBCbG9ja051bWJlcjo6U2FmZSwKICAgICAgICAgICAgU2VsZjo6UGVuZGluZyA9PiBCbG9ja051bWJlcjo6UGVuZGluZywKICAgICAgICAgICAgU2VsZjo6RWFybGllc3QgPT4gQmxvY2tOdW1iZXI6OkVhcmxpZXN0LAogICAgICAgICAgICBTZWxmOjpOdW1iZXIoYmxvY2spID0+IEJsb2NrTnVtYmVyOjpOdW1iZXIoVTY0Ojpmcm9tKCpibG9jaykpLAogICAgICAgIH0KICAgIH0KfQoKaW1wbCBDbG9uZSBmb3IgZmZpOjpCbG9ja1RhZyB7CiAgICBmbiBjbG9uZSgmc2VsZikgLT4gU2VsZiB7CiAgICAgICAgbWF0Y2ggc2VsZiB7CiAgICAgICAgICAgIFNlbGY6OkZpbmFsaXplZCA9PiBmZmk6OkJsb2NrVGFnOjpGaW5hbGl6ZWQsCiAgICAgICAgICAgIFNlbGY6OkxhdGVzdCA9PiBmZmk6OkJsb2NrVGFnOjpMYXRlc3QsCiAgICAgICAgICAgIFNlbGY6OlNhZmUgPT4gZmZpOjpCbG9ja1RhZzo6U2FmZSwKICAgICAgICAgICAgU2VsZjo6UGVuZGluZyA9PiBmZmk6OkJsb2NrVGFnOjpQZW5kaW5nLAogICAgICAgICAgICBTZWxmOjpFYXJsaWVzdCA9PiBmZmk6OkJsb2NrVGFnOjpFYXJsaWVzdCwKICAgICAgICAgICAgU2VsZjo6TnVtYmVyKGJsb2NrKSA9PiBmZmk6OkJsb2NrVGFnOjpOdW1iZXIoKmJsb2NrKSwKICAgICAgICB9CiAgICB9Cn0KCmltcGwgZmZpOjpGaWx0ZXJCbG9ja09wdGlvbiB7CiAgICBmbiB0b19ldGhlcnNfYmxvY2tfb3B0aW9uKCZzZWxmKSAtPiBSZXN1bHQ8RmlsdGVyQmxvY2tPcHRpb24sIFN0cmluZz4gewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpSYW5nZSB7CiAgICAgICAgICAgICAgICBmcm9tX2Jsb2NrLAogICAgICAgICAgICAgICAgdG9fYmxvY2ssCiAgICAgICAgICAgIH0gPT4gT2soRmlsdGVyQmxvY2tPcHRpb246OlJhbmdlIHsKICAgICAgICAgICAgICAgIGZyb21fYmxvY2s6IGZyb21fYmxvY2suYXNfcmVmKCkubWFwKHxibG9ja3wgYmxvY2sudG9fZXRoZXJzX2Jsb2NrKCkpLAogICAgICAgICAgICAgICAgdG9fYmxvY2s6IHRvX2Jsb2NrLmFzX3JlZigpLm1hcCh8YmxvY2t8IGJsb2NrLnRvX2V0aGVyc19ibG9jaygpKSwKICAgICAgICAgICAgfSksCiAgICAgICAgICAgIFNlbGY6OkF0QmxvY2tIYXNoKGhhc2gpID0+IE9rKEZpbHRlckJsb2NrT3B0aW9uOjpBdEJsb2NrSGFzaCgKICAgICAgICAgICAgICAgIGgyNTZfZnJvbV9zdHJpbmcoaGFzaC50b19zdHJpbmcoKSkKICAgICAgICAgICAgICAgICAgICAubWFwX2Vycih8ZXJyb3J8IGZvcm1hdCEoIkZpbHRlciBibG9jayBoYXNoOiB7fSIsIGVycm9yKSk/LAogICAgICAgICAgICApKSwKICAgICAgICB9CiAgICB9Cn0KCmltcGwgQ2xvbmUgZm9yIGZmaTo6RmlsdGVyQmxvY2tPcHRpb24gewogICAgZm4gY2xvbmUoJnNlbGYpIC0+IFNlbGYgewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpSYW5nZSB7CiAgICAgICAgICAgICAgICBmcm9tX2Jsb2NrLAogICAgICAgICAgICAgICAgdG9fYmxvY2ssCiAgICAgICAgICAgIH0gPT4gZmZpOjpGaWx0ZXJCbG9ja09wdGlvbjo6UmFuZ2UgewogICAgICAgICAgICAgICAgZnJvbV9ibG9jazogZnJvbV9ibG9jay5jbG9uZSgpLAogICAgICAgICAgICAgICAgdG9fYmxvY2s6IHRvX2Jsb2NrLmNsb25lKCksCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIFNlbGY6OkF0QmxvY2tIYXNoKGhhc2gpID0+IGZmaTo6RmlsdGVyQmxvY2tPcHRpb246OkF0QmxvY2tIYXNoKGhhc2guY2xvbmUoKSksCiAgICAgICAgfQogICAgfQp9CgppbXBsIGZmaTo6TG9nRmlsdGVyIHsKICAgIGZuIHRvX2V0aGVyc19maWx0ZXIoJnNlbGYpIC0+IFJlc3VsdDxGaWx0ZXIsIFN0cmluZz4gewogICAgICAgIE9rKEZpbHRlciB7CiAgICAgICAgICAgIGJsb2NrX29wdGlvbjogc2VsZi5ibG9ja19vcHRpb24udG9fZXRoZXJzX2Jsb2NrX29wdGlvbigpPywKICAgICAgICAgICAgYWRkcmVzczogaWYgc2VsZi5hZGRyZXNzLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgTm9uZQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgU29tZSgKICAgICAgICAgICAgICAgICAgICBhZGRyZXNzZXNfZnJvbV9zdHJpbmcoc2VsZi5hZGRyZXNzLmNsb25lKCkpCiAgICAgICAgICAgICAgICAgICAgICAgIC5tYXBfZXJyKHxlcnJ8IGZvcm1hdCEoIkZpbHRlciBhZGRyZXNzOiB7fSIsIGVycikpPywKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdG9waWNzOiB0b3BpY3NfZnJvbV9zdHJpbmdzKHNlbGYudG9waWNzLmNsb25lKCkpCiAgICAgICAgICAgICAgICAubWFwX2Vycih8ZXJyfCBmb3JtYXQhKCJGaWx0ZXIgdG9waWNzOiB7fSIsIGVycikpPywKICAgICAgICB9KQogICAgfQp9CgppbXBsIGZmaTo6Q2FsbE9wdHMgewogICAgZm4gdG9fYmFzZV9vcHRzKCZzZWxmKSAtPiBSZXN1bHQ8ZXhlY3V0aW9uOjp0eXBlczo6Q2FsbE9wdHMsIFN0cmluZz4gewogICAgICAgIE9rKGV4ZWN1dGlvbjo6dHlwZXM6OkNhbGxPcHRzIHsKICAgICAgICAgICAgZnJvbTogaWYgc2VsZi5mcm9tLmlzX2VtcHR5KCkgewogICAgICAgICAgICAgICAgTm9uZQogICAgICAgICAgICB9IGVsc2UgewogICAgICAgICAgICAgICAgU29tZSgKICAgICAgICAgICAgICAgICAgICBhZGRyZXNzX2Zyb21fc3RyaW5nKHNlbGYuZnJvbS5jbG9uZSgpKQogICAgICAgICAgICAgICAgICAgICAgICAubWFwX2Vycih8ZXJyfCBmb3JtYXQhKCJmcm9tOiB7fSIsIGVycikpPywKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdG86IFNvbWUoYWRkcmVzc19mcm9tX3N0cmluZyhzZWxmLnRvLmNsb25lKCkpLm1hcF9lcnIofGVycnwgZm9ybWF0ISgidG86IHt9IiwgZXJyKSk/KSwKICAgICAgICAgICAgZ2FzOiBpZiBzZWxmLmdhcy5pc19lbXB0eSgpIHsKICAgICAgICAgICAgICAgIE5vbmUKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIFNvbWUodTI1Nl9mcm9tX3N0cmluZyhzZWxmLmdhcy5jbG9uZSgpKS5tYXBfZXJyKHxlcnJ8IGZvcm1hdCEoImdhczoge30iLCBlcnIpKT8pCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGdhc19wcmljZTogaWYgc2VsZi5nYXNfcHJpY2UuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICBOb25lCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBTb21lKAogICAgICAgICAgICAgICAgICAgIHUyNTZfZnJvbV9zdHJpbmcoc2VsZi5nYXNfcHJpY2UuY2xvbmUoKSkKICAgICAgICAgICAgICAgICAgICAgICAgLm1hcF9lcnIofGVycnwgZm9ybWF0ISgiZ2FzX3ByaWNlOiB7fSIsIGVycikpPywKICAgICAgICAgICAgICAgICkKICAgICAgICAgICAgfSwKICAgICAgICAgICAgdmFsdWU6IGlmIHNlbGYudmFsdWUuaXNfZW1wdHkoKSB7CiAgICAgICAgICAgICAgICBOb25lCiAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICBTb21lKAogICAgICAgICAgICAgICAgICAgIHUyNTZfZnJvbV9zdHJpbmcoc2VsZi52YWx1ZS5jbG9uZSgpKQogICAgICAgICAgICAgICAgICAgICAgICAubWFwX2Vycih8ZXJyfCBmb3JtYXQhKCJ2YWx1ZToge30iLCBlcnIpKT8sCiAgICAgICAgICAgICAgICApCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgIGRhdGE6IGlmIHNlbGYuZGF0YS5pc19lbXB0eSgpIHsKICAgICAgICAgICAgICAgIE5vbmUKICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgIFNvbWUodmVjOF9mcm9tX3N0cmluZyhzZWxmLmRhdGEuY2xvbmUoKSkubWFwX2Vycih8ZXJyfCBmb3JtYXQhKCJkYXRhOiB7fSIsIGVycikpPy5pbnRvKCkpCiAgICAgICAgICAgIH0sCiAgICAgICAgfSkKICAgIH0KfQoKaW1wbCBDbG9uZSBmb3IgZmZpOjpUcmFuc2FjdGlvbnMgewogICAgZm4gY2xvbmUoJnNlbGYpIC0+IFNlbGYgewogICAgICAgIG1hdGNoIHNlbGYgewogICAgICAgICAgICBTZWxmOjpIYXNoZXMoaGFzaGVzKSA9PiBmZmk6OlRyYW5zYWN0aW9uczo6SGFzaGVzKGhhc2hlcy5jbG9uZSgpKSwKICAgICAgICAgICAgU2VsZjo6RnVsbCh0cmFuc2FjdGlvbnMpID0+IGZmaTo6VHJhbnNhY3Rpb25zOjpGdWxsKHRyYW5zYWN0aW9ucy50b192ZWMoKSksCiAgICAgICAgfQogICAgfQp9CgpmbiB0b3BpY3NfZnJvbV9zdHJpbmdzKAogICAgdmFsdWU6IFZlYzxTdHJpbmc+LAopIC0+IFJlc3VsdDxbT3B0aW9uPFZhbHVlT3JBcnJheTxPcHRpb248SDI1Nj4+PjsgNF0sIFN0cmluZz4gewogICAgaWYgdmFsdWUubGVuKCkgPiA0IHsKICAgICAgICBFcnIoIlRvbyBtYW55IHRvcGljcyIudG9fc3RyaW5nKCkpCiAgICB9IGVsc2UgewogICAgICAgIGxldCBtYXBfc3RyaW5nX3RvX3RvcGljcyA9CiAgICAgICAgICAgIHx2YWx1ZTogU3RyaW5nfCAtPiBSZXN1bHQ8T3B0aW9uPFZhbHVlT3JBcnJheTxPcHRpb248SDI1Nj4+PiwgU3RyaW5nPiB7CiAgICAgICAgICAgICAgICBpZiB2YWx1ZS5pc19lbXB0eSgpIHsKICAgICAgICAgICAgICAgICAgICBPayhOb25lKQogICAgICAgICAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgICAgICAgICBsZXQgdG9waWNzOiBWZWM8JnN0cj4gPSB2YWx1ZS5zcGxpdCgnLCcpLmNvbGxlY3QoKTsKICAgICAgICAgICAgICAgICAgICBpZiB0b3BpY3MubGVuKCkgPT0gMSB7CiAgICAgICAgICAgICAgICAgICAgICAgIE9rKFNvbWUoVmFsdWVPckFycmF5OjpWYWx1ZShTb21lKGgyNTZfZnJvbV9zdHJpbmcoCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0b3BpY3NbMF0udG9fc3RyaW5nKCksCiAgICAgICAgICAgICAgICAgICAgICAgICk/KSkpKQogICAgICAgICAgICAgICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgICAgICAgICAgICAgIGxldCBtYXBwZWQ6IFJlc3VsdDxWZWM8SDI1Nj4sIFN0cmluZz4gPSB0b3BpY3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5pbnRvX2l0ZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLm1hcCh8dG9waWN8IGgyNTZfZnJvbV9zdHJpbmcodG9waWMudG9fc3RyaW5nKCkpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgLmNvbGxlY3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgbGV0IG9wdGlvbl9tYXBwZWQ6IFZlYzxPcHRpb248SDI1Nj4+ID0KICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1hcHBlZD8uaW50b19pdGVyKCkubWFwKHxoYXNofCBPcHRpb246OlNvbWUoaGFzaCkpLmNvbGxlY3QoKTsKICAgICAgICAgICAgICAgICAgICAgICAgT2soU29tZShWYWx1ZU9yQXJyYXk6OkFycmF5KG9wdGlvbl9tYXBwZWQpKSkKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIH07CiAgICAgICAgbGV0IG11dCB0b3BpY3MgPSB2YWx1ZS5jbG9uZSgpOwogICAgICAgIGZvciBfaSBpbiB0b3BpY3MubGVuKCkuLjQgewogICAgICAgICAgICB0b3BpY3MucHVzaCgiIi50b19zdHJpbmcoKSk7CiAgICAgICAgfQogICAgICAgIGxldCBtYXBwZWQ6IFJlc3VsdDxWZWM8T3B0aW9uPFZhbHVlT3JBcnJheTxPcHRpb248SDI1Nj4+Pj4sIFN0cmluZz4gPQogICAgICAgICAgICB0b3BpY3MuaW50b19pdGVyKCkubWFwKG1hcF9zdHJpbmdfdG9fdG9waWNzKS5jb2xsZWN0KCk7CiAgICAgICAgT2sobWFwcGVkPy50cnlfaW50bygpLm1hcF9lcnIofF9lcnJ8ICJGYWlsZWQgdG8gbWFwIHZlY3RvciIpPykKICAgIH0KfQoKZm4gYWRkcmVzc19mcm9tX3N0cmluZyh2YWx1ZTogU3RyaW5nKSAtPiBSZXN1bHQ8QWRkcmVzcywgU3RyaW5nPiB7CiAgICBsZXQgcmF3X2hleCA9IHZlYzhfZnJvbV9zdHJpbmcodmFsdWUpPzsKICAgIGlmIHJhd19oZXgubGVuKCkgPT0gQWRkcmVzczo6bGVuX2J5dGVzKCkgewogICAgICAgIE9rKEFkZHJlc3M6OmZyb21fc2xpY2UoJnJhd19oZXgpKQogICAgfSBlbHNlIHsKICAgICAgICBFcnIoZm9ybWF0ISgiU2hvdWxkIGJlIHt9IGJ5dGVzIGxvbmciLCBBZGRyZXNzOjpsZW5fYnl0ZXMoKSkpCiAgICB9Cn0KCmZuIGFkZHJlc3Nlc19mcm9tX3N0cmluZyh2YWx1ZTogU3RyaW5nKSAtPiBSZXN1bHQ8VmFsdWVPckFycmF5PEFkZHJlc3M+LCBTdHJpbmc+IHsKICAgIGxldCBhZGRyZXNzZXM6IFZlYzwmc3RyPiA9IHZhbHVlLnNwbGl0KCcsJykuY29sbGVjdCgpOwogICAgaWYgYWRkcmVzc2VzLmxlbigpID09IDEgewogICAgICAgIE9rKFZhbHVlT3JBcnJheTo6VmFsdWUoYWRkcmVzc19mcm9tX3N0cmluZygKICAgICAgICAgICAgYWRkcmVzc2VzWzBdLnRvX3N0cmluZygpLAogICAgICAgICk/KSkKICAgIH0gZWxzZSB7CiAgICAgICAgbGV0IG1hcHBlZDogUmVzdWx0PFZlYzxBZGRyZXNzPiwgU3RyaW5nPiA9IGFkZHJlc3NlcwogICAgICAgICAgICAuaW50b19pdGVyKCkKICAgICAgICAgICAgLm1hcCh8YWRkcmVzc3wgYWRkcmVzc19mcm9tX3N0cmluZyhhZGRyZXNzLnRvX3N0cmluZygpKSkKICAgICAgICAgICAgLmNvbGxlY3QoKTsKICAgICAgICBPayhWYWx1ZU9yQXJyYXk6OkFycmF5KG1hcHBlZD8pKQogICAgfQp9CgpmbiBoMjU2X2Zyb21fc3RyaW5nKHZhbHVlOiBTdHJpbmcpIC0+IFJlc3VsdDxIMjU2LCBTdHJpbmc+IHsKICAgIGxldCByYXdfaGV4ID0gdmVjOF9mcm9tX3N0cmluZyh2YWx1ZSk/OwogICAgaWYgcmF3X2hleC5sZW4oKSA9PSBIMjU2OjpsZW5fYnl0ZXMoKSB7CiAgICAgICAgT2soSDI1Njo6ZnJvbV9zbGljZSgmcmF3X2hleCkpCiAgICB9IGVsc2UgewogICAgICAgIEVycihmb3JtYXQhKCJTaG91bGQgYmUge30gYnl0ZXMgbG9uZyIsIEgyNTY6Omxlbl9ieXRlcygpKSkKICAgIH0KfQoKZm4gdTI1Nl9mcm9tX3N0cmluZyh2YWx1ZTogU3RyaW5nKSAtPiBSZXN1bHQ8VTI1NiwgU3RyaW5nPiB7CiAgICBpZiBsZXQgU29tZShyYXdfaGV4X3N0cmluZykgPSB2YWx1ZS5zdHJpcF9wcmVmaXgoIjB4IikgewogICAgICAgIE9rKFUyNTY6OmZyb21fc3RyX3JhZGl4KHJhd19oZXhfc3RyaW5nLCAxNikubWFwX2Vycih8ZXJyfCBlcnIudG9fc3RyaW5nKCkpPykKICAgIH0gZWxzZSB7CiAgICAgICAgT2soVTI1Njo6ZnJvbV9zdHJfcmFkaXgoJnZhbHVlLCAxMCkubWFwX2Vycih8ZXJyfCBlcnIudG9fc3RyaW5nKCkpPykKICAgIH0KfQoKZm4gdmVjOF9mcm9tX3N0cmluZyh2YWx1ZTogU3RyaW5nKSAtPiBSZXN1bHQ8VmVjPHU4PiwgU3RyaW5nPiB7CiAgICBpZiBsZXQgU29tZShyYXdfaGV4X3N0cmluZykgPSB2YWx1ZS5zdHJpcF9wcmVmaXgoIjB4IikgewogICAgICAgIE9rKGhleDo6ZGVjb2RlKHJhd19oZXhfc3RyaW5nKS5tYXBfZXJyKHxlcnJ8IGVyci50b19zdHJpbmcoKSk/KQogICAgfSBlbHNlIHsKICAgICAgICBFcnIoIlNob3VsZCBiZSBhIGhleCB2YWx1ZSBwcmVmaXhlZCB3aXRoIDB4Ii50b19zdHJpbmcoKSkKICAgIH0KfQoKZm4gZXRoZXJzX2xvZ190b19mZmlfbG9nKHZhbHVlOiBMb2cpIC0+IGZmaTo6TG9nIHsKICAgIGZmaTo6TG9nIHsKICAgICAgICBhZGRyZXNzOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUuYWRkcmVzcy5hc19ieXRlcygpKSksCiAgICAgICAgdG9waWNzOiB2YWx1ZQogICAgICAgICAgICAudG9waWNzCiAgICAgICAgICAgIC5pbnRvX2l0ZXIoKQogICAgICAgICAgICAubWFwKHx0b3BpY3wgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHRvcGljLmFzX2J5dGVzKCkpKSkKICAgICAgICAgICAgLmNvbGxlY3QoKSwKICAgICAgICBkYXRhOiB2YWx1ZS5kYXRhLmVuY29kZSgpLAogICAgICAgIGJsb2NrX2hhc2g6IHZhbHVlCiAgICAgICAgICAgIC5ibG9ja19oYXNoCiAgICAgICAgICAgIC5tYXAofGhhc2h8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShoYXNoLmFzX2J5dGVzKCkpKSkKICAgICAgICAgICAgLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICAgICAgYmxvY2tfbnVtYmVyOiB2YWx1ZS5ibG9ja19udW1iZXIubWFwKHxibG9ja3wgYmxvY2suYXNfdTY0KCkpLAogICAgICAgIHRyYW5zYWN0aW9uX2hhc2g6IHZhbHVlCiAgICAgICAgICAgIC50cmFuc2FjdGlvbl9oYXNoCiAgICAgICAgICAgIC5tYXAofGhhc2h8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShoYXNoLmFzX2J5dGVzKCkpKSkKICAgICAgICAgICAgLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICAgICAgdHJhbnNhY3Rpb25faW5kZXg6IHZhbHVlLnRyYW5zYWN0aW9uX2luZGV4Lm1hcCh8aW5kZXh8IGluZGV4LmFzX3U2NCgpKSwKICAgICAgICBsb2dfaW5kZXg6IHZhbHVlCiAgICAgICAgICAgIC5sb2dfaW5kZXgKICAgICAgICAgICAgLm1hcCh8aW5kZXh8IGluZGV4LnRvX3N0cmluZygpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICB0cmFuc2FjdGlvbl9sb2dfaW5kZXg6IHZhbHVlCiAgICAgICAgICAgIC50cmFuc2FjdGlvbl9sb2dfaW5kZXgKICAgICAgICAgICAgLm1hcCh8aW5kZXh8IGluZGV4LnRvX3N0cmluZygpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICBsb2dfdHlwZTogdmFsdWUubG9nX3R5cGUudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICByZW1vdmVkOiB2YWx1ZS5yZW1vdmVkLAogICAgfQp9CgpmbiBldGhlcnNfcmVjZWlwdF90b19mZmkodmFsdWU6IFRyYW5zYWN0aW9uUmVjZWlwdCkgLT4gZmZpOjpUcmFuc2FjdGlvblJlY2VpcHQgewogICAgZmZpOjpUcmFuc2FjdGlvblJlY2VpcHQgewogICAgICAgIHRyYW5zYWN0aW9uX2hhc2g6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS50cmFuc2FjdGlvbl9oYXNoLmFzX2J5dGVzKCkpKSwKICAgICAgICB0cmFuc2FjdGlvbl9pbmRleDogdmFsdWUudHJhbnNhY3Rpb25faW5kZXguYXNfdTY0KCksCiAgICAgICAgYmxvY2tfaGFzaDogdmFsdWUKICAgICAgICAgICAgLmJsb2NrX2hhc2gKICAgICAgICAgICAgLm1hcCh8aGFzaHwgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGhhc2guYXNfYnl0ZXMoKSkpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICBibG9ja19udW1iZXI6IHZhbHVlLmJsb2NrX251bWJlci5tYXAofG51bWJlcnwgbnVtYmVyLmFzX3U2NCgpKSwKICAgICAgICBmcm9tOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUuZnJvbS5hc19ieXRlcygpKSksCiAgICAgICAgdG86IHZhbHVlCiAgICAgICAgICAgIC50bwogICAgICAgICAgICAubWFwKHxhZGRyZXNzfCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoYWRkcmVzcy5hc19ieXRlcygpKSkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIGN1bXVsYXRpdmVfZ2FzX3VzZWQ6IHZhbHVlLmN1bXVsYXRpdmVfZ2FzX3VzZWQudG9fc3RyaW5nKCksCiAgICAgICAgZ2FzX3VzZWQ6IHZhbHVlCiAgICAgICAgICAgIC5nYXNfdXNlZAogICAgICAgICAgICAubWFwKHxnYXN8IGdhcy50b19zdHJpbmcoKSkKICAgICAgICAgICAgLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICAgICAgY29udHJhY3RfYWRkcmVzczogdmFsdWUKICAgICAgICAgICAgLmNvbnRyYWN0X2FkZHJlc3MKICAgICAgICAgICAgLm1hcCh8YWRkcmVzc3wgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGFkZHJlc3MuYXNfYnl0ZXMoKSkpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgICAgICBsb2dzOiB2YWx1ZS5sb2dzLmludG9faXRlcigpLm1hcChldGhlcnNfbG9nX3RvX2ZmaV9sb2cpLmNvbGxlY3QoKSwKICAgICAgICBzdGF0dXM6IHZhbHVlLnN0YXR1cy5tYXAofHN0YXR1c3wgc3RhdHVzLmFzX3U2NCgpKSwKICAgICAgICByb290OiB2YWx1ZQogICAgICAgICAgICAucm9vdAogICAgICAgICAgICAubWFwKHxoYXNofCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoaGFzaC5hc19ieXRlcygpKSkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIGxvZ3NfYmxvb206IHZhbHVlLmxvZ3NfYmxvb20uYXNfYnl0ZXMoKS50b192ZWMoKSwKICAgICAgICB0cmFuc2FjdGlvbl90eXBlOiB2YWx1ZS50cmFuc2FjdGlvbl90eXBlLm1hcCh8dmFsfCB2YWwuYXNfdTY0KCkpLAogICAgICAgIGVmZmVjdGl2ZV9nYXNfcHJpY2U6IHZhbHVlCiAgICAgICAgICAgIC5lZmZlY3RpdmVfZ2FzX3ByaWNlCiAgICAgICAgICAgIC5tYXAofGdhc3wgZ2FzLnRvX3N0cmluZygpKQogICAgICAgICAgICAudW53cmFwX29yKCIiLnRvX3N0cmluZygpKSwKICAgIH0KfQoKZm4gZXRoZXJzX3RyYW5zYWN0aW9uX3RvX2ZmaSh2YWx1ZTogVHJhbnNhY3Rpb24pIC0+IGZmaTo6VHJhbnNhY3Rpb24gewogICAgZmZpOjpUcmFuc2FjdGlvbiB7CiAgICAgICAgaGFzaDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLmhhc2guYXNfYnl0ZXMoKSkpLAogICAgICAgIG5vbmNlOiB2YWx1ZS5ub25jZS50b19zdHJpbmcoKSwKICAgICAgICBibG9ja19oYXNoOiB2YWx1ZQogICAgICAgICAgICAuYmxvY2tfaGFzaAogICAgICAgICAgICAubWFwKHxoYXNofCBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUoaGFzaC5hc19ieXRlcygpKSkpCiAgICAgICAgICAgIC51bndyYXBfb3IoIiIudG9fc3RyaW5nKCkpLAogICAgICAgIGJsb2NrX251bWJlcjogdmFsdWUuYmxvY2tfbnVtYmVyLm1hcCh8YmxvY2t8IGJsb2NrLmFzX3U2NCgpKSwKICAgICAgICB0cmFuc2FjdGlvbl9pbmRleDogdmFsdWUudHJhbnNhY3Rpb25faW5kZXgubWFwKHxpbmRleHwgaW5kZXguYXNfdTY0KCkpLAogICAgICAgIGZyb206IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5mcm9tLmFzX2J5dGVzKCkpKSwKICAgICAgICB0bzogdmFsdWUKICAgICAgICAgICAgLnRvCiAgICAgICAgICAgIC5tYXAofGFkZHJlc3N8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShhZGRyZXNzLmFzX2J5dGVzKCkpKSkKICAgICAgICAgICAgLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICAgICAgdmFsdWU6IHZhbHVlLnZhbHVlLnRvX3N0cmluZygpLAogICAgICAgIGdhc19wcmljZTogdmFsdWUKICAgICAgICAgICAgLmdhc19wcmljZQogICAgICAgICAgICAubWFwKHxnYXN8IGdhcy50b19zdHJpbmcoKSkKICAgICAgICAgICAgLnVud3JhcF9vcigiIi50b19zdHJpbmcoKSksCiAgICAgICAgZ2FzOiB2YWx1ZS5nYXMudG9fc3RyaW5nKCksCiAgICAgICAgaW5wdXQ6IHZhbHVlLmlucHV0LnRvX3ZlYygpLAogICAgICAgIHY6IHZhbHVlLnYudG9fc3RyaW5nKCksCiAgICAgICAgcjogdmFsdWUuci5lbmNvZGVfaGV4KCksCiAgICAgICAgczogdmFsdWUucy5lbmNvZGVfaGV4KCksCiAgICB9Cn0KCmZuIGV0aGVyc19zeW5jaW5nX3N0YXR1c190b19mZmkodmFsdWU6IFN5bmNpbmdTdGF0dXMpIC0+IE9wdGlvbjxmZmk6OlN5bmNpbmdTdGF0dXM+IHsKICAgIG1hdGNoIHZhbHVlIHsKICAgICAgICBTeW5jaW5nU3RhdHVzOjpJc0ZhbHNlID0+IE5vbmUsCiAgICAgICAgU3luY2luZ1N0YXR1czo6SXNTeW5jaW5nKHZhbHVlKSA9PiBTb21lKGZmaTo6U3luY2luZ1N0YXR1cyB7CiAgICAgICAgICAgIGN1cnJlbnRfYmxvY2s6IHZhbHVlLmN1cnJlbnRfYmxvY2suYXNfdTY0KCksCiAgICAgICAgICAgIGhpZ2hlc3RfYmxvY2s6IHZhbHVlLmhpZ2hlc3RfYmxvY2suYXNfdTY0KCksCiAgICAgICAgICAgIHN0YXJ0aW5nX2Jsb2NrOiB2YWx1ZS5zdGFydGluZ19ibG9jay5hc191NjQoKSwKICAgICAgICB9KSwKICAgIH0KfQoKZm4gaGVsaW9zX3RyYW5zYWN0aW9uc190b19mZmkodmFsdWU6IFRyYW5zYWN0aW9ucykgLT4gZmZpOjpUcmFuc2FjdGlvbnMgewogICAgbWF0Y2ggdmFsdWUgewogICAgICAgIFRyYW5zYWN0aW9uczo6SGFzaGVzKGhhc2hlcykgPT4gZmZpOjpUcmFuc2FjdGlvbnM6Okhhc2hlcygKICAgICAgICAgICAgaGFzaGVzCiAgICAgICAgICAgICAgICAuaW50b19pdGVyKCkKICAgICAgICAgICAgICAgIC5tYXAofGhhc2h8IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZShoYXNoLmFzX2J5dGVzKCkpKSkKICAgICAgICAgICAgICAgIC5jb2xsZWN0KCksCiAgICAgICAgKSwKICAgICAgICBUcmFuc2FjdGlvbnM6OkZ1bGwodHJhbnNhY3Rpb25zKSA9PiBmZmk6OlRyYW5zYWN0aW9uczo6RnVsbCgKICAgICAgICAgICAgdHJhbnNhY3Rpb25zCiAgICAgICAgICAgICAgICAuaW50b19pdGVyKCkKICAgICAgICAgICAgICAgIC5tYXAoZXRoZXJzX3RyYW5zYWN0aW9uX3RvX2ZmaSkKICAgICAgICAgICAgICAgIC5jb2xsZWN0KCksCiAgICAgICAgKSwKICAgIH0KfQoKZm4gaGVsaW9zX2V4ZWN1dGlvbl9ibG9ja190b19mZmkodmFsdWU6IEJsb2NrKSAtPiBmZmk6OkJsb2NrIHsKICAgIGZmaTo6QmxvY2sgewogICAgICAgIG51bWJlcjogdmFsdWUubnVtYmVyLmFzX3U2NCgpLAogICAgICAgIGJhc2VfZmVlX3Blcl9nYXM6IHZhbHVlLmJhc2VfZmVlX3Blcl9nYXMudG9fc3RyaW5nKCksCiAgICAgICAgZGlmZmljdWx0eTogdmFsdWUuZGlmZmljdWx0eS50b19zdHJpbmcoKSwKICAgICAgICBleHRyYV9kYXRhOiB2YWx1ZS5leHRyYV9kYXRhLnRvX3ZlYygpLAogICAgICAgIGdhc19saW1pdDogdmFsdWUuZ2FzX2xpbWl0LmFzX3U2NCgpLAogICAgICAgIGdhc191c2VkOiB2YWx1ZS5nYXNfdXNlZC5hc191NjQoKSwKICAgICAgICBoYXNoOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUuaGFzaC5hc19ieXRlcygpKSksCiAgICAgICAgbG9nc19ibG9vbTogdmFsdWUubG9nc19ibG9vbS50b192ZWMoKSwKICAgICAgICBtaW5lcjogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLm1pbmVyLmFzX2J5dGVzKCkpKSwKICAgICAgICBtaXhfaGFzaDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLm1peF9oYXNoLmFzX2J5dGVzKCkpKSwKICAgICAgICBub25jZTogdmFsdWUubm9uY2UudG9fc3RyaW5nKCksCiAgICAgICAgcGFyZW50X2hhc2g6IGZvcm1hdCEoIjB4e30iLCBoZXg6OmVuY29kZSh2YWx1ZS5wYXJlbnRfaGFzaC5hc19ieXRlcygpKSksCiAgICAgICAgcmVjZWlwdHNfcm9vdDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLnJlY2VpcHRzX3Jvb3QuYXNfYnl0ZXMoKSkpLAogICAgICAgIHNoYTNfdW5jbGVzOiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUuc2hhM191bmNsZXMuYXNfYnl0ZXMoKSkpLAogICAgICAgIHNpemU6IHZhbHVlLnNpemUuYXNfdTY0KCksCiAgICAgICAgc3RhdGVfcm9vdDogZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKHZhbHVlLnN0YXRlX3Jvb3QuYXNfYnl0ZXMoKSkpLAogICAgICAgIHRpbWVzdGFtcDogdmFsdWUudGltZXN0YW1wLmFzX3U2NCgpLAogICAgICAgIHRvdGFsX2RpZmZpY3VsdHk6IHZhbHVlLnRvdGFsX2RpZmZpY3VsdHkuYXNfdTY0KCksCiAgICAgICAgdHJhbnNhY3Rpb25zOiBoZWxpb3NfdHJhbnNhY3Rpb25zX3RvX2ZmaSh2YWx1ZS50cmFuc2FjdGlvbnMpLAogICAgICAgIHRyYW5zYWN0aW9uc19yb290OiBmb3JtYXQhKCIweHt9IiwgaGV4OjplbmNvZGUodmFsdWUudHJhbnNhY3Rpb25zX3Jvb3QuYXNfYnl0ZXMoKSkpLAogICAgICAgIHVuY2xlczogdmFsdWUKICAgICAgICAgICAgLnVuY2xlcwogICAgICAgICAgICAuaW50b19pdGVyKCkKICAgICAgICAgICAgLm1hcCh8aGFzaHwgZm9ybWF0ISgiMHh7fSIsIGhleDo6ZW5jb2RlKGhhc2guYXNfYnl0ZXMoKSkpKQogICAgICAgICAgICAuY29sbGVjdCgpLAogICAgfQp9CgojW2Rlcml2ZShDbG9uZSldCnB1YiBzdHJ1Y3QgT3B0aW9uYWxGaWxlREIgewogICAgZmlsZV9kYjogT3B0aW9uPEZpbGVEQj4sCiAgICBkZWZhdWx0X2NoZWNrcG9pbnQ6IFZlYzx1OD4sCn0KCmltcGwgRGF0YWJhc2UgZm9yIE9wdGlvbmFsRmlsZURCIHsKICAgIGZuIG5ldyhjb25maWc6ICZDb25maWcpIC0+IFJlc3VsdDxTZWxmLCBSZXBvcnQ+IHsKICAgICAgICBpZiBsZXQgU29tZShfZGF0YV9kaXIpID0gJmNvbmZpZy5kYXRhX2RpciB7CiAgICAgICAgICAgIE9rKE9wdGlvbmFsRmlsZURCIHsKICAgICAgICAgICAgICAgIGZpbGVfZGI6IFNvbWUoRmlsZURCOjpuZXcoY29uZmlnKT8pLAogICAgICAgICAgICAgICAgZGVmYXVsdF9jaGVja3BvaW50OiBjb25maWcuZGVmYXVsdF9jaGVja3BvaW50LmNsb25lKCksCiAgICAgICAgICAgIH0pCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgT2soT3B0aW9uYWxGaWxlREIgewogICAgICAgICAgICAgICAgZmlsZV9kYjogTm9uZSwKICAgICAgICAgICAgICAgIGRlZmF1bHRfY2hlY2twb2ludDogY29uZmlnLmRlZmF1bHRfY2hlY2twb2ludC5jbG9uZSgpLAogICAgICAgICAgICB9KQogICAgICAgIH0KICAgIH0KCiAgICBmbiBzYXZlX2NoZWNrcG9pbnQoJnNlbGYsIGNoZWNrcG9pbnQ6ICZbdThdKSAtPiBSZXN1bHQ8KCksIFJlcG9ydD4gewogICAgICAgIGlmIGxldCBTb21lKGZpbGVfZGIpID0gJnNlbGYuZmlsZV9kYiB7CiAgICAgICAgICAgIGZpbGVfZGIuc2F2ZV9jaGVja3BvaW50KCZjaGVja3BvaW50KQogICAgICAgIH0gZWxzZSB7CiAgICAgICAgICAgIE9rKCgpKQogICAgICAgIH0KICAgIH0KCiAgICBmbiBsb2FkX2NoZWNrcG9pbnQoJnNlbGYpIC0+IFJlc3VsdDxWZWM8dTg+LCBSZXBvcnQ+IHsKICAgICAgICBpZiBsZXQgU29tZShmaWxlX2RiKSA9ICZzZWxmLmZpbGVfZGIgewogICAgICAgICAgICBmaWxlX2RiLmxvYWRfY2hlY2twb2ludCgpCiAgICAgICAgfSBlbHNlIHsKICAgICAgICAgICAgT2soc2VsZi5kZWZhdWx0X2NoZWNrcG9pbnQuY2xvbmUoKSkKICAgICAgICB9CiAgICB9Cn0KCnB1YiBzdHJ1Y3QgSGVsaW9zQ2xpZW50IHsKICAgIGNsaWVudDogT3B0aW9uPENsaWVudDxPcHRpb25hbEZpbGVEQj4+LAogICAgaXNfbG9nZ2luZzogYm9vbCwKfQo="

rust::build
build::lipo
build::generate_c_headers
build::xcframework

post_build::compress
post_build::copy_bridge_files
post_build::success
