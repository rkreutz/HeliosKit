#! /bin/zsh -e

source "Build Scripts/functions.sh"

set -e

PACKAGE_VERSION=0.1.0

env::setup
env::build_configuration $1

rust::setup

pre_build::create_build_directory
pre_build::setup_openssl b30313a9775ed861ce9456745952e3012e5602ea
pre_build::setup_helios
pre_build::modify_helios 'dXNlIDo6Y2xpZW50Ojp7ZGF0YWJhc2U6OkZpbGVEQiwgQ2xpZW50LCBDbGllbnRCdWlsZGVyfTsKdXNlIDo6Y29uZmlnOjp7bmV0d29ya3N9OwoKI1tzd2lmdF9icmlkZ2U6OmJyaWRnZV0KbW9kIGZmaSB7CgogIGVudW0gSGVsaW9zTmV0d29yayB7CiAgICBNQUlOTkVULAogICAgR09FUkxJLAogIH0KCiAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICBzdHJ1Y3QgU3RhcnRVcFN0YXRlIHsKICAgIHN0YXJ0ZWQ6IGJvb2wsCiAgICBlcnJvcjogU3RyaW5nLAogIH0KCiAgZXh0ZXJuICJSdXN0IiB7CiAgICB0eXBlIEhlbGlvc0NsaWVudDsKCiAgICAjW3N3aWZ0X2JyaWRnZShpbml0KV0KICAgIGZuIG5ldygpIC0+IEhlbGlvc0NsaWVudDsKCiAgICBhc3luYyBmbiBzdGFydCgKICAgICAgJm11dCBzZWxmLCAKICAgICAgdW50cnVzdGVkX3JwY191cmw6IFN0cmluZywgCiAgICAgIGNvbnNlbnN1c19ycGNfdXJsOiBTdHJpbmcsCiAgICAgIGNoZWNrcG9pbnQ6IE9wdGlvbjxTdHJpbmc+LAogICAgICBycGNfcG9ydDogdTE2LAogICAgICBuZXR3b3JrOiBIZWxpb3NOZXR3b3JrCiAgICApIC0+IFN0YXJ0VXBTdGF0ZTsKCiAgICBhc3luYyBmbiBzaHV0ZG93bigmbXV0IHNlbGYpOwogIH0KfQoKaW1wbCBIZWxpb3NDbGllbnQgewoKICBwdWIgZm4gbmV3KCkgLT4gSGVsaW9zQ2xpZW50IHsKICAgIEhlbGlvc0NsaWVudCB7CiAgICAgIGNsaWVudDogTm9uZSwKICAgICAgaXNfbG9nZ2luZzogZmFsc2UsCiAgICB9CiAgfQoKICBhc3luYyBmbiBzdGFydCgKICAgICZtdXQgc2VsZiwKICAgIHVudHJ1c3RlZF9ycGNfdXJsOiBTdHJpbmcsCiAgICBjb25zZW5zdXNfcnBjX3VybDogU3RyaW5nLAogICAgY2hlY2twb2ludDogT3B0aW9uPFN0cmluZz4sCiAgICBycGNfcG9ydDogdTE2LAogICAgbmV0d29yazogZmZpOjpIZWxpb3NOZXR3b3JrLAogICkgLT4gZmZpOjpTdGFydFVwU3RhdGUgewogICAgaWYgbGV0IFNvbWUoX2NsaWVudCkgPSAmc2VsZi5jbGllbnQgewogICAgICByZXR1cm4gZmZpOjpTdGFydFVwU3RhdGUgewogICAgICAgIHN0YXJ0ZWQ6IGZhbHNlLAogICAgICAgIGVycm9yOiAiQ2xpZW50IGhhcyBhbHJlYWR5IHN0YXJ0ZWQuIi50b19zdHJpbmcoKSwKICAgICAgfTsKICAgIH0KCiAgICBpZiAhc2VsZi5pc19sb2dnaW5nIHsKICAgICAgc2VsZi5pc19sb2dnaW5nID0gdHJ1ZTsKICAgICAgZW52X2xvZ2dlcjo6aW5pdCgpOwogICAgfQoKICAgIGxldCBtdXQgY2xpZW50X2J1aWxkZXIgPSBDbGllbnRCdWlsZGVyOjpuZXcoKQogICAgICAubmV0d29yayhuZXR3b3JrLnRvX2Jhc2VfbmV0d29yaygpKQogICAgICAuZXhlY3V0aW9uX3JwYygmdW50cnVzdGVkX3JwY191cmwpCiAgICAgIC5jb25zZW5zdXNfcnBjKCZjb25zZW5zdXNfcnBjX3VybCkKICAgICAgLnJwY19wb3J0KHJwY19wb3J0KTsKICAgIAogICAgaWYgbGV0IFNvbWUoY2hlY2twb2ludCkgPSAmY2hlY2twb2ludCB7CiAgICAgIGNsaWVudF9idWlsZGVyID0gY2xpZW50X2J1aWxkZXIuY2hlY2twb2ludCgmY2hlY2twb2ludCk7CiAgICB9CgogICAgbWF0Y2ggY2xpZW50X2J1aWxkZXIuYnVpbGQoKSB7CiAgICAgIEVycihlcnJvcikgPT4gcmV0dXJuIGZmaTo6U3RhcnRVcFN0YXRlIHsKICAgICAgICBzdGFydGVkOiBmYWxzZSwKICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgIH0sCiAgICAgIE9rKG11dCBjbGllbnQpID0+IHsKICAgICAgICBtYXRjaCBjbGllbnQuc3RhcnQoKS5hd2FpdCB7CiAgICAgICAgICBFcnIoZXJyb3IpID0+IHJldHVybiBmZmk6OlN0YXJ0VXBTdGF0ZSB7CiAgICAgICAgICAgIHN0YXJ0ZWQ6IGZhbHNlLAogICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICB9LAogICAgICAgICAgT2soKCkpID0+IHsKICAgICAgICAgICAgc2VsZi5jbGllbnQgPSBTb21lKGNsaWVudCk7CiAgICAgICAgICAgIHJldHVybiBmZmk6OlN0YXJ0VXBTdGF0ZSB7CiAgICAgICAgICAgICAgc3RhcnRlZDogdHJ1ZSwKICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH07CiAgICAgICAgICB9LAogICAgICAgIH0KICAgICAgfSwKICAgIH0KICB9CgogIGFzeW5jIGZuIHNodXRkb3duKCZtdXQgc2VsZikgewogICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgIGNsaWVudC5zaHV0ZG93bigpLmF3YWl0OwogICAgICBzZWxmLmNsaWVudCA9IE5vbmU7CiAgICB9CiAgfQp9CgppbXBsIGZmaTo6SGVsaW9zTmV0d29yayB7CgogIGZuIHRvX2Jhc2VfbmV0d29yaygmc2VsZikgLT4gbmV0d29ya3M6Ok5ldHdvcmsgewogICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgIFNlbGY6Ok1BSU5ORVQgPT4gbmV0d29ya3M6Ok5ldHdvcms6Ok1BSU5ORVQsCiAgICAgICAgICBTZWxmOjpHT0VSTEkgPT4gbmV0d29ya3M6Ok5ldHdvcms6OkdPRVJMSSwKICAgICAgfQogIH0KfQoKcHViIHN0cnVjdCBIZWxpb3NDbGllbnQgewogIGNsaWVudDogT3B0aW9uPENsaWVudDxGaWxlREI+PiwKICBpc19sb2dnaW5nOiBib29sLAp9Cg=='

rust::build
build::lipo
build::generate_c_headers
build::xcframework

post_build::compress
post_build::copy_bridge_files
post_build::success
