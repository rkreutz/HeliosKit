#! /bin/zsh -e

source "Build Scripts/functions.sh"

set -e

PACKAGE_VERSION=0.1.4
HELIOS_VERSION=0.1.3
ETHERS_VERSION=1.0.2

env::setup
env::build_configuration $1

rust::setup

pre_build::create_build_directory
pre_build::setup_openssl dc976d756f9d3273c3c6f960fadb88e44b468050
pre_build::setup_helios
pre_build::modify_helios 'dXNlIDo6Y2xpZW50Ojp7ZGF0YWJhc2U6OkZpbGVEQiwgQ2xpZW50LCBDbGllbnRCdWlsZGVyfTsKdXNlIDo6Y29uZmlnOjp7bmV0d29ya3N9OwoKI1tzd2lmdF9icmlkZ2U6OmJyaWRnZV0KbW9kIGZmaSB7CgogIGVudW0gSGVsaW9zTmV0d29yayB7CiAgICBNQUlOTkVULAogICAgR09FUkxJLAogIH0KCiAgI1tzd2lmdF9icmlkZ2Uoc3dpZnRfcmVwciA9ICJzdHJ1Y3QiKV0KICBzdHJ1Y3QgU3RhcnRVcFN0YXRlIHsKICAgIHN0YXJ0ZWQ6IGJvb2wsCiAgICBlcnJvcjogU3RyaW5nLAogIH0KCiAgZXh0ZXJuICJSdXN0IiB7CiAgICB0eXBlIEhlbGlvc0NsaWVudDsKCiAgICAjW3N3aWZ0X2JyaWRnZShpbml0KV0KICAgIGZuIG5ldygpIC0+IEhlbGlvc0NsaWVudDsKCiAgICBhc3luYyBmbiBzdGFydCgKICAgICAgJm11dCBzZWxmLCAKICAgICAgdW50cnVzdGVkX3JwY191cmw6IFN0cmluZywgCiAgICAgIGNvbnNlbnN1c19ycGNfdXJsOiBTdHJpbmcsCiAgICAgIGNoZWNrcG9pbnQ6IE9wdGlvbjxTdHJpbmc+LAogICAgICBycGNfcG9ydDogdTE2LAogICAgICBuZXR3b3JrOiBIZWxpb3NOZXR3b3JrLAogICAgICBkYXRhX2RpcjogT3B0aW9uPFN0cmluZz4KICAgICkgLT4gU3RhcnRVcFN0YXRlOwoKICAgIGFzeW5jIGZuIHNodXRkb3duKCZtdXQgc2VsZik7CiAgfQp9CgppbXBsIEhlbGlvc0NsaWVudCB7CgogIHB1YiBmbiBuZXcoKSAtPiBIZWxpb3NDbGllbnQgewogICAgSGVsaW9zQ2xpZW50IHsKICAgICAgY2xpZW50OiBOb25lLAogICAgICBpc19sb2dnaW5nOiBmYWxzZSwKICAgIH0KICB9CgogIGFzeW5jIGZuIHN0YXJ0KAogICAgJm11dCBzZWxmLAogICAgdW50cnVzdGVkX3JwY191cmw6IFN0cmluZywKICAgIGNvbnNlbnN1c19ycGNfdXJsOiBTdHJpbmcsCiAgICBjaGVja3BvaW50OiBPcHRpb248U3RyaW5nPiwKICAgIHJwY19wb3J0OiB1MTYsCiAgICBuZXR3b3JrOiBmZmk6OkhlbGlvc05ldHdvcmssCiAgICBkYXRhX2RpcjogT3B0aW9uPFN0cmluZz4sCiAgKSAtPiBmZmk6OlN0YXJ0VXBTdGF0ZSB7CiAgICBpZiBsZXQgU29tZShfY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgIHJldHVybiBmZmk6OlN0YXJ0VXBTdGF0ZSB7CiAgICAgICAgc3RhcnRlZDogZmFsc2UsCiAgICAgICAgZXJyb3I6ICJDbGllbnQgaGFzIGFscmVhZHkgc3RhcnRlZC4iLnRvX3N0cmluZygpLAogICAgICB9OwogICAgfQoKICAgIGlmICFzZWxmLmlzX2xvZ2dpbmcgewogICAgICBzZWxmLmlzX2xvZ2dpbmcgPSB0cnVlOwogICAgICBlbnZfbG9nZ2VyOjppbml0KCk7CiAgICB9CgogICAgbGV0IG11dCBjbGllbnRfYnVpbGRlciA9IENsaWVudEJ1aWxkZXI6Om5ldygpCiAgICAgIC5uZXR3b3JrKG5ldHdvcmsudG9fYmFzZV9uZXR3b3JrKCkpCiAgICAgIC5leGVjdXRpb25fcnBjKCZ1bnRydXN0ZWRfcnBjX3VybCkKICAgICAgLmNvbnNlbnN1c19ycGMoJmNvbnNlbnN1c19ycGNfdXJsKQogICAgICAucnBjX3BvcnQocnBjX3BvcnQpOwogICAgCiAgICBpZiBsZXQgU29tZShjaGVja3BvaW50KSA9ICZjaGVja3BvaW50IHsKICAgICAgY2xpZW50X2J1aWxkZXIgPSBjbGllbnRfYnVpbGRlci5jaGVja3BvaW50KCZjaGVja3BvaW50KTsKICAgIH0KCiAgICBpZiBsZXQgU29tZShkYXRhX2RpcikgPSAmZGF0YV9kaXIgewogICAgICBjbGllbnRfYnVpbGRlciA9IGNsaWVudF9idWlsZGVyLmRhdGFfZGlyKCgmZGF0YV9kaXIpLmludG8oKSk7CiAgICB9CgogICAgbWF0Y2ggY2xpZW50X2J1aWxkZXIuYnVpbGQoKSB7CiAgICAgIEVycihlcnJvcikgPT4gcmV0dXJuIGZmaTo6U3RhcnRVcFN0YXRlIHsKICAgICAgICBzdGFydGVkOiBmYWxzZSwKICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgIH0sCiAgICAgIE9rKG11dCBjbGllbnQpID0+IHsKICAgICAgICBtYXRjaCBjbGllbnQuc3RhcnQoKS5hd2FpdCB7CiAgICAgICAgICBFcnIoZXJyb3IpID0+IHJldHVybiBmZmk6OlN0YXJ0VXBTdGF0ZSB7CiAgICAgICAgICAgIHN0YXJ0ZWQ6IGZhbHNlLAogICAgICAgICAgICBlcnJvcjogZXJyb3IudG9fc3RyaW5nKCksCiAgICAgICAgICB9LAogICAgICAgICAgT2soKCkpID0+IHsKICAgICAgICAgICAgc2VsZi5jbGllbnQgPSBTb21lKGNsaWVudCk7CiAgICAgICAgICAgIHJldHVybiBmZmk6OlN0YXJ0VXBTdGF0ZSB7CiAgICAgICAgICAgICAgc3RhcnRlZDogdHJ1ZSwKICAgICAgICAgICAgICBlcnJvcjogIiIudG9fc3RyaW5nKCksCiAgICAgICAgICAgIH07CiAgICAgICAgICB9LAogICAgICAgIH0KICAgICAgfSwKICAgIH0KICB9CgogIGFzeW5jIGZuIHNodXRkb3duKCZtdXQgc2VsZikgewogICAgaWYgbGV0IFNvbWUoY2xpZW50KSA9ICZzZWxmLmNsaWVudCB7CiAgICAgIGNsaWVudC5zaHV0ZG93bigpLmF3YWl0OwogICAgICBzZWxmLmNsaWVudCA9IE5vbmU7CiAgICB9CiAgfQp9CgppbXBsIGZmaTo6SGVsaW9zTmV0d29yayB7CgogIGZuIHRvX2Jhc2VfbmV0d29yaygmc2VsZikgLT4gbmV0d29ya3M6Ok5ldHdvcmsgewogICAgICBtYXRjaCBzZWxmIHsKICAgICAgICAgIFNlbGY6Ok1BSU5ORVQgPT4gbmV0d29ya3M6Ok5ldHdvcms6Ok1BSU5ORVQsCiAgICAgICAgICBTZWxmOjpHT0VSTEkgPT4gbmV0d29ya3M6Ok5ldHdvcms6OkdPRVJMSSwKICAgICAgfQogIH0KfQoKcHViIHN0cnVjdCBIZWxpb3NDbGllbnQgewogIGNsaWVudDogT3B0aW9uPENsaWVudDxGaWxlREI+PiwKICBpc19sb2dnaW5nOiBib29sLAp9Cg=='

rust::build
build::lipo
build::generate_c_headers
build::xcframework

post_build::compress
post_build::copy_bridge_files
post_build::success
